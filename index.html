<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Entretien du centre de secours de Consenvoye</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --bg0:#070a0f;
      --bg1:#0b111b;
      --panel:#0f1724;
      --panel2:#111c2c;
      --line:rgba(255,255,255,.10);
      --text:#eaf0fb;
      --muted:#aab6cc;

      --red:#d72638;
      --red2:#ff3b30;
      --amber:#ffb020;
      --green:#2ecc71;

      --radius:18px;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --shadow2: 0 10px 22px rgba(0,0,0,.35);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% -10%, rgba(215,38,56,.35), transparent 60%),
        radial-gradient(900px 600px at 105% 10%, rgba(255,176,32,.16), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 45%, var(--bg0));
      overflow-x:hidden;
    }

    /* d√©cor ‚Äúcaserne / pompier‚Äù */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      opacity:.30;
      background:
        repeating-linear-gradient(
          135deg,
          rgba(255,255,255,.06) 0px,
          rgba(255,255,255,.06) 10px,
          rgba(0,0,0,0) 10px,
          rgba(0,0,0,0) 26px
        );
      mix-blend-mode: overlay;
    }
    body::after{
      content:"";
      position:fixed;
      inset:-40px -40px auto auto;
      width: 380px;
      height: 380px;
      pointer-events:none;
      opacity:.55;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,59,48,.35), rgba(255,59,48,0) 60%),
        radial-gradient(circle at 60% 50%, rgba(255,176,32,.20), rgba(255,176,32,0) 55%);
      transform: rotate(18deg);
    }

    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px 14px 34px;
    }

    /* Header pleine largeur */
    .brand{
      width:100%;
      background:
        linear-gradient(135deg, rgba(215,38,56,.20), rgba(15,23,36,.92) 58%),
        linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,0) 40%);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px 16px;
      position:relative;
      overflow:hidden;
    }
    .brandRow{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:center;
      text-align:center;
      flex-wrap:wrap;
    }
    .mark{
      width:54px;
      height:54px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.18);
      background: linear-gradient(135deg, rgba(215,38,56,.95), rgba(255,176,32,.65));
      box-shadow: 0 14px 30px rgba(215,38,56,.18);
      display:grid;
      place-items:center;
      flex:0 0 auto;
    }
    .titleBox{ text-align:center; }
    .title{
      margin:0;
      font-size: 22px;
      line-height: 1.08;
      letter-spacing: .2px;
    }
    .subtitle{
      margin:6px 0 0;
      color: var(--muted);
      font-size: 13px;
    }

    /* P√©riode sous le header */
    .periodCard{
      margin-top: 12px;
      width:100%;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .two{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 520px){
      .two{ grid-template-columns: 1fr; }
    }
    .label{
      display:block;
      color: var(--muted);
      font-size: 12px;
      margin: 0 0 6px;
    }

    select, input, textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(15,23,36,.70);
      color: var(--text);
      outline: none;
      font-size: 16px;
    }
    textarea{ min-height: 110px; resize: vertical; }

    select:focus, input:focus, textarea:focus{
      border-color: rgba(255,59,48,.55);
      box-shadow: 0 0 0 4px rgba(215,38,56,.14);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
      white-space: nowrap;
    }
    .pill.ok{ color:#dff7ea; background: rgba(46,204,113,.10); border-color: rgba(46,204,113,.25); }
    .pill.warn{ color:#ffe9c7; background: rgba(255,176,32,.10); border-color: rgba(255,176,32,.25); }
    .pill.bad{ color:#ffd6da; background: rgba(255,59,48,.10); border-color: rgba(255,59,48,.25); }

    .hint{
      margin-top: 10px;
      color: rgba(255,255,255,.55);
      font-size: 12px;
      line-height: 1.35;
    }

    /* Onglets */
    .main{
      margin-top: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .tabs{
      display:flex;
      gap:10px;
      padding: 10px;
      background: rgba(15,23,36,.55);
      border-bottom: 1px solid var(--line);
    }
    .tab{
      flex:1;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 12px 10px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 900;
      font-size: 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      user-select:none;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
    }
    .tab:active{ transform: scale(.99); }
    .tab.active{
      background: linear-gradient(135deg, rgba(215,38,56,.22), rgba(255,176,32,.10));
      border-color: rgba(255,59,48,.55);
      box-shadow: 0 10px 22px rgba(215,38,56,.10);
    }

    .content{ display:none; padding: 14px; }
    .content.active{ display:block; }

    .section{
      border: 1px solid var(--line);
      border-radius: 16px;
      background: rgba(15,23,36,.45);
      padding: 12px;
      box-shadow: var(--shadow2);
    }
    .section + .section{ margin-top: 12px; }

    .sectionHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom: 10px;
    }
    .sectionTitle{
      margin:0;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: .35px;
      color: var(--muted);
      font-weight: 900;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items:start;
    }
    @media (max-width: 820px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; }
    .btnRow > *{ flex: 1 1 180px; }
    .btn{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(135deg, rgba(215,38,56,.95), rgba(255,59,48,.78));
      color:#fff;
      font-weight: 950;
      cursor:pointer;
      font-size: 15px;
      box-shadow: 0 14px 30px rgba(215,38,56,.20);
      transition: transform .08s ease, filter .15s ease;
    }
    .btn:active{ transform: scale(.99); }
    .btn:hover{ filter: brightness(1.05); }

    .btnGhost{
      width:100%;
      padding: 11px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      font-weight: 900;
      cursor:pointer;
    }

    .list{
      margin: 10px 0 0 0;
      padding: 0;
      list-style: none;
      display:flex;
      flex-direction: column;
      gap:8px;
    }
    .item{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:10px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
    }
    .itemLeft{
      display:flex;
      flex-direction: column;
      gap:2px;
      min-width: 0;
      flex: 1 1 auto;
    }
    .itemLeft .name{
      font-weight: 950;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .meta{
      color: var(--muted);
      font-size: 12px;
      font-weight: 750;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
    }
    .smallBtn{
      padding: 9px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      font-weight: 950;
      font-size: 13px;
      white-space: nowrap;
    }
    .smallBtn.danger{
      border-color: rgba(255,59,48,.35);
      background: rgba(255,59,48,.10);
    }

    .rowTight{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-end;
    }
    .rowTight > *{ flex: 1 1 220px; }
    .rowTight .auto{ flex: 0 0 auto; }

    /* Missions: 3 cases (exclusives) */
    .tri{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .tri label{
      display:inline-flex;
      gap:6px;
      align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      user-select:none;
      font-size: 13px;
      font-weight: 850;
      color: var(--text);
    }
    .tri input[type="checkbox"]{
      width: 16px;
      height: 16px;
      accent-color: var(--red2);
      cursor:pointer;
    }
    .tri label.fait{ border-color: rgba(46,204,113,.25); background: rgba(46,204,113,.08); }
    .tri label.partiel{ border-color: rgba(255,176,32,.25); background: rgba(255,176,32,.08); }
    .tri label.nonfait{ border-color: rgba(255,59,48,.25); background: rgba(255,59,48,.08); }

    .footer{
      margin-top: 14px;
      text-align:center;
      color: rgba(255,255,255,.45);
      font-size: 12px;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- HEADER pleine largeur -->
    <div class="brand">
      <div class="brandRow">
        <div class="mark" aria-hidden="true">
          <!-- casque / flamme -->
          <svg width="30" height="30" viewBox="0 0 24 24" fill="none">
            <path d="M7 13.5V10.8C7 7.6 9.3 5 12 5s5 2.6 5 5.8v2.7"
              stroke="white" stroke-width="2" stroke-linecap="round"/>
            <path d="M6 14.5c0-1.1.9-2 2-2h8c1.1 0 2 .9 2 2V18c0 .6-.4 1-1 1H7c-.6 0-1-.4-1-1v-3.5Z"
              stroke="white" stroke-width="2" stroke-linejoin="round"/>
            <path d="M12 9c.6.7.9 1.2.9 1.9 0 1-1 1.8-1.9 1.8S9.2 12 9.2 11c0-.9.7-1.6 1.5-2.3.6-.5.9-.9 1.3-1.7Z"
              fill="white" opacity=".9"/>
          </svg>
        </div>
        <div class="titleBox">
          <h1 class="title">Entretien du centre de secours de Consenvoye</h1>
          <p class="subtitle">Interface interne ‚Ä¢ Acc√®s agents ‚Ä¢ Param√©trage administrateur</p>
        </div>
      </div>
    </div>

    <!-- PERIODE sous le header -->
    <div class="periodCard">
      <div class="two">
        <div>
          <span class="label">Mois</span>
          <select id="mois">
            <option value="">-- S√©lectionner --</option>
            <option>Janvier</option><option>F√©vrier</option><option>Mars</option><option>Avril</option>
            <option>Mai</option><option>Juin</option><option>Juillet</option><option>Ao√ªt</option>
            <option>Septembre</option><option>Octobre</option><option>Novembre</option><option>D√©cembre</option>
          </select>
        </div>
        <div>
          <span class="label">Ann√©e</span>
          <select id="annee">
            <option value="">-- S√©lectionner --</option>
            <option>2025</option>
            <option selected>2026</option>
            <option>2027</option>
          </select>
        </div>
      </div>

      <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;">
        <span class="pill" id="periodPill">S√©lectionner mois + ann√©e</span>
        <span class="pill" id="whoPill">Non connect√©</span>
      </div>

      <div class="hint">
        La p√©riode sert √† param√©trer les missions (admin) et √† afficher les missions de l‚Äôagent (si l‚Äôagent est attribu√© √† la p√©riode).
      </div>
    </div>

    <!-- ONGLET -->
    <div class="main">
      <div class="tabs" role="tablist" aria-label="Onglets">
        <div class="tab active" role="tab" aria-selected="true" onclick="showTab('agent')">üë®‚Äçüöí Agent</div>
        <div class="tab" role="tab" aria-selected="false" onclick="showTab('admin')">üõ°Ô∏è Administrateur</div>
      </div>

      <!-- AGENT -->
      <div id="agent" class="content active">
        <div class="section">
          <div class="sectionHead">
            <h2 class="sectionTitle">Connexion agent</h2>
            <span class="pill" id="agentPill">Acc√®s</span>
          </div>

          <div class="grid2">
            <div>
              <span class="label">Nom</span>
              <select id="agentSelect"></select>
            </div>
            <div>
              <span class="label">Code d‚Äôacc√®s</span>
              <input id="agentCode" type="password" placeholder="Code agent" />
            </div>
          </div>

          <div class="btnRow" style="margin-top:10px;">
            <button class="btn" type="button" onclick="agentLogin()">Se connecter</button>
            <button class="btnGhost" type="button" onclick="agentLogout()">D√©connexion</button>
          </div>

          <!-- Forcer changement code -->
          <div id="forceChangeBox" class="section" style="display:none; margin-top:12px; background: rgba(15,23,36,.35);">
            <div class="sectionHead">
              <h2 class="sectionTitle">Changement de code requis</h2>
              <span class="pill warn">Premi√®re connexion</span>
            </div>

            <div class="grid2">
              <div>
                <span class="label">Nouveau code (min 4 lettres/chiffres)</span>
                <input id="newAgentCode" type="password" placeholder="Ex : 1234 ou A1b2" />
              </div>
              <div>
                <span class="label">Confirmer</span>
                <input id="newAgentCode2" type="password" placeholder="Retaper le code" />
              </div>
            </div>

            <div class="btnRow" style="margin-top:10px;">
              <button class="btn" type="button" onclick="confirmChangeAgentCode()">Valider le nouveau code</button>
            </div>
            <div class="hint">Lettres et chiffres uniquement. Minimum 4 caract√®res.</div>
          </div>

          <!-- Missions agent -->
          <div id="agentMissionsBox" class="section" style="display:none; margin-top:12px; background: rgba(15,23,36,.35);">
            <div class="sectionHead">
              <h2 class="sectionTitle">Missions √† effectuer</h2>
              <span class="pill ok" id="agentNamePill">‚Äî</span>
            </div>

            <div id="agentAccessMsg" class="hint" style="margin-top:0;"></div>
            <ul class="list" id="agentMissionsList"></ul>

            <div class="hint">
              Pour chaque mission : coche <b>Fait</b> / <b>Partiellement fait</b> / <b>Non fait</b>.
            </div>
          </div>
        </div>
      </div>

      <!-- ADMIN -->
      <div id="admin" class="content">
        <div class="section">
          <div class="sectionHead">
            <h2 class="sectionTitle">Acc√®s administrateur</h2>
            <span class="pill warn">Code requis</span>
          </div>

          <div class="grid2">
            <div>
              <span class="label">Code administrateur</span>
              <input id="codeAdmin" type="password" placeholder="Code admin" />
            </div>
            <div style="display:flex; align-items:flex-end;">
              <button class="btn" type="button" onclick="unlockAdmin()">Acc√©der</button>
            </div>
          </div>

          <div class="hint">
            Stockage : localStorage (sur ce navigateur). (On fera export/import plus tard si tu veux.)
          </div>
        </div>

        <div id="adminZone" style="display:none;">
          <!-- AGENTS -->
          <div class="section">
            <div class="sectionHead">
              <h2 class="sectionTitle">Agents</h2>
              <span class="pill" id="agentsCount">0</span>
            </div>

            <div class="rowTight">
              <div>
                <span class="label">Nom Pr√©nom</span>
                <input id="agentNom" placeholder="Ex : V√âNANTE Pierre" />
              </div>
              <div>
                <span class="label">Statut</span>
                <select id="agentStatut">
                  <option value="equipier">√âquipier</option>
                  <option value="responsable">Responsable d‚Äô√©quipe</option>
                </select>
              </div>
              <div class="auto">
                <button class="btn" type="button" onclick="addAgent()">Ajouter</button>
              </div>
            </div>

            <div class="btnRow" style="margin-top:10px;">
              <button class="btnGhost" type="button" onclick="sortAgents()">Trier A‚ÜíZ</button>
              <button class="btnGhost" type="button" onclick="assignSelectedPeriodToAll()">Attribuer cette p√©riode √† tous</button>
            </div>

            <ul class="list" id="agentsList"></ul>

            <div class="hint">
              Chaque agent a un <b>code</b> (r√©initialisable) et un <b>statut</b> modifiable.
              L‚Äôadmin peut attribuer des <b>p√©riodes</b> (mois/ann√©e) √† chaque agent.
            </div>
          </div>

          <!-- MISSIONS PAR P√âRIODE (sans compteur) -->
          <div class="section">
            <div class="sectionHead">
              <h2 class="sectionTitle">Missions par p√©riode</h2>
              <span class="pill" id="missionsPill">0</span>
            </div>

            <div class="grid2">
              <!-- gauche: liste p√©riode -->
              <div class="section" style="margin:0;">
                <div class="sectionHead">
                  <h2 class="sectionTitle">Liste (p√©riode)</h2>
                  <span class="pill" id="periodMissionsCount">0</span>
                </div>
                <ul class="list" id="periodMissionsList"></ul>
                <div class="hint">Une mission est pr√©sente ou absente (pas de compteur).</div>
              </div>

              <!-- droite: catalogue -->
              <div class="section" style="margin:0;">
                <div class="sectionHead">
                  <h2 class="sectionTitle">Catalogue</h2>
                  <span class="pill" id="catalogCount">0</span>
                </div>

                <span class="label">Mission</span>
                <select id="catalogSelect"></select>

                <div class="btnRow" style="margin-top:10px;">
                  <button class="btn" type="button" onclick="addSelectedMissionToPeriod()">Ajouter ‚ûï</button>
                  <button class="btnGhost" type="button" onclick="removeSelectedMissionFromPeriod()">Retirer ‚ûñ</button>
                </div>

                <div style="height:10px;"></div>

                <span class="label">Ajouter au catalogue</span>
                <div class="grid2" style="grid-template-columns: 1fr auto; gap:10px;">
                  <input id="newCatalogMission" placeholder="Ex : Inventaire VSAV" />
                  <button class="btnGhost" type="button" onclick="addMissionToCatalog()">Ajouter</button>
                </div>

                <div class="btnRow" style="margin-top:10px;">
                  <button class="btnGhost" type="button" onclick="deleteSelectedFromCatalog()">Supprimer du catalogue</button>
                  <button class="btnGhost" type="button" onclick="clearPeriodMissions()">Vider p√©riode</button>
                </div>

                <div class="hint">La p√©riode est celle s√©lectionn√©e tout en haut.</div>
              </div>
            </div>

          </div>
        </div>
      </div>

    </div>

    <div class="footer">¬© Centre de secours ‚Ä¢ Prototype web (GitHub Pages)</div>
  </div>

  <script>
    // ===================== CONFIG =====================
    const ADMIN_CODE = "1234";
    const LS_KEY = "consenvoye_entretien_v3";

    // ===================== STATE =====================
    const state = loadState();

    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return {
          agents: [],
          catalogMissions: [],
          periodMissions: {}, // { "2026-Janvier": ["Mission A","Mission B"] }
          missionStatus: {} // { "agentId|2026-Janvier|Mission A": "fait|partiel|nonfait" }
        };
        const p = JSON.parse(raw);
        return {
          agents: Array.isArray(p.agents) ? p.agents : [],
          catalogMissions: Array.isArray(p.catalogMissions) ? p.catalogMissions : [],
          periodMissions: (p.periodMissions && typeof p.periodMissions === "object") ? p.periodMissions : {},
          missionStatus: (p.missionStatus && typeof p.missionStatus === "object") ? p.missionStatus : {}
        };
      }catch(e){
        return { agents: [], catalogMissions: [], periodMissions: {}, missionStatus: {} };
      }
    }

    function saveState(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
      renderAll();
    }

    function normalize(s){
      return (s || "").trim().replace(/\s+/g, " ");
    }
    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function cryptoRandomId(){
      return (Math.random().toString(16).slice(2) + Date.now().toString(16)).slice(0,16);
    }

    // ===================== PERIOD =====================
    function periodKey(){
      const mois = document.getElementById("mois").value;
      const annee = document.getElementById("annee").value;
      if(!mois || !annee) return "";
      return `${annee}-${mois}`;
    }
    function renderPeriodPill(){
      const pill = document.getElementById("periodPill");
      const key = periodKey();
      pill.textContent = key ? key : "S√©lectionner mois + ann√©e";
    }

    // ===================== TABS =====================
    function showTab(tab) {
      const tabs = document.querySelectorAll('.tab');
      const contents = document.querySelectorAll('.content');

      tabs.forEach(t => { t.classList.remove('active'); t.setAttribute('aria-selected','false'); });
      contents.forEach(c => c.classList.remove('active'));

      if (tab === 'agent') {
        tabs[0].classList.add('active'); tabs[0].setAttribute('aria-selected','true');
      } else {
        tabs[1].classList.add('active'); tabs[1].setAttribute('aria-selected','true');
      }
      document.getElementById(tab).classList.add('active');

      // cache admin si on quitte
      if(tab !== 'admin'){
        const codeEl = document.getElementById('codeAdmin');
        const zoneEl = document.getElementById('adminZone');
        if(codeEl) codeEl.value = "";
        if(zoneEl) zoneEl.style.display = "none";
      }
    }

    // ===================== ADMIN LOCK =====================
    function unlockAdmin(){
      const code = document.getElementById("codeAdmin").value;
      if(code === ADMIN_CODE){
        document.getElementById("adminZone").style.display = "block";
        renderAll();
      }else{
        alert("Code incorrect");
      }
    }

    // ===================== AGENTS =====================
    function generateAgentCode(){
      // 4 chiffres par d√©faut (l‚Äôagent pourra le changer)
      const n = Math.floor(Math.random() * 9000) + 1000;
      return String(n);
    }

    function addAgent(){
      const name = normalize(document.getElementById("agentNom").value);
      const role = document.getElementById("agentStatut").value;

      if(!name) return;

      if(state.agents.some(a => a.name === name)){
        document.getElementById("agentNom").value = "";
        return;
      }

      state.agents.push({
        id: cryptoRandomId(),
        name,
        role, // equipier | responsable
        code: generateAgentCode(),
        mustChangeCode: true, // premi√®re connexion
        periods: [] // p√©riodes autoris√©es
      });

      document.getElementById("agentNom").value = "";
      saveState();
    }

    function sortAgents(){
      state.agents.sort((a,b)=>a.name.localeCompare(b.name,"fr",{sensitivity:"base"}));
      saveState();
    }

    function updateAgentRole(id, newRole){
      const a = state.agents.find(x => x.id === id);
      if(!a) return;
      a.role = newRole;
      saveState();
    }

    function resetAgentCode(id){
      const a = state.agents.find(x => x.id === id);
      if(!a) return;
      a.code = generateAgentCode();
      a.mustChangeCode = true;
      saveState();
    }

    function removeAgent(id){
      const idx = state.agents.findIndex(x => x.id === id);
      if(idx >= 0){
        // purge status entries for this agent
        const prefix = id + "|";
        Object.keys(state.missionStatus).forEach(k=>{
          if(k.startsWith(prefix)) delete state.missionStatus[k];
        });
        state.agents.splice(idx,1);
        saveState();
      }
    }

    function toggleAgentPeriod(id, key, enabled){
      const a = state.agents.find(x => x.id === id);
      if(!a) return;
      if(!Array.isArray(a.periods)) a.periods = [];
      if(enabled){
        if(!a.periods.includes(key)) a.periods.push(key);
      }else{
        a.periods = a.periods.filter(p => p !== key);
      }
      saveState();
    }

    function assignSelectedPeriodToAll(){
      const key = periodKey();
      if(!key){ alert("S√©lectionne d'abord mois + ann√©e."); return; }
      state.agents.forEach(a=>{
        if(!a.periods) a.periods = [];
        if(!a.periods.includes(key)) a.periods.push(key);
      });
      saveState();
    }

    function renderAgents(){
      const ul = document.getElementById("agentsList");
      const badge = document.getElementById("agentsCount");
      ul.innerHTML = "";
      badge.textContent = String(state.agents.length);

      const key = periodKey();

      state.agents.forEach(a=>{
        const li = document.createElement("li");
        li.className = "item";

        const roleSelectId = `role_${a.id}`;
        const assignId = `assign_${a.id}`;

        const isAssigned = key && Array.isArray(a.periods) && a.periods.includes(key);

        li.innerHTML = `
          <div class="itemLeft">
            <div class="name">${escapeHtml(a.name)}</div>
            <div class="meta">
              <span class="tag">üîë Code : <b style="color:var(--text)">${escapeHtml(a.code)}</b></span>
              <span class="tag">üë§ Statut :
                <select id="${roleSelectId}" style="margin-left:6px; padding:6px 8px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.06); color: var(--text);">
                  <option value="equipier">√âquipier</option>
                  <option value="responsable">Responsable d‚Äô√©quipe</option>
                </select>
              </span>
              <span class="tag">
                üìÖ Attribu√© √† la p√©riode :
                <input id="${assignId}" type="checkbox" ${isAssigned ? "checked" : ""} ${key ? "" : "disabled"} style="width:16px;height:16px; accent-color: var(--amber);" />
              </span>
            </div>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
            <button class="smallBtn" type="button">R√©init. code</button>
            <button class="smallBtn danger" type="button">Supprimer</button>
          </div>
        `;

        const sel = li.querySelector(`#${roleSelectId}`);
        sel.value = a.role || "equipier";
        sel.addEventListener("change", e => updateAgentRole(a.id, e.target.value));

        const cb = li.querySelector(`#${assignId}`);
        cb.addEventListener("change", e => {
          const k = periodKey();
          if(!k) return;
          toggleAgentPeriod(a.id, k, e.target.checked);
        });

        const btnReset = li.querySelectorAll("button")[0];
        const btnDel = li.querySelectorAll("button")[1];
        btnReset.addEventListener("click", ()=> resetAgentCode(a.id));
        btnDel.addEventListener("click", ()=> removeAgent(a.id));

        ul.appendChild(li);
      });
    }

    // ===================== MISSIONS (catalogue + p√©riode) =====================
    function getPeriodMissions(key){
      if(!key) return [];
      const arr = state.periodMissions[key];
      return Array.isArray(arr) ? arr : [];
    }

    function setPeriodMissions(key, missions){
      state.periodMissions[key] = missions;
    }

    function renderCatalog(){
      const sel = document.getElementById("catalogSelect");
      const badge = document.getElementById("catalogCount");
      sel.innerHTML = "";

      const catalog = state.catalogMissions.slice().sort((a,b)=>a.localeCompare(b,"fr",{sensitivity:"base"}));
      badge.textContent = String(catalog.length);

      if(catalog.length === 0){
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "-- Catalogue vide --";
        sel.appendChild(opt);
        return;
      }

      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "-- Choisir une mission --";
      sel.appendChild(opt0);

      catalog.forEach(m=>{
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        sel.appendChild(opt);
      });
    }

    function addMissionToCatalog(){
      const inp = document.getElementById("newCatalogMission");
      const name = normalize(inp.value);
      if(!name) return;
      if(!state.catalogMissions.includes(name)) state.catalogMissions.push(name);
      inp.value = "";
      saveState();
    }

    function deleteSelectedFromCatalog(){
      const sel = document.getElementById("catalogSelect");
      const name = sel.value;
      if(!name) return;
      state.catalogMissions = state.catalogMissions.filter(x => x !== name);
      saveState();
    }

    function addSelectedMissionToPeriod(){
      const key = periodKey();
      if(!key){ alert("S√©lectionne d'abord mois + ann√©e."); return; }
      const sel = document.getElementById("catalogSelect");
      const name = sel.value;
      if(!name) return;

      const list = getPeriodMissions(key).slice();
      if(!list.includes(name)) list.push(name);
      setPeriodMissions(key, list);
      saveState();
    }

    function removeSelectedMissionFromPeriod(){
      const key = periodKey();
      if(!key){ alert("S√©lectionne d'abord mois + ann√©e."); return; }
      const sel = document.getElementById("catalogSelect");
      const name = sel.value;
      if(!name) return;

      const list = getPeriodMissions(key).slice().filter(x => x !== name);
      setPeriodMissions(key, list);
      saveState();
    }

    function clearPeriodMissions(){
      const key = periodKey();
      if(!key){ alert("S√©lectionne d'abord mois + ann√©e."); return; }
      setPeriodMissions(key, []);
      saveState();
    }

    function renderPeriodMissions(){
      const key = periodKey();
      const ul = document.getElementById("periodMissionsList");
      const count = document.getElementById("periodMissionsCount");
      const pill = document.getElementById("missionsPill");

      ul.innerHTML = "";
      if(!key){
        count.textContent = "0";
        pill.textContent = "0";
        return;
      }

      const list = getPeriodMissions(key);
      count.textContent = String(list.length);
      pill.textContent = String(list.length);

      list
        .slice()
        .sort((a,b)=>a.localeCompare(b,"fr",{sensitivity:"base"}))
        .forEach(m=>{
          const li = document.createElement("li");
          li.className = "item";
          li.innerHTML = `
            <div class="itemLeft">
              <div class="name">${escapeHtml(m)}</div>
              <div class="meta"><span class="tag">üìå ${escapeHtml(key)}</span></div>
            </div>
            <button class="smallBtn danger" type="button">Retirer</button>
          `;
          li.querySelector("button").addEventListener("click", ()=>{
            const list2 = getPeriodMissions(key).filter(x => x !== m);
            setPeriodMissions(key, list2);
            saveState();
          });
          ul.appendChild(li);
        });
    }

    // ===================== AGENT LOGIN + MISSIONS =====================
    let agentSession = null; // {id,name,role}

    function renderAgentSelect(){
      const sel = document.getElementById("agentSelect");
      sel.innerHTML = "";

      if(state.agents.length === 0){
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "-- Aucun agent --";
        sel.appendChild(opt);
        return;
      }

      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "-- Choisir votre nom --";
      sel.appendChild(opt0);

      state.agents
        .slice()
        .sort((a,b)=>a.name.localeCompare(b.name,"fr",{sensitivity:"base"}))
        .forEach(a=>{
          const opt = document.createElement("option");
          opt.value = a.id;
          opt.textContent = a.name;
          sel.appendChild(opt);
        });
    }

    function isValidAgentCode(code){
      return /^[A-Za-z0-9]{4,}$/.test(code);
    }

    function agentLogin(){
      const id = document.getElementById("agentSelect").value;
      const code = document.getElementById("agentCode").value;

      const a = state.agents.find(x=>x.id===id);
      if(!a){ alert("S√©lectionne ton nom."); return; }
      if(!code){ alert("Entre ton code."); return; }
      if(code !== a.code){ alert("Code incorrect."); return; }

      agentSession = { id:a.id, name:a.name, role:a.role };

      document.getElementById("agentNamePill").textContent = a.name;
      document.getElementById("agentMissionsBox").style.display = "block";
      document.getElementById("forceChangeBox").style.display = "none";
      document.getElementById("agentCode").value = "";

      document.getElementById("whoPill").className = "pill ok";
      document.getElementById("whoPill").textContent = "Connect√© : " + a.name;

      const ap = document.getElementById("agentPill");
      ap.className = "pill ok";
      ap.textContent = "Connect√©";

      if(a.mustChangeCode){
        // force changement avant de voir les missions
        document.getElementById("agentMissionsBox").style.display = "none";
        document.getElementById("forceChangeBox").style.display = "block";
        ap.className = "pill warn";
        ap.textContent = "Changement code requis";
        return;
      }

      renderAgentMissions();
    }

    function agentLogout(){
      agentSession = null;
      document.getElementById("agentSelect").value = "";
      document.getElementById("agentCode").value = "";
      document.getElementById("newAgentCode").value = "";
      document.getElementById("newAgentCode2").value = "";
      document.getElementById("forceChangeBox").style.display = "none";
      document.getElementById("agentMissionsBox").style.display = "none";

      const ap = document.getElementById("agentPill");
      ap.className = "pill";
      ap.textContent = "Acc√®s";

      document.getElementById("whoPill").className = "pill";
      document.getElementById("whoPill").textContent = "Non connect√©";
    }

    function confirmChangeAgentCode(){
      if(!agentSession){ alert("Connecte-toi d'abord."); return; }
      const a = state.agents.find(x=>x.id===agentSession.id);
      if(!a) return;

      const c1 = document.getElementById("newAgentCode").value || "";
      const c2 = document.getElementById("newAgentCode2").value || "";

      if(c1 !== c2){ alert("Les deux codes ne sont pas identiques."); return; }
      if(!isValidAgentCode(c1)){
        alert("Code invalide : min 4 caract√®res, lettres/chiffres uniquement.");
        return;
      }

      a.code = c1;
      a.mustChangeCode = false;

      document.getElementById("newAgentCode").value = "";
      document.getElementById("newAgentCode2").value = "";
      document.getElementById("forceChangeBox").style.display = "none";
      document.getElementById("agentMissionsBox").style.display = "block";

      const ap = document.getElementById("agentPill");
      ap.className = "pill ok";
      ap.textContent = "Connect√©";

      saveState();
      renderAgentMissions();
      alert("Code modifi√©.");
    }

    function statusKey(agentId, period, mission){
      return `${agentId}|${period}|${mission}`;
    }

    function setMissionStatus(agentId, period, mission, status){
      const k = statusKey(agentId, period, mission);
      if(!status){
        delete state.missionStatus[k];
      }else{
        state.missionStatus[k] = status;
      }
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }

    function getMissionStatus(agentId, period, mission){
      return state.missionStatus[statusKey(agentId, period, mission)] || "";
    }

    function renderAgentMissions(){
      const box = document.getElementById("agentMissionsBox");
      const msg = document.getElementById("agentAccessMsg");
      const ul = document.getElementById("agentMissionsList");

      ul.innerHTML = "";
      msg.textContent = "";

      if(!agentSession){
        box.style.display = "none";
        return;
      }

      const period = periodKey();
      if(!period){
        msg.textContent = "S√©lectionne une p√©riode (mois/ann√©e).";
        return;
      }

      const agent = state.agents.find(x=>x.id===agentSession.id);
      const assigned = agent && Array.isArray(agent.periods) && agent.periods.includes(period);

      if(!assigned){
        msg.textContent = "Tu n‚Äôes pas attribu√© √† cette p√©riode.";
        msg.style.color = "rgba(255,255,255,.70)";
        return;
      }

      const missions = getPeriodMissions(period);
      if(missions.length === 0){
        msg.textContent = "Aucune mission enregistr√©e pour cette p√©riode.";
        return;
      }

      msg.innerHTML = `P√©riode : <b>${escapeHtml(period)}</b> ‚Ä¢ Missions : <b>${missions.length}</b>`;

      missions
        .slice()
        .sort((a,b)=>a.localeCompare(b,"fr",{sensitivity:"base"}))
        .forEach(m=>{
          const li = document.createElement("li");
          li.className = "item";

          const current = getMissionStatus(agentSession.id, period, m);

          // 3 cases √† cocher mais exclusives : JS forcera une seule coche
          const idF = `f_${agentSession.id}_${hash(period+m)}`;
          const idP = `p_${agentSession.id}_${hash(period+m)}`;
          const idN = `n_${agentSession.id}_${hash(period+m)}`;

          li.innerHTML = `
            <div class="itemLeft">
              <div class="name">${escapeHtml(m)}</div>
              <div class="meta">
                <span class="tag">üìå ${escapeHtml(period)}</span>
              </div>
            </div>
            <div class="tri" data-mission="${escapeHtml(m)}">
              <label class="fait" title="Fait">
                <input type="checkbox" id="${idF}" data-status="fait" /> Fait
              </label>
              <label class="partiel" title="Partiellement fait">
                <input type="checkbox" id="${idP}" data-status="partiel" /> Partiel
              </label>
              <label class="nonfait" title="Non fait">
                <input type="checkbox" id="${idN}" data-status="nonfait" /> Non fait
              </label>
            </div>
          `;

          const tri = li.querySelector(".tri");
          const checks = Array.from(tri.querySelectorAll('input[type="checkbox"]'));

          // init
          checks.forEach(ch=>{
            const s = ch.getAttribute("data-status");
            ch.checked = (s === current);
          });

          // exclusivit√© + sauvegarde
          checks.forEach(ch=>{
            ch.addEventListener("change", ()=>{
              if(ch.checked){
                // un seul
                checks.forEach(other=>{
                  if(other !== ch) other.checked = false;
                });
                const status = ch.getAttribute("data-status");
                setMissionStatus(agentSession.id, period, m, status);
              }else{
                // si on d√©coche -> plus de statut
                setMissionStatus(agentSession.id, period, m, "");
              }
            });
          });

          ul.appendChild(li);
        });
    }

    function hash(s){
      // petit hash stable pour ids DOM
      let h = 0;
      for(let i=0;i<s.length;i++){
        h = (h<<5) - h + s.charCodeAt(i);
        h |= 0;
      }
      return Math.abs(h);
    }

    // ===================== RENDER ALL =====================
    function renderAll(){
      renderPeriodPill();
      renderCatalog();
      renderPeriodMissions();
      renderAgents();
      renderAgentSelect();

      // si agent connect√©, rafra√Æchir missions
      if(agentSession){
        const a = state.agents.find(x=>x.id===agentSession.id);
        if(a){
          document.getElementById("agentNamePill").textContent = a.name;
          document.getElementById("whoPill").className = "pill ok";
          document.getElementById("whoPill").textContent = "Connect√© : " + a.name;
          if(a.mustChangeCode){
            document.getElementById("forceChangeBox").style.display = "block";
            document.getElementById("agentMissionsBox").style.display = "none";
            const ap = document.getElementById("agentPill");
            ap.className = "pill warn";
            ap.textContent = "Changement code requis";
          }else{
            document.getElementById("forceChangeBox").style.display = "none";
            document.getElementById("agentMissionsBox").style.display = "block";
            const ap = document.getElementById("agentPill");
            ap.className = "pill ok";
            ap.textContent = "Connect√©";
            renderAgentMissions();
          }
        }
      }
    }

    // ===================== EVENTS =====================
    document.getElementById("mois").addEventListener("change", ()=> renderAll());
    document.getElementById("annee").addEventListener("change", ()=> renderAll());

    // init defaults
    renderAll();
  </script>
</body>
</html>
