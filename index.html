<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Entretien CS Consenvoye</title>

<style>
:root{
  --bg:#0b0f14; --panel:#0f1724;
  --stroke:rgba(255,255,255,.12);
  --text:#e8eef9; --muted:rgba(232,238,249,.65);
  --accent:#ff7a00; --accent2:#ffb000;
  --danger:#ff3b30; --ok:#1fd36b;
  --r:16px;
  --font:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
}
*{box-sizing:border-box}
body{
  margin:0;font-family:var(--font);color:var(--text);
  background:linear-gradient(180deg,#06080b,var(--bg));
}
.wrap{max-width:1100px;margin:auto;padding:16px}
h1{text-align:center;color:var(--accent);margin:0}
.tabs{display:flex;justify-content:center;gap:8px;margin:16px 0}
.tab{padding:10px 16px;border-radius:999px;border:1px solid var(--stroke);
background:transparent;color:var(--muted);cursor:pointer;font-weight:800}
.tab.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#000}
.card{background:rgba(255,255,255,.03);border:1px solid var(--stroke);
border-radius:var(--r);padding:16px;margin-bottom:16px}
.row{display:flex;gap:10px;flex-wrap:wrap}
.row>*{flex:1;min-width:200px}
input,select,textarea,button{
  width:100%;padding:10px;border-radius:12px;border:1px solid var(--stroke);
  background:#000;color:var(--text)
}
button.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));
color:#000;font-weight:900;border:0;cursor:pointer}
button.danger{background:rgba(255,59,48,.2);color:#ffd0cd}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:8px;border-bottom:1px solid rgba(255,255,255,.1)}
.status{font-weight:900}
.ok{color:var(--ok)} .bad{color:var(--danger)}
@media(max-width:800px){
  .wrap{padding:10px}
}
</style>
</head>

<body>
<div class="wrap">
<h1>Entretien CS Consenvoye</h1>

<div class="tabs">
  <button class="tab active" onclick="show('agent')">üßë‚Äçüöí Agent</button>
  <button class="tab" onclick="show('admin')">üõ°Ô∏è Admin</button>
</div>

<!-- ================= AGENT ================= -->
<div id="agent" class="card">
  <div class="status" id="agentStatus">Agent non connect√©</div>
  <div class="row">
    <select id="agentSelect"></select>
    <input id="agentCode" placeholder="Code agent">
    <button class="primary" onclick="agentLogin()">Connexion</button>
  </div>

  <div id="agentBody" style="display:none">
    <hr>
    <select id="agentPeriod"></select>
    <button class="primary" onclick="loadAgentMissions()">Charger missions</button>
    <div id="agentMissions"></div>
    <button class="primary" onclick="saveAgent()">Enregistrer</button>
  </div>
</div>

<!-- ================= ADMIN ================= -->
<div id="admin" class="card" style="display:none">
  <div class="status" id="adminStatus">Admin non connect√©</div>
  <div class="row">
    <input id="adminCode" placeholder="Code admin">
    <button class="primary" onclick="adminLogin()">Connexion</button>
  </div>

  <div id="adminBody" style="display:none">

    <h3>Changer code admin</h3>
    <div class="row">
      <input id="newAdminCode" placeholder="Nouveau code">
      <button class="primary" onclick="changeAdminCode()">Changer</button>
    </div>

    <h3>Agents</h3>
    <div class="row">
      <input id="newAgentName" placeholder="Nom agent">
      <input id="newAgentCode" placeholder="Code">
      <button class="primary" onclick="addAgent()">Ajouter</button>
    </div>
    <table class="table" id="agentTable"></table>

    <h3>P√©riodes</h3>
    <div class="row">
      <input id="newPeriod" placeholder="YYYY-MM">
      <button class="primary" onclick="addPeriod()">Ajouter</button>
    </div>
    <ul id="periodList"></ul>

    <h3>Missions</h3>
    <div class="row">
      <input id="newMission" placeholder="Libell√© mission">
      <button class="primary" onclick="addMission()">Ajouter</button>
    </div>
    <ul id="missionList"></ul>

    <h3>Missions actives par p√©riode</h3>
    <select id="adminPeriod"></select>
    <div id="adminMissionChecks"></div>

    <h3>Retours agents</h3>
    <table class="table" id="retoursTable"></table>

    <h3>Sauvegarde</h3>
    <button class="primary" onclick="exportData()">Exporter JSON</button>
    <input type="file" onchange="importData(this)">
  </div>
</div>
</div>

<script>
/* ================= CONFIG & DATA ================= */
const STORE="cs_entretien_full_v1";
let DB=JSON.parse(localStorage.getItem(STORE))||{
  adminCode:"1234",
  agents:[
    {id:1,name:"Durand",code:"1111",active:true},
    {id:2,name:"Martin",code:"2222",active:true},
    {id:3,name:"Bernard",code:"3333",active:true}
  ],
  periods:["2025-01","2025-02"],
  missions:["V√©rif VSAV","Nettoyage FPT","Contr√¥le ARI","Pression pneus","Inventaire"],
  active:{},
  declarations:{}
};
function save(){localStorage.setItem(STORE,JSON.stringify(DB))}

/* ================= UI ================= */
function show(v){
  document.getElementById("agent").style.display=v==="agent"?"":"none";
  document.getElementById("admin").style.display=v==="admin"?"":"none";
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  event.target.classList.add("active");
}

/* ================= AGENT ================= */
let CUR_AGENT=null;
function agentLogin(){
  const id=document.getElementById("agentSelect").value;
  const code=document.getElementById("agentCode").value;
  const a=DB.agents.find(x=>x.id==id&&x.code==code&&x.active);
  if(!a){agentStatus.textContent="Code incorrect";agentStatus.className="bad";return;}
  CUR_AGENT=a;
  agentStatus.textContent="Connect√© : "+a.name;
  agentStatus.className="ok";
  agentBody.style.display="";
  fillAgentPeriods();
}
function fillAgentPeriods(){
  agentPeriod.innerHTML=DB.periods.map(p=>`<option>${p}</option>`).join("");
}
function loadAgentMissions(){
  const p=agentPeriod.value;
  const list=(DB.active[p]||[]);
  agentMissions.innerHTML=list.map(m=>`
    <div>
      <b>${m}</b>
      <select data-m="${m}">
        <option></option>
        <option>Fait</option>
        <option>Partiel</option>
        <option>Non fait</option>
      </select>
      <input placeholder="Justificatif">
    </div>`).join("");
}
function saveAgent(){
  const p=agentPeriod.value;
  DB.declarations[CUR_AGENT.id]=DB.declarations[CUR_AGENT.id]||{};
  DB.declarations[CUR_AGENT.id][p]=[...agentMissions.querySelectorAll("div")].map(d=>{
    return{
      mission:d.querySelector("b").textContent,
      etat:d.querySelector("select").value,
      justif:d.querySelector("input").value
    }
  });
  save(); alert("Enregistr√©");
}

/* ================= ADMIN ================= */
function adminLogin(){
  if(adminCode.value!==DB.adminCode){
    adminStatus.textContent="Code incorrect";adminStatus.className="bad";return;
  }
  adminStatus.textContent="Admin connect√©";adminStatus.className="ok";
  adminBody.style.display="";
  refreshAdmin();
}
function changeAdminCode(){DB.adminCode=newAdminCode.value;save();alert("Code chang√©")}
function addAgent(){
  DB.agents.push({id:Date.now(),name:newAgentName.value,code:newAgentCode.value,active:true});
  save();refreshAdmin();
}
function addPeriod(){DB.periods.push(newPeriod.value);save();refreshAdmin()}
function addMission(){DB.missions.push(newMission.value);save();refreshAdmin()}
function refreshAdmin(){
  agentTable.innerHTML=DB.agents.map(a=>`
    <tr><td>${a.name}</td><td>${a.code}</td></tr>`).join("");
  periodList.innerHTML=DB.periods.map(p=>`<li>${p}</li>`).join("");
  missionList.innerHTML=DB.missions.map(m=>`<li>${m}</li>`).join("");
  adminPeriod.innerHTML=DB.periods.map(p=>`<option>${p}</option>`).join("");
  refreshChecks();
  refreshRetours();
}
function refreshChecks(){
  const p=adminPeriod.value;
  adminMissionChecks.innerHTML=DB.missions.map(m=>{
    const c=(DB.active[p]||[]).includes(m)?"checked":"";
    return `<label><input type=checkbox ${c} onchange="toggleMission('${p}','${m}',this.checked)"> ${m}</label>`;
  }).join("<br>");
}
function toggleMission(p,m,on){
  DB.active[p]=DB.active[p]||[];
  if(on) DB.active[p].push(m);
  else DB.active[p]=DB.active[p].filter(x=>x!==m);
  save();
}
function refreshRetours(){
  let rows="";
  for(const aid in DB.declarations){
    for(const p in DB.declarations[aid]){
      DB.declarations[aid][p].forEach(d=>{
        if(d.etat==="Partiel"||d.etat==="Non fait")
          rows+=`<tr><td>${aid}</td><td>${p}</td><td>${d.mission}</td><td>${d.etat}</td><td>${d.justif}</td></tr>`;
      })
    }
  }
  retoursTable.innerHTML=rows;
}
function exportData(){
  const a=document.createElement("a");
  a.href="data:text/json,"+encodeURIComponent(JSON.stringify(DB,null,2));
  a.download="sauvegarde.json";a.click();
}
function importData(inp){
  const r=new FileReader();
  r.onload=e=>{DB=JSON.parse(e.target.result);save();location.reload()};
  r.readAsText(inp.files[0]);
}

/* INIT */
agentSelect.innerHTML=DB.agents.filter(a=>a.active).map(a=>`<option value=${a.id}>${a.name}</option>`).join("");
</script>
</body>
</html>
