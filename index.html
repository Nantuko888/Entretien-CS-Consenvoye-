<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Entretien CS Consenvoye</title>

  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1724; --panel2:#111b2b;
      --stroke:rgba(255,255,255,.12);
      --text:#e8eef9; --muted:rgba(232,238,249,.72);
      --accent:#ff7a00; --accent2:#ffb000;
      --danger:#ff3b30; --ok:#1fd36b;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --r:18px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial, "Noto Sans", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:var(--font);color:var(--text);
      background:
        radial-gradient(900px 420px at 20% 20%, rgba(255,122,0,.18), transparent 65%),
        radial-gradient(900px 420px at 80% 10%, rgba(255,176,0,.12), transparent 60%),
        linear-gradient(180deg, #06080b, var(--bg));
      min-height:100vh;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px 14px 46px}
    h1{margin:0;font-size:30px;font-weight:950;letter-spacing:.2px;color:#ff8d1a;text-shadow:0 2px 14px rgba(255,122,0,.18);text-align:center;}
    .subtitle{margin:6px 0 0;color:var(--muted);font-size:12px;text-align:center}

    .tabsCenter{margin:14px 0 18px;display:flex;justify-content:center;}
    .tabs{display:flex;gap:8px;align-items:center;border:1px solid var(--stroke);background:rgba(255,255,255,.02);padding:6px;border-radius:999px;box-shadow:var(--shadow);}
    .tab{border:0;background:transparent;color:var(--muted);padding:10px 14px;border-radius:999px;cursor:pointer;font-weight:950;font-size:13px;}
    .tab.active{background:linear-gradient(90deg, rgba(255,122,0,.26), rgba(255,176,0,.18));color:var(--text);}

    .btn{
      appearance:none;border:1px solid var(--stroke);background:rgba(255,255,255,.03);color:var(--text);
      border-radius:999px;padding:10px 14px;cursor:pointer;font-weight:950;font-size:13px;
      transition:.15s transform ease,.15s background ease,.15s border-color ease;white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.2);background:rgba(255,255,255,.06)}
    .btn.primary{
      background:linear-gradient(90deg, var(--accent), var(--accent2));
      border-color:transparent;color:#0b0f14;box-shadow:0 12px 26px rgba(255,122,0,.18);
    }
    /* ‚úÖ jaune ‚Üí vert pendant chargement (toutes actions) */
    .btn.loading, .btn.primary.loading{
      background: linear-gradient(90deg, #1fd36b, #7dff9c) !important;
      border-color: transparent !important;
      color:#0b0f14 !important;
      cursor: wait !important;
      opacity: .95;
    }
    .btn[disabled]{opacity:.65;cursor:not-allowed}
    .btn.danger{background:rgba(255,59,48,.14);border-color:rgba(255,59,48,.35);color:#ffd0cd}
    .btn.small{padding:8px 12px;font-size:12px}

    .card{
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border-radius:var(--r);padding:16px;box-shadow:var(--shadow);
    }
    .headRow{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;flex-wrap:wrap}
    .h2{margin:0;font-size:15px;font-weight:950}
    .status{
      font-size:12px;font-weight:950;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.02);color:var(--muted);display:inline-flex;align-items:center;gap:8px;white-space:nowrap;
    }
    .status.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.10);color:#bdf6d2}
    .status.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.10);color:#ffd0cd}

    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
    input, select, textarea{
      width:100%;padding:11px 12px;border-radius:12px;border:1px solid var(--stroke);
      background:rgba(0,0,0,.25);color:var(--text);outline:none;font-size:14px;
    }
    textarea{min-height:90px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .row > *{flex:1;min-width:220px}
    .divider{height:1px;background:rgba(255,255,255,.09);margin:14px 0}

    .twoColBlock{display:grid;gap:12px}
    @media(min-width:1000px){ .twoColBlock{grid-template-columns: 1fr 1.2fr;} }

    .toast{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);background:rgba(255,255,255,.02);color:var(--muted);font-size:13px;display:none}
    .toast.show{display:block}
    .toast.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.08);color:#c9f9db}
    .toast.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.08);color:#ffd0cd}

    .list{display:grid;gap:10px;margin-top:10px}
    .item{
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.18);
      border-radius:14px;padding:12px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .pill{font-size:12px;font-weight:950;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.02)}
    .pill.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.10);color:#bdf6d2}
    .pill.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.10);color:#ffd0cd}

    .keyBtn{
      border:1px solid var(--stroke);background:rgba(255,255,255,.04);
      border-radius:999px;padding:10px 12px;cursor:pointer;font-weight:950;
    }

    .scrollBox{max-height:280px;overflow:auto;border-radius:14px;border:1px solid var(--stroke);background:rgba(0,0,0,.18)}
    .rowLine{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08)}
    .rowLine:last-child{border-bottom:0}

    .imgDone{
      width:100%;max-width:560px;margin:8px auto 0;display:block;border-radius:16px;
      border:1px solid var(--stroke);
    }

    details{border:1px solid var(--stroke);border-radius:14px;padding:10px;background:rgba(0,0,0,.12)}
    summary{cursor:pointer;font-weight:950}
    .muted{color:var(--muted)}

    @media(max-width:700px){
      .wrap{max-width:none;width:100%;padding:12px}
      .row > *{min-width:100%}
      h1{font-size:26px}
      input,select,textarea,button,.btn{min-height:44px;font-size:16px}
    }
  </style>
</head>

<body>
<div class="wrap">
  <h1>Entretien du centre de secours de Consenvoye</h1>
  <div class="subtitle">Agent : saisie ‚Ä¢ Admin : configuration</div>

  <div class="tabsCenter">
    <div class="tabs">
      <button class="tab active" id="tabAgent" onclick="showView('agent')">üßë‚Äçüöí Agent</button>
      <button class="tab" id="tabAdmin" onclick="showView('admin')">üõ°Ô∏è Admin</button>
    </div>
  </div>

  <!-- ================= AGENT ================= -->
  <div id="viewAgent" class="card">
    <div class="headRow">
      <div class="h2">Espace agent</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="keyBtn" id="agentKey" style="display:none" title="Changer le code" onclick="openAgentKey()">üîë</button>
        <button class="btn danger small" id="agentLogout" style="display:none" onclick="agentLogout()">D√©connexion</button>
        <div class="status" id="agentStatus">Agent : non connect√©</div>
      </div>
    </div>

    <div class="row" id="agentLoginRow">
      <div>
        <label>Agent</label>
        <select id="agentSel"></select>
      </div>
      <div>
        <label>Code</label>
        <input id="agentCode" placeholder="Code agent" />
      </div>
      <div>
        <button class="btn primary" id="btnAgentLogin" onclick="agentLogin(event)">Se connecter</button>
      </div>
    </div>

    <div id="agentToast" class="toast"></div>

    <!-- Changement code (obligatoire ou volontaire via cl√©) -->
    <div id="agentKeyBox" style="display:none;margin-top:14px">
      <div class="h2" style="margin:0 0 8px 0">Changer mon code</div>
      <div class="row">
        <div>
          <label>Ancien code</label>
          <input id="agentOldCode" placeholder="Ancien code" />
        </div>
        <div>
          <label>Nouveau code (min 4)</label>
          <input id="agentNewCode" placeholder="Nouveau code" />
        </div>
        <div>
          <button class="btn primary" id="btnAgentChange" onclick="agentChangeCode(event)">Valider</button>
        </div>
      </div>
      <div id="agentChangeToast" class="toast"></div>
      <div class="divider"></div>
    </div>

    <div id="agentWork" style="display:none;margin-top:14px">
      <div class="row">
        <div>
          <label>P√©riode</label>
          <select id="agentPeriodSel"></select>
        </div>
        <div>
          <button class="btn primary" id="btnAgentLoad" onclick="agentLoadPeriod(event)">Charger</button>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Missions accomplies -->
      <div id="agentDoneWrap" style="display:none">
        <img class="imgDone" id="imgDone" src="./missions-accomplies.jpg" alt="missions accomplies">
        <div class="muted" style="text-align:center;margin-top:6px;font-size:12px">(double-tap / double-clic pour masquer)</div>
        <div class="divider"></div>
      </div>

      <div id="agentMissions" class="list"></div>

      <div class="divider"></div>

      <label>Remarque g√©n√©rale (facultatif)</label>
      <textarea id="agentRemark" placeholder="Remarque g√©n√©rale‚Ä¶"></textarea>

      <div class="row" style="margin-top:10px">
        <div>
          <button class="btn primary" id="btnAgentSave" onclick="agentSave(event)">Enregistrer</button>
        </div>
      </div>

      <div id="agentSaveToast" class="toast"></div>
    </div>
  </div>

  <!-- ================= ADMIN ================= -->
  <div id="viewAdmin" class="card" style="display:none">
    <div class="headRow">
      <div class="h2">Espace admin</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="keyBtn" id="adminKey" style="display:none" title="Changer le code admin" onclick="openAdminKey()">üîë</button>
        <button class="btn danger small" id="adminLogout" style="display:none" onclick="adminLogout()">D√©connexion</button>
        <div class="status" id="adminStatus">Admin : non connect√©</div>
      </div>
    </div>

    <div class="row" id="adminLoginRow">
      <div>
        <label>Code admin</label>
        <input id="adminCode" placeholder="Code admin" />
      </div>
      <div>
        <button class="btn primary" id="btnAdminLogin" onclick="adminLogin(event)">Se connecter</button>
      </div>
    </div>

    <div id="adminToast" class="toast"></div>

    <!-- Changer code admin via cl√© -->
    <div id="adminKeyBox" style="display:none;margin-top:14px">
      <div class="h2" style="margin:0 0 8px 0">Changer mon code admin</div>
      <div class="row">
        <div>
          <label>Nouveau code (min 4)</label>
          <input id="adminNewCode" placeholder="Nouveau code" />
        </div>
        <div>
          <button class="btn primary" id="btnAdminChange" onclick="adminChangeCode(event)">Valider</button>
        </div>
      </div>
      <div id="adminChangeToast" class="toast"></div>
      <div class="divider"></div>
    </div>

    <div id="adminWork" style="display:none;margin-top:14px">
      <details>
        <summary>Avanc√©</summary>
        <div class="divider"></div>
        <button class="btn" id="btnAdminRefresh" onclick="adminRefresh(event)">Actualiser les donn√©es</button>
      </details>

      <div class="divider"></div>

      <div class="twoColBlock">
        <div class="card">
          <div class="headRow"><div class="h2">Agents</div></div>
          <div class="row">
            <div><label>Nom</label><input id="newAgentName" placeholder="Nom Pr√©nom"></div>
            <div><label>Code</label><input id="newAgentCode" value="0000"></div>
            <div><button class="btn primary" id="btnAddAgent" onclick="adminAddAgent(event)">Ajouter</button></div>
          </div>
          <div id="adminAgentsToast" class="toast"></div>
        </div>

        <div class="card">
          <div class="headRow"><div class="h2">Liste agents</div></div>
          <div id="adminAgentsList" class="scrollBox"></div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="twoColBlock">
        <div class="card">
          <div class="headRow"><div class="h2">Catalogue missions</div></div>
          <div class="row">
            <div><label>Libell√©</label><input id="newMissionLib" placeholder="Ex: Nettoyage"></div>
            <div><button class="btn primary" id="btnAddMission" onclick="adminAddMission(event)">Ajouter</button></div>
          </div>
          <div id="adminMissionsToast" class="toast"></div>
        </div>

        <div class="card">
          <div class="headRow"><div class="h2">Liste missions</div></div>
          <div id="adminMissionsList" class="scrollBox"></div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="twoColBlock">
        <div class="card">
          <div class="headRow"><div class="h2">Groupe par p√©riode</div><div class="status" id="respPill">Responsable : ‚Äî</div></div>
          <div class="row">
            <div><label>P√©riode</label><select id="periodeSel"></select></div>
            <div><button class="btn primary" id="btnLoadPeriod" onclick="adminLoadPeriod(event)">Charger</button></div>
          </div>
          <div class="row" style="margin-top:10px">
            <div><label>Ajouter au groupe</label><select id="addToGroupSel"></select></div>
            <div><button class="btn primary" id="btnAddToGroup" onclick="adminAddToGroup(event)">Ajouter</button></div>
          </div>
          <div class="row" style="margin-top:10px">
            <div><label>Responsable</label><select id="responsableSel"></select></div>
            <div><button class="btn primary" id="btnSetResp" onclick="adminSetResp(event)">D√©finir</button></div>
          </div>
          <div id="adminGroupToast" class="toast"></div>
        </div>

        <div class="card">
          <div class="headRow"><div class="h2">Agents du groupe</div></div>
          <div id="groupList" class="scrollBox"></div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="twoColBlock">
        <div class="card">
          <div class="headRow"><div class="h2">Missions actives du mois</div></div>
          <div id="monthBox" class="scrollBox"></div>
          <div class="row" style="margin-top:10px">
            <div><button class="btn primary" id="btnSaveMonth" onclick="adminSaveMonth(event)">Enregistrer</button></div>
          </div>
          <div id="adminMonthToast" class="toast"></div>
        </div>

        <div class="card">
          <div class="headRow"><div class="h2">Retours (Partiel / Non fait)</div></div>
          <div class="row">
            <div><button class="btn primary" id="btnLoadRetours" onclick="adminLoadRetours(event)">Charger</button></div>
          </div>
          <div id="retoursList" class="scrollBox" style="margin-top:10px"></div>
          <div id="adminRetoursToast" class="toast"></div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
/* ‚úÖ Remplace ici ton URL Apps Script /exec */
const API_EXEC = "https://script.google.com/macros/s/AKfycbwTo8mKf9yDCmFDZbT03-nbxv5QVLcMjNEGuvlL25alCktBLX9P-G3i4NTVMw048DE/exec";

/* ---------- util ---------- */
function setLoading(btn,on){ if(!btn) return; btn.classList.toggle("loading",!!on); btn.disabled=!!on; }
function toast(id,msg,ok){ const el=document.getElementById(id); if(!el) return; el.className="toast show "+(ok?"ok":"bad"); el.textContent=msg||""; }
function clearToast(id){ const el=document.getElementById(id); if(!el) return; el.className="toast"; el.textContent=""; }
function showView(v){
  document.getElementById("tabAgent").classList.toggle("active", v==="agent");
  document.getElementById("tabAdmin").classList.toggle("active", v==="admin");
  document.getElementById("viewAgent").style.display = (v==="agent") ? "" : "none";
  document.getElementById("viewAdmin").style.display = (v==="admin") ? "" : "none";
}
function esc(s){ return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* JSONP helper */
function jsonp(action, params){
  return new Promise((resolve,reject)=>{
    const cb = "cb_" + action + "_" + Date.now() + "_" + Math.random().toString(16).slice(2);
    window[cb] = (data)=>{ cleanup(); resolve(data); };
    const cleanup = ()=>{ try{ delete window[cb]; }catch(_){ } if(s && s.parentNode) s.parentNode.removeChild(s); };
    const q = new URLSearchParams({ action, callback: cb, ...params });
    const s = document.createElement("script");
    s.src = API_EXEC + "?" + q.toString() + "&_=" + Date.now();
    s.onerror = ()=>{ cleanup(); reject(new Error("load_error")); };
    document.head.appendChild(s);
  });
}

/* ---------- state ---------- */
let ADMIN = { ok:false, code:"", bootstrap:null, period_id:"" };
let AGENT = { ok:false, agent_id:"", nom:"", must_change:false, period_id:"" };

/* ---------- init ---------- */
(async function init(){
  await loadPublicAgents();
})();

async function loadPublicAgents(){
  const sel=document.getElementById("agentSel");
  sel.innerHTML = `<option value="">‚Äî Chargement‚Ä¶ ‚Äî</option>`;
  try{
    const res = await jsonp("listAgentsPublic",{});
    if(!res || !res.ok) throw 0;
    sel.innerHTML = `<option value="">‚Äî Choisir agent ‚Äî</option>` + (res.agents||[]).map(a=>`<option value="${esc(a.agent_id)}">${esc(a.nom)}</option>`).join("");
  }catch(_){
    sel.innerHTML = `<option value="">‚Äî Erreur ‚Äî</option>`;
  }
}

/* ---------- ADMIN ---------- */
function adminUI(on){
  document.getElementById("adminWork").style.display = on ? "" : "none";
  document.getElementById("adminKey").style.display = on ? "" : "none";
  document.getElementById("adminLogout").style.display = on ? "" : "none";
}
function openAdminKey(){
  const box=document.getElementById("adminKeyBox");
  box.style.display = (box.style.display==="none"||!box.style.display) ? "" : "none";
}

async function adminLogin(evt){
  clearToast("adminToast");
  const btn=document.getElementById("btnAdminLogin");
  const code=document.getElementById("adminCode").value.trim();
  if(!code) return;
  setLoading(btn,true);
  try{
    const res = await jsonp("adminLogin",{ code });
    if(!res || !res.ok){
      document.getElementById("adminStatus").className="status bad";
      document.getElementById("adminStatus").textContent="Admin : non connect√©";
      toast("adminToast","Code incorrect.", false);
      ADMIN.ok=false; ADMIN.code=""; adminUI(false);
      return;
    }
    ADMIN.ok=true; ADMIN.code=code;
    document.getElementById("adminStatus").className="status ok";
    document.getElementById("adminStatus").textContent="Admin : connect√©";
    toast("adminToast","Connect√© ‚úÖ", true);
    adminUI(true);
    await adminBootstrap();
  }catch(e){
    toast("adminToast","Erreur r√©seau", false);
  }finally{
    setLoading(btn,false);
  }
}

function adminLogout(){
  ADMIN={ ok:false, code:"", bootstrap:null, period_id:"" };
  document.getElementById("adminStatus").className="status";
  document.getElementById("adminStatus").textContent="Admin : non connect√©";
  adminUI(false);
}

async function adminChangeCode(evt){
  clearToast("adminChangeToast");
  const btn=document.getElementById("btnAdminChange");
  const new_code=document.getElementById("adminNewCode").value.trim();
  if(new_code.length<4){ toast("adminChangeToast","Code trop court (min 4).", false); return; }
  setLoading(btn,true);
  try{
    const res=await jsonp("adminChangeAdminCode",{ code: ADMIN.code, new_code });
    if(!res||!res.ok){ toast("adminChangeToast", res?.message||"Erreur", false); return; }
    toast("adminChangeToast","Code admin chang√© ‚úÖ", true);
  }catch(e){
    toast("adminChangeToast","Erreur r√©seau", false);
  }finally{ setLoading(btn,false); }
}

async function adminRefresh(evt){
  if(!ADMIN.ok) return;
  const btn=document.getElementById("btnAdminRefresh");
  setLoading(btn,true);
  try{ await adminBootstrap(true); }
  finally{ setLoading(btn,false); }
}

async function adminBootstrap(silent){
  const res = await jsonp("adminBootstrap",{ code: ADMIN.code });
  if(!res || !res.ok) throw new Error("bootstrap");
  ADMIN.bootstrap = res;

  // p√©riodes
  const pSel=document.getElementById("periodeSel");
  pSel.innerHTML = `<option value="">‚Äî Choisir p√©riode ‚Äî</option>` + (res.periodes||[]).map(p=>`<option value="${esc(p.period_id)}">${esc(p.libelle||p.period_id)}</option>`).join("");

  // agents selects
  const addSel=document.getElementById("addToGroupSel");
  addSel.innerHTML = `<option value="">‚Äî Choisir agent ‚Äî</option>` + (res.agents||[]).map(a=>`<option value="${esc(a.agent_id)}">${esc(a.nom)}</option>`).join("");

  // list agents + catalog
  await adminLoadAgents(true);
  await adminLoadCatalog(true);

  if(!silent) toast("adminToast","Donn√©es actualis√©es ‚úÖ", true);
}

async function adminLoadAgents(silent){
  const btn=document.getElementById("btnLoadAgents");
  if(btn && !silent) setLoading(btn,true);
  try{
    const res=await jsonp("adminListAgents",{ code: ADMIN.code });
    if(!res||!res.ok) throw 0;
    const list=res.agents||[];
    // liste agents (sans afficher IDs)
    document.getElementById("adminAgentsList").innerHTML = list.map(a=>{
      const badge=a.actif?`<span class="pill ok">Actif ‚úÖ</span>`:`<span class="pill bad">Inactif ‚ùå</span>`;
      return `
        <div class="rowLine">
          <div style="min-width:0"><b>${esc(a.nom)}</b></div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
            ${badge}
            <button class="btn small" onclick="adminToggleAgent('${esc(a.agent_id)}', ${a.actif? "false":"true"})">${a.actif?"D√©sactiver":"Activer"}</button>
            <button class="btn small danger" onclick="adminDeleteAgent('${esc(a.agent_id)}')">Supprimer</button>
          </div>
        </div>`;
    }).join("");
  }finally{
    if(btn && !silent) setLoading(btn,false);
  }
}

async function adminAddAgent(evt){
  clearToast("adminAgentsToast");
  const btn=document.getElementById("btnAddAgent");
  const nom=document.getElementById("newAgentName").value.trim();
  const agent_code=document.getElementById("newAgentCode").value.trim() || "0000";
  if(!nom){ toast("adminAgentsToast","Nom requis.", false); return; }
  setLoading(btn,true);
  try{
    const res=await jsonp("adminAddAgent",{ code: ADMIN.code, nom, agent_code });
    if(!res||!res.ok){ toast("adminAgentsToast", res?.message||"Erreur", false); return; }
    toast("adminAgentsToast","Ajout√© ‚úÖ", true);
    document.getElementById("newAgentName").value="";
    document.getElementById("newAgentCode").value="0000";
    await adminBootstrap(true);
  }catch(e){
    toast("adminAgentsToast","Erreur r√©seau", false);
  }finally{ setLoading(btn,false); }
}

async function adminToggleAgent(agent_id, actif){
  const res=await jsonp("adminToggleAgent",{ code: ADMIN.code, agent_id, actif });
  if(res && res.ok) await adminBootstrap(true);
}

async function adminDeleteAgent(agent_id){
  if(!confirm("Supprimer cet agent ?")) return;
  const res=await jsonp("adminDeleteAgent",{ code: ADMIN.code, agent_id });
  if(res && res.ok) await adminBootstrap(true);
}

let CATALOG = [];
async function adminLoadCatalog(silent){
  const res=await jsonp("adminListCatalog",{ code: ADMIN.code });
  if(!res||!res.ok) return;
  CATALOG = res.catalog||[];
  document.getElementById("adminMissionsList").innerHTML = CATALOG.map(m=>{
    const badge=m.actif?`<span class="pill ok">Actif ‚úÖ</span>`:`<span class="pill bad">Inactif ‚ùå</span>`;
    return `
      <div class="rowLine">
        <div style="min-width:0"><b>${esc(m.libelle)}</b></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
          ${badge}
          <button class="btn small" onclick="adminToggleMission('${esc(m.mission_id)}', ${m.actif? "false":"true"})">${m.actif?"D√©sactiver":"Activer"}</button>
          <button class="btn small danger" onclick="adminDeleteMission('${esc(m.mission_id)}')">Supprimer</button>
        </div>
      </div>`;
  }).join("");
}

async function adminAddMission(evt){
  clearToast("adminMissionsToast");
  const btn=document.getElementById("btnAddMission");
  const libelle=document.getElementById("newMissionLib").value.trim();
  if(!libelle){ toast("adminMissionsToast","Libell√© requis.", false); return; }
  setLoading(btn,true);
  try{
    const res=await jsonp("adminAddCatalog",{ code: ADMIN.code, libelle });
    if(!res||!res.ok){ toast("adminMissionsToast", res?.message||"Erreur", false); return; }
    toast("adminMissionsToast","Ajout√©e ‚úÖ", true);
    document.getElementById("newMissionLib").value="";
    await adminLoadCatalog(true);
  }catch(e){
    toast("adminMissionsToast","Erreur r√©seau", false);
  }finally{ setLoading(btn,false); }
}
async function adminToggleMission(mission_id, actif){
  await jsonp("adminToggleCatalog",{ code: ADMIN.code, mission_id, actif });
  await adminLoadCatalog(true);
}
async function adminDeleteMission(mission_id){
  if(!confirm("Supprimer cette mission ?")) return;
  await jsonp("adminDeleteCatalog",{ code: ADMIN.code, mission_id });
  await adminLoadCatalog(true);
}

async function adminLoadPeriod(evt){
  clearToast("adminGroupToast");
  const btn=document.getElementById("btnLoadPeriod");
  const pid=document.getElementById("periodeSel").value;
  if(!pid){ toast("adminGroupToast","Choisis une p√©riode.", false); return; }
  ADMIN.period_id = pid;
  setLoading(btn,true);
  try{
    const res=await jsonp("adminLoadPeriod",{ code: ADMIN.code, period_id: pid });
    if(!res||!res.ok){ toast("adminGroupToast", res?.message||"Erreur", false); return; }
    // groupe
    document.getElementById("groupList").innerHTML = (res.group||[]).length
      ? (res.group||[]).map(a=>`
          <div class="rowLine">
            <div><b>${esc(a.nom)}</b></div>
            <button class="btn small danger" onclick="adminRemoveFromGroup('${esc(a.agent_id)}')">Retirer</button>
          </div>`).join("")
      : `<div class="rowLine"><span class="muted">Aucun agent.</span></div>`;

    // responsable
    document.getElementById("respPill").textContent = "Responsable : " + (res.responsable?.nom || "‚Äî");

    // select responsable = group
    const rsel=document.getElementById("responsableSel");
    rsel.innerHTML = `<option value="">‚Äî Choisir ‚Äî</option>` + (res.group||[]).map(a=>`<option value="${esc(a.agent_id)}">${esc(a.nom)}</option>`).join("");

    // missions actives
    await adminLoadMonth(true);

    toast("adminGroupToast","Groupe charg√© ‚úÖ", true);
  }catch(e){
    toast("adminGroupToast","Erreur r√©seau", false);
  }finally{ setLoading(btn,false); }
}

async function adminAddToGroup(evt){
  clearToast("adminGroupToast");
  const btn=document.getElementById("btnAddToGroup");
  const pid=document.getElementById("periodeSel").value;
  const aid=document.getElementById("addToGroupSel").value;
  if(!pid||!aid){ toast("adminGroupToast","Choisis p√©riode + agent.", false); return; }
  setLoading(btn,true);
  try{
    await jsonp("adminAddToGroup",{ code: ADMIN.code, period_id: pid, agent_id: aid });
    await adminLoadPeriod({target:document.getElementById("btnLoadPeriod")});
  }finally{ setLoading(btn,false); }
}
async function adminRemoveFromGroup(aid){
  const pid=ADMIN.period_id || document.getElementById("periodeSel").value;
  await jsonp("adminRemoveFromGroup",{ code: ADMIN.code, period_id: pid, agent_id: aid });
  await adminLoadPeriod({target:document.getElementById("btnLoadPeriod")});
}
async function adminSetResp(evt){
  clearToast("adminGroupToast");
  const btn=document.getElementById("btnSetResp");
  const pid=ADMIN.period_id || document.getElementById("periodeSel").value;
  const aid=document.getElementById("responsableSel").value;
  if(!pid||!aid){ toast("adminGroupToast","Choisis un responsable.", false); return; }
  setLoading(btn,true);
  try{
    await jsonp("adminSetResponsable",{ code: ADMIN.code, period_id: pid, agent_id: aid });
    await adminLoadPeriod({target:document.getElementById("btnLoadPeriod")});
  }finally{ setLoading(btn,false); }
}

/* month missions */
async function adminLoadMonth(silent){
  const pid=ADMIN.period_id || document.getElementById("periodeSel").value;
  if(!pid) return;
  const res=await jsonp("adminGetMonthMissions",{ code: ADMIN.code, period_id: pid });
  if(!res||!res.ok) return;
  // check list
  const onSet=new Set((res.missionsOn||[]).map(x=>x.mission_id));
  document.getElementById("monthBox").innerHTML = (res.missionsAll||[]).filter(m=>m.actif).map(m=>`
    <label class="rowLine" style="cursor:pointer">
      <div style="display:flex;gap:10px;align-items:center;min-width:0">
        <input type="checkbox" data-mid="${esc(m.mission_id)}" ${onSet.has(m.mission_id)?"checked":""} />
        <b style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(m.libelle)}</b>
      </div>
    </label>`).join("");
}

async function adminSaveMonth(evt){
  clearToast("adminMonthToast");
  const btn=document.getElementById("btnSaveMonth");
  const pid=ADMIN.period_id || document.getElementById("periodeSel").value;
  if(!pid){ toast("adminMonthToast","Choisis une p√©riode.", false); return; }
  setLoading(btn,true);
  try{
    const ids = Array.from(document.querySelectorAll('#monthBox input[type="checkbox"][data-mid]'))
      .filter(x=>x.checked).map(x=>x.getAttribute("data-mid"));
    const res=await jsonp("adminSaveMonthMissions",{ code: ADMIN.code, period_id: pid, ids: JSON.stringify(ids) });
    if(!res||!res.ok){ toast("adminMonthToast", res?.message||"Erreur", false); return; }
    toast("adminMonthToast","Enregistr√© ‚úÖ", true);
  }catch(e){
    toast("adminMonthToast","Erreur r√©seau", false);
  }finally{ setLoading(btn,false); }
}

async function adminLoadRetours(evt){
  clearToast("adminRetoursToast");
  const btn=document.getElementById("btnLoadRetours");
  const pid=ADMIN.period_id || document.getElementById("periodeSel").value;
  if(!pid){ toast("adminRetoursToast","Choisis une p√©riode.", false); return; }
  setLoading(btn,true);
  try{
    const res=await jsonp("adminRetours",{ code: ADMIN.code, period_id: pid });
    if(!res||!res.ok){ toast("adminRetoursToast","Erreur", false); return; }
    const items=res.items||[];
    document.getElementById("retoursList").innerHTML = items.length
      ? items.map(it=>`
          <div class="rowLine">
            <div style="min-width:0">
              <b>${esc(it.agent)}</b>
              <div class="muted" style="font-size:13px;margin-top:2px">${esc(it.mission)}</div>
              <div class="muted" style="font-size:13px;margin-top:6px">Justif : ${esc(it.justificatif||"‚Äî")}</div>
            </div>
            <span class="pill ${it.declaration==="Non fait"?"bad":"ok"}">${esc(it.declaration)}</span>
          </div>`).join("")
      : `<div class="rowLine"><span class="muted">Aucun retour.</span></div>`;
  }catch(e){
    toast("adminRetoursToast","Erreur r√©seau", false);
  }finally{ setLoading(btn,false); }
}

/* ---------- AGENT ---------- */
function agentLogout(){
  AGENT={ ok:false, agent_id:"", nom:"", must_change:false, period_id:"" };
  document.getElementById("agentKey").style.display="none";
  document.getElementById("agentLogout").style.display="none";
  document.getElementById("agentWork").style.display="none";
  document.getElementById("agentKeyBox").style.display="none";
  document.getElementById("agentStatus").className="status";
  document.getElementById("agentStatus").textContent="Agent : non connect√©";
  clearToast("agentToast"); clearToast("agentSaveToast"); clearToast("agentChangeToast");
}

function openAgentKey(){
  const box=document.getElementById("agentKeyBox");
  box.style.display = (box.style.display==="none"||!box.style.display) ? "" : "none";
}

async function agentLogin(evt){
  clearToast("agentToast");
  const btn=document.getElementById("btnAgentLogin");
  const agent_id=document.getElementById("agentSel").value;
  const code=document.getElementById("agentCode").value.trim();
  if(!agent_id||!code) return;

  setLoading(btn,true);
  try{
    const res=await jsonp("agentLogin",{ agent_id, code });
    if(!res||!res.ok){
      document.getElementById("agentStatus").className="status bad";
      document.getElementById("agentStatus").textContent="Agent : code incorrect";
      toast("agentToast", res?.message||"Erreur", false);
      return;
    }
    AGENT.ok=true; AGENT.agent_id=res.agent.agent_id; AGENT.nom=res.agent.nom; AGENT.must_change=!!res.must_change;

    document.getElementById("agentStatus").className="status ok";
    document.getElementById("agentStatus").textContent="Agent : " + AGENT.nom;

    document.getElementById("agentKey").style.display="";
    document.getElementById("agentLogout").style.display="";

    // p√©riodes
    const per=await jsonp("agentListMyPeriodes",{ agent_id: AGENT.agent_id });
    const pSel=document.getElementById("agentPeriodSel");
    pSel.innerHTML = `<option value="">‚Äî Choisir p√©riode ‚Äî</option>` + (per.periodes||[]).map(p=>`<option value="${esc(p.period_id)}">${esc(p.libelle||p.period_id)}</option>`).join("");

    // obligatoire: ouvrir cl√© + bloquer
    if(AGENT.must_change){
      document.getElementById("agentWork").style.display="none";
      document.getElementById("agentKeyBox").style.display="";
      toast("agentToast","Changement de code obligatoire.", false);
      return;
    }

    document.getElementById("agentWork").style.display="";
    toast("agentToast","Connect√© ‚úÖ", true);

  }catch(e){
    toast("agentToast","Erreur r√©seau", false);
  }finally{ setLoading(btn,false); }
}

async function agentChangeCode(evt){
  clearToast("agentChangeToast");
  const btn=document.getElementById("btnAgentChange");
  const old_code=document.getElementById("agentOldCode").value.trim();
  const new_code=document.getElementById("agentNewCode").value.trim();
  if(!old_code||!new_code) return;
  setLoading(btn,true);
  try{
    const res=await jsonp("agentChangeCode",{ agent_id: AGENT.agent_id, old_code, new_code });
    if(!res||!res.ok){ toast("agentChangeToast", res?.message||"Erreur", false); return; }
    toast("agentChangeToast","Code chang√© ‚úÖ", true);
    AGENT.must_change=false;
    document.getElementById("agentKeyBox").style.display="none";
    document.getElementById("agentWork").style.display="";
  }catch(e){
    toast("agentChangeToast","Erreur r√©seau", false);
  }finally{ setLoading(btn,false); }
}

async function agentLoadPeriod(evt){
  clearToast("agentSaveToast");
  const btn=document.getElementById("btnAgentLoad");
  const pid=document.getElementById("agentPeriodSel").value;
  if(!pid) return;

  setLoading(btn,true);
  try{
    const res=await jsonp("agentLoadPeriod",{ agent_id: AGENT.agent_id, period_id: pid });
    if(!res||!res.ok){ toast("agentSaveToast", res?.message||"Erreur", false); return; }
    AGENT.period_id=pid;

    // remarque
    document.getElementById("agentRemark").value = res.remark || "";

    // missions accomplies
    const key="done_hide_"+AGENT.agent_id+"_"+pid;
    const hidden = localStorage.getItem(key)==="1";
    const doneWrap=document.getElementById("agentDoneWrap");
    doneWrap.style.display = (res.allDone && !hidden) ? "" : "none";

    // double click/tap => hide
    const img=document.getElementById("imgDone");
    img.ondblclick=()=>{ localStorage.setItem(key,"1"); doneWrap.style.display="none"; };
    let lastTap=0;
    img.ontouchend=()=>{ const now=Date.now(); if(now-lastTap<350){ localStorage.setItem(key,"1"); doneWrap.style.display="none"; } lastTap=now; };

    // missions list (si allDone => vide)
    const box=document.getElementById("agentMissions");
    if(res.allDone){
      box.innerHTML="";
      toast("agentSaveToast","Toutes les missions sont accomplies ‚úÖ", true);
      return;
    }

    const missions=res.missions||[];
    box.innerHTML = missions.map(m=>`
      <div class="item" data-mid="${esc(m.mission_id)}">
        <div style="min-width:0"><b>${esc(m.libelle)}</b></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
          <select class="dec">
            <option value="" ${m.declaration===""?"selected":""}>‚Äî</option>
            <option value="Fait" ${m.declaration==="Fait"?"selected":""}>Fait</option>
            <option value="Partiel" ${m.declaration==="Partiel"?"selected":""}>Partiel</option>
            <option value="Non fait" ${m.declaration==="Non fait"?"selected":""}>Non fait</option>
          </select>
          <input class="just" placeholder="Justificatif si Partiel/Non fait" value="${esc(m.justificatif||"")}" />
        </div>
      </div>
    `).join("");

    toast("agentSaveToast","Missions charg√©es ‚úÖ", true);
  }catch(e){
    toast("agentSaveToast","Erreur r√©seau", false);
  }finally{ setLoading(btn,false); }
}

async function agentSave(evt){
  clearToast("agentSaveToast");
  const btn=document.getElementById("btnAgentSave");
  if(!AGENT.period_id) return;

  setLoading(btn,true);
  try{
    const items = Array.from(document.querySelectorAll("#agentMissions .item")).map(div=>{
      const mid = div.getAttribute("data-mid");
      const dec = div.querySelector(".dec")?.value || "";
      const just = div.querySelector(".just")?.value || "";
      return { mission_id: mid, declaration: dec, justificatif: just };
    });
    const remark = document.getElementById("agentRemark").value || "";
    const res=await jsonp("agentSave",{ agent_id: AGENT.agent_id, period_id: AGENT.period_id, items: JSON.stringify(items), remark });
    if(!res||!res.ok){ toast("agentSaveToast", res?.message||"Erreur", false); return; }
    toast("agentSaveToast","Enregistrement effectu√© ‚úÖ", true);
    // reload period to possibly show done image
    await agentLoadPeriod({target:document.getElementById("btnAgentLoad")});
  }catch(e){
    toast("agentSaveToast","Erreur r√©seau", false);
  }finally{ setLoading(btn,false); }
}

/* init */
showView("agent");
</script>
</body>
</html>
