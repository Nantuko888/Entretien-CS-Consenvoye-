<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>JTUB Entretien CS</title>

<style>
:root{
  --bg:#0b0f14; --stroke:rgba(255,255,255,.12);
  --text:#e8eef9; --muted:rgba(232,238,249,.72);
  --accent:#ff7a00; --accent2:#ffb000;
  --danger:#ff3b30; --ok:#1fd36b;
  --r:18px;
  --font:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
}
*{box-sizing:border-box}
body{
  margin:0;font-family:var(--font);color:var(--text);
  background:
    radial-gradient(900px 420px at 20% 20%, rgba(255,122,0,.18), transparent 65%),
    radial-gradient(900px 420px at 80% 10%, rgba(255,176,0,.12), transparent 60%),
    linear-gradient(180deg, #06080b, var(--bg));
  min-height:100vh;
}
.wrap{max-width:1100px;margin:0 auto;padding:16px 12px 48px}
h1{margin:0;font-size:28px;font-weight:900;color:#ff8d1a;text-align:center;text-shadow:0 2px 14px rgba(255,122,0,.18);}
.subtitle{margin:6px 0 0;color:var(--muted);font-size:12px;text-align:center}
.tabsCenter{margin:14px 0 18px;display:flex;justify-content:center;}
.tabs{display:flex;gap:8px;align-items:center;border:1px solid var(--stroke);background:rgba(255,255,255,.02);padding:6px;border-radius:999px;}
.tab{border:0;background:transparent;color:var(--muted);padding:10px 14px;border-radius:999px;cursor:pointer;font-weight:900;font-size:13px;}
.tab.active{background:linear-gradient(90deg, rgba(255,122,0,.26), rgba(255,176,0,.18));color:var(--text);}
.card{border:1px solid var(--stroke);background:rgba(255,255,255,.02);border-radius:var(--r);padding:16px}
.headRow{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.h2{margin:0;font-size:15px;font-weight:900}
.status{font-size:12px;font-weight:900;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(0,0,0,.18);color:var(--muted);white-space:nowrap}
.status.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.10);color:#bdf6d2}
.status.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.10);color:#ffd0cd}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
.row>*{flex:1;min-width:220px}
label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
input,select,textarea{width:100%;padding:11px 12px;border-radius:12px;border:1px solid var(--stroke);background:rgba(0,0,0,.25);color:var(--text);outline:none;font-size:14px;}
textarea{min-height:90px}
.btn{appearance:none;border:1px solid var(--stroke);background:rgba(255,255,255,.03);color:var(--text);border-radius:999px;padding:10px 14px;cursor:pointer;font-weight:900;font-size:13px}
.btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));border-color:transparent;color:#0b0f14}
.btn.danger{background:rgba(255,59,48,.14);border-color:rgba(255,59,48,.35);color:#ffd0cd}
.btn.small{padding:8px 12px;font-size:12px}
.btn.loading,.btn.primary.loading{background:linear-gradient(90deg,var(--ok),#7dff9c)!important;color:#0b0f14!important;border-color:transparent!important;cursor:wait!important;opacity:.95}
.btn[disabled]{opacity:.65;cursor:not-allowed}
.toast{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);background:rgba(0,0,0,.18);color:var(--muted);font-size:13px;display:none}
.toast.show{display:block}
.toast.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.10);color:#c9f9db}
.toast.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.10);color:#ffd0cd}
.divider{height:1px;background:rgba(255,255,255,.09);margin:14px 0}
.list{display:grid;gap:10px;margin-top:10px}
.item{border:1px solid var(--stroke);border-radius:14px;padding:12px;background:rgba(0,0,0,.18);display:flex;justify-content:space-between;gap:10px;align-items:center}
.pill{font-size:12px;font-weight:900;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.02);color:var(--muted)}
.pill.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.10);color:#bdf6d2}
.pill.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.10);color:#ffd0cd}
.keyBtn{border:1px solid var(--stroke);background:rgba(255,255,255,.04);border-radius:999px;padding:10px 12px;cursor:pointer;font-weight:900}
.imgDone{width:100%;max-width:560px;margin:8px auto 0;display:block;border-radius:16px;border:1px solid var(--stroke)}
details{border:1px solid var(--stroke);border-radius:14px;padding:10px;background:rgba(0,0,0,.12)}
summary{cursor:pointer;font-weight:900}
@media(max-width:700px){
  .wrap{max-width:none;width:100%;padding:12px}
  .row>*{min-width:100%}
  input,select,textarea,button,.btn{min-height:44px;font-size:16px}
  h1{font-size:26px}
}
</style>
</head>

<body>
<div class="wrap">
  <h1>Entretien CS Consenvoye</h1>
  <div class="subtitle">JTUB (GitHub) ‚Ä¢ Sheets (moteur)</div>

  <div class="tabsCenter">
    <div class="tabs">
      <button class="tab active" id="tabAgent" onclick="showView('agent')">üßë‚Äçüöí Agent</button>
      <button class="tab" id="tabAdmin" onclick="showView('admin')">üõ°Ô∏è Admin</button>
    </div>
  </div>

  <!-- AGENT -->
  <div id="viewAgent" class="card">
    <div class="headRow">
      <div class="h2">Agent</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="keyBtn" id="agentKey" style="display:none" title="Changer le code" onclick="toggle('agentKeyBox')">üîë</button>
        <button class="btn danger small" id="agentLogout" style="display:none" onclick="agentLogout()">D√©connexion</button>
        <div class="status" id="agentStatus">Agent : non connect√©</div>
      </div>
    </div>

    <div class="row" id="agentLoginRow">
      <div>
        <label>Agent</label>
        <select id="agentSel"></select>
      </div>
      <div>
        <label>Code</label>
        <input id="agentCode" placeholder="Code agent"/>
      </div>
      <div>
        <button class="btn primary" id="btnAgentLogin" onclick="agentLogin(event)">Se connecter</button>
      </div>
    </div>

    <div id="agentToast" class="toast"></div>

    <div id="agentKeyBox" style="display:none;margin-top:14px">
      <div class="h2" style="margin:0 0 8px 0">Changer mon code</div>
      <div class="row">
        <div><label>Ancien code</label><input id="agentOldCode"/></div>
        <div><label>Nouveau code (min 4)</label><input id="agentNewCode"/></div>
        <div><button class="btn primary" id="btnAgentChange" onclick="agentChangeCode(event)">Valider</button></div>
      </div>
      <div id="agentChangeToast" class="toast"></div>
      <div class="divider"></div>
    </div>

    <div id="agentWork" style="display:none;margin-top:14px">
      <div class="row">
        <div><label>P√©riode</label><select id="agentPeriodSel"></select></div>
        <div><button class="btn primary" id="btnAgentLoad" onclick="agentLoadPeriod(event)">Charger</button></div>
      </div>

      <div class="divider"></div>

      <div id="agentDoneWrap" style="display:none">
        <img class="imgDone" id="imgDone" src="./missions-accomplies.jpg" alt="missions accomplies">
        <div class="muted" style="text-align:center;margin-top:6px;font-size:12px">(double-tap / double-clic pour masquer)</div>
        <div class="divider"></div>
      </div>

      <div id="agentMissions" class="list"></div>

      <div class="divider"></div>

      <label>Remarque g√©n√©rale (facultatif)</label>
      <textarea id="agentRemark" placeholder="Remarque g√©n√©rale‚Ä¶"></textarea>

      <div class="row" style="margin-top:10px">
        <div><button class="btn primary" id="btnAgentSave" onclick="agentSave(event)">Enregistrer</button></div>
      </div>
      <div id="agentSaveToast" class="toast"></div>
    </div>
  </div>

  <!-- ADMIN -->
  <div id="viewAdmin" class="card" style="display:none;margin-top:16px">
    <div class="headRow">
      <div class="h2">Admin</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="keyBtn" id="adminKey" style="display:none" title="Changer le code admin" onclick="toggle('adminKeyBox')">üîë</button>
        <button class="btn danger small" id="adminLogout" style="display:none" onclick="adminLogout()">D√©connexion</button>
        <div class="status" id="adminStatus">Admin : non connect√©</div>
      </div>
    </div>

    <div class="row" id="adminLoginRow">
      <div><label>Code admin</label><input id="adminCode"/></div>
      <div><button class="btn primary" id="btnAdminLogin" onclick="adminLogin(event)">Se connecter</button></div>
    </div>
    <div id="adminToast" class="toast"></div>

    <div id="adminKeyBox" style="display:none;margin-top:14px">
      <div class="h2" style="margin:0 0 8px 0">Changer mon code admin</div>
      <div class="row">
        <div><label>Nouveau code (min 4)</label><input id="adminNewCode"/></div>
        <div><button class="btn primary" id="btnAdminChange" onclick="adminChangeCode(event)">Valider</button></div>
      </div>
      <div id="adminChangeToast" class="toast"></div>
      <div class="divider"></div>
    </div>

    <div id="adminWork" style="display:none;margin-top:14px">
      <details>
        <summary>Avanc√©</summary>
        <div class="divider"></div>
        <button class="btn" id="btnAdminRefresh" onclick="adminRefresh(event)">Actualiser les donn√©es</button>
        <div class="divider"></div>
        <label>Reset agent (d√©pan.)</label>
        <div class="row">
          <div><select id="resetAgentSel"></select></div>
          <div><button class="btn" id="btnResetAgent" onclick="adminResetAgent(event)">Reset 0000</button></div>
        </div>
        <div id="adminAdvToast" class="toast"></div>
      </details>

      <div class="divider"></div>

      <div class="card">
        <div class="h2">Agents</div>
        <div class="row">
          <div><label>Nom</label><input id="newAgentName"/></div>
          <div><label>Code</label><input id="newAgentCode" value="0000"/></div>
          <div><button class="btn primary" id="btnAddAgent" onclick="adminAddAgent(event)">Ajouter</button></div>
        </div>
        <div id="adminAgentsToast" class="toast"></div>
        <div id="adminAgentsList" class="list"></div>
      </div>

      <div class="divider"></div>

      <div class="card">
        <div class="h2">Catalogue missions</div>
        <div class="row">
          <div><label>Libell√©</label><input id="newMissionLib"/></div>
          <div><button class="btn primary" id="btnAddMission" onclick="adminAddMission(event)">Ajouter</button></div>
        </div>
        <div id="adminMissionsToast" class="toast"></div>
        <div id="adminMissionsList" class="list"></div>
      </div>

      <div class="divider"></div>

      <div class="card">
        <div class="h2">P√©riode / Groupe / Missions actives / Retours</div>
        <div class="row">
          <div><label>P√©riode</label><select id="periodeSel"></select></div>
          <div><button class="btn primary" id="btnLoadGroup" onclick="adminLoadGroup(event)">Charger</button></div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div><label>Ajouter au groupe</label><select id="addToGroupSel"></select></div>
          <div><button class="btn primary" id="btnAddToGroup" onclick="adminAddToGroup(event)">Ajouter</button></div>
        </div>

        <div class="row" style="margin-top:10px">
          <div><label>Responsable</label><select id="responsableSel"></select></div>
          <div><button class="btn primary" id="btnSetResp" onclick="adminSetResp(event)">D√©finir</button></div>
        </div>

        <div class="divider"></div>

        <div class="h2" style="margin:0 0 8px 0">Groupe</div>
        <div id="groupList" class="list"></div>

        <div class="divider"></div>

        <div class="h2" style="margin:0 0 8px 0">Missions actives</div>
        <div id="activeBox" class="list"></div>
        <button class="btn primary" id="btnSaveActive" onclick="adminSaveActive(event)">Enregistrer missions actives</button>
        <div id="adminActiveToast" class="toast"></div>

        <div class="divider"></div>

        <div class="h2" style="margin:0 0 8px 0">Retours (Partiel / Non fait)</div>
        <button class="btn primary" id="btnLoadRetours" onclick="adminLoadRetours(event)">Charger retours</button>
        <div id="retoursList" class="scrollBox" style="margin-top:10px"></div>
        <div id="adminRetoursToast" class="toast"></div>
      </div>

    </div>
  </div>

</div>

<script>
/* ‚úÖ Mets ici ton URL /exec Apps Script */
const API_EXEC = "https://script.google.com/macros/s/AKfycbwTo8mKf9yDCmFDZbT03-nbxv5QVLcMjNEGuvlL25alCktBLX9P-G3i4NTVMw048DE/exec";

/* ---------- helpers ---------- */
function esc(s){return String(s??"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
function toggle(id){ const el=document.getElementById(id); el.style.display = (el.style.display==="none"||!el.style.display) ? "" : "none"; }
function setLoading(btn,on){ if(!btn) return; btn.classList.toggle("loading",!!on); btn.disabled=!!on; }
function toast(id,msg,ok){ const el=document.getElementById(id); if(!el) return; el.className="toast show "+(ok?"ok":"bad"); el.textContent=msg||""; }
function clearToast(id){ const el=document.getElementById(id); if(!el) return; el.className="toast"; el.textContent=""; }
function showView(v){
  document.getElementById("tabAgent").classList.toggle("active",v==="agent");
  document.getElementById("tabAdmin").classList.toggle("active",v==="admin");
  document.getElementById("viewAgent").style.display = (v==="agent") ? "" : "none";
  document.getElementById("viewAdmin").style.display = (v==="admin") ? "" : "none";
}

/* JSONP */
function jsonp(action, params){
  return new Promise((resolve,reject)=>{
    const cb="cb_"+action+"_"+Date.now()+"_"+Math.random().toString(16).slice(2);
    window[cb]=(data)=>{cleanup();resolve(data);};
    const cleanup=()=>{try{delete window[cb];}catch(_){}
      if(s&&s.parentNode)s.parentNode.removeChild(s);
    };
    const q=new URLSearchParams({action,callback:cb,...params});
    const s=document.createElement("script");
    s.src=API_EXEC+"?"+q.toString()+"&_="+Date.now();
    s.onerror=()=>{cleanup();reject(new Error("load_error"));};
    document.head.appendChild(s);
  });
}

/* ---------- state ---------- */
let admin = { ok:false, token:"", bootstrap:null, period_id:"" };
let agent = { ok:false, token:"", agent_id:"", nom:"", must_change:false, period_id:"" };

/* ---------- init ---------- */
(async function(){
  await loadAgentsPublic();
})();

async function loadAgentsPublic(){
  const sel=document.getElementById("agentSel");
  sel.innerHTML=`<option value="">‚Äî Chargement‚Ä¶ ‚Äî</option>`;
  try{
    const res=await jsonp("listAgentsPublic",{});
    if(!res||!res.ok) throw 0;
    sel.innerHTML=`<option value="">‚Äî Choisir agent ‚Äî</option>` + (res.agents||[]).map(a=>`<option value="${esc(a.agent_id)}">${esc(a.nom)}</option>`).join("");
  }catch(e){
    sel.innerHTML=`<option value="">‚Äî Erreur ‚Äî</option>`;
  }
}

/* ---------- AGENT ---------- */
function agentUi(on){
  document.getElementById("agentKey").style.display=on?"":"none";
  document.getElementById("agentLogout").style.display=on?"":"none";
  document.getElementById("agentWork").style.display=on?"":"none";
}

async function agentLogin(ev){
  clearToast("agentToast");
  const btn=document.getElementById("btnAgentLogin");
  const agent_id=document.getElementById("agentSel").value;
  const code=document.getElementById("agentCode").value.trim();
  if(!agent_id||!code) return;

  setLoading(btn,true);
  try{
    const res=await jsonp("agentLogin",{ agent_id, code });
    if(!res||!res.ok){
      document.getElementById("agentStatus").className="status bad";
      document.getElementById("agentStatus").textContent="Agent : non connect√©";
      toast("agentToast", res?.message||"Code incorrect", false);
      return;
    }
    agent.ok=true;
    agent.token=res.token;
    agent.agent_id=agent_id;
    agent.nom=res.agent?.nom||"";
    agent.must_change=!!res.must_change;

    document.getElementById("agentStatus").className="status ok";
    document.getElementById("agentStatus").textContent="Agent : connect√©";
    agentUi(true);

    // p√©riodes
    const per=await jsonp("agentListPeriodes",{ token: agent.token });
    const pSel=document.getElementById("agentPeriodSel");
    pSel.innerHTML = `<option value="">‚Äî Choisir p√©riode ‚Äî</option>` + (per.periodes||[]).map(p=>`<option value="${esc(p.period_id)}">${esc(p.libelle||p.period_id)}</option>`).join("");

    // must change => open key box and block work
    if(agent.must_change){
      document.getElementById("agentKeyBox").style.display="";
      document.getElementById("agentWork").style.display="none";
      toast("agentToast","Changement de code obligatoire.", false);
      return;
    }

    toast("agentToast","Connect√© ‚úÖ", true);
  }catch(e){
    toast("agentToast","Erreur r√©seau", false);
  }finally{ setLoading(btn,false); }
}

function agentLogout(){
  if(agent.token){ jsonp("agentLogout",{ token: agent.token }).catch(()=>{}); }
  agent={ ok:false, token:"", agent_id:"", nom:"", must_change:false, period_id:"" };
  agentUi(false);
  document.getElementById("agentKeyBox").style.display="none";
  document.getElementById("agentStatus").className="status";
  document.getElementById("agentStatus").textContent="Agent : non connect√©";
  document.getElementById("agentMissions").innerHTML="";
  document.getElementById("agentRemark").value="";
  document.getElementById("agentDoneWrap").style.display="none";
  clearToast("agentToast"); clearToast("agentSaveToast"); clearToast("agentChangeToast");
}

async function agentChangeCode(ev){
  clearToast("agentChangeToast");
  const btn=document.getElementById("btnAgentChange");
  const old_code=document.getElementById("agentOldCode").value.trim();
  const new_code=document.getElementById("agentNewCode").value.trim();
  if(!old_code||!new_code) return;

  setLoading(btn,true);
  try{
    const res=await jsonp("agentChangeMyCode",{ token: agent.token, old_code, new_code });
    if(!res||!res.ok){
      toast("agentChangeToast", res?.message||"Erreur", false);
      return;
    }
    toast("agentChangeToast","Code chang√© ‚úÖ", true);
    agent.must_change=false;
    document.getElementById("agentKeyBox").style.display="none";
    document.getElementById("agentWork").style.display="";
  }catch(e){
    toast("agentChangeToast","Erreur r√©seau", false);
  }finally{ setLoading(btn,false); }
}

async function agentLoadPeriod(ev){
  clearToast("agentSaveToast");
  const btn=document.getElementById("btnAgentLoad");
  const pid=document.getElementById("agentPeriodSel").value;
  if(!pid) return;
  agent.period_id=pid;

  setLoading(btn,true);
  try{
    const res=await jsonp("agentLoadPeriod",{ token: agent.token, period_id: pid });
    if(!res||!res.ok){ toast("agentSaveToast", res?.message||"Erreur", false); return; }

    document.getElementById("agentRemark").value = res.remark || "";

    // done image
    const doneWrap=document.getElementById("agentDoneWrap");
    const key="hide_done_"+agent.agent_id+"_"+pid;
    const hidden = localStorage.getItem(key)==="1";
    doneWrap.style.display = (res.allDone && !hidden) ? "" : "none";

    const img=document.getElementById("imgDone");
    img.ondblclick=()=>{ localStorage.setItem(key,"1"); doneWrap.style.display="none"; };
    let lastTap=0;
    img.ontouchend=()=>{ const now=Date.now(); if(now-lastTap<350){ localStorage.setItem(key,"1"); doneWrap.style.display="none"; } lastTap=now; };

    // missions list
    const box=document.getElementById("agentMissions");
    if(res.allDone){
      box.innerHTML="";
      toast("agentSaveToast","Toutes les missions sont accomplies ‚úÖ", true);
      return;
    }

    box.innerHTML=(res.missions||[]).map(m=>`
      <div class="item" data-mid="${esc(m.mission_id)}">
        <div style="min-width:0"><b>${esc(m.libelle)}</b></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
          <select class="dec">
            <option value="" ${m.declaration===""?"selected":""}>‚Äî</option>
            <option value="Fait" ${m.declaration==="Fait"?"selected":""}>Fait</option>
            <option value="Partiel" ${m.declaration==="Partiel"?"selected":""}>Partiel</option>
            <option value="Non fait" ${m.declaration==="Non fait"?"selected":""}>Non fait</option>
          </select>
          <input class="just" placeholder="Justificatif si Partiel/Non fait" value="${esc(m.justificatif||"")}" />
        </div>
      </div>
    `).join("");

    toast("agentSaveToast","Missions charg√©es ‚úÖ", true);
  }catch(e){
    toast("agentSaveToast","Erreur r√©seau", false);
  }finally{ setLoading(btn,false); }
}

async function agentSave(ev){
  clearToast("agentSaveToast");
  const btn=document.getElementById("btnAgentSave");
  if(!agent.period_id) return;

  setLoading(btn,true);
  try{
    const items = Array.from(document.querySelectorAll("#agentMissions .item")).map(div=>{
      const mid=div.getAttribute("data-mid");
      const dec=div.querySelector(".dec")?.value||"";
      const just=div.querySelector(".just")?.value||"";
      return { mission_id: mid, declaration: dec, justificatif: just };
    });
    const remark=document.getElementById("agentRemark").value||"";
    const res=await jsonp("agentSave",{ token: agent.token, period_id: agent.period_id, items: JSON.stringify(items), remark });
    if(!res||!res.ok){ toast("agentSaveToast", res?.message||"Erreur", false); return; }
    toast("agentSaveToast","Enregistrement effectu√© ‚úÖ", true);
    await agentLoadPeriod({target:document.getElementById("btnAgentLoad")});
  }catch(e){
    toast("agentSaveToast","Erreur r√©seau", false);
  }finally{ setLoading(btn,false); }
}

/* ---------- ADMIN ---------- */
function adminUi(on){
  document.getElementById("adminKey").style.display=on?"":"none";
  document.getElementById("adminLogout").style.display=on?"":"none";
  document.getElementById("adminWork").style.display=on?"":"none";
}

async function adminLogin(ev){
  clearToast("adminToast");
  const btn=document.getElementById("btnAdminLogin");
  const code=document.getElementById("adminCode").value.trim();
  if(!code) return;

  setLoading(btn,true);
  try{
    const res=await jsonp("adminLogin",{ code });
    if(!res||!res.ok){
      document.getElementById("adminStatus").className="status bad";
      document.getElementById("adminStatus").textContent="Admin : non connect√©";
      toast("adminToast","Code incorrect", false);
      adminUi(false);
      admin={ok:false,token:"",bootstrap:null,period_id:""};
      return;
    }
    admin.ok=true;
    admin.token=res.token;
    document.getElementById("adminStatus").className="status ok";
    document.getElementById("adminStatus").textContent="Admin : connect√©";
    toast("adminToast","Connect√© ‚úÖ", true);
    adminUi(true);
    await adminBootstrap();
  }catch(e){
    toast("adminToast","Erreur r√©seau", false);
  }finally{ setLoading(btn,false); }
}

function adminLogout(){
  if(admin.token){ jsonp("adminLogout",{ token: admin.token }).catch(()=>{}); }
  admin={ok:false,token:"",bootstrap:null,period_id:""};
  adminUi(false);
  document.getElementById("adminStatus").className="status";
  document.getElementById("adminStatus").textContent="Admin : non connect√©";
  clearToast("adminToast"); clearToast("adminAgentsToast"); clearToast("adminMissionsToast");
  clearToast("adminActiveToast"); clearToast("adminRetoursToast"); clearToast("adminAdvToast");
}

async function adminChangeCode(ev){
  clearToast("adminChangeToast");
  const btn=document.getElementById("btnAdminChange");
  const new_code=document.getElementById("adminNewCode").value.trim();
  if(new_code.length<4){ toast("adminChangeToast","Code trop court (min 4).", false); return; }
  setLoading(btn,true);
  try{
    const res=await jsonp("adminChangeMyCode",{ token: admin.token, new_code });
    if(!res||!res.ok){ toast("adminChangeToast", res?.message||"Erreur", false); return; }
    toast("adminChangeToast","OK ‚úÖ", true);
  }catch(e){
    toast("adminChangeToast","Erreur r√©seau", false);
  }finally{ setLoading(btn,false); }
}

async function adminRefresh(ev){
  const btn=document.getElementById("btnAdminRefresh");
  setLoading(btn,true);
  try{ await adminBootstrap(true); toast("adminAdvToast","Actualis√© ‚úÖ", true); }
  catch(e){ toast("adminAdvToast","Erreur", false); }
  finally{ setLoading(btn,false); }
}

async function adminBootstrap(silent){
  const res=await jsonp("adminBootstrap",{ token: admin.token });
  if(!res||!res.ok) throw 0;
  admin.bootstrap=res;

  // selects
  const pSel=document.getElementById("periodeSel");
  pSel.innerHTML = `<option value="">‚Äî Choisir p√©riode ‚Äî</option>` + (res.periodes||[]).map(p=>`<option value="${esc(p.period_id)}">${esc(p.libelle||p.period_id)}</option>`).join("");

  const addSel=document.getElementById("addToGroupSel");
  const agentsOpt = (res.agents||[]).map(a=>`<option value="${esc(a.agent_id)}">${esc(a.nom)}</option>`).join("");
  addSel.innerHTML = `<option value="">‚Äî Choisir agent ‚Äî</option>` + agentsOpt;

  document.getElementById("resetAgentSel").innerHTML = `<option value="">‚Äî Choisir agent ‚Äî</option>` + agentsOpt;

  await adminLoadAgents(true);
  await adminLoadCatalog(true);

  if(!silent) toast("adminToast","Donn√©es charg√©es ‚úÖ", true);
}

async function adminLoadAgents(silent){
  const res=await jsonp("adminListAgents",{ token: admin.token });
  if(!res||!res.ok) return;
  const list=res.agents||[];
  document.getElementById("adminAgentsList").innerHTML = list.map(a=>{
    const badge=a.actif?`<span class="pill ok">Actif ‚úÖ</span>`:`<span class="pill bad">Inactif ‚ùå</span>`;
    return `
      <div class="item">
        <div style="min-width:0"><b>${esc(a.nom)}</b></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
          ${badge}
          <button class="btn small" onclick="adminToggleAgent('${esc(a.agent_id)}',${a.actif?'false':'true'})">${a.actif?'D√©sactiver':'Activer'}</button>
          <button class="btn small danger" onclick="adminDeleteAgent('${esc(a.agent_id)}')">Supprimer</button>
        </div>
      </div>`;
  }).join("");
}

async function adminAddAgent(ev){
  clearToast("adminAgentsToast");
  const btn=document.getElementById("btnAddAgent");
  const nom=document.getElementById("newAgentName").value.trim();
  const code=document.getElementById("newAgentCode").value.trim()||"0000";
  if(!nom){ toast("adminAgentsToast","Nom requis.", false); return; }
  setLoading(btn,true);
  try{
    const res=await jsonp("adminAddAgent",{ token: admin.token, nom, code });
    if(!res||!res.ok){ toast("adminAgentsToast", res?.message||"Erreur", false); return; }
    toast("adminAgentsToast","Ajout√© ‚úÖ", true);
    document.getElementById("newAgentName").value="";
    document.getElementById("newAgentCode").value="0000";
    await adminBootstrap(true);
  }catch(e){
    toast("adminAgentsToast","Erreur r√©seau", false);
  }finally{ setLoading(btn,false); }
}

async function adminToggleAgent(agent_id, actif){
  await jsonp("adminToggleAgent",{ token: admin.token, agent_id, actif });
  await adminBootstrap(true);
}
async function adminDeleteAgent(agent_id){
  if(!confirm("Supprimer cet agent ?")) return;
  await jsonp("adminDeleteAgent",{ token: admin.token, agent_id });
  await adminBootstrap(true);
}
async function adminResetAgent(ev){
  clearToast("adminAdvToast");
  const btn=document.getElementById("btnResetAgent");
  const agent_id=document.getElementById("resetAgentSel").value;
  if(!agent_id){ toast("adminAdvToast","Choisis un agent.", false); return; }
  setLoading(btn,true);
  try{
    const res=await jsonp("adminResetAgent",{ token: admin.token, agent_id });
    if(!res||!res.ok){ toast("adminAdvToast","Erreur", false); return; }
    toast("adminAdvToast","Reset ‚úÖ", true);
  }catch(e){
    toast("adminAdvToast","Erreur r√©seau", false);
  }finally{ setLoading(btn,false); }
}

async function adminLoadCatalog(silent){
  const res=await jsonp("adminListCatalog",{ token: admin.token });
  if(!res||!res.ok) return;
  const list=res.catalog||[];
  document.getElementById("adminMissionsList").innerHTML = list.map(m=>{
    const badge=m.actif?`<span class="pill ok">Actif ‚úÖ</span>`:`<span class="pill bad">Inactif ‚ùå</span>`;
    return `
      <div class="item">
        <div style="min-width:0"><b>${esc(m.libelle)}</b></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
          ${badge}
          <button class="btn small" onclick="adminToggleMission('${esc(m.mission_id)}',${m.actif?'false':'true'})">${m.actif?'D√©sactiver':'Activer'}</button>
          <button class="btn small danger" onclick="adminDeleteMission('${esc(m.mission_id)}')">Supprimer</button>
        </div>
      </div>`;
  }).join("");
}

async function adminAddMission(ev){
  clearToast("adminMissionsToast");
  const btn=document.getElementById("btnAddMission");
  const libelle=document.getElementById("newMissionLib").value.trim();
  if(!libelle){ toast("adminMissionsToast","Libell√© requis.", false); return; }
  setLoading(btn,true);
  try{
    const res=await jsonp("adminAddCatalog",{ token: admin.token, libelle });
    if(!res||!res.ok){ toast("adminMissionsToast", res?.message||"Erreur", false); return; }
    toast("adminMissionsToast","Ajout√©e ‚úÖ", true);
    document.getElementById("newMissionLib").value="";
    await adminLoadCatalog(true);
  }catch(e){
    toast("adminMissionsToast","Erreur r√©seau", false);
  }finally{ setLoading(btn,false); }
}
async function adminToggleMission(mission_id, actif){
  await jsonp("adminToggleCatalog",{ token: admin.token, mission_id, actif });
  await adminLoadCatalog(true);
}
async function adminDeleteMission(mission_id){
  if(!confirm("Supprimer cette mission ?")) return;
  await jsonp("adminDeleteCatalog",{ token: admin.token, mission_id });
  await adminLoadCatalog(true);
}

async function adminLoadGroup(ev){
  const btn=document.getElementById("btnLoadGroup");
  const pid=document.getElementById("periodeSel").value;
  if(!pid) return;
  admin.period_id=pid;
  setLoading(btn,true);
  try{
    const res=await jsonp("adminLoadGroup",{ token: admin.token, period_id: pid });
    if(!res||!res.ok) return;

    // group list
    document.getElementById("groupList").innerHTML = (res.group||[]).length
      ? (res.group||[]).map(a=>`
        <div class="item">
          <div style="min-width:0"><b>${esc(a.nom)}</b></div>
          <button class="btn small danger" onclick="adminRemoveFromGroup('${esc(a.agent_id)}')">Retirer</button>
        </div>`).join("")
      : `<div class="toast show">Aucun agent.</div>`;

    // responsable select = group
    const rsel=document.getElementById("responsableSel");
    rsel.innerHTML = `<option value="">‚Äî Choisir ‚Äî</option>` + (res.group||[]).map(a=>`<option value="${esc(a.agent_id)}">${esc(a.nom)}</option>`).join("");

    // load active missions + retours
    await adminLoadActive(true);
    await adminLoadRetours(true);
  }finally{ setLoading(btn,false); }
}

async function adminAddToGroup(ev){
  const btn=document.getElementById("btnAddToGroup");
  const pid=admin.period_id || document.getElementById("periodeSel").value;
  const aid=document.getElementById("addToGroupSel").value;
  if(!pid||!aid) return;
  setLoading(btn,true);
  try{
    await jsonp("adminAddToGroup",{ token: admin.token, period_id: pid, agent_id: aid });
    await adminLoadGroup({target:document.getElementById("btnLoadGroup")});
  }finally{ setLoading(btn,false); }
}
async function adminRemoveFromGroup(aid){
  const pid=admin.period_id || document.getElementById("periodeSel").value;
  await jsonp("adminRemoveFromGroup",{ token: admin.token, period_id: pid, agent_id: aid });
  await adminLoadGroup({target:document.getElementById("btnLoadGroup")});
}
async function adminSetResp(ev){
  const btn=document.getElementById("btnSetResp");
  const pid=admin.period_id || document.getElementById("periodeSel").value;
  const aid=document.getElementById("responsableSel").value;
  if(!pid||!aid) return;
  setLoading(btn,true);
  try{
    await jsonp("adminSetResponsable",{ token: admin.token, period_id: pid, agent_id: aid });
    await adminLoadGroup({target:document.getElementById("btnLoadGroup")});
  }finally{ setLoading(btn,false); }
}

async function adminLoadActive(silent){
  const pid=admin.period_id || document.getElementById("periodeSel").value;
  const res=await jsonp("adminGetActiveMissions",{ token: admin.token, period_id: pid });
  if(!res||!res.ok) return;
  const onSet=new Set((res.on||[]).map(x=>x.mission_id));
  document.getElementById("activeBox").innerHTML = (res.all||[]).filter(m=>m.actif).map(m=>`
    <div class="item">
      <div style="min-width:0"><b>${esc(m.libelle)}</b></div>
      <input type="checkbox" data-mid="${esc(m.mission_id)}" ${onSet.has(m.mission_id)?"checked":""}/>
    </div>`).join("");
}

async function adminSaveActive(ev){
  clearToast("adminActiveToast");
  const btn=document.getElementById("btnSaveActive");
  const pid=admin.period_id || document.getElementById("periodeSel").value;
  setLoading(btn,true);
  try{
    const ids = Array.from(document.querySelectorAll('#activeBox input[type="checkbox"][data-mid]'))
      .filter(x=>x.checked).map(x=>x.getAttribute("data-mid"));
    const res=await jsonp("adminSaveActiveMissions",{ token: admin.token, period_id: pid, ids: JSON.stringify(ids) });
    if(!res||!res.ok){ toast("adminActiveToast","Erreur", false); return; }
    toast("adminActiveToast","Enregistr√© ‚úÖ", true);
  }catch(e){
    toast("adminActiveToast","Erreur r√©seau", false);
  }finally{ setLoading(btn,false); }
}

async function adminLoadRetours(silent){
  const pid=admin.period_id || document.getElementById("periodeSel").value;
  const res=await jsonp("adminRetours",{ token: admin.token, period_id: pid });
  if(!res||!res.ok) return;
  const items=res.items||[];
  document.getElementById("retoursList").innerHTML = items.length
    ? items.map(it=>`
      <div class="rowLine">
        <div style="min-width:0">
          <b>${esc(it.agent)}</b>
          <div class="muted" style="font-size:13px;margin-top:2px">${esc(it.mission)}</div>
          <div class="muted" style="font-size:13px;margin-top:6px">Justif : ${esc(it.justificatif||"‚Äî")}</div>
        </div>
        <span class="pill ${it.declaration==="Non fait"?"bad":"ok"}">${esc(it.declaration)}</span>
      </div>`).join("")
    : `<div class="rowLine"><span class="muted">Aucun retour.</span></div>`;
}

showView("agent");
  // === rendre les fonctions accessibles aux boutons HTML ===
window.agentLogin = agentLogin;
window.agentLogout = agentLogout;
window.agentLoadPeriod = agentLoadPeriod;
window.agentSave = agentSave;
window.agentChangePassword = agentChangePassword;

window.adminLogin = adminLogin;
window.adminLogout = adminLogout;
window.adminChangePassword = adminChangePassword;
window.adminLoad = adminLoad;
window.adminAddAgent = adminAddAgent;
window.adminRemoveAgent = adminRemoveAgent;
window.adminAddMission = adminAddMission;
window.adminToggleMission = adminToggleMission;
</script>
</body>
</html>
