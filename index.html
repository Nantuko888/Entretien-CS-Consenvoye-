<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Entretien du centre de secours de Consenvoye</title>

  <!-- anti-cache (utile sur smartphone) -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    :root{
      --bg0:#070a0f; --bg1:#0b111b;
      --card:rgba(18,26,42,.65);
      --line:rgba(255,255,255,.12);
      --text:#eaf0fb; --muted:#aab6cc;
      --red:#ff3b30; --amber:#ffb020; --green:#2ecc71; --blue:#3aa0ff;
      --shadow:0 18px 50px rgba(0,0,0,.45);
      --r:18px;
      --r2:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 700px at 15% -10%, rgba(255,59,48,.22), transparent 60%),
        radial-gradient(900px 600px at 105% 10%, rgba(255,176,32,.14), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 45%, var(--bg0));
      overflow-x:hidden;
    }
    .wrap{max-width:1180px;margin:0 auto;padding:16px 12px 28px}
    .card{
      border:1px solid var(--line);
      border-radius:var(--r);
      background:var(--card);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .brand{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
    }
    .titleBox{display:flex;align-items:center;gap:12px;min-width:260px}
    .mark{
      width:54px;height:54px;border-radius:16px;border:1px solid rgba(255,255,255,.18);
      background:linear-gradient(135deg, rgba(255,59,48,.95), rgba(255,176,32,.65));
      display:grid;place-items:center; flex:0 0 auto;
    }
    h1{margin:0;font-size:20px;line-height:1.1}
    .sub{margin-top:6px;color:var(--muted);font-size:12px}
    .topRight{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      color:var(--muted);
      font-size:12px;font-weight:850;white-space:nowrap;
    }
    .pill.ok{color:#dff7ea;background:rgba(46,204,113,.10);border-color:rgba(46,204,113,.25)}
    .pill.bad{color:#ffd6da;background:rgba(255,59,48,.10);border-color:rgba(255,59,48,.25)}
    .pill.warn{color:#ffe9c7;background:rgba(255,176,32,.10);border-color:rgba(255,176,32,.25)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:720px){.grid2{grid-template-columns:1fr}}
    label{display:block;color:var(--muted);font-size:12px;margin:0 0 6px}
    select,input,textarea,button{
      width:100%;
      border-radius:var(--r2);
      border:1px solid var(--line);
      padding:12px;
      background:rgba(15,23,36,.75);
      color:var(--text);
      font-size:16px;
      outline:none;
    }
    textarea{min-height:90px;resize:vertical}
    .tabs{display:flex;gap:10px;margin-top:12px}
    .tab{
      flex:1;cursor:pointer;user-select:none;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      padding:12px 10px;border-radius:var(--r2);
      font-weight:950;text-align:center;
    }
    .tab.active{
      border-color:rgba(255,59,48,.55);
      background:linear-gradient(135deg, rgba(255,59,48,.18), rgba(255,176,32,.08));
    }
    .content{display:none;margin-top:12px}
    .content.active{display:block}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      border:none;
      background:linear-gradient(135deg, rgba(255,59,48,.95), rgba(255,59,48,.70));
      font-weight:950;cursor:pointer;
    }
    .btn2{
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      font-weight:900;cursor:pointer;
    }
    .btnBlue{
      border:none;
      background:linear-gradient(135deg, rgba(58,160,255,.95), rgba(58,160,255,.65));
      font-weight:950;cursor:pointer;
    }
    .btnGreen{
      border:none;
      background:linear-gradient(135deg, rgba(46,204,113,.95), rgba(46,204,113,.65));
      font-weight:950;cursor:pointer;
    }
    .hint{color:rgba(255,255,255,.55);font-size:12px;line-height:1.35;margin-top:10px}
    .hr{height:1px;background:rgba(255,255,255,.10);margin:12px 0}

    .list{margin:10px 0 0;padding:0;list-style:none;display:flex;flex-direction:column;gap:10px}
    .item{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      border-radius:var(--r2);
      padding:10px;
    }
    .itemTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap}
    .name{font-weight:950}
    .meta{color:var(--muted);font-size:12px;margin-top:4px}
    .tri{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;align-items:center}
    .tri label{
      display:inline-flex;gap:6px;align-items:center;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      cursor:pointer;user-select:none;
      font-size:13px;font-weight:900;margin:0;
    }
    .tri input{width:16px;height:16px;accent-color:var(--red)}
    .fait{border-color:rgba(46,204,113,.25);background:rgba(46,204,113,.08)}
    .partiel{border-color:rgba(255,176,32,.25);background:rgba(255,176,32,.08)}
    .nonfait{border-color:rgba(255,59,48,.25);background:rgba(255,59,48,.08)}
    .badge{padding:4px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px;font-weight:950}
    .b-fait{border-color:rgba(46,204,113,.35);background:rgba(46,204,113,.12)}
    .b-partiel{border-color:rgba(255,176,32,.35);background:rgba(255,176,32,.12)}
    .b-nonfait{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.12)}
    .b-none{border-color:rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:rgba(255,255,255,.75)}
    .twoCols{display:grid;grid-template-columns:1.2fr .8fr;gap:10px}
    @media(max-width:920px){.twoCols{grid-template-columns:1fr}}
    .panel{border:1px solid var(--line);border-radius:var(--r2);background:rgba(255,255,255,.04);padding:10px}

    .tableWrap{overflow:auto;border-radius:var(--r2);border:1px solid rgba(255,255,255,.10)}
    table{border-collapse:collapse;min-width:900px;width:100%;background:rgba(10,16,26,.45)}
    th,td{border-bottom:1px solid rgba(255,255,255,.10);padding:10px;text-align:left;vertical-align:top}
    th{position:sticky;top:0;background:rgba(12,18,30,.95);z-index:2}
    td small{color:var(--muted)}
    .kpiRow{display:flex;gap:10px;flex-wrap:wrap}
    .kpi{flex:1 1 180px;border:1px solid var(--line);border-radius:var(--r2);background:rgba(255,255,255,.04);padding:10px}
    .kpi b{font-size:18px}
    .danger{color:#ffd6da}
    .ok{color:#dff7ea}

    .toast{
      position:fixed; left:12px; right:12px; bottom:12px;
      display:none; max-width:820px; margin:0 auto;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(12,18,30,.92);
      border-radius:14px;
      padding:12px;
      box-shadow:0 20px 60px rgba(0,0,0,.55);
    }
    .toast.show{display:block}
    .toast .t{font-weight:950}
    .toast .m{color:rgba(255,255,255,.72);font-size:12px;margin-top:4px}
    .right{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}
    .smallBtn{width:auto;padding:10px 12px}
  </style>
</head>

<body>
<div class="wrap">

  <!-- HEADER -->
  <div class="card">
    <div class="brand">
      <div class="titleBox">
        <div class="mark" aria-hidden="true">
          <svg width="30" height="30" viewBox="0 0 24 24" fill="none">
            <path d="M7 13.5V10.8C7 7.6 9.3 5 12 5s5 2.6 5 5.8v2.7" stroke="white" stroke-width="2" stroke-linecap="round"/>
            <path d="M6 14.5c0-1.1.9-2 2-2h8c1.1 0 2 .9 2 2V18c0 .6-.4 1-1 1H7c-.6 0-1-.4-1-1v-3.5Z" stroke="white" stroke-width="2" stroke-linejoin="round"/>
          </svg>
        </div>
        <div>
          <h1>Entretien du centre de secours de Consenvoye</h1>
          <div class="sub">Mode local (sans serveur) ‚Ä¢ Admin : suivi + justification obligatoire si non fait</div>
        </div>
      </div>

      <div class="topRight">
        <span class="pill" id="pillPeriod">P√©riode : ‚Äî</span>
        <span class="pill" id="pillSession">Non connect√©</span>
      </div>
    </div>

    <div class="hr"></div>

    <div class="grid2">
      <div>
        <label>Mois</label>
        <select id="selMois"></select>
      </div>
      <div>
        <label>Ann√©e</label>
        <select id="selAnnee"></select>
      </div>
    </div>

    <div class="hint">
      GitHub Pages met √† jour l‚Äôinterface pour tout le monde. Les donn√©es (cases coch√©es) sont stock√©es sur l‚Äôappareil.
      Pour transf√©rer (t√©l√©phone ‚Üí PC), utilise <b>Exporter / Importer</b> dans l‚ÄôAdmin.
    </div>
  </div>

  <!-- TABS -->
  <div class="card" style="margin-top:12px">
    <div class="tabs">
      <div class="tab active" id="tabAgent">üë®‚Äçüöí Agent</div>
      <div class="tab" id="tabAdmin">üõ°Ô∏è Administrateur</div>
    </div>

    <!-- AGENT -->
    <div class="content active" id="viewAgent">
      <div class="twoCols">
        <div class="panel">
          <div class="grid2">
            <div>
              <label>Nom</label>
              <select id="agentNom"></select>
            </div>
            <div>
              <label>Code</label>
              <input id="agentCode" type="password" inputmode="numeric" placeholder="0000"/>
            </div>
          </div>

          <div class="btnRow" style="margin-top:10px">
            <button class="btn" id="btnAgentLogin">Se connecter</button>
            <button class="btn2" id="btnAgentLogout">D√©connexion</button>
          </div>

          <div class="hint">
            L‚Äôagent voit uniquement ses missions sur la p√©riode choisie (mois/ann√©e).
            Si une mission est <b>Non fait</b>, la justification est <b>obligatoire</b>.
          </div>
        </div>

        <div class="panel">
          <div class="kpiRow">
            <div class="kpi"><div class="meta">Missions</div><b id="kpiCount">‚Äî</b></div>
            <div class="kpi"><div class="meta">Fait</div><b id="kpiFait" class="ok">‚Äî</b></div>
            <div class="kpi"><div class="meta">Non fait</div><b id="kpiNon" class="danger">‚Äî</b></div>
          </div>
          <div class="hint">Ces compteurs sont calcul√©s sur la p√©riode choisie.</div>
        </div>
      </div>

      <ul class="list" id="agentMissions"></ul>
    </div>

    <!-- ADMIN -->
    <div class="content" id="viewAdmin">
      <div class="twoCols">
        <div class="panel">
          <div class="grid2">
            <div>
              <label>Compte admin</label>
              <select id="adminNom"></select>
            </div>
            <div>
              <label>Code admin</label>
              <input id="adminCode" type="password" inputmode="numeric" placeholder="0000"/>
            </div>
          </div>

          <div class="btnRow" style="margin-top:10px">
            <button class="btn" id="btnAdminLogin">Se connecter</button>
            <button class="btn2" id="btnAdminLogout">D√©connexion</button>
          </div>

          <div class="hint">
            L‚Äôadmin g√®re : agents, missions, affectations et voit les retours (fait/partiel/non fait + justification).
          </div>

          <div class="hr"></div>

          <div class="btnRow">
            <button class="btnBlue" id="btnExport">Exporter donn√©es (JSON)</button>
            <button class="btnGreen" id="btnImport">Importer donn√©es (JSON)</button>
            <input type="file" id="importFile" accept="application/json" style="display:none"/>
          </div>
          <div class="hint">
            Export/Import sert √† transf√©rer les retours entre appareils (t√©l√©phone ‚Üî PC) sans serveur.
          </div>
        </div>

        <div class="panel">
          <div class="kpiRow">
            <div class="kpi"><div class="meta">Agents actifs</div><b id="kpiAgents">‚Äî</b></div>
            <div class="kpi"><div class="meta">Missions p√©riode</div><b id="kpiMissionsP">‚Äî</b></div>
            <div class="kpi"><div class="meta">Retours re√ßus</div><b id="kpiRetours">‚Äî</b></div>
          </div>
          <div class="hint">Vue globale (p√©riode s√©lectionn√©e).</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="twoCols">
        <!-- Admin config -->
        <div class="panel">
          <div class="name">‚öôÔ∏è Configuration</div>
          <div class="meta">Agents ‚Ä¢ Missions ‚Ä¢ Affectations pour la p√©riode</div>

          <div class="hr"></div>

          <div class="name">Agents</div>
          <div class="grid2" style="margin-top:10px">
            <div>
              <label>Nom agent</label>
              <input id="newAgentName" placeholder="Ex : DUPONT Jean"/>
            </div>
            <div>
              <label>R√¥le</label>
              <select id="newAgentRole">
                <option value="equipier">√âquipier</option>
                <option value="responsable">Responsable d‚Äô√©quipe</option>
                <option value="admin">Administrateur</option>
              </select>
            </div>
          </div>
          <div class="btnRow" style="margin-top:10px">
            <button class="btn2" id="btnAddAgent">Ajouter agent</button>
            <button class="btn2" id="btnResetAll">R√©initialiser tout (dangereux)</button>
          </div>

          <div class="hint">
            R√©initialiser code d‚Äôun agent = le remettre √† <b>0000</b> (sans afficher son code).
          </div>

          <div class="hr"></div>

          <div class="name">Missions (biblioth√®que)</div>
          <div class="grid2" style="margin-top:10px">
            <div>
              <label>Nouvelle mission</label>
              <input id="newMissionTitle" placeholder="Ex : V√©rifier ARI"/>
            </div>
            <div>
              <label>Ajouter √† la p√©riode s√©lectionn√©e ?</label>
              <select id="addToPeriod">
                <option value="yes">Oui</option>
                <option value="no">Non (juste biblioth√®que)</option>
              </select>
            </div>
          </div>
          <div class="btnRow" style="margin-top:10px">
            <button class="btn2" id="btnAddMission">Ajouter mission</button>
          </div>

          <div class="hr"></div>

          <div class="name">Affectations (p√©riode s√©lectionn√©e)</div>
          <div class="grid2" style="margin-top:10px">
            <div>
              <label>Agent</label>
              <select id="assignAgent"></select>
            </div>
            <div>
              <label>Action</label>
              <select id="assignAction">
                <option value="assign">Attribuer</option>
                <option value="unassign">Retirer</option>
              </select>
            </div>
          </div>
          <div class="btnRow" style="margin-top:10px">
            <button class="btn2" id="btnDoAssign">Valider</button>
          </div>

          <div class="hint">
            Les missions n‚Äôapparaissent √† l‚Äôagent que s‚Äôil est affect√© √† la p√©riode.
          </div>
        </div>

        <!-- Admin lists -->
        <div class="panel">
          <div class="name">üìã Listes</div>
          <div class="meta">Clique pour g√©rer rapidement</div>

          <div class="hr"></div>
          <div class="name">Agents</div>
          <div id="adminAgentsList" class="list"></div>

          <div class="hr"></div>
          <div class="name">Missions de la p√©riode</div>
          <div id="adminPeriodMissions" class="list"></div>

          <div class="hr"></div>
          <div class="name">Affect√©s √† la p√©riode</div>
          <div id="adminAssignedList" class="list"></div>
        </div>
      </div>

      <div class="hr"></div>

      <!-- Admin dashboard -->
      <div class="panel">
        <div class="name">‚úÖ Suivi des missions (Admin)</div>
        <div class="meta">Vue ‚Äúpage mission‚Äù : statut + justification si non fait</div>

        <div class="grid2" style="margin-top:10px">
          <div>
            <label>Filtre agent</label>
            <select id="filterAgent"></select>
          </div>
          <div>
            <label>Filtre statut</label>
            <select id="filterStatus">
              <option value="all">Tous</option>
              <option value="fait">Fait</option>
              <option value="partiel">Partiel</option>
              <option value="non_fait">Non fait</option>
              <option value="none">Sans retour</option>
            </select>
          </div>
        </div>

        <div class="tableWrap" style="margin-top:10px">
          <table id="dashTable">
            <thead>
              <tr>
                <th style="min-width:240px">Mission</th>
                <th style="min-width:200px">Agent</th>
                <th style="min-width:140px">Statut</th>
                <th>Justification (si non fait)</th>
                <th style="min-width:160px">Derni√®re mise √† jour</th>
              </tr>
            </thead>
            <tbody id="dashBody"></tbody>
          </table>
        </div>

        <div class="hint">
          R√®gle : si <b>Non fait</b> alors justification obligatoire (min 3 caract√®res).
        </div>
      </div>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast">
  <div class="t" id="toastT">‚Äî</div>
  <div class="m" id="toastM">‚Äî</div>
  <div class="right" style="margin-top:10px">
    <button class="btn2 smallBtn" id="toastClose">OK</button>
  </div>
</div>

  <script>
  const API_URL = "COLLE_ICI_URL_EXEC";
  const TOKEN = "TEST123";

  function jsonp(params){
    return new Promise((resolve, reject)=>{
      const cb = "cb_" + Math.random().toString(36).slice(2);
      params.callback = cb;
      const s = document.createElement("script");
      const t = setTimeout(()=>{ cleanup(); reject(new Error("timeout")); }, 12000);
      function cleanup(){ clearTimeout(t); delete window[cb]; s.remove(); }
      window[cb] = (data)=>{ cleanup(); resolve(data); };
      s.onerror = ()=>{ cleanup(); reject(new Error("load_error")); };
      s.src = API_URL + "?" + new URLSearchParams(params);
      document.body.appendChild(s);
    });
  }

  // Test ping
  (async ()=>{
    try{
      const res = await jsonp({ action:"ping", token:TOKEN });
      console.log("PING RESULT:", res);
      alert(res.ok ? "‚úÖ PING OK (GitHub ‚Üî Apps Script)" : "‚ùå PING FAIL: " + res.error);
    }catch(e){
      alert("‚ùå PING ERREUR TECHNIQUE: " + e);
    }
  })();
</script>

<script>
/** ============================================================
 *  ENTRETENIR CS CONSENVOYE ‚Äî Version locale (sans serveur)
 *  - 1 seul fichier
 *  - Donn√©es stock√©es en localStorage
 *  - Admin : agents / missions / affectations / suivi retours
 *  - Agent : fait/partiel/non_fait + justification obligatoire si non_fait
 *  - Export/Import JSON : transfert entre appareils
 * ============================================================ */

/* -----------------------------
   Utils UI
------------------------------ */
const $ = (id) => document.getElementById(id);
const toast = {
  show(title, msg){
    $("toastT").textContent = title || "";
    $("toastM").textContent = msg || "";
    $("toast").classList.add("show");
  },
  hide(){ $("toast").classList.remove("show"); }
};
$("toastClose").onclick = () => toast.hide();

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function fmtDate(ts){
  if(!ts) return "‚Äî";
  const d = new Date(ts);
  if(isNaN(d.getTime())) return "‚Äî";
  return d.toLocaleString();
}

/* -----------------------------
   Storage (schema)
------------------------------ */
const STORE_KEY = "cs_consenvoye_v1";

function loadStore(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(_){
    return null;
  }
}

function saveStore(store){
  localStorage.setItem(STORE_KEY, JSON.stringify(store));
}

function uuid(){
  // simple uuid-like
  return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, c=>{
    const r = Math.random()*16|0;
    const v = c==="x" ? r : (r&0x3|0x8);
    return v.toString(16);
  });
}

function periodKey(mois, annee){
  return `${annee}::${mois}`;
}

/* -----------------------------
   Default data
------------------------------ */
function defaultStore(){
  const adminId = uuid();
  const a1 = uuid();
  const a2 = uuid();

  return {
    version: 1,
    createdAt: Date.now(),

    // session
    session: { kind: "none", userId: null },

    // agents
    agents: [
      { id: adminId, name: "ADMIN", role: "admin", active: true, code: "0000" },
      { id: a1, name: "DUPONT Jean", role: "equipier", active: true, code: "0000" },
      { id: a2, name: "MARTIN Paul", role: "responsable", active: true, code: "0000" },
    ],

    // missions library
    missions: [
      { id: uuid(), title: "Nettoyage VSAV", active: true },
      { id: uuid(), title: "V√©rification ARI", active: true },
      { id: uuid(), title: "Balayage remise", active: true },
      { id: uuid(), title: "Contr√¥le pharmacie", active: true },
    ],

    // missions per period (array of missionIds)
    periodMissions: {
      // [periodKey]: [missionId...]
    },

    // assignments per period (array of agentIds)
    assignments: {
      // [periodKey]: [agentId...]
    },

    // returns (per period, mission, agent)
    // key: `${periodKey}::${missionId}::${agentId}`
    returns: {
      // [key]: { status, justification, updatedAt }
    }
  };
}

let store = loadStore();
if(!store){
  store = defaultStore();
  // by default, add all default missions to current 2026 Janvier & assign all non-admin agents
  const p = periodKey("Janvier", 2026);
  store.periodMissions[p] = store.missions.map(m=>m.id);
  store.assignments[p] = store.agents.filter(a=>a.role!=="admin" && a.active).map(a=>a.id);
  saveStore(store);
}

/* -----------------------------
   App state (period)
------------------------------ */
const MONTHS = ["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"];
const YEARS = [2025,2026,2027,2028];

function getSelectedPeriod(){
  const mois = $("selMois").value;
  const annee = Number($("selAnnee").value);
  if(!mois || !annee) return null;
  return { mois, annee, key: periodKey(mois, annee) };
}

/* -----------------------------
   Tabs
------------------------------ */
function showTab(which){
  $("tabAgent").classList.toggle("active", which==="agent");
  $("tabAdmin").classList.toggle("active", which==="admin");
  $("viewAgent").classList.toggle("active", which==="agent");
  $("viewAdmin").classList.toggle("active", which==="admin");
}
$("tabAgent").onclick = ()=>showTab("agent");
$("tabAdmin").onclick = ()=>showTab("admin");

/* -----------------------------
   Session helpers
------------------------------ */
function setSession(kind, userId){
  store.session = { kind, userId };
  saveStore(store);
}
function getSessionUser(){
  if(!store.session?.userId) return null;
  return store.agents.find(a=>a.id===store.session.userId) || null;
}

/* -----------------------------
   Roles helpers
------------------------------ */
function roleLabel(role){
  if(role==="admin") return "Administrateur";
  if(role==="responsable") return "Responsable";
  return "√âquipier";
}

/* -----------------------------
   Status helpers
------------------------------ */
const STATUS = ["fait","partiel","non_fait"];
function badgeClass(st){
  if(st==="fait") return "badge b-fait";
  if(st==="partiel") return "badge b-partiel";
  if(st==="non_fait") return "badge b-nonfait";
  return "badge b-none";
}
function badgeText(st){
  if(st==="fait") return "Fait";
  if(st==="partiel") return "Partiel";
  if(st==="non_fait") return "Non fait";
  return "‚Äî";
}
function returnKey(pKey, missionId, agentId){
  return `${pKey}::${missionId}::${agentId}`;
}

/* -----------------------------
   Render: period selectors
------------------------------ */
function renderPeriodSelectors(){
  $("selMois").innerHTML = `<option value="">-- S√©lectionner --</option>` + MONTHS.map(m=>`<option>${m}</option>`).join("");
  $("selAnnee").innerHTML = `<option value="">-- S√©lectionner --</option>` + YEARS.map(y=>`<option>${y}</option>`).join("");

  // default selection: keep if exists, else 2026 Janvier
  const cur = getSelectedPeriod();
  if(!cur){
    $("selMois").value = "Janvier";
    $("selAnnee").value = "2026";
  }
}

/* -----------------------------
   Render: pills
------------------------------ */
function renderPills(){
  const p = getSelectedPeriod();
  $("pillPeriod").textContent = p ? `P√©riode : ${p.mois} ${p.annee}` : "P√©riode : ‚Äî";

  const u = getSessionUser();
  if(!u){
    $("pillSession").className = "pill";
    $("pillSession").textContent = "Non connect√©";
    return;
  }
  const isAdmin = (store.session.kind==="admin");
  $("pillSession").className = "pill ok";
  $("pillSession").textContent = (isAdmin ? "Admin : " : "Agent : ") + u.name;
}

/* -----------------------------
   Render: dropdowns users
------------------------------ */
function renderUserDropdowns(){
  const activeAgents = store.agents.filter(a=>a.active);

  $("agentNom").innerHTML = `<option value="">-- Choisir --</option>` +
    activeAgents.filter(a=>a.role!=="admin").map(a=>`<option value="${a.id}">${escapeHtml(a.name)} ‚Ä¢ ${roleLabel(a.role)}</option>`).join("");

  $("adminNom").innerHTML = `<option value="">-- Choisir --</option>` +
    activeAgents.filter(a=>a.role==="admin").map(a=>`<option value="${a.id}">${escapeHtml(a.name)}</option>`).join("");

  // assignment selection
  $("assignAgent").innerHTML = `<option value="">-- Choisir --</option>` +
    activeAgents.filter(a=>a.role!=="admin").map(a=>`<option value="${a.id}">${escapeHtml(a.name)} ‚Ä¢ ${roleLabel(a.role)}</option>`).join("");

  // filter agent
  $("filterAgent").innerHTML = `<option value="all">Tous</option>` +
    activeAgents.filter(a=>a.role!=="admin").map(a=>`<option value="${a.id}">${escapeHtml(a.name)}</option>`).join("");
}

/* -----------------------------
   Auth: Agent/Admin login
------------------------------ */
$("btnAgentLogin").onclick = ()=>{
  const id = $("agentNom").value;
  const code = $("agentCode").value;
  if(!id) return toast.show("Connexion", "Choisis ton nom.");
  const a = store.agents.find(x=>x.id===id);
  if(!a || !a.active) return toast.show("Connexion", "Compte invalide.");
  if(code !== a.code) return toast.show("Connexion", "Code incorrect.");

  setSession("agent", a.id);
  $("agentCode").value = "";
  renderAll();
  toast.show("Connect√©", `Bienvenue ${a.name}`);
};

$("btnAgentLogout").onclick = ()=>{
  setSession("none", null);
  renderAll();
  toast.show("D√©connexion", "OK.");
};

$("btnAdminLogin").onclick = ()=>{
  const id = $("adminNom").value;
  const code = $("adminCode").value;
  if(!id) return toast.show("Connexion", "Choisis le compte admin.");
  const a = store.agents.find(x=>x.id===id);
  if(!a || !a.active || a.role!=="admin") return toast.show("Connexion", "Compte admin invalide.");
  if(code !== a.code) return toast.show("Connexion", "Code incorrect.");

  setSession("admin", a.id);
  $("adminCode").value = "";
  renderAll();
  toast.show("Admin connect√©", `Bienvenue ${a.name}`);
};

$("btnAdminLogout").onclick = ()=>{
  setSession("none", null);
  renderAll();
  toast.show("D√©connexion", "OK.");
};

/* -----------------------------
   Agent view: mission list
------------------------------ */
function agentIsAssigned(periodKeyStr, agentId){
  const arr = store.assignments[periodKeyStr] || [];
  return arr.includes(agentId);
}

function missionsForPeriod(periodKeyStr){
  const ids = store.periodMissions[periodKeyStr] || [];
  const set = new Set(ids);
  return store.missions.filter(m=>m.active && set.has(m.id));
}

function renderAgentKPIs(){
  const u = getSessionUser();
  const p = getSelectedPeriod();
  if(!u || store.session.kind!=="agent" || !p){
    $("kpiCount").textContent = "‚Äî";
    $("kpiFait").textContent = "‚Äî";
    $("kpiNon").textContent = "‚Äî";
    return;
  }
  const isAssigned = agentIsAssigned(p.key, u.id);
  if(!isAssigned){
    $("kpiCount").textContent = "0";
    $("kpiFait").textContent = "0";
    $("kpiNon").textContent = "0";
    return;
  }
  const ms = missionsForPeriod(p.key);
  let fait=0, non=0;
  for(const m of ms){
    const r = store.returns[returnKey(p.key, m.id, u.id)];
    if(r?.status==="fait") fait++;
    if(r?.status==="non_fait") non++;
  }
  $("kpiCount").textContent = String(ms.length);
  $("kpiFait").textContent = String(fait);
  $("kpiNon").textContent = String(non);
}

function renderAgentMissions(){
  const list = $("agentMissions");
  list.innerHTML = "";

  const p = getSelectedPeriod();
  const u = getSessionUser();

  if(!p){
    list.innerHTML = `<li class="item"><div class="name">Choisis un mois et une ann√©e.</div><div class="meta">Ensuite connecte-toi.</div></li>`;
    renderAgentKPIs();
    return;
  }
  if(!u || store.session.kind!=="agent"){
    list.innerHTML = `<li class="item"><div class="name">Non connect√©.</div><div class="meta">Connecte-toi en agent pour voir tes missions.</div></li>`;
    renderAgentKPIs();
    return;
  }

  // must be assigned
  if(!agentIsAssigned(p.key, u.id)){
    list.innerHTML = `<li class="item"><div class="name">Aucune mission</div><div class="meta">Tu n‚Äôes pas affect√© √† cette p√©riode.</div></li>`;
    renderAgentKPIs();
    return;
  }

  const ms = missionsForPeriod(p.key);
  if(ms.length===0){
    list.innerHTML = `<li class="item"><div class="name">Aucune mission</div><div class="meta">L‚Äôadmin n‚Äôa pas cr√©√© de missions pour cette p√©riode.</div></li>`;
    renderAgentKPIs();
    return;
  }

  for(const m of ms){
    const key = returnKey(p.key, m.id, u.id);
    const current = store.returns[key] || null;
    const st = current?.status || "";
    const just = current?.justification || "";

    const li = document.createElement("li");
    li.className = "item";
    li.innerHTML = `
      <div class="itemTop">
        <div style="min-width:0;flex:1">
          <div class="name">${escapeHtml(m.title)}</div>
          <div class="meta">Statut actuel : <span class="${badgeClass(st)}">${badgeText(st)}</span></div>
        </div>
        <div class="tri">
          <label class="fait"><input type="radio" name="m_${m.id}" value="fait">Fait</label>
          <label class="partiel"><input type="radio" name="m_${m.id}" value="partiel">Partiel</label>
          <label class="nonfait"><input type="radio" name="m_${m.id}" value="non_fait">Non fait</label>
        </div>
      </div>

      <div style="margin-top:10px; display:none" id="justifBox_${m.id}">
        <label>Justification (obligatoire si Non fait)</label>
        <textarea id="justif_${m.id}" placeholder="Explique pourquoi ce n‚Äôest pas fait...">${escapeHtml(just)}</textarea>
      </div>

      <div class="btnRow" style="margin-top:10px">
        <button class="btn2" id="save_${m.id}">Enregistrer</button>
        <button class="btn2" id="clear_${m.id}">Effacer mon retour</button>
      </div>

      <div class="hint">Derni√®re mise √† jour : <b>${fmtDate(current?.updatedAt)}</b></div>
    `;

    // preselect
    if(st){
      const r = li.querySelector(`input[type="radio"][value="${st}"]`);
      if(r) r.checked = true;
    }
    const justifBox = li.querySelector(`#justifBox_${m.id}`);
    const justArea = li.querySelector(`#justif_${m.id}`);
    const showJustif = (s)=>{ justifBox.style.display = (s==="non_fait") ? "block" : "none"; };
    showJustif(st);

    li.querySelectorAll(`input[name="m_${m.id}"]`).forEach(inp=>{
      inp.addEventListener("change", ()=> showJustif(inp.value));
    });

    li.querySelector(`#save_${m.id}`).addEventListener("click", ()=>{
      const selected = li.querySelector(`input[name="m_${m.id}"]:checked`);
      if(!selected) return toast.show("Mission", "Choisis un statut.");
      const status = selected.value;

      const justification = (justArea?.value || "").trim();
      if(status==="non_fait" && justification.length < 3){
        return toast.show("Justification obligatoire", "Si Non fait, tu dois expliquer (min 3 caract√®res).");
      }

      store.returns[key] = {
        status,
        justification: status==="non_fait" ? justification : "",
        updatedAt: Date.now()
      };
      saveStore(store);
      renderAll();
      toast.show("Enregistr√©", `${m.title} ‚Üí ${badgeText(status)}`);
    });

    li.querySelector(`#clear_${m.id}`).addEventListener("click", ()=>{
      delete store.returns[key];
      saveStore(store);
      renderAll();
      toast.show("Effac√©", "Ton retour a √©t√© supprim√©.");
    });

    list.appendChild(li);
  }

  renderAgentKPIs();
}

/* -----------------------------
   Admin view: security gate
------------------------------ */
function requireAdmin(){
  const u = getSessionUser();
  return !!u && store.session.kind==="admin";
}

/* -----------------------------
   Admin: KPIs
------------------------------ */
function renderAdminKPIs(){
  const p = getSelectedPeriod();
  const activeAgents = store.agents.filter(a=>a.active && a.role!=="admin");
  $("kpiAgents").textContent = String(activeAgents.length);

  if(!p){
    $("kpiMissionsP").textContent = "‚Äî";
    $("kpiRetours").textContent = "‚Äî";
    return;
  }
  const ms = missionsForPeriod(p.key);
  $("kpiMissionsP").textContent = String(ms.length);

  // count returns for this period
  let ret=0;
  const assigned = store.assignments[p.key] || [];
  for(const m of ms){
    for(const aid of assigned){
      const r = store.returns[returnKey(p.key, m.id, aid)];
      if(r && r.status) ret++;
    }
  }
  $("kpiRetours").textContent = String(ret);
}

/* -----------------------------
   Admin: Agents list (manage)
------------------------------ */
function renderAdminAgentsList(){
  const root = $("adminAgentsList");
  root.innerHTML = "";

  const agents = store.agents.slice().sort((a,b)=>a.name.localeCompare(b.name,"fr"));
  for(const a of agents){
    const li = document.createElement("div");
    li.className = "item";
    li.innerHTML = `
      <div class="itemTop">
        <div style="min-width:0;flex:1">
          <div class="name">${escapeHtml(a.name)} ${a.role==="admin" ? "üõ°Ô∏è" : ""}</div>
          <div class="meta">R√¥le : ${roleLabel(a.role)} ‚Ä¢ Actif : ${a.active ? "Oui" : "Non"}</div>
        </div>
        <div class="btnRow" style="justify-content:flex-end">
          <button class="btn2 smallBtn" data-act="toggle">${a.active ? "D√©sactiver" : "Activer"}</button>
          <button class="btn2 smallBtn" data-act="reset">Reset code (0000)</button>
          <button class="btn2 smallBtn" data-act="del">Supprimer</button>
        </div>
      </div>
    `;

    li.querySelector('[data-act="toggle"]').onclick = ()=>{
      a.active = !a.active;
      // if deactivated and currently logged in, logout
      const u = getSessionUser();
      if(u && u.id===a.id && !a.active){
        setSession("none", null);
      }
      saveStore(store);
      renderAll();
      toast.show("Agent", `${a.name} ‚Üí ${a.active ? "Activ√©" : "D√©sactiv√©"}`);
    };

    li.querySelector('[data-act="reset"]').onclick = ()=>{
      a.code = "0000";
      saveStore(store);
      toast.show("Code r√©initialis√©", `${a.name} ‚Üí 0000`);
    };

    li.querySelector('[data-act="del"]').onclick = ()=>{
      if(a.role==="admin" && store.agents.filter(x=>x.role==="admin").length<=1){
        return toast.show("Refus", "Il faut garder au moins 1 admin.");
      }
      // remove agent
      store.agents = store.agents.filter(x=>x.id!==a.id);

      // clean assignments
      for(const k in store.assignments){
        store.assignments[k] = (store.assignments[k] || []).filter(id=>id!==a.id);
      }
      // clean returns
      for(const rk of Object.keys(store.returns)){
        if(rk.endsWith(`::${a.id}`)) delete store.returns[rk];
      }

      // if logged in with this agent
      const u = getSessionUser();
      if(u && u.id===a.id) setSession("none", null);

      saveStore(store);
      renderAll();
      toast.show("Supprim√©", `${a.name} supprim√©.`);
    };

    root.appendChild(li);
  }
}

/* -----------------------------
   Admin: Period missions list
------------------------------ */
function renderAdminPeriodMissions(){
  const root = $("adminPeriodMissions");
  root.innerHTML = "";
  const p = getSelectedPeriod();

  if(!p){
    root.innerHTML = `<div class="item"><div class="name">Choisis une p√©riode.</div><div class="meta">Mois/ann√©e en haut.</div></div>`;
    return;
  }

  const ms = missionsForPeriod(p.key);
  if(ms.length===0){
    root.innerHTML = `<div class="item"><div class="name">Aucune mission</div><div class="meta">Ajoute des missions √† cette p√©riode.</div></div>`;
    return;
  }

  for(const m of ms){
    const li = document.createElement("div");
    li.className = "item";
    li.innerHTML = `
      <div class="itemTop">
        <div style="min-width:0;flex:1">
          <div class="name">${escapeHtml(m.title)}</div>
          <div class="meta">Active : ${m.active ? "Oui" : "Non"}</div>
        </div>
        <div class="btnRow" style="justify-content:flex-end">
          <button class="btn2 smallBtn" data-act="remove">Retirer de la p√©riode</button>
          <button class="btn2 smallBtn" data-act="disable">${m.active ? "D√©sactiver" : "Activer"}</button>
        </div>
      </div>
    `;
    li.querySelector('[data-act="remove"]').onclick = ()=>{
      const arr = store.periodMissions[p.key] || [];
      store.periodMissions[p.key] = arr.filter(id=>id!==m.id);

      // also clean returns of this mission for this period
      const assigned = store.assignments[p.key] || [];
      for(const aid of assigned){
        delete store.returns[returnKey(p.key, m.id, aid)];
      }

      saveStore(store);
      renderAll();
      toast.show("P√©riode", `Mission retir√©e : ${m.title}`);
    };
    li.querySelector('[data-act="disable"]').onclick = ()=>{
      m.active = !m.active;
      saveStore(store);
      renderAll();
      toast.show("Mission", `${m.title} ‚Üí ${m.active ? "Active" : "D√©sactiv√©e"}`);
    };
    root.appendChild(li);
  }
}

/* -----------------------------
   Admin: Assigned list
------------------------------ */
function renderAdminAssignedList(){
  const root = $("adminAssignedList");
  root.innerHTML = "";
  const p = getSelectedPeriod();

  if(!p){
    root.innerHTML = `<div class="item"><div class="name">Choisis une p√©riode.</div><div class="meta">Mois/ann√©e en haut.</div></div>`;
    return;
  }

  const ids = store.assignments[p.key] || [];
  if(ids.length===0){
    root.innerHTML = `<div class="item"><div class="name">Personne affect√©</div><div class="meta">Attribue des agents √† cette p√©riode.</div></div>`;
    return;
  }

  const byId = new Map(store.agents.map(a=>[a.id,a]));
  for(const id of ids){
    const a = byId.get(id);
    if(!a) continue;
    const li = document.createElement("div");
    li.className = "item";
    li.innerHTML = `
      <div class="itemTop">
        <div style="min-width:0;flex:1">
          <div class="name">${escapeHtml(a.name)}</div>
          <div class="meta">${roleLabel(a.role)}</div>
        </div>
        <div class="btnRow" style="justify-content:flex-end">
          <button class="btn2 smallBtn">Retirer</button>
        </div>
      </div>
    `;
    li.querySelector("button").onclick = ()=>{
      store.assignments[p.key] = (store.assignments[p.key] || []).filter(x=>x!==id);

      // clean returns for this period for this agent
      const ms = missionsForPeriod(p.key);
      for(const m of ms){
        delete store.returns[returnKey(p.key, m.id, id)];
      }

      saveStore(store);
      renderAll();
      toast.show("Affectation", `${a.name} retir√© de la p√©riode.`);
    };
    root.appendChild(li);
  }
}

/* -----------------------------
   Admin actions: add agent
------------------------------ */
$("btnAddAgent").onclick = ()=>{
  if(!requireAdmin()) return toast.show("Acc√®s refus√©", "Connecte-toi en administrateur.");
  const name = $("newAgentName").value.trim();
  const role = $("newAgentRole").value;
  if(name.length<2) return toast.show("Agent", "Nom trop court.");

  // avoid duplicates (same name)
  const exists = store.agents.some(a=>a.name.toLowerCase()===name.toLowerCase());
  if(exists) return toast.show("Agent", "Ce nom existe d√©j√†.");

  store.agents.push({
    id: uuid(),
    name,
    role,
    active: true,
    code: "0000"
  });

  $("newAgentName").value = "";
  saveStore(store);
  renderAll();
  toast.show("Agent ajout√©", `${name} (code 0000)`);
};

/* -----------------------------
   Admin actions: add mission
------------------------------ */
$("btnAddMission").onclick = ()=>{
  if(!requireAdmin()) return toast.show("Acc√®s refus√©", "Connecte-toi en administrateur.");
  const title = $("newMissionTitle").value.trim();
  if(title.length<2) return toast.show("Mission", "Titre trop court.");

  // avoid duplicates
  const exists = store.missions.some(m=>m.title.toLowerCase()===title.toLowerCase());
  if(exists) return toast.show("Mission", "Cette mission existe d√©j√†.");

  const id = uuid();
  store.missions.push({ id, title, active: true });

  const addPeriod = $("addToPeriod").value === "yes";
  const p = getSelectedPeriod();
  if(addPeriod && p){
    store.periodMissions[p.key] = store.periodMissions[p.key] || [];
    store.periodMissions[p.key].push(id);
  }

  $("newMissionTitle").value = "";
  saveStore(store);
  renderAll();
  toast.show("Mission ajout√©e", addPeriod && p ? "Ajout√©e √† la p√©riode." : "Ajout√©e √† la biblioth√®que.");
};

/* -----------------------------
   Admin actions: assignments
------------------------------ */
$("btnDoAssign").onclick = ()=>{
  if(!requireAdmin()) return toast.show("Acc√®s refus√©", "Connecte-toi en administrateur.");
  const p = getSelectedPeriod();
  if(!p) return toast.show("P√©riode", "Choisis mois et ann√©e.");
  const agentId = $("assignAgent").value;
  if(!agentId) return toast.show("Affectation", "Choisis un agent.");
  const action = $("assignAction").value;

  store.assignments[p.key] = store.assignments[p.key] || [];
  const arr = store.assignments[p.key];

  if(action==="assign"){
    if(!arr.includes(agentId)) arr.push(agentId);
    saveStore(store);
    renderAll();
    toast.show("Affectation", "Agent attribu√© √† la p√©riode.");
    return;
  }

  // unassign
  store.assignments[p.key] = arr.filter(x=>x!==agentId);

  // clean returns for this period for this agent
  const ms = missionsForPeriod(p.key);
  for(const m of ms){
    delete store.returns[returnKey(p.key, m.id, agentId)];
  }

  saveStore(store);
  renderAll();
  toast.show("Affectation", "Agent retir√©.");
};

/* -----------------------------
   Admin: hard reset all
------------------------------ */
$("btnResetAll").onclick = ()=>{
  if(!requireAdmin()) return toast.show("Acc√®s refus√©", "Connecte-toi en administrateur.");
  const sure = confirm("R√©initialiser TOUT ? (agents, missions, retours) ‚Äî irr√©versible");
  if(!sure) return;
  store = defaultStore();
  const p = periodKey("Janvier", 2026);
  store.periodMissions[p] = store.missions.map(m=>m.id);
  store.assignments[p] = store.agents.filter(a=>a.role!=="admin" && a.active).map(a=>a.id);
  saveStore(store);
  renderAll();
  toast.show("R√©initialis√©", "Tout a √©t√© remis √† z√©ro.");
};

/* -----------------------------
   Admin: Export / Import JSON
------------------------------ */
$("btnExport").onclick = ()=>{
  if(!requireAdmin()) return toast.show("Acc√®s refus√©", "Connecte-toi en administrateur.");
  const data = JSON.stringify(store, null, 2);
  const blob = new Blob([data], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  const ts = new Date().toISOString().replaceAll(":","-");
  a.href = url;
  a.download = `entretien_cs_consenvoye_${ts}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  toast.show("Export", "Fichier JSON t√©l√©charg√©.");
};

$("btnImport").onclick = ()=>{
  if(!requireAdmin()) return toast.show("Acc√®s refus√©", "Connecte-toi en administrateur.");
  $("importFile").click();
};

$("importFile").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  try{
    const txt = await file.text();
    const imported = JSON.parse(txt);
    if(!imported || imported.version !== 1) throw new Error("Format invalide");

    // merge strategy: replace entirely (simple)
    const sure = confirm("Importer = remplacer les donn√©es actuelles sur cet appareil. Continuer ?");
    if(!sure) return;

    store = imported;
    saveStore(store);
    renderAll();
    toast.show("Import", "Donn√©es import√©es.");
  }catch(err){
    toast.show("Import √©chou√©", String(err?.message || err));
  }finally{
    $("importFile").value = "";
  }
});

/* -----------------------------
   Admin: dashboard table
------------------------------ */
function renderDashboard(){
  const body = $("dashBody");
  body.innerHTML = "";

  if(!requireAdmin()){
    body.innerHTML = `<tr><td colspan="5">Connecte-toi en admin.</td></tr>`;
    return;
  }

  const p = getSelectedPeriod();
  if(!p){
    body.innerHTML = `<tr><td colspan="5">Choisis une p√©riode.</td></tr>`;
    return;
  }

  const assignedIds = store.assignments[p.key] || [];
  const assignedAgents = store.agents.filter(a=>assignedIds.includes(a.id) && a.active && a.role!=="admin")
    .sort((a,b)=>a.name.localeCompare(b.name,"fr"));

  const ms = missionsForPeriod(p.key).sort((a,b)=>a.title.localeCompare(b.title,"fr"));

  if(assignedAgents.length===0 || ms.length===0){
    body.innerHTML = `<tr><td colspan="5">Pas d‚Äôagents affect√©s ou pas de missions sur cette p√©riode.</td></tr>`;
    return;
  }

  const filterA = $("filterAgent").value;
  const filterS = $("filterStatus").value;

  let rows = 0;

  for(const m of ms){
    for(const a of assignedAgents){
      if(filterA!=="all" && a.id!==filterA) continue;

      const rk = returnKey(p.key, m.id, a.id);
      const r = store.returns[rk] || null;
      const st = r?.status || "";
      const just = r?.justification || "";
      const updated = r?.updatedAt || null;

      // status filter
      if(filterS==="none"){
        if(st) continue;
      } else if(filterS!=="all"){
        if(st !== filterS) continue;
      }

      // if non_fait but missing justification => highlight
      const missingJust = (st==="non_fait" && (!just || just.trim().length<3));

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><b>${escapeHtml(m.title)}</b><br><small>ID: ${escapeHtml(m.id)}</small></td>
        <td><b>${escapeHtml(a.name)}</b><br><small>${roleLabel(a.role)}</small></td>
        <td><span class="${badgeClass(st)}">${badgeText(st)}</span>${missingJust ? ` <span class="badge b-nonfait">Justif manquante</span>` : ""}</td>
        <td>${st==="non_fait" ? escapeHtml(just || "‚Äî") : "‚Äî"}</td>
        <td>${fmtDate(updated)}</td>
      `;
      body.appendChild(tr);
      rows++;
    }
  }

  if(rows===0){
    body.innerHTML = `<tr><td colspan="5">Aucun r√©sultat avec ces filtres.</td></tr>`;
  }
}

/* -----------------------------
   Period change handlers
------------------------------ */
$("selMois").addEventListener("change", ()=>{
  renderAll();
});
$("selAnnee").addEventListener("change", ()=>{
  renderAll();
});
$("filterAgent").addEventListener("change", ()=>renderDashboard());
$("filterStatus").addEventListener("change", ()=>renderDashboard());

/* -----------------------------
   Admin: Auto add period missions if empty (helper)
------------------------------ */
function ensurePeriodInitialized(){
  const p = getSelectedPeriod();
  if(!p) return;
  // if period not present, initialize empty arrays
  store.periodMissions[p.key] = store.periodMissions[p.key] || [];
  store.assignments[p.key] = store.assignments[p.key] || [];
  saveStore(store);
}

/* -----------------------------
   Render all
------------------------------ */
function renderAll(){
  ensurePeriodInitialized();
  renderPills();
  renderUserDropdowns();

  // show/hide admin content based on session
  renderAgentMissions();

  // admin sections
  renderAdminKPIs();
  renderAdminAgentsList();
  renderAdminPeriodMissions();
  renderAdminAssignedList();
  renderDashboard();
}

/* -----------------------------
   Init (first load)
------------------------------ */
(function init(){
  renderPeriodSelectors();

  // Set defaults
  $("selMois").value = $("selMois").value || "Janvier";
  $("selAnnee").value = $("selAnnee").value || "2026";

  // if there was no period missions for current, create from library
  const p = getSelectedPeriod();
  if(p){
    if(!store.periodMissions[p.key] || store.periodMissions[p.key].length===0){
      store.periodMissions[p.key] = store.missions.filter(m=>m.active).map(m=>m.id);
    }
    if(!store.assignments[p.key] || store.assignments[p.key].length===0){
      store.assignments[p.key] = store.agents.filter(a=>a.role!=="admin" && a.active).map(a=>a.id);
    }
    saveStore(store);
  }

  renderAll();
})();
</script>
</body>
</html>
