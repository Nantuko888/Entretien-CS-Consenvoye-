<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Entretien du centre de secours de Consenvoye</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --bg0:#070a0f;
      --bg1:#0b111b;
      --panel:#0f1724;
      --panel2:#111c2c;
      --line:rgba(255,255,255,.10);
      --text:#eaf0fb;
      --muted:#aab6cc;

      --red:#d72638;
      --red2:#ff3b30;
      --amber:#ffb020;
      --green:#2ecc71;

      --radius:18px;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --shadow2: 0 10px 22px rgba(0,0,0,.35);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% -10%, rgba(215,38,56,.35), transparent 60%),
        radial-gradient(900px 600px at 105% 10%, rgba(255,176,32,.16), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 45%, var(--bg0));
      overflow-x:hidden;
    }

    /* d√©cor ‚Äúpompier / caserne‚Äù (sans image externe) */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      opacity:.30;
      background:
        repeating-linear-gradient(
          135deg,
          rgba(255,255,255,.06) 0px,
          rgba(255,255,255,.06) 10px,
          rgba(0,0,0,0) 10px,
          rgba(0,0,0,0) 26px
        );
      mix-blend-mode: overlay;
    }
    body::after{
      content:"";
      position:fixed;
      inset:-40px -40px auto auto;
      width: 380px;
      height: 380px;
      pointer-events:none;
      opacity:.55;
      filter: blur(.2px);
      background:
        radial-gradient(circle at 30% 30%, rgba(255,59,48,.35), rgba(255,59,48,0) 60%),
        radial-gradient(circle at 60% 50%, rgba(255,176,32,.20), rgba(255,176,32,0) 55%);
      transform: rotate(18deg);
    }

    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px 14px 34px;
    }

    .topbar{
      display:flex;
      align-items:stretch;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
    }

    .brand{
      flex: 1 1 520px;
      min-width: 290px;
      background:
        linear-gradient(135deg, rgba(215,38,56,.20), rgba(15,23,36,.92) 58%),
        linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,0) 40%);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px 16px;
      position:relative;
      overflow:hidden;
    }

    .brand .row{
      display:flex;
      gap:12px;
      align-items:center;
    }

    .mark{
      width:54px;
      height:54px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.18);
      background: linear-gradient(135deg, rgba(215,38,56,.95), rgba(255,176,32,.65));
      box-shadow: 0 14px 30px rgba(215,38,56,.18);
      display:grid;
      place-items:center;
      flex:0 0 auto;
    }

    .title{
      margin:0;
      font-size: 22px;
      line-height: 1.08;
      letter-spacing: .2px;
      text-align:left;
    }

    .subtitle{
      margin:6px 0 0;
      color: var(--muted);
      font-size: 13px;
    }

    .chips{
      margin-top: 12px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-size: 12px;
      font-weight: 650;
      user-select:none;
    }
    .chip b{ color: var(--text); }

    .periodCard{
      flex: 0 1 360px;
      min-width: 290px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }

    .label{
      display:block;
      color: var(--muted);
      font-size: 12px;
      margin: 0 0 6px;
    }

    select, input, textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(15,23,36,.70);
      color: var(--text);
      outline: none;
      font-size: 16px;
    }
    textarea{ min-height: 110px; resize: vertical; }

    select:focus, input:focus, textarea:focus{
      border-color: rgba(255,59,48,.55);
      box-shadow: 0 0 0 4px rgba(215,38,56,.14);
    }

    .two{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 520px){
      .two{ grid-template-columns: 1fr; }
    }

    .main{
      margin-top: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .tabs{
      display:flex;
      gap:10px;
      padding: 10px;
      background: rgba(15,23,36,.55);
      border-bottom: 1px solid var(--line);
    }
    .tab{
      flex:1;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 12px 10px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 900;
      font-size: 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      user-select:none;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
    }
    .tab:active{ transform: scale(.99); }
    .tab.active{
      background: linear-gradient(135deg, rgba(215,38,56,.22), rgba(255,176,32,.10));
      border-color: rgba(255,59,48,.55);
      box-shadow: 0 10px 22px rgba(215,38,56,.10);
    }

    .content{ display:none; padding: 14px; }
    .content.active{ display:block; }

    .section{
      border: 1px solid var(--line);
      border-radius: 16px;
      background: rgba(15,23,36,.45);
      padding: 12px;
      box-shadow: var(--shadow2);
    }
    .section + .section{ margin-top: 12px; }

    .sectionHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom: 10px;
    }
    .sectionTitle{
      margin:0;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: .35px;
      color: var(--muted);
      font-weight: 900;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
      white-space: nowrap;
    }
    .pill.ok{ color:#dff7ea; background: rgba(46,204,113,.10); border-color: rgba(46,204,113,.25); }
    .pill.warn{ color:#ffe9c7; background: rgba(255,176,32,.10); border-color: rgba(255,176,32,.25); }

    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; }
    .btnRow > *{ flex: 1 1 180px; }

    .btn{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(135deg, rgba(215,38,56,.95), rgba(255,59,48,.78));
      color:#fff;
      font-weight: 950;
      cursor:pointer;
      font-size: 15px;
      box-shadow: 0 14px 30px rgba(215,38,56,.20);
      transition: transform .08s ease, filter .15s ease;
    }
    .btn:active{ transform: scale(.99); }
    .btn:hover{ filter: brightness(1.05); }

    .btnGhost{
      width:100%;
      padding: 11px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      font-weight: 900;
      cursor:pointer;
    }

    .list{
      margin: 10px 0 0 0;
      padding: 0;
      list-style: none;
      display:flex;
      flex-direction: column;
      gap:8px;
    }
    .item{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:10px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
    }
    .itemLeft{
      display:flex;
      flex-direction: column;
      gap:2px;
      min-width: 0;
    }
    .itemLeft .name{
      font-weight: 950;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .itemLeft .meta{
      color: var(--muted);
      font-size: 12px;
      font-weight: 750;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
    }
    .tag.resp{ border-color: rgba(255,176,32,.35); background: rgba(255,176,32,.10); color:#ffe9c7; }
    .tag.eq{ border-color: rgba(255,255,255,.14); background: rgba(255,255,255,.04); color: var(--muted); }

    .smallBtn{
      padding: 9px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      font-weight: 950;
      font-size: 13px;
      white-space: nowrap;
    }
    .smallBtn.danger{
      border-color: rgba(255,59,48,.35);
      background: rgba(255,59,48,.10);
    }

    .qtyBox{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .qty{
      min-width: 46px;
      text-align:center;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      font-weight: 950;
      color: var(--text);
    }

    .hint{
      margin-top: 10px;
      color: rgba(255,255,255,.55);
      font-size: 12px;
      line-height: 1.35;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items:start;
    }
    @media (max-width: 820px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .empty{
      height: 160px;
      border: 1px dashed rgba(255,255,255,.16);
      border-radius: 16px;
      background: rgba(15,23,36,.35);
    }

    .footer{
      margin-top: 14px;
      text-align:center;
      color: rgba(255,255,255,.45);
      font-size: 12px;
    }

    /* mini ic√¥nes */
    .ico{ width:18px; height:18px; opacity:.9; }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <div class="row">
          <div class="mark" aria-hidden="true">
            <!-- ic√¥ne casque / flamme -->
            <svg width="30" height="30" viewBox="0 0 24 24" fill="none">
              <path d="M7 13.5V10.8C7 7.6 9.3 5 12 5s5 2.6 5 5.8v2.7"
                stroke="white" stroke-width="2" stroke-linecap="round"/>
              <path d="M6 14.5c0-1.1.9-2 2-2h8c1.1 0 2 .9 2 2V18c0 .6-.4 1-1 1H7c-.6 0-1-.4-1-1v-3.5Z"
                stroke="white" stroke-width="2" stroke-linejoin="round"/>
              <path d="M12 9c.6.7.9 1.2.9 1.9 0 1-1 1.8-1.9 1.8S9.2 12 9.2 11c0-.9.7-1.6 1.5-2.3.6-.5.9-.9 1.3-1.7Z"
                fill="white" opacity=".9"/>
            </svg>
          </div>
          <div>
            <h1 class="title">Entretien du centre de secours de Consenvoye</h1>
            <p class="subtitle">Interface interne ‚Ä¢ Param√©trage administratif ‚Ä¢ Acc√®s agents</p>
          </div>
        </div>

        <div class="chips" aria-label="Infos rapides">
          <div class="chip">üì± <b>Mobile</b> agents</div>
          <div class="chip">üñ•Ô∏è <b>PC</b> admin</div>
          <div class="chip">üóìÔ∏è <b>P√©riode</b> mensuelle</div>
          <div class="chip">üîê <b>Acc√®s</b> par code</div>
        </div>
      </div>

      <div class="periodCard">
        <div class="two">
          <div>
            <span class="label">Mois</span>
            <select id="mois">
              <option value="">-- S√©lectionner --</option>
              <option>Janvier</option><option>F√©vrier</option><option>Mars</option><option>Avril</option>
              <option>Mai</option><option>Juin</option><option>Juillet</option><option>Ao√ªt</option>
              <option>Septembre</option><option>Octobre</option><option>Novembre</option><option>D√©cembre</option>
            </select>
          </div>
          <div>
            <span class="label">Ann√©e</span>
            <select id="annee">
              <option value="">-- S√©lectionner --</option>
              <option>2025</option>
              <option selected>2026</option>
              <option>2027</option>
            </select>
          </div>
        </div>

        <div style="margin-top:10px;">
          <span class="pill" id="periodPill">S√©lectionner mois + ann√©e</span>
        </div>

        <div class="hint">
          La p√©riode pilote l‚Äôaffectation et les missions (c√¥t√© administrateur).
        </div>
      </div>
    </div>

    <div class="main">
      <div class="tabs" role="tablist" aria-label="Onglets">
        <div class="tab active" role="tab" aria-selected="true" onclick="showTab('agent')">üë®‚Äçüöí Agent</div>
        <div class="tab" role="tab" aria-selected="false" onclick="showTab('admin')">üõ°Ô∏è Administrateur</div>
      </div>

      <!-- AGENT -->
      <div id="agent" class="content active">
        <div class="section">
          <div class="sectionHead">
            <h2 class="sectionTitle">Connexion agent</h2>
            <span class="pill" id="agentLockPill">Acc√®s restreint</span>
          </div>

          <div class="grid2">
            <div>
              <span class="label">Nom</span>
              <select id="agentSelect"></select>
            </div>
            <div>
              <span class="label">Code d‚Äôacc√®s</span>
              <input id="agentCode" type="password" placeholder="Code agent" />
            </div>
          </div>

          <div class="btnRow" style="margin-top:10px;">
            <button class="btn" type="button" onclick="agentLogin()">Se connecter</button>
            <button class="btnGhost" type="button" onclick="agentLogout()">D√©connexion</button>
          </div>

          <div id="agentArea" style="margin-top:12px; display:none;">
            <div class="section" style="background: rgba(15,23,36,.35);">
              <div class="sectionHead">
                <h2 class="sectionTitle">Espace agent</h2>
                <span class="pill ok" id="agentNamePill">‚Äî</span>
              </div>
              <div class="hint" id="agentInfo">
                (√Ä brancher ensuite : affichage des mois autoris√©s + missions.)
              </div>
              <div class="empty" style="margin-top:10px;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ADMIN -->
      <div id="admin" class="content">
        <div class="section">
          <div class="sectionHead">
            <h2 class="sectionTitle">Acc√®s administrateur</h2>
            <span class="pill warn">Code requis</span>
          </div>

          <div class="grid2">
            <div>
              <span class="label">Code administrateur</span>
              <input id="codeAdmin" type="password" placeholder="Code admin" />
            </div>
            <div style="display:flex; align-items:flex-end;">
              <button class="btn" type="button" onclick="unlockAdmin()">Acc√©der</button>
            </div>
          </div>

          <div class="hint">
            Les param√®tres sont stock√©s sur ce navigateur (localStorage). (Export/import possible plus tard.)
          </div>
        </div>

        <div id="adminZone" style="display:none;">
          <!-- AGENTS -->
          <div class="section">
            <div class="sectionHead">
              <h2 class="sectionTitle">Agents</h2>
              <span class="pill" id="agentsCount">0</span>
            </div>

            <div class="grid2">
              <div>
                <span class="label">Nom Pr√©nom</span>
                <input id="agentNom" placeholder="Ex : V√âNANTE Pierre" />
              </div>
              <div>
                <span class="label">Statut</span>
                <select id="agentStatut">
                  <option value="equipier">√âquipier</option>
                  <option value="responsable">Responsable d‚Äô√©quipe</option>
                </select>
              </div>
            </div>

            <div class="btnRow" style="margin-top:10px;">
              <button class="btn" type="button" onclick="addAgent()">Ajouter l‚Äôagent</button>
              <button class="btnGhost" type="button" onclick="sortAgents()">Trier A‚ÜíZ</button>
            </div>

            <ul class="list" id="agentsList"></ul>

            <div class="hint">
              Chaque agent a un <b>code d‚Äôacc√®s</b> (r√©initialisable) + un <b>statut</b> (√©quipier/responsable).
            </div>
          </div>

          <!-- MISSIONS PAR P√âRIODE -->
          <div class="section">
            <div class="sectionHead">
              <h2 class="sectionTitle">Missions par p√©riode</h2>
              <span class="pill" id="missionsCountPill">0</span>
            </div>

            <div class="grid2">
              <!-- gauche : liste p√©riode -->
              <div class="section" style="margin:0;">
                <div class="sectionHead">
                  <h2 class="sectionTitle">Liste (p√©riode)</h2>
                  <span class="pill" id="periodCount">0</span>
                </div>
                <ul class="list" id="periodMissionsList"></ul>
                <div class="hint">Utilise + / ‚àí pour ajuster la quantit√©. √Ä 0, la mission dispara√Æt.</div>
              </div>

              <!-- droite : catalogue -->
              <div class="section" style="margin:0;">
                <div class="sectionHead">
                  <h2 class="sectionTitle">Catalogue</h2>
                  <span class="pill" id="catalogCount">0</span>
                </div>

                <span class="label">Mission</span>
                <select id="catalogSelect"></select>

                <div class="btnRow" style="margin-top:10px;">
                  <button class="btn" type="button" onclick="addSelectedMissionToPeriod()">Ajouter ‚ûï</button>
                  <button class="btnGhost" type="button" onclick="removeSelectedMissionFromPeriod()">Retirer ‚ûñ</button>
                </div>

                <div style="height:10px;"></div>

                <span class="label">Ajouter au catalogue</span>
                <div class="grid2" style="grid-template-columns: 1fr auto; gap:10px;">
                  <input id="newCatalogMission" placeholder="Ex : Inventaire VSAV" />
                  <button class="btnGhost" type="button" onclick="addMissionToCatalog()">Ajouter</button>
                </div>

                <div class="btnRow" style="margin-top:10px;">
                  <button class="btnGhost" type="button" onclick="deleteSelectedFromCatalog()">Supprimer du catalogue</button>
                  <button class="btnGhost" type="button" onclick="resetPeriodMissions()">Vider p√©riode</button>
                </div>

                <div class="hint">La p√©riode est celle s√©lectionn√©e en haut (mois/ann√©e).</div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="footer">¬© Centre de secours ‚Ä¢ Prototype web (GitHub Pages)</div>
  </div>

  <script>
    // ===================== CONFIG =====================
    const ADMIN_CODE = "1234";
    const LS_KEY = "consenvoye_entretien_v2";

    // ===================== STATE =====================
    const state = loadState();

    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return { agents: [], catalogMissions: [], missionsByPeriod: {} };
        const parsed = JSON.parse(raw);
        return {
          agents: Array.isArray(parsed.agents) ? parsed.agents : [],
          catalogMissions: Array.isArray(parsed.catalogMissions) ? parsed.catalogMissions : [],
          missionsByPeriod: (parsed.missionsByPeriod && typeof parsed.missionsByPeriod === "object") ? parsed.missionsByPeriod : {}
        };
      }catch(e){
        return { agents: [], catalogMissions: [], missionsByPeriod: {} };
      }
    }

    function saveState(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
      renderAll();
    }

    function normalize(s){
      return (s || "").trim().replace(/\s+/g, " ");
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ===================== PERIOD =====================
    function periodKey(){
      const mois = document.getElementById("mois").value;
      const annee = document.getElementById("annee").value;
      if(!mois || !annee) return "";
      return `${annee}-${mois}`;
    }

    function renderPeriodPill(){
      const pill = document.getElementById("periodPill");
      const key = periodKey();
      pill.textContent = key ? key : "S√©lectionner mois + ann√©e";
    }

    // ===================== TABS =====================
    function showTab(tab) {
      const tabs = document.querySelectorAll('.tab');
      const contents = document.querySelectorAll('.content');

      tabs.forEach(t => { t.classList.remove('active'); t.setAttribute('aria-selected','false'); });
      contents.forEach(c => c.classList.remove('active'));

      if (tab === 'agent') {
        tabs[0].classList.add('active'); tabs[0].setAttribute('aria-selected','true');
      } else {
        tabs[1].classList.add('active'); tabs[1].setAttribute('aria-selected','true');
      }
      document.getElementById(tab).classList.add('active');

      // Nettoyage minimal visuel quand on quitte admin
      if(tab !== 'admin'){
        const codeEl = document.getElementById('codeAdmin');
        const zoneEl = document.getElementById('adminZone');
        if(codeEl) codeEl.value = "";
        if(zoneEl) zoneEl.style.display = "none";
      }
    }

    // ===================== ADMIN LOCK =====================
    function unlockAdmin(){
      const code = document.getElementById("codeAdmin").value;
      if(code === ADMIN_CODE){
        document.getElementById("adminZone").style.display = "block";
        renderAll();
      }else{
        alert("Code incorrect");
      }
    }

    // ===================== AGENTS =====================
    function generateAgentCode(){
      // 4 chiffres
      const n = Math.floor(Math.random() * 9000) + 1000;
      return String(n);
    }

    function addAgent(){
      const name = normalize(document.getElementById("agentNom").value);
      const statut = document.getElementById("agentStatut").value;

      if(!name) return;

      // pas de doublon exact
      if(state.agents.some(a => a.name === name)){
        document.getElementById("agentNom").value = "";
        return;
      }

      state.agents.push({
        id: cryptoRandomId(),
        name,
        role: statut, // "equipier" | "responsable"
        code: generateAgentCode()
      });

      document.getElementById("agentNom").value = "";
      saveState();
    }

    function cryptoRandomId(){
      // id simple
      return (Math.random().toString(16).slice(2) + Date.now().toString(16)).slice(0,16);
    }

    function sortAgents(){
      state.agents.sort((a,b)=>a.name.localeCompare(b.name,"fr",{sensitivity:"base"}));
      saveState();
    }

    function resetAgentCode(id){
      const a = state.agents.find(x=>x.id===id);
      if(!a) return;
      a.code = generateAgentCode();
      saveState();
    }

    function removeAgent(id){
      const idx = state.agents.findIndex(x=>x.id===id);
      if(idx >= 0){
        state.agents.splice(idx,1);
        saveState();
      }
    }

    function renderAgents(){
      const ul = document.getElementById("agentsList");
      const badge = document.getElementById("agentsCount");
      ul.innerHTML = "";
      badge.textContent = String(state.agents.length);

      state.agents.forEach(a=>{
        const li = document.createElement("li");
        li.className = "item";
        const roleLabel = (a.role === "responsable") ? "Responsable d‚Äô√©quipe" : "√âquipier";
        const roleTagClass = (a.role === "responsable") ? "resp" : "eq";

        li.innerHTML = `
          <div class="itemLeft">
            <div class="name">${escapeHtml(a.name)}</div>
            <div class="meta">
              <span class="tag ${roleTagClass}">üë§ ${escapeHtml(roleLabel)}</span>
              <span class="tag">üîë Code : <b style="color:var(--text)">${escapeHtml(a.code)}</b></span>
            </div>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
            <button class="smallBtn" type="button">R√©init. code</button>
            <button class="smallBtn danger" type="button">Supprimer</button>
          </div>
        `;
        const btnReset = li.querySelectorAll("button")[0];
        const btnDel = li.querySelectorAll("button")[1];

        btnReset.addEventListener("click", ()=> resetAgentCode(a.id));
        btnDel.addEventListener("click", ()=> removeAgent(a.id));

        ul.appendChild(li);
      });
    }

    // ===================== AGENT LOGIN UI =====================
    let agentSession = null;

    function renderAgentSelect(){
      const sel = document.getElementById("agentSelect");
      sel.innerHTML = "";

      if(state.agents.length === 0){
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "-- Aucun agent --";
        sel.appendChild(opt);
        return;
      }

      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "-- Choisir votre nom --";
      sel.appendChild(opt0);

      state.agents
        .slice()
        .sort((a,b)=>a.name.localeCompare(b.name,"fr",{sensitivity:"base"}))
        .forEach(a=>{
          const opt = document.createElement("option");
          opt.value = a.id;
          opt.textContent = a.name;
          sel.appendChild(opt);
        });
    }

    function agentLogin(){
      const id = document.getElementById("agentSelect").value;
      const code = document.getElementById("agentCode").value;

      const a = state.agents.find(x=>x.id===id);
      if(!a){
        alert("S√©lectionne ton nom.");
        return;
      }
      if(!code){
        alert("Entre ton code.");
        return;
      }
      if(code !== a.code){
        alert("Code incorrect.");
        return;
      }

      agentSession = { id: a.id, name: a.name, role: a.role };
      document.getElementById("agentArea").style.display = "block";
      document.getElementById("agentNamePill").textContent = a.name;
      document.getElementById("agentCode").value = "";
      document.getElementById("agentLockPill").className = "pill ok";
      document.getElementById("agentLockPill").textContent = "Connect√©";
      document.getElementById("agentInfo").textContent =
        "Connexion OK. (√âtape suivante : afficher uniquement les p√©riodes attribu√©es + missions.)";
    }

    function agentLogout(){
      agentSession = null;
      document.getElementById("agentArea").style.display = "none";
      document.getElementById("agentSelect").value = "";
      document.getElementById("agentCode").value = "";
      document.getElementById("agentLockPill").className = "pill";
      document.getElementById("agentLockPill").textContent = "Acc√®s restreint";
    }

    // ===================== MISSIONS (catalogue + p√©riode + qty) =====================
    function getPeriodList(){
      const key = periodKey();
      if(!key) return [];
      const raw = state.missionsByPeriod[key];
      if(Array.isArray(raw)) return raw;
      return [];
    }

    function setPeriodList(list){
      const key = periodKey();
      if(!key) return;
      state.missionsByPeriod[key] = list;
    }

    function renderCatalog(){
      const sel = document.getElementById("catalogSelect");
      const badge = document.getElementById("catalogCount");
      sel.innerHTML = "";

      const catalog = state.catalogMissions.slice().sort((a,b)=>a.localeCompare(b,"fr",{sensitivity:"base"}));
      badge.textContent = String(catalog.length);

      if(catalog.length === 0){
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "-- Catalogue vide --";
        sel.appendChild(opt);
        return;
      }

      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "-- Choisir une mission --";
      sel.appendChild(opt0);

      catalog.forEach(m=>{
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        sel.appendChild(opt);
      });
    }

    function renderPeriodMissions(){
      const ul = document.getElementById("periodMissionsList");
      const badge = document.getElementById("periodCount");
      const countPill = document.getElementById("missionsCountPill");

      ul.innerHTML = "";

      const key = periodKey();
      if(!key){
        badge.textContent = "0";
        countPill.textContent = "0";
        return;
      }

      const list = getPeriodList();
      badge.textContent = String(list.length);
      countPill.textContent = String(list.length);

      list.forEach((item)=>{
        const li = document.createElement("li");
        li.className = "item";
        li.innerHTML = `
          <div class="itemLeft">
            <div class="name">${escapeHtml(item.name)}</div>
            <div class="meta"><span class="tag">üìå P√©riode : <b style="color:var(--text)">${escapeHtml(key)}</b></span></div>
          </div>
          <div class="qtyBox">
            <button class="smallBtn" type="button">‚àí</button>
            <div class="qty">${item.qty}</div>
            <button class="smallBtn" type="button">+</button>
          </div>
        `;
        const minus = li.querySelectorAll("button")[0];
        const plus = li.querySelectorAll("button")[1];

        minus.addEventListener("click", ()=> changeQty(item.name, -1));
        plus.addEventListener("click", ()=> changeQty(item.name, +1));

        ul.appendChild(li);
      });
    }

    function addMissionToCatalog(){
      const inp = document.getElementById("newCatalogMission");
      const name = normalize(inp.value);
      if(!name) return;

      if(!state.catalogMissions.includes(name)){
        state.catalogMissions.push(name);
      }
      inp.value = "";
      saveState();
    }

    function deleteSelectedFromCatalog(){
      const sel = document.getElementById("catalogSelect");
      const name = sel.value;
      if(!name) return;

      state.catalogMissions = state.catalogMissions.filter(x => x !== name);
      saveState();
    }

    function addSelectedMissionToPeriod(){
      const key = periodKey();
      if(!key){
        alert("S√©lectionne d'abord le mois et l'ann√©e.");
        return;
      }
      const sel = document.getElementById("catalogSelect");
      const name = sel.value;
      if(!name) return;

      const list = getPeriodList().slice();
      const idx = list.findIndex(x => x.name === name);
      if(idx >= 0){
        list[idx].qty += 1;
      }else{
        list.push({ name, qty: 1 });
      }
      setPeriodList(list);
      saveState();
    }

    function removeSelectedMissionFromPeriod(){
      const key = periodKey();
      if(!key){
        alert("S√©lectionne d'abord le mois et l'ann√©e.");
        return;
      }
      const sel = document.getElementById("catalogSelect");
      const name = sel.value;
      if(!name) return;

      changeQty(name, -1);
    }

    function changeQty(name, delta){
      const key = periodKey();
      if(!key) return;

      const list = getPeriodList().slice();
      const idx = list.findIndex(x => x.name === name);
      if(idx < 0) return;

      list[idx].qty += delta;
      if(list[idx].qty <= 0){
        list.splice(idx, 1);
      }
      setPeriodList(list);
      saveState();
    }

    function resetPeriodMissions(){
      const key = periodKey();
      if(!key){
        alert("S√©lectionne d'abord le mois et l'ann√©e.");
        return;
      }
      setPeriodList([]);
      saveState();
    }

    // ===================== RENDER ALL =====================
    function renderAll(){
      renderPeriodPill();
      renderAgents();
      renderAgentSelect();
      renderCatalog();
      renderPeriodMissions();
    }

    // events p√©riode
    document.getElementById("mois").addEventListener("change", ()=> { renderAll(); });
    document.getElementById("annee").addEventListener("change", ()=> { renderAll(); });

    // init
    renderAll();
  </script>
</body>
</html>
