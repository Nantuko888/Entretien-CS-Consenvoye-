<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Entretien CS Consenvoye</title>

  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1724; --panel2:#111b2b;
      --stroke:rgba(255,255,255,.12);
      --text:#e8eef9; --muted:rgba(232,238,249,.72);
      --accent:#ff7a00; --accent2:#ffb000;
      --danger:#ff3b30; --ok:#1fd36b;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --r:18px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial, "Noto Sans", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:var(--font);color:var(--text);
      background:
        radial-gradient(900px 420px at 20% 20%, rgba(255,122,0,.18), transparent 65%),
        radial-gradient(900px 420px at 80% 10%, rgba(255,176,0,.12), transparent 60%),
        linear-gradient(180deg, #06080b, var(--bg));
      min-height:100vh;
      overflow-x:hidden;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:22px 14px 46px}
    h1{margin:0;font-size:30px;font-weight:900;letter-spacing:.2px;color:#ff8d1a;text-shadow:0 2px 14px rgba(255,122,0,.18);text-align:center;}
    .subtitle{margin:6px 0 0;color:var(--muted);font-size:12px;text-align:center}

    .tabsCenter{margin:14px 0 18px;display:flex;justify-content:center;}
    .tabs{display:flex;gap:8px;align-items:center;border:1px solid var(--stroke);background:rgba(255,255,255,.02);padding:6px;border-radius:999px;box-shadow:var(--shadow);}
    .tab{border:0;background:transparent;color:var(--muted);padding:10px 14px;border-radius:999px;cursor:pointer;font-weight:900;font-size:13px;}
    .tab.active{background:linear-gradient(90deg, rgba(255,122,0,.26), rgba(255,176,0,.18));color:var(--text);}

    .btn{appearance:none;border:1px solid var(--stroke);background:rgba(255,255,255,.03);color:var(--text);border-radius:999px;padding:10px 14px;cursor:pointer;font-weight:900;font-size:13px;transition:.15s transform ease,.15s background ease,.15s border-color ease;white-space:nowrap;}
    .btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.2);background:rgba(255,255,255,.06)}
    .btn.primary{background:linear-gradient(90deg, var(--accent), var(--accent2));border-color:transparent;color:#0b0f14;box-shadow:0 12px 26px rgba(255,122,0,.18);}
    .btn.ghost{background:rgba(255,255,255,.03)}
    .btn.danger{background:rgba(255,59,48,.14);border-color:rgba(255,59,48,.35);color:#ffd0cd}
    .btn.small{padding:8px 12px;font-size:12px}
    .btn.loading,.btn.primary.loading{
      background: linear-gradient(90deg, #1fd36b, #7dff9c) !important;
      border-color: transparent !important;
      color:#0b0f14 !important;
      box-shadow: 0 12px 26px rgba(31,211,107,.18) !important;
      cursor: wait !important;
      opacity: 0.95;
    }
    .btn.loading::after{content:" ‚è≥";font-weight:900;}
    .btn[disabled]{opacity:.6;cursor:not-allowed}

    .card{border:1px solid var(--stroke);background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));border-radius:var(--r);padding:16px;box-shadow:var(--shadow);}
    .headRow{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;flex-wrap:wrap}
    .h2{margin:0;font-size:15px;font-weight:900}
    .status{font-size:12px;font-weight:900;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.02);color:var(--muted);display:inline-flex;align-items:center;gap:8px;white-space:nowrap;}
    .status.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.10);color:#bdf6d2}
    .status.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.10);color:#ffd0cd}

    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
    input, select, textarea{width:100%;padding:11px 12px;border-radius:12px;border:1px solid var(--stroke);background:rgba(0,0,0,.25);color:var(--text);outline:none;font-size:13px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .row > *{flex:1;min-width:220px}
    .right{display:flex;justify-content:flex-end;gap:8px;align-items:center}
    .divider{height:1px;background:rgba(255,255,255,.09);margin:14px 0}

    .twoCol{display:grid;gap:12px}
    @media(min-width:1000px){ .twoCol{grid-template-columns: 1fr 1fr;} }

    .scrollBox{
      max-height:260px;
      overflow:auto;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.18);
    }
    .listItem{
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08)
    }
    .listItem:last-child{border-bottom:0}
    .listLeft{min-width:0}
    .listTitle{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .listSub{font-size:12px;color:rgba(232,238,249,.6)}
    .pillRow{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .toast{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);background:rgba(255,255,255,.02);color:var(--muted);font-size:13px;display:none}
    .toast.show{display:block}
    .toast.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.08);color:#c9f9db}
    .toast.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.08);color:#ffd0cd}

    /* Overlay mission accomplie */
    .overlay{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background:rgba(0,0,0,.72);z-index:9999;padding:16px;
    }
    .overlay.show{display:flex}
    .overlayCard{
      max-width:min(520px, 92vw);
      border-radius:22px;overflow:hidden;
      border:1px solid rgba(255,255,255,.16);
      box-shadow:0 20px 60px rgba(0,0,0,.55);
      background:#000;
    }
    .overlayCard img{display:block;width:100%;height:auto}
    .overlayHint{padding:10px 12px;color:rgba(255,255,255,.75);font-size:12px;text-align:center;background:rgba(0,0,0,.35)}
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Entretien du centre de secours de Consenvoye</h1>
    <div class="subtitle">Agent : saisie ‚Ä¢ Admin : configuration</div>

    <div class="tabsCenter">
      <div class="tabs">
        <button class="tab active" id="tabAgents" onclick="showViews('agents')">üßë‚Äçüöí Agent</button>
        <button class="tab" id="tabAdmins" onclick="showViews('admins')">üõ°Ô∏è Admin</button>
        <button class="btn" onclick="bootstraps()">Recharger</button>
      </div>
    </div>

    <!-- =================== AGENTS =================== -->
    <div id="viewAgents" class="card">
      <div class="headRow">
        <div class="h2">Espace agent</div>
        <div class="right">
          <button class="btn small" id="btnAgentsKey" style="display:none" onclick="toggleAgentsKey()">üîë</button>
          <button class="btn small danger" id="btnAgentsLogout" style="display:none" onclick="agentsLogouts()">D√©connexion</button>
          <div class="status" id="pillAgentsStatus">Agent : non connect√©</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Agent</label>
          <select id="agentsSel"></select>
        </div>
        <div>
          <label>Code</label>
          <input id="agentsCode" placeholder="Code agent" />
        </div>
        <div class="right">
          <button class="btn primary" id="btnAgentsLogin" onclick="agentsLogins(event)">Se connecter</button>
        </div>
      </div>
      <div id="toastAgentsLogin" class="toast"></div>

      <!-- changement code (ic√¥ne üîë) -->
      <div id="boxAgentsKey" style="display:none;margin-top:12px">
        <div class="divider"></div>
        <div class="h2" style="margin:0 0 8px 0">Changer mon code</div>
        <div class="row">
          <div>
            <label>Ancien code</label>
            <input id="agentsOldCode" placeholder="Ancien code" />
          </div>
          <div>
            <label>Nouveau code (min 4)</label>
            <input id="agentsNewCode" placeholder="Nouveau code" />
          </div>
          <div class="right">
            <button class="btn primary" id="btnAgentsChangePwd" onclick="agentsChangePasswords(event)">Valider</button>
          </div>
        </div>
        <div id="toastAgentsChangePwd" class="toast"></div>
      </div>

      <!-- travail agent -->
      <div id="boxAgentsWork" style="display:none;margin-top:14px">
        <div class="divider"></div>

        <div class="row">
          <div>
            <label>P√©riode</label>
            <select id="agentsPeriodsSel"></select>
          </div>
          <div class="right">
            <button class="btn primary" id="btnAgentsLoadPeriod" onclick="agentsLoadPeriods(event)">Charger</button>
          </div>
        </div>
        <div id="toastAgentsPeriod" class="toast"></div>

        <div class="divider"></div>

        <div class="h2" style="margin:0 0 8px 0">Missions du mois</div>
        <div class="scrollBox" id="boxAgentsMissions"></div>

        <div class="divider"></div>

        <label>Remarque g√©n√©rale (facultatif)</label>
        <textarea id="agentsRemark" rows="3" placeholder="Remarque g√©n√©rale..."></textarea>

        <div class="right" style="margin-top:10px">
          <button class="btn primary" id="btnAgentsSave" onclick="agentsSaves(event)">Enregistrer</button>
        </div>
        <div id="toastAgentsSave" class="toast"></div>
      </div>
    </div>

    <!-- =================== ADMINS =================== -->
    <div id="viewAdmins" class="card" style="display:none">
      <div class="headRow">
        <div class="h2">Espace admin</div>
        <div class="right">
          <button class="btn small" id="btnAdminsKey" style="display:none" onclick="toggleAdminsKey()">üîë</button>
          <button class="btn small danger" id="btnAdminsLogout" style="display:none" onclick="adminsLogouts()">D√©connexion</button>
          <div class="status" id="pillAdminsStatus">Admin : non connect√©</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Code admin</label>
          <input id="adminsCode" placeholder="Code admin" />
        </div>
        <div class="right">
          <button class="btn primary" id="btnAdminsLogin" onclick="adminsLogins(event)">Se connecter</button>
        </div>
      </div>
      <div id="toastAdminsLogin" class="toast"></div>

      <!-- changement code admin (ic√¥ne üîë) -->
      <div id="boxAdminsKey" style="display:none;margin-top:12px">
        <div class="divider"></div>
        <div class="h2" style="margin:0 0 8px 0">Changer le code admin</div>
        <div class="row">
          <div>
            <label>Ancien code</label>
            <input id="adminsOldCode" placeholder="Ancien code" />
          </div>
          <div>
            <label>Nouveau code (min 4)</label>
            <input id="adminsNewCode" placeholder="Nouveau code" />
          </div>
          <div class="right">
            <button class="btn primary" id="btnAdminsChangePwd" onclick="adminsChangePasswords(event)">Valider</button>
          </div>
        </div>
        <div id="toastAdminsChangePwd" class="toast"></div>
      </div>

      <!-- Work area -->
      <div id="boxAdminsWork" style="display:none;margin-top:14px">
        <div class="divider"></div>

        <div class="twoCol">
          <!-- Agents -->
          <div class="card">
            <div class="headRow"><div class="h2">üë• Agents</div></div>
            <div class="row">
              <div>
                <label>Nom</label>
                <input id="adminsNewAgentName" placeholder="Nom Pr√©nom" />
              </div>
              <div>
                <label>Code</label>
                <input id="adminsNewAgentCode" placeholder="0000" value="0000" />
              </div>
              <div class="right">
                <button class="btn primary" id="btnAdminsAddAgent" onclick="adminsAddAgents(event)">Ajouter</button>
              </div>
            </div>
            <div id="toastAdminsAgents" class="toast"></div>
            <div class="divider"></div>
            <div class="scrollBox" id="boxAdminsAgents"></div>
          </div>

          <!-- Catalogue missions -->
          <div class="card">
            <div class="headRow"><div class="h2">üìö Catalogue missions</div></div>
            <div class="row">
              <div>
                <label>Libell√©</label>
                <input id="adminsNewMissionLib" placeholder="Ex : Nettoyage" />
              </div>
              <div class="right">
                <button class="btn primary" id="btnAdminsAddMission" onclick="adminsAddMissions(event)">Ajouter</button>
              </div>
            </div>
            <div id="toastAdminsMissions" class="toast"></div>
            <div class="divider"></div>
            <div class="scrollBox" id="boxAdminsMissions"></div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="twoCol">
          <!-- P√©riode / Groupe / Responsable -->
          <div class="card">
            <div class="headRow">
              <div class="h2">P√©riode / Groupe / Responsable</div>
              <div class="status" id="pillResponsable">Responsable : ‚Äî</div>
            </div>

            <div class="row">
              <div>
                <label>P√©riode</label>
                <select id="adminsPeriodsSel"></select>
              </div>
              <div class="right">
                <button class="btn primary" id="btnAdminsLoadPeriod" onclick="adminsLoadPeriods(event)">Charger</button>
              </div>
            </div>
            <div id="toastAdminsPeriod" class="toast"></div>

            <div class="divider"></div>

            <div class="row">
              <div>
                <label>Ajouter au groupe</label>
                <select id="adminsAddToGroupsSel"></select>
              </div>
              <div class="right">
                <button class="btn primary" id="btnAdminsAddToGroup" onclick="adminsAddToGroups(event)">Ajouter</button>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>Responsable (doit √™tre dans le groupe)</label>
                <select id="adminsResponsablesSel"></select>
              </div>
              <div class="right">
                <button class="btn primary" id="btnAdminsSetResponsable" onclick="adminsSetResponsables(event)">D√©finir</button>
              </div>
            </div>

            <div class="divider"></div>
            <div class="scrollBox" id="boxAdminsGroup"></div>
          </div>

          <!-- Missions actives / Retours -->
          <div class="card">
            <div class="headRow"><div class="h2">Missions actives (par p√©riode)</div></div>

            <div class="row">
              <div class="right" style="width:100%">
                <button class="btn" id="btnAdminsLoadActive" onclick="adminsLoadActiveMissions(event)">Charger</button>
                <button class="btn primary" id="btnAdminsSaveActive" onclick="adminsSaveActiveMissions(event)">Enregistrer</button>
              </div>
            </div>
            <div id="toastAdminsActive" class="toast"></div>
            <div class="divider"></div>
            <div class="scrollBox" id="boxAdminsActiveMissions"></div>

            <div class="divider"></div>

            <div class="headRow"><div class="h2">Retours (Partiel / Non fait)</div></div>
            <div class="row">
              <div class="right" style="width:100%">
                <button class="btn" id="btnAdminsLoadRetours" onclick="adminsLoadRetours(event)">Charger retours</button>
              </div>
            </div>
            <div id="toastAdminsRetours" class="toast"></div>
            <div class="divider"></div>
            <div class="scrollBox" id="boxAdminsRetours"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- overlay mission accomplie -->
  <div class="overlay" id="doneOverlay">
    <div class="overlayCard">
      <img id="doneImg" alt="Missions accomplies" />
      <div class="overlayHint">Double-clic / double-tap pour fermer</div>
    </div>
  </div>

<script>
/* ==========================================================
   CONFIG
   ========================================================== */

// ‚úÖ COLLE ICI TON URL /exec Apps Script (IMPORTANT)
const API_EXEC = "COLLE_ICI_TON_URL_EXEC";

/* ==========================================================
   STATE
   ========================================================== */
const STATE = {
  admins:{ ok:false, code:"" },
  agents:{ ok:false, agent_id:"", name:"", must_change:false },
  current:{ period_id:"" },
  data:{
    agents_public:[],
    agents:[],
    catalog:[],
    periods:[],
    group:[],
    active_missions_all:[],
    active_missions_on:[],
    agent_periods:[],
    agent_work:[]
  }
};

/* ==========================================================
   UI helpers
   ========================================================== */
function $(id){ return document.getElementById(id); }
function esc(s){ return String(s ?? "").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function showViews(which){
  $("tabAgents").classList.toggle("active", which==="agents");
  $("tabAdmins").classList.toggle("active", which==="admins");
  $("viewAgents").style.display = which==="agents" ? "" : "none";
  $("viewAdmins").style.display = which==="admins" ? "" : "none";
}
function showToast(id,msg,ok){
  const el=$(id); if(!el) return;
  el.className="toast show "+(ok?"ok":"bad");
  el.textContent=msg||"";
}
function hideToast(id){
  const el=$(id); if(!el) return;
  el.className="toast"; el.textContent="";
}
function setPill(id,text,kind){
  const el=$(id); if(!el) return;
  el.textContent=text;
  el.className="status "+(kind==="ok"?"ok":kind==="bad"?"bad":"");
}
function setLoading(btn,on){
  if(!btn) return;
  btn.classList.toggle("loading", !!on);
  btn.disabled = !!on;
}

/* ==========================================================
   JSONP (GitHub ‚Üí Apps Script)
   ========================================================== */
function apiJsonp(action, params){
  return new Promise((resolve,reject)=>{
    if(!API_EXEC || API_EXEC.includes("COLLE_ICI")){
      reject(new Error("API_EXEC_missing")); return;
    }
    const cb = "CB_"+action+"_"+Date.now()+"_"+Math.floor(Math.random()*1e6);
    window[cb] = (data)=>{ try{ delete window[cb]; }catch(e){}; resolve(data); };
    const url = new URL(API_EXEC);
    url.searchParams.set("action", action);
    url.searchParams.set("callback", cb);
    // params
    Object.entries(params||{}).forEach(([k,v])=>{
      if(v===undefined || v===null) return;
      url.searchParams.set(k, String(v));
    });

    const s = document.createElement("script");
    s.src = url.toString();
    s.onerror = ()=>{ try{ delete window[cb]; }catch(e){}; reject(new Error("jsonp_error")); };
    document.head.appendChild(s);
    // cleanup later
    setTimeout(()=>{ try{ document.head.removeChild(s); }catch(e){}; }, 5000);
  });
}

/* ==========================================================
   BOOTSTRAP (public agents list)
   ========================================================== */
async function bootstraps(){
  // recharge liste agents public
  await agentsBootstraps();
  // si admin connect√©, recharge son dashboard
  if(STATE.admins.ok){
    await adminsBootstraps();
  }
}

async function agentsBootstraps(){
  // liste publique: agents actifs
  try{
    const res = await apiJsonp("listAgentsPublic", {});
    if(!res || !res.ok) throw new Error(res && res.message || "bad");
    STATE.data.agents_public = res.agents || [];
    renderAgentsPublic();
  }catch(e){
    STATE.data.agents_public = [];
    $("agentsSel").innerHTML = `<option value="">‚Äî Erreur chargement ‚Äî</option>`;
  }
}

function renderAgentsPublic(){
  const sel = $("agentsSel");
  sel.innerHTML = `<option value="">‚Äî Choisir agent ‚Äî</option>` +
    (STATE.data.agents_public||[]).map(a=>`<option value="${esc(a.agent_id)}">${esc(a.name)}</option>`).join("");
}

/* ==========================================================
   AGENT
   ========================================================== */
function toggleAgentsKey(){
  const box=$("boxAgentsKey");
  box.style.display = (box.style.display==="none"||!box.style.display) ? "" : "none";
}
async function agentsLogins(ev){
  hideToast("toastAgentsLogin");
  const btn = ev?.target || $("btnAgentsLogin");
  const agent_id = $("agentsSel").value;
  const code = $("agentsCode").value.trim();
  if(!agent_id || !code){ showToast("toastAgentsLogin","S√©lection + code requis.", false); return; }

  setLoading(btn,true);
  try{
    const res = await apiJsonp("agentLogin", { agent_id, code });
    if(!res || !res.ok){
      setPill("pillAgentsStatus","Agent : non connect√©","bad");
      showToast("toastAgentsLogin", (res&&res.message)||"Code incorrect", false);
      STATE.agents = { ok:false, agent_id:"", name:"", must_change:false };
      $("btnAgentsKey").style.display="none";
      $("btnAgentsLogout").style.display="none";
      $("boxAgentsWork").style.display="none";
      return;
    }

    STATE.agents.ok = true;
    STATE.agents.agent_id = res.agent.agent_id;
    STATE.agents.name = res.agent.name;
    STATE.agents.must_change = !!res.agent.must_change;

    setPill("pillAgentsStatus","Agent : "+STATE.agents.name,"ok");
    showToast("toastAgentsLogin","Connect√© ‚úÖ", true);
    $("btnAgentsLogout").style.display="";
    $("btnAgentsKey").style.display="";

    // must change code => ouvre la box üîë automatiquement
    $("boxAgentsKey").style.display = STATE.agents.must_change ? "" : "none";

    // p√©riodes
    const periods = res.periods || [];
    STATE.data.agent_periods = periods;
    $("agentsPeriodsSel").innerHTML =
      `<option value="">‚Äî Choisir p√©riode ‚Äî</option>` +
      periods.map(p=>`<option value="${esc(p.period_id)}">${esc(p.label)}</option>`).join("");

    $("boxAgentsWork").style.display="";
    // reset zone missions
    $("boxAgentsMissions").innerHTML = `<div class="listItem"><div class="listLeft"><div class="listSub">Choisis une p√©riode puis ‚ÄúCharger‚Äù.</div></div></div>`;
  }catch(e){
    showToast("toastAgentsLogin","Erreur r√©seau.", false);
  }finally{
    setLoading(btn,false);
  }
}

async function agentsLogouts(){
  STATE.agents = { ok:false, agent_id:"", name:"", must_change:false };
  STATE.current.period_id = "";
  setPill("pillAgentsStatus","Agent : non connect√©","bad");
  $("btnAgentsLogout").style.display="none";
  $("btnAgentsKey").style.display="none";
  $("boxAgentsKey").style.display="none";
  $("boxAgentsWork").style.display="none";
  hideToast("toastAgentsLogin");
  hideToast("toastAgentsSave");
  hideToast("toastAgentsPeriod");
}

async function agentsChangePasswords(ev){
  hideToast("toastAgentsChangePwd");
  const btn = ev?.target || $("btnAgentsChangePwd");
  if(!STATE.agents.ok){ showToast("toastAgentsChangePwd","Non connect√©.",false); return; }
  const old_code = $("agentsOldCode").value.trim();
  const new_code = $("agentsNewCode").value.trim();
  if(!old_code || !new_code){ showToast("toastAgentsChangePwd","Ancien + nouveau requis.",false); return; }
  setLoading(btn,true);
  try{
    const res = await apiJsonp("agentChangeCode", { agent_id: STATE.agents.agent_id, old_code, new_code });
    if(!res || !res.ok){
      showToast("toastAgentsChangePwd",(res&&res.message)||"Erreur",false); return;
    }
    showToast("toastAgentsChangePwd","Code modifi√© ‚úÖ",true);
    STATE.agents.must_change = false;
    $("agentsOldCode").value=""; $("agentsNewCode").value="";
    $("boxAgentsKey").style.display="none";
  }catch(e){
    showToast("toastAgentsChangePwd","Erreur r√©seau",false);
  }finally{
    setLoading(btn,false);
  }
}

async function agentsLoadPeriods(ev){
  hideToast("toastAgentsPeriod");
  const btn = ev?.target || $("btnAgentsLoadPeriod");
  if(!STATE.agents.ok){ showToast("toastAgentsPeriod","Non connect√©.",false); return; }
  const period_id = $("agentsPeriodsSel").value;
  if(!period_id){ showToast("toastAgentsPeriod","Choisis une p√©riode.",false); return; }

  setLoading(btn,true);
  try{
    const res = await apiJsonp("agentLoadPeriod", { agent_id: STATE.agents.agent_id, period_id });
    if(!res || !res.ok){
      showToast("toastAgentsPeriod",(res&&res.message)||"Erreur",false); return;
    }
    STATE.current.period_id = period_id;
    STATE.data.agent_work = res.missions || [];
    $("agentsRemark").value = res.remark || "";

    renderAgentMissions(STATE.data.agent_work);
    showToast("toastAgentsPeriod","Charg√© ‚úÖ",true);
  }catch(e){
    showToast("toastAgentsPeriod","Erreur r√©seau",false);
  }finally{
    setLoading(btn,false);
  }
}

function renderAgentMissions(list){
  const box = $("boxAgentsMissions");
  if(!list || !list.length){
    box.innerHTML = `<div class="listItem"><div class="listLeft"><div class="listSub">Aucune mission active pour cette p√©riode.</div></div></div>`;
    return;
  }
  box.innerHTML = list.map(m=>{
    const checked = m.declaration==="Fait";
    return `
      <div class="listItem">
        <div class="listLeft" style="min-width:0">
          <div class="listTitle">${esc(m.label)}</div>
          <div class="listSub">${esc(m.declaration||"‚Äî")}${m.justificatif ? " ‚Ä¢ "+esc(m.justificatif) : ""}</div>
        </div>
        <div class="pillRow">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
            <input type="checkbox" data-mid="${esc(m.mission_id)}" ${checked?"checked":""} style="width:18px;height:18px" />
            <span class="listSub">Fait</span>
          </label>
          <select data-mid="${esc(m.mission_id)}" class="agentDecl" style="min-width:160px">
            <option value="">‚Äî</option>
            <option value="Fait" ${m.declaration==="Fait"?"selected":""}>Fait</option>
            <option value="Partiel" ${m.declaration==="Partiel"?"selected":""}>Partiel</option>
            <option value="Non fait" ${m.declaration==="Non fait"?"selected":""}>Non fait</option>
          </select>
        </div>
      </div>
      <div class="listItem" style="border-top:1px solid rgba(255,255,255,.06)">
        <div class="listLeft" style="min-width:0">
          <div class="listSub">Justificatif (si Partiel / Non fait)</div>
          <input data-mid="${esc(m.mission_id)}" class="agentJustif" placeholder="Justificatif..." value="${esc(m.justificatif||"")}" />
        </div>
      </div>
    `;
  }).join("");

  // synchro checkbox -> select
  box.querySelectorAll('input[type="checkbox"][data-mid]').forEach(chk=>{
    chk.addEventListener("change", ()=>{
      const mid = chk.getAttribute("data-mid");
      const sel = box.querySelector(`select.agentDecl[data-mid="${CSS.escape(mid)}"]`);
      if(sel){
        sel.value = chk.checked ? "Fait" : (sel.value==="Fait" ? "" : sel.value);
      }
    });
  });
}

async function agentsSaves(ev){
  hideToast("toastAgentsSave");
  const btn = ev?.target || $("btnAgentsSave");
  if(!STATE.agents.ok){ showToast("toastAgentsSave","Non connect√©.",false); return; }
  const period_id = STATE.current.period_id;
  if(!period_id){ showToast("toastAgentsSave","Choisis une p√©riode.",false); return; }

  const box = $("boxAgentsMissions");
  const items = (STATE.data.agent_work||[]).map(m=>{
    const sel = box.querySelector(`select.agentDecl[data-mid="${CSS.escape(String(m.mission_id))}"]`);
    const just = box.querySelector(`input.agentJustif[data-mid="${CSS.escape(String(m.mission_id))}"]`);
    const declaration = sel ? sel.value : "";
    const justificatif = just ? just.value.trim() : "";
    return { mission_id: m.mission_id, declaration, justificatif };
  });

  const remark = $("agentsRemark").value.trim();

  setLoading(btn,true);
  try{
    const res = await apiJsonp("agentSaveDeclarations", {
      agent_id: STATE.agents.agent_id,
      period_id,
      remark,
      items: JSON.stringify(items)
    });
    if(!res || !res.ok){
      showToast("toastAgentsSave",(res&&res.message)||"Erreur",false); return;
    }
    showToast("toastAgentsSave","Enregistr√© ‚úÖ",true);

    // overlay si tout est fait
    const allDone = items.length>0 && items.every(x=>x.declaration==="Fait");
    if(allDone){
      showDoneOverlay();
    }
  }catch(e){
    showToast("toastAgentsSave","Erreur r√©seau",false);
  }finally{
    setLoading(btn,false);
  }
}

/* Overlay image (charg√©e seulement si besoin, donc pas de 404 au chargement) */
function showDoneOverlay(){
  const overlay = $("doneOverlay");
  const img = $("doneImg");
  img.onload = ()=> overlay.classList.add("show");
  img.onerror = ()=> { /* si pas d'image -> fallback simple */ overlay.classList.remove("show"); };
  img.src = "./missions-accomplies.jpg"; // tu pourras l‚Äôajouter plus tard
}
$("doneImg").addEventListener("dblclick", ()=> $("doneOverlay").classList.remove("show"));
(function(){
  let lastTap=0;
  $("doneImg").addEventListener("touchend", ()=>{
    const now=Date.now();
    if(now-lastTap<350){ $("doneOverlay").classList.remove("show"); }
    lastTap=now;
  });
})();

/* ==========================================================
   ADMIN
   ========================================================== */
function toggleAdminsKey(){
  const box=$("boxAdminsKey");
  box.style.display = (box.style.display==="none"||!box.style.display) ? "" : "none";
}

async function adminsLogins(ev){
  hideToast("toastAdminsLogin");
  const btn = ev?.target || $("btnAdminsLogin");
  const code = $("adminsCode").value.trim();
  if(!code){ showToast("toastAdminsLogin","Code requis.",false); return; }

  setLoading(btn,true);
  try{
    const res = await apiJsonp("adminLogin", { code });
    if(!res || !res.ok){
      setPill("pillAdminsStatus","Admin : non connect√©","bad");
      showToast("toastAdminsLogin","Code admin incorrect.",false);
      STATE.admins = { ok:false, code:"" };
      $("boxAdminsWork").style.display="none";
      $("btnAdminsLogout").style.display="none";
      $("btnAdminsKey").style.display="none";
      return;
    }
    STATE.admins.ok=true;
    STATE.admins.code=code;
    setPill("pillAdminsStatus","Admin : connect√© ‚úÖ","ok");
    showToast("toastAdminsLogin","Admin connect√© ‚úÖ",true);
    $("btnAdminsLogout").style.display="";
    $("btnAdminsKey").style.display="";
    $("boxAdminsWork").style.display="";
    await adminsBootstraps();
  }catch(e){
    showToast("toastAdminsLogin","Erreur r√©seau.",false);
  }finally{
    setLoading(btn,false);
  }
}

async function adminsLogouts(){
  STATE.admins = { ok:false, code:"" };
  STATE.current.period_id="";
  setPill("pillAdminsStatus","Admin : non connect√©","bad");
  $("boxAdminsWork").style.display="none";
  $("btnAdminsLogout").style.display="none";
  $("btnAdminsKey").style.display="none";
  $("boxAdminsKey").style.display="none";
  hideToast("toastAdminsLogin");
}

async function adminsChangePasswords(ev){
  hideToast("toastAdminsChangePwd");
  const btn = ev?.target || $("btnAdminsChangePwd");
  if(!STATE.admins.ok){ showToast("toastAdminsChangePwd","Non connect√©.",false); return; }
  const old_code = $("adminsOldCode").value.trim();
  const new_code = $("adminsNewCode").value.trim();
  if(!old_code || !new_code){ showToast("toastAdminsChangePwd","Ancien + nouveau requis.",false); return; }

  setLoading(btn,true);
  try{
    const res = await apiJsonp("adminChangeCode", { admin_code: STATE.admins.code, old_code, new_code });
    if(!res || !res.ok){
      showToast("toastAdminsChangePwd",(res&&res.message)||"Erreur",false); return;
    }
    STATE.admins.code = new_code;
    $("adminsOldCode").value=""; $("adminsNewCode").value="";
    $("boxAdminsKey").style.display="none";
    showToast("toastAdminsChangePwd","Code admin modifi√© ‚úÖ",true);
  }catch(e){
    showToast("toastAdminsChangePwd","Erreur r√©seau",false);
  }finally{
    setLoading(btn,false);
  }
}

async function adminsBootstraps(){
  await Promise.all([
    adminsListPeriods(),
    adminsListAgents(),
    adminsListCatalog()
  ]);
}

/* ----- Admin: Agents ----- */
async function adminsListAgents(){
  const box = $("boxAdminsAgents");
  box.innerHTML = `<div class="listItem"><div class="listLeft"><div class="listSub">Chargement‚Ä¶</div></div></div>`;
  try{
    const res = await apiJsonp("adminListAgents", { admin_code: STATE.admins.code });
    if(!res || !res.ok) throw new Error(res&&res.message||"bad");
    STATE.data.agents = res.agents || [];
    renderAdminsAgents();
    // aussi refresh select add-to-group
    renderAdminsAddToGroupSelect();
  }catch(e){
    box.innerHTML = `<div class="listItem"><div class="listLeft"><div class="listSub">Erreur chargement.</div></div></div>`;
  }
}

function renderAdminsAgents(){
  const box = $("boxAdminsAgents");
  const list = STATE.data.agents || [];
  if(!list.length){
    box.innerHTML = `<div class="listItem"><div class="listLeft"><div class="listSub">Aucun agent.</div></div></div>`;
    return;
  }
  box.innerHTML = list.map(a=>`
    <div class="listItem">
      <div class="listLeft">
        <div class="listTitle">${esc(a.name)}</div>
        <div class="listSub">${a.active ? "Actif ‚úÖ" : "Inactif ‚ùå"}</div>
      </div>
      <div class="pillRow">
        <button class="btn small" onclick="adminsToggleAgents('${esc(a.agent_id)}', ${a.active ? "false":"true"})">${a.active ? "D√©sactiver":"Activer"}</button>
        <button class="btn small" onclick="adminsResetAgentsCodes('${esc(a.agent_id)}')">Reset 0000</button>
        <button class="btn small danger" onclick="adminsDeleteAgents('${esc(a.agent_id)}')">Supprimer</button>
      </div>
    </div>
  `).join("");
}

function renderAdminsAddToGroupSelect(){
  const sel = $("adminsAddToGroupsSel");
  const list = (STATE.data.agents||[]).filter(a=>a.active);
  sel.innerHTML = `<option value="">‚Äî Choisir agent ‚Äî</option>` +
    list.map(a=>`<option value="${esc(a.agent_id)}">${esc(a.name)}</option>`).join("");
}

async function adminsAddAgents(ev){
  hideToast("toastAdminsAgents");
  const btn = ev?.target || $("btnAdminsAddAgent");
  const name = $("adminsNewAgentName").value.trim();
  const code = $("adminsNewAgentCode").value.trim() || "0000";
  if(!name){ showToast("toastAdminsAgents","Nom requis.",false); return; }

  setLoading(btn,true);
  try{
    const res = await apiJsonp("adminAddAgent", { admin_code: STATE.admins.code, name, code });
    if(!res || !res.ok){ showToast("toastAdminsAgents",(res&&res.message)||"Erreur",false); return; }
    showToast("toastAdminsAgents","Agent ajout√© ‚úÖ",true);
    $("adminsNewAgentName").value=""; $("adminsNewAgentCode").value="0000";
    await adminsListAgents();
  }catch(e){
    showToast("toastAdminsAgents","Erreur r√©seau",false);
  }finally{
    setLoading(btn,false);
  }
}

async function adminsToggleAgents(agent_id, active){
  hideToast("toastAdminsAgents");
  try{
    const res = await apiJsonp("adminToggleAgent", { admin_code: STATE.admins.code, agent_id, active: active ? "TRUE":"FALSE" });
    if(!res || !res.ok){ showToast("toastAdminsAgents",(res&&res.message)||"Erreur",false); return; }
    await adminsListAgents();
  }catch(e){
    showToast("toastAdminsAgents","Erreur r√©seau",false);
  }
}
async function adminsResetAgentsCodes(agent_id){
  hideToast("toastAdminsAgents");
  try{
    const res = await apiJsonp("adminResetAgentCode", { admin_code: STATE.admins.code, agent_id });
    if(!res || !res.ok){ showToast("toastAdminsAgents",(res&&res.message)||"Erreur",false); return; }
    showToast("toastAdminsAgents","Code reset ‚úÖ",true);
  }catch(e){
    showToast("toastAdminsAgents","Erreur r√©seau",false);
  }
}
async function adminsDeleteAgents(agent_id){
  if(!confirm("Supprimer d√©finitivement cet agent ?")) return;
  hideToast("toastAdminsAgents");
  try{
    const res = await apiJsonp("adminDeleteAgent", { admin_code: STATE.admins.code, agent_id });
    if(!res || !res.ok){ showToast("toastAdminsAgents",(res&&res.message)||"Erreur",false); return; }
    await adminsListAgents();
  }catch(e){
    showToast("toastAdminsAgents","Erreur r√©seau",false);
  }
}

/* ----- Admin: Catalog ----- */
async function adminsListCatalog(){
  const box = $("boxAdminsMissions");
  box.innerHTML = `<div class="listItem"><div class="listLeft"><div class="listSub">Chargement‚Ä¶</div></div></div>`;
  try{
    const res = await apiJsonp("adminListCatalog", { admin_code: STATE.admins.code });
    if(!res || !res.ok) throw new Error(res&&res.message||"bad");
    STATE.data.catalog = res.catalog || [];
    renderAdminsCatalog();
  }catch(e){
    box.innerHTML = `<div class="listItem"><div class="listLeft"><div class="listSub">Erreur chargement.</div></div></div>`;
  }
}
function renderAdminsCatalog(){
  const box = $("boxAdminsMissions");
  const list = STATE.data.catalog || [];
  if(!list.length){
    box.innerHTML = `<div class="listItem"><div class="listLeft"><div class="listSub">Aucune mission.</div></div></div>`;
    return;
  }
  box.innerHTML = list.map(m=>`
    <div class="listItem">
      <div class="listLeft">
        <div class="listTitle">${esc(m.label)}</div>
        <div class="listSub">${m.active ? "Actif ‚úÖ" : "Inactif ‚ùå"}</div>
      </div>
      <div class="pillRow">
        <button class="btn small" onclick="adminsToggleMissions('${esc(m.mission_id)}', ${m.active?"false":"true"})">${m.active ? "D√©sactiver":"Activer"}</button>
        <button class="btn small danger" onclick="adminsDeleteMissions('${esc(m.mission_id)}')">Supprimer</button>
      </div>
    </div>
  `).join("");
}
async function adminsAddMissions(ev){
  hideToast("toastAdminsMissions");
  const btn = ev?.target || $("btnAdminsAddMission");
  const label = $("adminsNewMissionLib").value.trim();
  if(!label){ showToast("toastAdminsMissions","Libell√© requis.",false); return; }
  setLoading(btn,true);
  try{
    const res = await apiJsonp("adminAddMission", { admin_code: STATE.admins.code, label });
    if(!res || !res.ok){ showToast("toastAdminsMissions",(res&&res.message)||"Erreur",false); return; }
    showToast("toastAdminsMissions","Mission ajout√©e ‚úÖ",true);
    $("adminsNewMissionLib").value="";
    await adminsListCatalog();
  }catch(e){
    showToast("toastAdminsMissions","Erreur r√©seau",false);
  }finally{
    setLoading(btn,false);
  }
}
async function adminsToggleMissions(mission_id, active){
  hideToast("toastAdminsMissions");
  try{
    const res = await apiJsonp("adminToggleMission", { admin_code: STATE.admins.code, mission_id, active: active ? "TRUE":"FALSE" });
    if(!res || !res.ok){ showToast("toastAdminsMissions",(res&&res.message)||"Erreur",false); return; }
    await adminsListCatalog();
  }catch(e){
    showToast("toastAdminsMissions","Erreur r√©seau",false);
  }
}
async function adminsDeleteMissions(mission_id){
  if(!confirm("Supprimer d√©finitivement cette mission ?")) return;
  hideToast("toastAdminsMissions");
  try{
    const res = await apiJsonp("adminDeleteMission", { admin_code: STATE.admins.code, mission_id });
    if(!res || !res.ok){ showToast("toastAdminsMissions",(res&&res.message)||"Erreur",false); return; }
    await adminsListCatalog();
  }catch(e){
    showToast("toastAdminsMissions","Erreur r√©seau",false);
  }
}

/* ----- Admin: Periods + group ----- */
async function adminsListPeriods(){
  const sel = $("adminsPeriodsSel");
  sel.innerHTML = `<option value="">Chargement‚Ä¶</option>`;
  try{
    const res = await apiJsonp("adminListPeriods", { admin_code: STATE.admins.code });
    if(!res || !res.ok) throw new Error("bad");
    STATE.data.periods = res.periods || [];
    sel.innerHTML = `<option value="">‚Äî Choisir une p√©riode ‚Äî</option>` +
      STATE.data.periods.filter(p=>p.active).map(p=>`<option value="${esc(p.period_id)}">${esc(p.label)}</option>`).join("");
  }catch(e){
    sel.innerHTML = `<option value="">‚Äî Erreur ‚Äî</option>`;
  }
}

async function adminsLoadPeriods(ev){
  hideToast("toastAdminsPeriod");
  const btn = ev?.target || $("btnAdminsLoadPeriod");
  const period_id = $("adminsPeriodsSel").value;
  if(!period_id){ showToast("toastAdminsPeriod","Choisis une p√©riode.",false); return; }

  setLoading(btn,true);
  try{
    const res = await apiJsonp("adminLoadPeriod", { admin_code: STATE.admins.code, period_id });
    if(!res || !res.ok){
      showToast("toastAdminsPeriod",(res&&res.message)||"Erreur",false); return;
    }
    STATE.current.period_id = period_id;
    STATE.data.group = res.group || [];
    const responsable_name = res.responsable_name || "‚Äî";
    setPill("pillResponsable","Responsable : "+responsable_name, responsable_name==="‚Äî" ? "" : "ok");
    renderAdminsGroup();
    // responsable select
    const rsel = $("adminsResponsablesSel");
    rsel.innerHTML = `<option value="">‚Äî Choisir ‚Äî</option>` +
      STATE.data.group.map(a=>`<option value="${esc(a.agent_id)}">${esc(a.name)}</option>`).join("");

    showToast("toastAdminsPeriod","P√©riode charg√©e ‚úÖ",true);

    // (ne d√©clenche rien d‚Äôautre ici : plus de guirlande)
  }catch(e){
    showToast("toastAdminsPeriod","Erreur r√©seau",false);
  }finally{
    setLoading(btn,false);
  }
}

function renderAdminsGroup(){
  const box = $("boxAdminsGroup");
  const g = STATE.data.group || [];
  if(!g.length){
    box.innerHTML = `<div class="listItem"><div class="listLeft"><div class="listSub">Aucun groupe charg√©.</div></div></div>`;
    return;
  }
  box.innerHTML = g.map(a=>`
    <div class="listItem">
      <div class="listLeft"><div class="listTitle">${esc(a.name)}</div></div>
      <div class="pillRow"><button class="btn small danger" onclick="adminsRemoveFromGroups('${esc(a.agent_id)}')">Retirer</button></div>
    </div>
  `).join("");
}

async function adminsAddToGroups(ev){
  hideToast("toastAdminsPeriod");
  const btn = ev?.target || $("btnAdminsAddToGroup");
  const period_id = STATE.current.period_id || $("adminsPeriodsSel").value;
  const agent_id = $("adminsAddToGroupsSel").value;
  if(!period_id){ showToast("toastAdminsPeriod","Choisis une p√©riode.",false); return; }
  if(!agent_id){ showToast("toastAdminsPeriod","Choisis un agent.",false); return; }

  setLoading(btn,true);
  try{
    const res = await apiJsonp("adminAddToGroup", { admin_code: STATE.admins.code, period_id, agent_id });
    if(!res || !res.ok){
      showToast("toastAdminsPeriod",(res&&res.message)||"Erreur",false); return;
    }
    // recharge juste la p√©riode (pas d‚Äôautres boutons)
    await adminsLoadPeriods({ target: $("btnAdminsLoadPeriod") });
  }catch(e){
    showToast("toastAdminsPeriod","Erreur r√©seau",false);
  }finally{
    setLoading(btn,false);
  }
}

async function adminsRemoveFromGroups(agent_id){
  hideToast("toastAdminsPeriod");
  const period_id = STATE.current.period_id || $("adminsPeriodsSel").value;
  if(!period_id) return;
  try{
    const res = await apiJsonp("adminRemoveFromGroup", { admin_code: STATE.admins.code, period_id, agent_id });
    if(!res || !res.ok){
      showToast("toastAdminsPeriod",(res&&res.message)||"Erreur",false); return;
    }
    await adminsLoadPeriods({ target: $("btnAdminsLoadPeriod") });
  }catch(e){
    showToast("toastAdminsPeriod","Erreur r√©seau",false);
  }
}

async function adminsSetResponsables(ev){
  hideToast("toastAdminsPeriod");
  const btn = ev?.target || $("btnAdminsSetResponsable");
  const period_id = STATE.current.period_id || $("adminsPeriodsSel").value;
  const agent_id = $("adminsResponsablesSel").value;
  if(!period_id){ showToast("toastAdminsPeriod","Choisis une p√©riode.",false); return; }
  if(!agent_id){ showToast("toastAdminsPeriod","Choisis un responsable.",false); return; }

  setLoading(btn,true);
  try{
    const res = await apiJsonp("adminSetResponsable", { admin_code: STATE.admins.code, period_id, agent_id });
    if(!res || !res.ok){
      showToast("toastAdminsPeriod",(res&&res.message)||"Erreur",false); return;
    }
    await adminsLoadPeriods({ target: $("btnAdminsLoadPeriod") });
  }catch(e){
    showToast("toastAdminsPeriod","Erreur r√©seau",false);
  }finally{
    setLoading(btn,false);
  }
}

/* ----- Admin: active missions per period ----- */
async function adminsLoadActiveMissions(ev){
  hideToast("toastAdminsActive");
  const btn = ev?.target || $("btnAdminsLoadActive");
  const period_id = STATE.current.period_id || $("adminsPeriodsSel").value;
  if(!period_id){ showToast("toastAdminsActive","Charge d‚Äôabord une p√©riode.",false); return; }

  setLoading(btn,true);
  try{
    const res = await apiJsonp("adminGetActiveMissions", { admin_code: STATE.admins.code, period_id });
    if(!res || !res.ok){
      showToast("toastAdminsActive",(res&&res.message)||"Erreur",false); return;
    }
    STATE.data.active_missions_all = res.missionsAll || [];
    STATE.data.active_missions_on = res.missionsOn || [];
    renderAdminsActiveMissions();
    showToast("toastAdminsActive","Charg√© ‚úÖ",true);
  }catch(e){
    showToast("toastAdminsActive","Erreur r√©seau",false);
  }finally{
    setLoading(btn,false);
  }
}

function renderAdminsActiveMissions(){
  const box = $("boxAdminsActiveMissions");
  const all = STATE.data.active_missions_all || [];
  const on = new Set((STATE.data.active_missions_on||[]).map(x=>String(x.mission_id)));
  if(!all.length){
    box.innerHTML = `<div class="listItem"><div class="listLeft"><div class="listSub">Aucune mission catalogue.</div></div></div>`;
    return;
  }
  box.innerHTML = all.map(m=>`
    <div class="listItem">
      <div class="listLeft"><div class="listTitle">${esc(m.label)}</div></div>
      <div class="pillRow">
        <label style="display:flex;align-items:center;gap:10px;cursor:pointer">
          <input type="checkbox" data-mid="${esc(m.mission_id)}" ${on.has(String(m.mission_id))?"checked":""} style="width:18px;height:18px" />
          <span class="listSub">Active</span>
        </label>
      </div>
    </div>
  `).join("");
}

async function adminsSaveActiveMissions(ev){
  hideToast("toastAdminsActive");
  const btn = ev?.target || $("btnAdminsSaveActive");
  const period_id = STATE.current.period_id || $("adminsPeriodsSel").value;
  if(!period_id){ showToast("toastAdminsActive","Charge d‚Äôabord une p√©riode.",false); return; }

  const checks = Array.from($("boxAdminsActiveMissions").querySelectorAll('input[type="checkbox"][data-mid]'));
  const ids = checks.filter(c=>c.checked).map(c=>c.getAttribute("data-mid"));

  setLoading(btn,true);
  try{
    const res = await apiJsonp("adminSaveActiveMissions", { admin_code: STATE.admins.code, period_id, mission_ids: JSON.stringify(ids) });
    if(!res || !res.ok){
      showToast("toastAdminsActive",(res&&res.message)||"Erreur",false); return;
    }
    showToast("toastAdminsActive","Enregistr√© ‚úÖ",true);
    // refresh on list
    await adminsLoadActiveMissions({ target: $("btnAdminsLoadActive") });
  }catch(e){
    showToast("toastAdminsActive","Erreur r√©seau",false);
  }finally{
    setLoading(btn,false);
  }
}

/* ----- Admin: retours ----- */
async function adminsLoadRetours(ev){
  hideToast("toastAdminsRetours");
  const btn = ev?.target || $("btnAdminsLoadRetours");
  const period_id = STATE.current.period_id || $("adminsPeriodsSel").value;
  if(!period_id){ showToast("toastAdminsRetours","Charge d‚Äôabord une p√©riode.",false); return; }

  setLoading(btn,true);
  try{
    const res = await apiJsonp("adminGetRetours", { admin_code: STATE.admins.code, period_id });
    if(!res || !res.ok){
      showToast("toastAdminsRetours",(res&&res.message)||"Erreur",false); return;
    }
    const items = res.items || [];
    const box = $("boxAdminsRetours");
    if(!items.length){
      box.innerHTML = `<div class="listItem"><div class="listLeft"><div class="listSub">Aucun retour.</div></div></div>`;
    }else{
      box.innerHTML = items.map(it=>`
        <div class="listItem">
          <div class="listLeft" style="min-width:0">
            <div class="listTitle">${esc(it.agent)}</div>
            <div class="listSub">${esc(it.mission)} ‚Ä¢ ${esc(it.declaration)}${it.justificatif ? " ‚Ä¢ "+esc(it.justificatif) : ""}</div>
          </div>
        </div>
      `).join("");
    }
    showToast("toastAdminsRetours","Charg√© ‚úÖ",true);
  }catch(e){
    showToast("toastAdminsRetours","Erreur r√©seau",false);
  }finally{
    setLoading(btn,false);
  }
}

/* ==========================================================
   INIT
   ========================================================== */
(function init(){
  showViews("agents");
  // bind enter on agent login
  document.addEventListener("keydown",(e)=>{
    if(e.key!=="Enter") return;
    const v = $("viewAgents");
    if(v && v.contains(document.activeElement) && !STATE.agents.ok){
      agentsLogins({target:$("btnAgentsLogin")});
    }
  });
  bootstraps();
})();
</script>
</body>
</html>
