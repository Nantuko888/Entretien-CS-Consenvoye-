<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Entretien CS Consenvoye ‚Äî DEMO</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1724; --panel2:#111b2b;
      --stroke:rgba(255,255,255,.12);
      --text:#e8eef9; --muted:rgba(232,238,249,.72);
      --accent:#ff7a00; --accent2:#ffb000;
      --danger:#ff3b30; --ok:#1fd36b;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --r:18px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial, "Noto Sans", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:var(--font);color:var(--text);
      background:
        radial-gradient(900px 420px at 20% 20%, rgba(255,122,0,.18), transparent 65%),
        radial-gradient(900px 420px at 80% 10%, rgba(255,176,0,.12), transparent 60%),
        linear-gradient(180deg, #06080b, var(--bg));
      min-height:100vh;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:22px 14px 46px}
    h1{margin:0;font-size:30px;font-weight:900;letter-spacing:.2px;color:#ff8d1a;text-shadow:0 2px 14px rgba(255,122,0,.18);text-align:center;}
    .subtitle{margin:6px 0 0;color:var(--muted);font-size:12px;text-align:center}
    .tabsCenter{margin:14px 0 18px;display:flex;justify-content:center;}
    .tabs{display:flex;gap:8px;align-items:center;border:1px solid var(--stroke);background:rgba(255,255,255,.02);padding:6px;border-radius:999px;box-shadow:var(--shadow);}
    .tab{border:0;background:transparent;color:var(--muted);padding:10px 14px;border-radius:999px;cursor:pointer;font-weight:900;font-size:13px;}
    .tab.active{background:linear-gradient(90deg, rgba(255,122,0,.26), rgba(255,176,0,.18));color:var(--text);}
    .btn{
      appearance:none;border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);color:var(--text);
      border-radius:999px;padding:10px 14px;cursor:pointer;
      font-weight:900;font-size:13px;transition:.15s transform ease,.15s background ease,.15s border-color ease;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.2);background:rgba(255,255,255,.06)}
    .btn.primary{background:linear-gradient(90deg, var(--accent), var(--accent2));border-color:transparent;color:#0b0f14;box-shadow:0 12px 26px rgba(255,122,0,.18);}
    .btn.danger{background:rgba(255,59,48,.14);border-color:rgba(255,59,48,.35);color:#ffd0cd}
    .btn.small{padding:8px 12px;font-size:12px}
    .btn.icon{padding:10px 12px; min-width:44px; display:inline-flex; align-items:center; justify-content:center}
    .btn.loading,
    .btn.primary.loading{
      background: linear-gradient(90deg, #1fd36b, #7dff9c) !important;
      border-color: transparent !important;
      color:#0b0f14 !important;
      box-shadow: 0 12px 26px rgba(31,211,107,.18) !important;
      cursor: wait !important;
      opacity: 0.95;
    }
    .btn.loading::after{ content: " ‚è≥"; font-weight: 900; }
    .btn[disabled]{opacity:.6;cursor:not-allowed}

    .card{border:1px solid var(--stroke);background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));border-radius:var(--r);padding:16px;box-shadow:var(--shadow);}
    .headRow{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;flex-wrap:wrap}
    .h2{margin:0;font-size:15px;font-weight:900}
    .status{font-size:12px;font-weight:900;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.02);color:var(--muted);display:inline-flex;align-items:center;gap:8px;white-space:nowrap;}
    .status.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.10);color:#bdf6d2}
    .status.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.10);color:#ffd0cd}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
    input, select, textarea{
      width:100%;padding:11px 12px;border-radius:12px;border:1px solid var(--stroke);
      background:rgba(0,0,0,.25);color:var(--text);outline:none;font-size:13px;
    }
    textarea{min-height:88px; resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .row > *{flex:1;min-width:220px}
    .right{display:flex;justify-content:flex-end;gap:8px;align-items:center}
    .divider{height:1px;background:rgba(255,255,255,.09);margin:14px 0}
    .ghost{color:rgba(232,238,249,.55)}
    .twoCol{display:grid;gap:12px}
    @media(min-width:1000px){ .twoCol{grid-template-columns: 1fr 1fr;} }
    .scrollBox{max-height:240px;overflow:auto;border-radius:14px;border:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.18)}
    .listItem{display:flex;justify-content:space-between;gap:12px;align-items:center;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08)}
    .listItem:last-child{border-bottom:0}
    .listLeft{min-width:0}
    .listTitle{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .listSub{font-size:12px;color:rgba(232,238,249,.6);margin-top:2px}
    .pillRow{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);font-size:13px;vertical-align:top}
    .table th{color:var(--muted);text-align:left;font-weight:900}
    .table tr:last-child td{border-bottom:0}

    .toast{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);background:rgba(255,255,255,.02);color:var(--muted);font-size:13px;display:none}
    .toast.show{display:block}
    .toast.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.08);color:#c9f9db}
    .toast.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.08);color:#ffd0cd}

    /* overlay "missions accomplies" */
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.70);
      display:none; align-items:center; justify-content:center;
      z-index:9999;
      padding:18px;
    }
    .overlay.show{display:flex}
    .overlayCard{
      max-width:560px; width:100%;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(15,23,36,.75);
      box-shadow:0 20px 60px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .overlayCard img{width:100%; display:block}
    .overlayHint{padding:10px 12px; font-size:12px; color:rgba(232,238,249,.75)}
    .overlayHint b{color:var(--text)}

    /* Mobile: plus compact */
    @media (max-width: 700px){
      .wrap{padding:12px}
      input, select, textarea, button, .btn{min-height:44px;font-size:16px}
      .row > *{min-width:100%}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Entretien du centre de secours de Consenvoye</h1>
    <div class="subtitle">DEMO (sans API) ‚Äî Agent : saisie ‚Ä¢ Admin : configuration ‚Ä¢ Justificatif obligatoire si <b>Partiel</b> / <b>Non fait</b></div>

    <div class="tabsCenter">
      <div class="tabs">
        <button class="tab active" id="tabAgents" onclick="showViews('agents')">üßë‚Äçüöí Agent</button>
        <button class="tab" id="tabAdmins" onclick="showViews('admins')">üõ°Ô∏è Admin</button>
        <button class="btn" onclick="reloadDemo()">Recharger</button>
      </div>
    </div>

    <!-- ========================= AGENT ========================= -->
    <div id="viewAgents" class="card">
      <div class="headRow">
        <div class="h2">Espace agent</div>
        <div class="right">
          <button class="btn icon" id="btnAgentsKey" title="Changer mon code" onclick="toggleAgentsKey()" style="display:none">üîë</button>
          <button class="btn danger" id="btnAgentsLogout" onclick="agentsLogouts()" style="display:none">D√©connexion</button>
          <div class="status bad" id="pillAgentsStatus">Agent : non connect√©</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Agent</label>
          <select id="agentsSel"></select>
        </div>
        <div>
          <label>Code</label>
          <input id="agentsCode" placeholder="Code agent" />
        </div>
        <div class="right">
          <button class="btn primary" id="btnAgentsLogin" onclick="agentsLogins(event)">Se connecter</button>
        </div>
      </div>
      <div id="toastAgentsLogin" class="toast"></div>

      <!-- bo√Æte changement code agent -->
      <div id="agentsKeyBox" style="display:none; margin-top:12px;">
        <div class="divider"></div>
        <div class="h2" style="margin:0 0 10px 0">Changer mon code</div>
        <div class="row">
          <div>
            <label>Ancien code</label>
            <input id="agentsOldCode" placeholder="Ancien code" />
          </div>
          <div>
            <label>Nouveau code</label>
            <input id="agentsNewCode" placeholder="Nouveau code (min 4)" />
          </div>
          <div class="right">
            <button class="btn primary" id="btnAgentsChange" onclick="agentsChangePasswords(event)">Valider</button>
          </div>
        </div>
        <div id="toastAgentsChange" class="toast"></div>
      </div>

      <!-- zone travail agent -->
      <div id="boxAgentsWork" style="display:none; margin-top:14px;">
        <div class="divider"></div>

        <div class="headRow">
          <div class="h2">Missions du mois</div>
          <div class="status" id="pillAgentsPeriod">P√©riode : ‚Äî</div>
        </div>

        <div class="row">
          <div>
            <label>P√©riode</label>
            <select id="agentsPeriodsSel"></select>
          </div>
          <div class="right">
            <button class="btn primary" id="btnAgentsLoad" onclick="agentsLoadPeriods(event)">Charger</button>
          </div>
        </div>
        <div id="toastAgentsPeriod" class="toast"></div>

        <div class="divider"></div>

        <div class="scrollBox" id="boxAgentsMissions"></div>

        <div class="divider"></div>

        <label>Remarque g√©n√©rale (facultatif)</label>
        <textarea id="agentsRemark" placeholder="Remarque g√©n√©rale..."></textarea>

        <div class="right" style="margin-top:10px">
          <button class="btn primary" id="btnAgentsSave" onclick="agentsSaves(event)">Enregistrer</button>
        </div>
        <div id="toastAgentsSave" class="toast"></div>
      </div>
    </div>

    <!-- ========================= ADMIN ========================= -->
    <div id="viewAdmins" class="card" style="display:none">
      <div class="headRow">
        <div class="h2">Espace admin</div>
        <div class="right">
          <button class="btn icon" id="btnAdminsKey" title="Changer le code admin" onclick="toggleAdminsKey()" style="display:none">üîë</button>
          <button class="btn danger" id="btnAdminsLogout" onclick="adminsLogouts()" style="display:none">D√©connexion</button>
          <div class="status bad" id="pillAdminsStatus">Admin : non connect√©</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Code admin</label>
          <input id="adminsCode" placeholder="Code admin" />
        </div>
        <div class="right">
          <button class="btn primary" id="btnAdminsLogin" onclick="adminsLogins(event)">Se connecter</button>
        </div>
      </div>
      <div id="toastAdminsLogin" class="toast"></div>

      <!-- bo√Æte changement code admin -->
      <div id="adminsKeyBox" style="display:none; margin-top:12px;">
        <div class="divider"></div>
        <div class="h2" style="margin:0 0 10px 0">Changer le code admin</div>
        <div class="row">
          <div>
            <label>Ancien code</label>
            <input id="adminsOldCode" placeholder="Ancien code" />
          </div>
          <div>
            <label>Nouveau code</label>
            <input id="adminsNewCode" placeholder="Nouveau code (min 4)" />
          </div>
          <div class="right">
            <button class="btn primary" id="btnAdminsChange" onclick="adminsChangePasswords(event)">Valider</button>
          </div>
        </div>
        <div id="toastAdminsChange" class="toast"></div>
      </div>

      <div id="boxAdminsWork" style="display:none; margin-top:14px;">
        <div class="divider"></div>

        <!-- Agents + Missions : 2 colonnes -->
        <div class="twoCol">
          <div class="card">
            <div class="headRow"><div class="h2">üë• Agents</div></div>
            <div class="row">
              <div>
                <label>Nom</label>
                <input id="adminsNewAgentName" placeholder="Nom Pr√©nom" />
              </div>
              <div>
                <label>Code</label>
                <input id="adminsNewAgentCode" value="0000" />
              </div>
              <div class="right">
                <button class="btn primary" id="btnAdminsAddAgent" onclick="adminsAddAgents(event)">Ajouter</button>
              </div>
            </div>
            <div id="toastAdminsAgents" class="toast"></div>

            <div class="divider"></div>
            <div class="h2" style="margin:0 0 8px 0">Liste agents</div>
            <div class="scrollBox" id="boxAdminsAgents"></div>
          </div>

          <div class="card">
            <div class="headRow"><div class="h2">üìö Catalogue missions</div></div>
            <div class="row">
              <div>
                <label>Libell√©</label>
                <input id="adminsNewMissionLib" placeholder="Ex : Nettoyage communs" />
              </div>
              <div class="right">
                <button class="btn primary" id="btnAdminsAddMission" onclick="adminsAddMissions(event)">Ajouter</button>
              </div>
            </div>
            <div id="toastAdminsMissions" class="toast"></div>

            <div class="divider"></div>
            <div class="h2" style="margin:0 0 8px 0">Liste missions</div>
            <div class="scrollBox" id="boxAdminsMissions"></div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- P√©riode / Groupe / Responsable : 2 colonnes (gauche commandes, droite liste groupe) -->
        <div class="twoCol">
          <div class="card">
            <div class="headRow">
              <div class="h2">üìÖ P√©riode / Groupe / Responsable</div>
              <div class="status" id="pillResponsable">Responsable : ‚Äî</div>
            </div>

            <div class="row">
              <div>
                <label>P√©riode</label>
                <select id="adminsPeriodsSel"></select>
              </div>
              <div class="right">
                <button class="btn primary" id="btnAdminsLoadPeriod" onclick="adminsLoadPeriods(event)">Charger</button>
              </div>
            </div>
            <div id="toastAdminsPeriod" class="toast"></div>

            <div class="divider"></div>

            <div class="row">
              <div>
                <label>Ajouter au groupe</label>
                <select id="adminsAddToGroupsSel"></select>
              </div>
              <div class="right">
                <button class="btn primary" id="btnAdminsAddToGroup" onclick="adminsAddToGroups(event)">Ajouter</button>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>Responsable</label>
                <select id="adminsResponsablesSel"></select>
              </div>
              <div class="right">
                <button class="btn primary" id="btnAdminsSetResp" onclick="adminsSetResponsables(event)">D√©finir</button>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="headRow"><div class="h2">üë• Agents du groupe</div></div>
            <div class="scrollBox" id="boxAdminsGroup"></div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- Missions actives : 2 colonnes (gauche check, droite r√©sum√©) -->
        <div class="twoCol">
          <div class="card">
            <div class="headRow"><div class="h2">‚úÖ Missions actives (par p√©riode)</div></div>
            <div class="row">
              <div class="right" style="width:100%; justify-content:flex-end">
                <button class="btn" id="btnAdminsLoadActive" onclick="adminsLoadActiveMissions(event)">Charger</button>
                <button class="btn primary" id="btnAdminsSaveActive" onclick="adminsSaveActiveMissions(event)">Enregistrer</button>
              </div>
            </div>
            <div id="toastAdminsActive" class="toast"></div>
            <div class="divider"></div>
            <div class="scrollBox" id="boxAdminsActiveMissions"></div>
          </div>

          <div class="card">
            <div class="headRow"><div class="h2">üìå Missions actives (r√©sum√©)</div></div>
            <div class="scrollBox" id="boxAdminsActiveSummary"></div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- Retours -->
        <div class="card">
          <div class="headRow"><div class="h2">üßæ Retours (Partiel / Non fait)</div></div>
          <div class="right">
            <button class="btn" id="btnAdminsLoadRetours" onclick="adminsLoadRetours(event)">Charger (par p√©riode)</button>
          </div>
          <div id="toastAdminsRetours" class="toast"></div>
          <div class="divider"></div>
          <div class="scrollBox">
            <table class="table">
              <thead>
                <tr>
                  <th>P√©riode</th>
                  <th>Agent</th>
                  <th>Mission</th>
                  <th>D√©claration</th>
                  <th>Justificatif</th>
                </tr>
              </thead>
              <tbody id="tblAdminsRetours">
                <tr><td class="ghost" colspan="5">‚Äî</td></tr>
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </div>

  </div>

  <!-- overlay "missions accomplies" -->
  <div class="overlay" id="doneOverlay">
    <div class="overlayCard">
      <img id="doneImg" alt="Missions accomplies" />
      <div class="overlayHint">Double-clic / double-tap pour fermer. <b>‚úî</b></div>
    </div>
  </div>

<script>
/* =========================================================
   DEMO DATA (aucune API)
   ========================================================= */
const DEMO = {
  admin_code: "1234",
  agents: [
    { agent_id:"A-1", name:"Bamm√© Melody", code:"1111", active:true, must_change:false },
    { agent_id:"A-2", name:"Laleeu(w) Franck", code:"1111", active:true, must_change:false },
    { agent_id:"A-3", name:"V√©nante Am√©lie", code:"0000", active:true, must_change:true },
    { agent_id:"A-4", name:"S√©n√©chal Benjamin", code:"0000", active:true, must_change:true },
    { agent_id:"A-5", name:"Michel Marianne", code:"0000", active:true, must_change:true },
    { agent_id:"A-6", name:"V√©nante Pierre", code:"2222", active:true, must_change:false },
  ],
  catalog: [
    { mission_id:"M-1", label:"Nettoyage communs", active:true },
    { mission_id:"M-2", label:"Pression des pneus", active:true },
    { mission_id:"M-3", label:"Pressions des v√©hicules", active:true },
    { mission_id:"M-4", label:"Tonte", active:true },
    { mission_id:"M-5", label:"Laver vitres", active:true },
    { mission_id:"M-6", label:"Inventaire", active:true },
    { mission_id:"M-7", label:"Frigo", active:true },
  ],
  periods: [
    { period_id:"2026-01", label:"Janvier 2026", active:true, responsable_agent_id:"A-2" },
    { period_id:"2026-02", label:"F√©vrier 2026", active:true, responsable_agent_id:"" },
    { period_id:"2026-03", label:"Mars 2026", active:true, responsable_agent_id:"" },
  ],
  // affectations (agent dans p√©riode)
  affectations: [
    { period_id:"2026-01", agent_id:"A-1" },
    { period_id:"2026-01", agent_id:"A-2" },
    { period_id:"2026-01", agent_id:"A-6" },
    { period_id:"2026-02", agent_id:"A-3" },
    { period_id:"2026-02", agent_id:"A-4" },
    { period_id:"2026-03", agent_id:"A-5" },
  ],
  // missions actives par p√©riode
  activeMissionsByPeriod: {
    "2026-01": ["M-1","M-2","M-3","M-4"],
    "2026-02": ["M-1","M-5"],
    "2026-03": ["M-6","M-7"],
  },
  // d√©clarations agent (done / partiel / non fait)
  declarations: [
    // { period_id, agent_id, mission_id, declaration, justificatif, remark }
  ],
  retours: [
    // stocke les retours "Partiel/Non fait"
  ]
};

const STATE = {
  admins: { ok:false, code:"" },
  agents: { ok:false, agent_id:"", name:"" },
  current: { period_id:"" },
  data: {
    agents: [], catalog: [], periods: [],
    group: [], activeMissions: [],
    agentPeriods: [], agentWork: []
  }
};

/* =========================================================
   UI utils
   ========================================================= */
const $ = (id)=>document.getElementById(id);
function esc(s){ return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

function showToasts(id,msg,ok){
  const el=$(id); if(!el) return;
  el.className="toast show " + (ok?"ok":"bad");
  el.textContent=msg||"";
}
function hideToasts(id){
  const el=$(id); if(!el) return;
  el.className="toast"; el.textContent="";
}
function setPills(id,txt,mode){
  const el=$(id); if(!el) return;
  el.textContent=txt;
  el.className="status " + (mode==="ok"?"ok": mode==="bad"?"bad":"");
}
function setLoadings(btn,on){
  if(!btn) return;
  btn.classList.toggle("loading", !!on);
  btn.disabled = !!on;
}
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* =========================================================
   Tabs
   ========================================================= */
function showViews(v){
  const isAgents = v==="agents";
  $("tabAgents").classList.toggle("active", isAgents);
  $("tabAdmins").classList.toggle("active", !isAgents);
  $("viewAgents").style.display = isAgents ? "" : "none";
  $("viewAdmins").style.display = isAgents ? "none" : "";
}

/* =========================================================
   Demo reload
   ========================================================= */
function reloadDemo(){
  // reset UI only (data stays)
  hideToasts("toastAgentsLogin");
  hideToasts("toastAgentsPeriod");
  hideToasts("toastAgentsSave");
  hideToasts("toastAgentsChange");
  hideToasts("toastAdminsLogin");
  hideToasts("toastAdminsAgents");
  hideToasts("toastAdminsMissions");
  hideToasts("toastAdminsPeriod");
  hideToasts("toastAdminsActive");
  hideToasts("toastAdminsRetours");

  // refill selects
  renderAgentsPublics();
  renderAdminsPeriods();
  renderAgentsPeriods([]);
  renderAgentMissions([]);
  renderAdminsAgents();
  renderAdminsMissions();
  renderAdminsGroup([]);
  renderAdminsActive([],[]);
  renderAdminsRetours([]);

  // reset login states
  agentsLogouts(true);
  adminsLogouts(true);

  showViews("agents");
}

/* =========================================================
   Render functions
   ========================================================= */
function renderAgentsPublics(){
  const sel = $("agentsSel");
  const list = DEMO.agents.filter(a=>a.active);
  sel.innerHTML = `<option value="">‚Äî Choisir agent ‚Äî</option>` +
    list.map(a=>`<option value="${esc(a.agent_id)}">${esc(a.name)}</option>`).join("");
}

function renderAdminsPeriods(){
  const sel = $("adminsPeriodsSel");
  const list = DEMO.periods.filter(p=>p.active);
  sel.innerHTML = `<option value="">‚Äî Choisir une p√©riode ‚Äî</option>` +
    list.map(p=>`<option value="${esc(p.period_id)}">${esc(p.label)}</option>`).join("");
}

function renderAgentsPeriods(periods){
  const sel = $("agentsPeriodsSel");
  if(!periods.length){
    sel.innerHTML = `<option value="">‚Äî</option>`;
    return;
  }
  sel.innerHTML = `<option value="">‚Äî Choisir une p√©riode ‚Äî</option>` +
    periods.map(p=>`<option value="${esc(p.period_id)}">${esc(p.label)}</option>`).join("");
}

function renderAgentMissions(missions){
  const box = $("boxAgentsMissions");
  if(!missions.length){
    box.innerHTML = `<div class="ghost" style="padding:10px">Choisis une p√©riode puis ‚ÄúCharger‚Äù.</div>`;
    return;
  }
  box.innerHTML = missions.map(m=>`
    <div class="listItem">
      <div class="listLeft">
        <div class="listTitle">${esc(m.label)}</div>
      </div>
      <div class="pillRow">
        <label style="display:flex;align-items:center;gap:10px;margin:0">
          <input type="checkbox" data-mid="${esc(m.mission_id)}" ${m.done?"checked":""} style="width:18px;height:18px">
          <span class="ghost" style="font-weight:900">Fait</span>
        </label>
        <select data-decl="${esc(m.mission_id)}" style="min-width:160px">
          <option value="Fait" ${m.declaration==="Fait"?"selected":""}>Fait</option>
          <option value="Partiel" ${m.declaration==="Partiel"?"selected":""}>Partiel</option>
          <option value="Non fait" ${m.declaration==="Non fait"?"selected":""}>Non fait</option>
        </select>
        <input data-justif="${esc(m.mission_id)}" placeholder="Justificatif si Partiel/Non fait" value="${esc(m.justificatif||"")}" style="min-width:220px">
      </div>
    </div>
  `).join("");
}

function renderAdminsAgents(){
  const box = $("boxAdminsAgents");
  const list = DEMO.agents.slice().sort((a,b)=>a.name.localeCompare(b.name,"fr"));
  if(!list.length){
    box.innerHTML = `<div class="ghost" style="padding:10px">‚Äî</div>`; return;
  }
  box.innerHTML = list.map(a=>`
    <div class="listItem">
      <div class="listLeft">
        <div class="listTitle">${esc(a.name)}</div>
        <div class="listSub">${a.active ? "Actif ‚úÖ" : "Inactif ‚ùå"}</div>
      </div>
      <div class="pillRow">
        <button class="btn small" onclick="adminsToggleAgents('${esc(a.agent_id)}')">${a.active?"D√©sactiver":"Activer"}</button>
        <button class="btn small" onclick="adminsResetAgentCodes('${esc(a.agent_id)}')">Reset 0000</button>
        <button class="btn small danger" onclick="adminsDeleteAgents('${esc(a.agent_id)}')">Supprimer</button>
      </div>
    </div>
  `).join("");

  // select "ajouter au groupe" (actifs)
  const addSel = $("adminsAddToGroupsSel");
  addSel.innerHTML = `<option value="">‚Äî Choisir agent ‚Äî</option>` +
    DEMO.agents.filter(x=>x.active).sort((a,b)=>a.name.localeCompare(b.name,"fr"))
      .map(a=>`<option value="${esc(a.agent_id)}">${esc(a.name)}</option>`).join("");
}

function renderAdminsMissions(){
  const box = $("boxAdminsMissions");
  const list = DEMO.catalog.slice().sort((a,b)=>a.label.localeCompare(b.label,"fr"));
  if(!list.length){
    box.innerHTML = `<div class="ghost" style="padding:10px">‚Äî</div>`; return;
  }
  box.innerHTML = list.map(m=>`
    <div class="listItem">
      <div class="listLeft">
        <div class="listTitle">${esc(m.label)}</div>
        <div class="listSub">${m.active ? "Active ‚úÖ" : "Inactive ‚ùå"}</div>
      </div>
      <div class="pillRow">
        <button class="btn small" onclick="adminsToggleMissions('${esc(m.mission_id)}')">${m.active?"D√©sactiver":"Activer"}</button>
        <button class="btn small danger" onclick="adminsDeleteMissions('${esc(m.mission_id)}')">Supprimer</button>
      </div>
    </div>
  `).join("");
}

function renderAdminsGroup(group){
  const box = $("boxAdminsGroup");
  if(!group.length){
    box.innerHTML = `<div class="ghost" style="padding:10px">Aucun groupe charg√©.</div>`;
    return;
  }
  box.innerHTML = group.map(a=>`
    <div class="listItem">
      <div class="listLeft">
        <div class="listTitle">${esc(a.name)}</div>
      </div>
      <div class="pillRow">
        <button class="btn small danger" onclick="adminsRemoveFromGroups('${esc(a.agent_id)}')">Retirer</button>
      </div>
    </div>
  `).join("");
}

function renderAdminsActive(allMissions, activeIds){
  const box = $("boxAdminsActiveMissions");
  const box2 = $("boxAdminsActiveSummary");

  if(!STATE.current.period_id){
    box.innerHTML = `<div class="ghost" style="padding:10px">Charge une p√©riode d‚Äôabord.</div>`;
    box2.innerHTML = `<div class="ghost" style="padding:10px">‚Äî</div>`;
    return;
  }

  // left checklist
  const activeSet = new Set(activeIds);
  const list = allMissions.filter(m=>m.active);
  box.innerHTML = list.map(m=>`
    <label class="listItem" style="cursor:pointer">
      <div class="listLeft" style="flex:1;min-width:0">
        <div class="listTitle">${esc(m.label)}</div>
      </div>
      <input type="checkbox" data-mid="${esc(m.mission_id)}" ${activeSet.has(m.mission_id)?"checked":""} style="width:18px;height:18px">
    </label>
  `).join("") || `<div class="ghost" style="padding:10px">Aucune mission active dans le catalogue.</div>`;

  // right summary
  const activeM = list.filter(m=>activeSet.has(m.mission_id));
  box2.innerHTML = activeM.map(m=>`
    <div class="listItem">
      <div class="listLeft"><div class="listTitle">${esc(m.label)}</div></div>
    </div>
  `).join("") || `<div class="ghost" style="padding:10px">Aucune mission active.</div>`;
}

function renderAdminsRetours(rows){
  const tb = $("tblAdminsRetours");
  if(!rows.length){
    tb.innerHTML = `<tr><td class="ghost" colspan="5">Aucun retour.</td></tr>`;
    return;
  }
  tb.innerHTML = rows.map(r=>`
    <tr>
      <td>${esc(r.period_label)}</td>
      <td>${esc(r.agent_name)}</td>
      <td>${esc(r.mission_label)}</td>
      <td>${esc(r.declaration)}</td>
      <td>${esc(r.justificatif||"")}</td>
    </tr>
  `).join("");
}

/* =========================================================
   Admin flows (DEMO)
   ========================================================= */
function toggleAdminsKey(){
  $("adminsKeyBox").style.display = $("adminsKeyBox").style.display==="none" ? "" : "none";
}

async function adminsLogins(ev){
  hideToasts("toastAdminsLogin");
  const btn = ev?.target || $("btnAdminsLogin");
  const code = $("adminsCode").value.trim();
  if(!code){ showToasts("toastAdminsLogin","Code requis.",false); return; }
  setLoadings(btn,true);
  await sleep(350);

  if(code !== DEMO.admin_code){
    setPills("pillAdminsStatus","Admin : non connect√©","bad");
    showToasts("toastAdminsLogin","Code admin incorrect.",false);
    setLoadings(btn,false);
    return;
  }

  STATE.admins.ok = true;
  STATE.admins.code = code;
  setPills("pillAdminsStatus","Admin : connect√© ‚úÖ","ok");
  showToasts("toastAdminsLogin","Admin connect√© ‚úÖ",true);

  $("btnAdminsKey").style.display = "";
  $("btnAdminsLogout").style.display = "";
  $("boxAdminsWork").style.display = "";

  // bootstrap lists
  setLoadings(btn,true);
  await sleep(250);
  renderAdminsPeriods();
  renderAdminsAgents();
  renderAdminsMissions();

  setLoadings(btn,false);
}

function adminsLogouts(silent){
  STATE.admins.ok=false; STATE.admins.code="";
  setPills("pillAdminsStatus","Admin : non connect√©","bad");
  $("btnAdminsKey").style.display="none";
  $("btnAdminsLogout").style.display="none";
  $("boxAdminsWork").style.display="none";
  $("adminsKeyBox").style.display="none";
  STATE.current.period_id = "";
  setPills("pillResponsable","Responsable : ‚Äî","");
  renderAdminsGroup([]);
  renderAdminsActive([],[]);
  renderAdminsRetours([]);
  if(!silent) showToasts("toastAdminsLogin","D√©connect√©.",true);
}

async function adminsChangePasswords(ev){
  hideToasts("toastAdminsChange");
  const btn = ev?.target || $("btnAdminsChange");
  if(!STATE.admins.ok){ showToasts("toastAdminsChange","Non connect√©.",false); return; }

  const oldC = $("adminsOldCode").value.trim();
  const newC = $("adminsNewCode").value.trim();
  if(!oldC || !newC){ showToasts("toastAdminsChange","Ancien + nouveau requis.",false); return; }
  if(newC.length < 4){ showToasts("toastAdminsChange","Nouveau code min 4.",false); return; }

  setLoadings(btn,true);
  await sleep(250);

  if(oldC !== DEMO.admin_code){
    showToasts("toastAdminsChange","Ancien code incorrect.",false);
    setLoadings(btn,false); return;
  }

  DEMO.admin_code = newC;
  showToasts("toastAdminsChange","Code admin modifi√© ‚úÖ",true);
  $("adminsOldCode").value=""; $("adminsNewCode").value="";
  setLoadings(btn,false);
}

async function adminsAddAgents(ev){
  hideToasts("toastAdminsAgents");
  const btn = ev?.target || $("btnAdminsAddAgent");
  if(!STATE.admins.ok){ showToasts("toastAdminsAgents","Non connect√©.",false); return; }

  const name = $("adminsNewAgentName").value.trim();
  const code = ($("adminsNewAgentCode").value || "0000").trim() || "0000";
  if(!name){ showToasts("toastAdminsAgents","Nom requis.",false); return; }

  setLoadings(btn,true);
  await sleep(250);

  const agent_id = "A-" + Math.random().toString(16).slice(2,10);
  DEMO.agents.push({ agent_id, name, code, active:true, must_change:(code==="0000") });
  $("adminsNewAgentName").value=""; $("adminsNewAgentCode").value="0000";

  renderAdminsAgents();
  renderAgentsPublics();
  showToasts("toastAdminsAgents","Agent ajout√© ‚úÖ",true);
  setLoadings(btn,false);
}

function adminsToggleAgents(agent_id){
  const a = DEMO.agents.find(x=>x.agent_id===agent_id);
  if(!a) return;
  a.active = !a.active;
  renderAdminsAgents();
  renderAgentsPublics();
}
function adminsResetAgentCodes(agent_id){
  const a = DEMO.agents.find(x=>x.agent_id===agent_id);
  if(!a) return;
  a.code = "0000";
  a.must_change = true;
  renderAdminsAgents();
}
function adminsDeleteAgents(agent_id){
  if(!confirm("Supprimer d√©finitivement cet agent ?")) return;
  DEMO.agents = DEMO.agents.filter(x=>x.agent_id!==agent_id);
  // retire affectations + groupe etc
  DEMO.affectations = DEMO.affectations.filter(x=>x.agent_id!==agent_id);
  DEMO.periods.forEach(p=>{ if(p.responsable_agent_id===agent_id) p.responsable_agent_id=""; });
  renderAdminsAgents();
  renderAgentsPublics();
}

async function adminsAddMissions(ev){
  hideToasts("toastAdminsMissions");
  const btn = ev?.target || $("btnAdminsAddMission");
  if(!STATE.admins.ok){ showToasts("toastAdminsMissions","Non connect√©.",false); return; }

  const label = $("adminsNewMissionLib").value.trim();
  if(!label){ showToasts("toastAdminsMissions","Libell√© requis.",false); return; }

  setLoadings(btn,true);
  await sleep(250);

  const mission_id = "M-" + Math.random().toString(16).slice(2,10);
  DEMO.catalog.push({ mission_id, label, active:true });
  $("adminsNewMissionLib").value="";
  renderAdminsMissions();
  // refresh active view if period loaded
  adminsLoadActiveMissions({target:$("btnAdminsLoadActive")}, true).catch(()=>{});
  showToasts("toastAdminsMissions","Mission ajout√©e ‚úÖ",true);
  setLoadings(btn,false);
}
function adminsToggleMissions(mission_id){
  const m = DEMO.catalog.find(x=>x.mission_id===mission_id);
  if(!m) return;
  m.active=!m.active;
  renderAdminsMissions();
  adminsLoadActiveMissions({target:$("btnAdminsLoadActive")}, true).catch(()=>{});
}
function adminsDeleteMissions(mission_id){
  if(!confirm("Supprimer d√©finitivement cette mission ?")) return;
  DEMO.catalog = DEMO.catalog.filter(x=>x.mission_id!==mission_id);
  Object.keys(DEMO.activeMissionsByPeriod).forEach(pid=>{
    DEMO.activeMissionsByPeriod[pid] = (DEMO.activeMissionsByPeriod[pid]||[]).filter(x=>x!==mission_id);
  });
  renderAdminsMissions();
  adminsLoadActiveMissions({target:$("btnAdminsLoadActive")}, true).catch(()=>{});
}

/* P√©riode / Groupe / Responsable */
async function adminsLoadPeriods(ev){
  hideToasts("toastAdminsPeriod");
  const btn = ev?.target || $("btnAdminsLoadPeriod");
  if(!STATE.admins.ok){ showToasts("toastAdminsPeriod","Non connect√©.",false); return; }

  const pid = $("adminsPeriodsSel").value;
  if(!pid){ showToasts("toastAdminsPeriod","Choisis une p√©riode.",false); return; }

  setLoadings(btn,true);
  await sleep(250);

  STATE.current.period_id = pid;

  // group = affectations for pid
  const ids = DEMO.affectations.filter(x=>x.period_id===pid).map(x=>x.agent_id);
  const group = ids.map(id=>DEMO.agents.find(a=>a.agent_id===id)).filter(Boolean);
  STATE.data.group = group;

  // responsable
  const per = DEMO.periods.find(p=>p.period_id===pid);
  const resp = per ? DEMO.agents.find(a=>a.agent_id===per.responsable_agent_id) : null;
  setPills("pillResponsable","Responsable : " + (resp ? resp.name : "‚Äî"), resp ? "ok" : "");

  // responsables select (dans le groupe)
  const rsel = $("adminsResponsablesSel");
  rsel.innerHTML = `<option value="">‚Äî Choisir ‚Äî</option>` +
    group.map(a=>`<option value="${esc(a.agent_id)}">${esc(a.name)}</option>`).join("");

  renderAdminsGroup(group);

  // active missions load+render
  await adminsLoadActiveMissions({target:$("btnAdminsLoadActive")}, true);

  // retours render (admin can load)
  renderAdminsRetours(getRetoursForPeriod(pid));

  showToasts("toastAdminsPeriod","P√©riode charg√©e ‚úÖ",true);
  setLoadings(btn,false);
}

async function adminsAddToGroups(ev){
  hideToasts("toastAdminsPeriod");
  const btn = ev?.target || $("btnAdminsAddToGroup");
  if(!STATE.admins.ok){ showToasts("toastAdminsPeriod","Non connect√©.",false); return; }
  const pid = STATE.current.period_id;
  if(!pid){ showToasts("toastAdminsPeriod","Charge une p√©riode d‚Äôabord.",false); return; }

  const aid = $("adminsAddToGroupsSel").value;
  if(!aid){ showToasts("toastAdminsPeriod","Choisis un agent.",false); return; }

  setLoadings(btn,true);
  await sleep(220);

  const exists = DEMO.affectations.some(x=>x.period_id===pid && x.agent_id===aid);
  if(!exists) DEMO.affectations.push({ period_id: pid, agent_id: aid });

  // re-render group (sans relancer plein d‚Äôautres chargements)
  const ids = DEMO.affectations.filter(x=>x.period_id===pid).map(x=>x.agent_id);
  const group = ids.map(id=>DEMO.agents.find(a=>a.agent_id===id)).filter(Boolean);
  STATE.data.group = group;

  const per = DEMO.periods.find(p=>p.period_id===pid);
  const resp = per ? DEMO.agents.find(a=>a.agent_id===per.responsable_agent_id) : null;
  setPills("pillResponsable","Responsable : " + (resp ? resp.name : "‚Äî"), resp ? "ok" : "");

  const rsel = $("adminsResponsablesSel");
  rsel.innerHTML = `<option value="">‚Äî Choisir ‚Äî</option>` +
    group.map(a=>`<option value="${esc(a.agent_id)}">${esc(a.name)}</option>`).join("");

  renderAdminsGroup(group);

  showToasts("toastAdminsPeriod","Agent ajout√© au groupe ‚úÖ",true);
  setLoadings(btn,false);
}

function adminsRemoveFromGroups(aid){
  const pid = STATE.current.period_id;
  if(!pid) return;
  DEMO.affectations = DEMO.affectations.filter(x=>!(x.period_id===pid && x.agent_id===aid));

  // si responsable retir√© => reset responsable
  const per = DEMO.periods.find(p=>p.period_id===pid);
  if(per && per.responsable_agent_id===aid) per.responsable_agent_id="";

  const ids = DEMO.affectations.filter(x=>x.period_id===pid).map(x=>x.agent_id);
  const group = ids.map(id=>DEMO.agents.find(a=>a.agent_id===id)).filter(Boolean);
  STATE.data.group = group;
  renderAdminsGroup(group);

  const resp = per ? DEMO.agents.find(a=>a.agent_id===per.responsable_agent_id) : null;
  setPills("pillResponsable","Responsable : " + (resp ? resp.name : "‚Äî"), resp ? "ok" : "");

  const rsel = $("adminsResponsablesSel");
  rsel.innerHTML = `<option value="">‚Äî Choisir ‚Äî</option>` +
    group.map(a=>`<option value="${esc(a.agent_id)}">${esc(a.name)}</option>`).join("");
}

async function adminsSetResponsables(ev){
  hideToasts("toastAdminsPeriod");
  const btn = ev?.target || $("btnAdminsSetResp");
  if(!STATE.admins.ok){ showToasts("toastAdminsPeriod","Non connect√©.",false); return; }
  const pid = STATE.current.period_id;
  if(!pid){ showToasts("toastAdminsPeriod","Charge une p√©riode d‚Äôabord.",false); return; }

  const aid = $("adminsResponsablesSel").value;
  if(!aid){ showToasts("toastAdminsPeriod","Choisis un responsable.",false); return; }

  setLoadings(btn,true);
  await sleep(220);

  const per = DEMO.periods.find(p=>p.period_id===pid);
  if(per) per.responsable_agent_id = aid;

  const resp = DEMO.agents.find(a=>a.agent_id===aid);
  setPills("pillResponsable","Responsable : " + (resp ? resp.name : "‚Äî"), resp ? "ok" : "");
  showToasts("toastAdminsPeriod","Responsable d√©fini ‚úÖ",true);

  setLoadings(btn,false);
}

/* Missions actives */
async function adminsLoadActiveMissions(ev, silent){
  hideToasts("toastAdminsActive");
  const btn = ev?.target || $("btnAdminsLoadActive");
  if(!STATE.admins.ok){ if(!silent) showToasts("toastAdminsActive","Non connect√©.",false); return; }
  const pid = STATE.current.period_id;
  if(!pid){
    renderAdminsActive([],[]);
    if(!silent) showToasts("toastAdminsActive","Charge une p√©riode d‚Äôabord.",false);
    return;
  }

  setLoadings(btn,true);
  await sleep(200);

  const activeIds = (DEMO.activeMissionsByPeriod[pid] || []).slice();
  renderAdminsActive(DEMO.catalog, activeIds);

  if(!silent) showToasts("toastAdminsActive","Missions charg√©es ‚úÖ",true);
  setLoadings(btn,false);
}

async function adminsSaveActiveMissions(ev){
  hideToasts("toastAdminsActive");
  const btn = ev?.target || $("btnAdminsSaveActive");
  if(!STATE.admins.ok){ showToasts("toastAdminsActive","Non connect√©.",false); return; }
  const pid = STATE.current.period_id;
  if(!pid){ showToasts("toastAdminsActive","Charge une p√©riode d‚Äôabord.",false); return; }

  setLoadings(btn,true);
  await sleep(220);

  const checks = Array.from($("boxAdminsActiveMissions").querySelectorAll('input[type="checkbox"][data-mid]'));
  const ids = checks.filter(c=>c.checked).map(c=>c.getAttribute("data-mid"));

  DEMO.activeMissionsByPeriod[pid] = ids;

  renderAdminsActive(DEMO.catalog, ids);
  showToasts("toastAdminsActive","Enregistr√© ‚úÖ",true);
  setLoadings(btn,false);
}

/* Retours */
function getRetoursForPeriod(pid){
  const period = DEMO.periods.find(p=>p.period_id===pid);
  const period_label = period ? period.label : pid;
  return DEMO.retours
    .filter(r=>r.period_id===pid)
    .map(r=>{
      const a = DEMO.agents.find(x=>x.agent_id===r.agent_id);
      const m = DEMO.catalog.find(x=>x.mission_id===r.mission_id);
      return {
        period_label,
        agent_name: a ? a.name : r.agent_id,
        mission_label: m ? m.label : r.mission_id,
        declaration: r.declaration,
        justificatif: r.justificatif
      };
    });
}

async function adminsLoadRetours(ev){
  hideToasts("toastAdminsRetours");
  const btn = ev?.target || $("btnAdminsLoadRetours");
  if(!STATE.admins.ok){ showToasts("toastAdminsRetours","Non connect√©.",false); return; }
  const pid = STATE.current.period_id;
  if(!pid){ showToasts("toastAdminsRetours","Charge une p√©riode d‚Äôabord.",false); return; }

  setLoadings(btn,true);
  await sleep(200);

  renderAdminsRetours(getRetoursForPeriod(pid));
  showToasts("toastAdminsRetours","Charg√© ‚úÖ",true);
  setLoadings(btn,false);
}

/* =========================================================
   Agent flows (DEMO)
   ========================================================= */
function toggleAgentsKey(){
  $("agentsKeyBox").style.display = $("agentsKeyBox").style.display==="none" ? "" : "none";
}

async function agentsLogins(ev){
  hideToasts("toastAgentsLogin");
  const btn = ev?.target || $("btnAgentsLogin");
  const agent_id = $("agentsSel").value;
  const code = $("agentsCode").value.trim();

  if(!agent_id || !code){
    showToasts("toastAgentsLogin","S√©lection + code requis.",false); return;
  }

  setLoadings(btn,true);
  await sleep(250);

  const a = DEMO.agents.find(x=>x.agent_id===agent_id);
  if(!a || !a.active){
    setPills("pillAgentsStatus","Agent : non connect√©","bad");
    showToasts("toastAgentsLogin","Agent inconnu/inactif.",false);
    setLoadings(btn,false); return;
  }
  if(String(a.code).trim() !== String(code).trim()){
    setPills("pillAgentsStatus","Agent : non connect√©","bad");
    showToasts("toastAgentsLogin","Code incorrect.",false);
    setLoadings(btn,false); return;
  }

  STATE.agents.ok = true;
  STATE.agents.agent_id = a.agent_id;
  STATE.agents.name = a.name;

  setPills("pillAgentsStatus","Agent : " + a.name,"ok");
  showToasts("toastAgentsLogin","Connect√© ‚úÖ",true);

  $("btnAgentsKey").style.display = "";
  $("btnAgentsLogout").style.display = "";
  $("boxAgentsWork").style.display = "";

  // p√©riodes affect√©es √† l‚Äôagent
  const pids = DEMO.affectations.filter(x=>x.agent_id===agent_id).map(x=>x.period_id);
  const periods = DEMO.periods.filter(p=>pids.includes(p.period_id) && p.active);
  STATE.data.agentPeriods = periods;

  renderAgentsPeriods(periods);
  setPills("pillAgentsPeriod","P√©riode : ‚Äî","");
  renderAgentMissions([]);

  // si doit changer => ouvre bo√Æte cl√© automatiquement
  if(a.must_change){
    $("agentsKeyBox").style.display = "";
    showToasts("toastAgentsChange","‚ö†Ô∏è Nouveau code obligatoire (premi√®re connexion).",false);
  } else {
    $("agentsKeyBox").style.display = "none";
  }

  setLoadings(btn,false);
}

function agentsLogouts(silent){
  STATE.agents.ok=false; STATE.agents.agent_id=""; STATE.agents.name="";
  setPills("pillAgentsStatus","Agent : non connect√©","bad");
  $("btnAgentsKey").style.display="none";
  $("btnAgentsLogout").style.display="none";
  $("boxAgentsWork").style.display="none";
  $("agentsKeyBox").style.display="none";
  $("agentsCode").value="";
  $("agentsOldCode").value="";
  $("agentsNewCode").value="";
  $("agentsRemark").value="";
  renderAgentsPeriods([]);
  renderAgentMissions([]);
  if(!silent) showToasts("toastAgentsLogin","D√©connect√©.",true);
}

async function agentsChangePasswords(ev){
  hideToasts("toastAgentsChange");
  const btn = ev?.target || $("btnAgentsChange");
  if(!STATE.agents.ok){ showToasts("toastAgentsChange","Non connect√©.",false); return; }

  const oldC = $("agentsOldCode").value.trim();
  const newC = $("agentsNewCode").value.trim();
  if(!oldC || !newC){ showToasts("toastAgentsChange","Ancien + nouveau requis.",false); return; }
  if(newC.length < 4){ showToasts("toastAgentsChange","Nouveau code min 4.",false); return; }

  setLoadings(btn,true);
  await sleep(220);

  const a = DEMO.agents.find(x=>x.agent_id===STATE.agents.agent_id);
  if(!a){ showToasts("toastAgentsChange","Agent introuvable.",false); setLoadings(btn,false); return; }
  if(String(a.code).trim() !== String(oldC).trim()){
    showToasts("toastAgentsChange","Ancien code incorrect.",false);
    setLoadings(btn,false); return;
  }

  a.code = newC;
  a.must_change = false;
  $("agentsOldCode").value=""; $("agentsNewCode").value="";
  showToasts("toastAgentsChange","Code modifi√© ‚úÖ",true);

  setLoadings(btn,false);
}

async function agentsLoadPeriods(ev){
  hideToasts("toastAgentsPeriod");
  const btn = ev?.target || $("btnAgentsLoad");
  if(!STATE.agents.ok){ showToasts("toastAgentsPeriod","Non connect√©.",false); return; }

  const pid = $("agentsPeriodsSel").value;
  if(!pid){ showToasts("toastAgentsPeriod","Choisis une p√©riode.",false); return; }

  setLoadings(btn,true);
  await sleep(220);

  const activeIds = new Set(DEMO.activeMissionsByPeriod[pid] || []);
  const list = DEMO.catalog.filter(m=>m.active && activeIds.has(m.mission_id));

  // r√©cup√®re d√©clarations existantes
  const decls = DEMO.declarations.filter(d=>d.period_id===pid && d.agent_id===STATE.agents.agent_id);
  const byMid = new Map(decls.map(d=>[d.mission_id,d]));

  const missions = list.map(m=>{
    const d = byMid.get(m.mission_id);
    return {
      mission_id:m.mission_id,
      label:m.label,
      done: d ? (d.declaration==="Fait") : false,
      declaration: d ? d.declaration : "Fait",
      justificatif: d ? (d.justificatif||"") : ""
    };
  });

  STATE.current.period_id = pid;
  STATE.data.agentWork = missions;

  const per = DEMO.periods.find(p=>p.period_id===pid);
  setPills("pillAgentsPeriod","P√©riode : " + (per?per.label:pid),"");

  renderAgentMissions(missions);

  showToasts("toastAgentsPeriod","Charg√© ‚úÖ",true);
  setLoadings(btn,false);
}

async function agentsSaves(ev){
  hideToasts("toastAgentsSave");
  const btn = ev?.target || $("btnAgentsSave");
  if(!STATE.agents.ok){ showToasts("toastAgentsSave","Non connect√©.",false); return; }
  const pid = STATE.current.period_id;
  if(!pid){ showToasts("toastAgentsSave","Choisis une p√©riode.",false); return; }

  setLoadings(btn,true);
  await sleep(250);

  // r√©cup√®re l‚Äô√©tat UI
  const box = $("boxAgentsMissions");
  const checks = Array.from(box.querySelectorAll('input[type="checkbox"][data-mid]'));
  const doneSet = new Set(checks.filter(c=>c.checked).map(c=>c.getAttribute("data-mid")));

  const missions = STATE.data.agentWork.map(m=>{
    const decl = box.querySelector(`select[data-decl="${CSS.escape(m.mission_id)}"]`)?.value || "Fait";
    const justif = box.querySelector(`input[data-justif="${CSS.escape(m.mission_id)}"]`)?.value || "";
    return { mission_id:m.mission_id, declaration:decl, justificatif:justif, done: doneSet.has(m.mission_id) };
  });

  const remark = $("agentsRemark").value.trim();

  // update declarations store
  // supprime anciennes
  DEMO.declarations = DEMO.declarations.filter(d=>!(d.period_id===pid && d.agent_id===STATE.agents.agent_id));
  missions.forEach(m=>{
    DEMO.declarations.push({
      period_id:pid,
      agent_id:STATE.agents.agent_id,
      mission_id:m.mission_id,
      declaration:m.declaration,
      justificatif:m.justificatif,
      remark
    });
    // retours si Partiel / Non fait
    DEMO.retours = DEMO.retours.filter(r=>!(r.period_id===pid && r.agent_id===STATE.agents.agent_id && r.mission_id===m.mission_id));
    if(m.declaration==="Partiel" || m.declaration==="Non fait"){
      DEMO.retours.push({
        period_id:pid,
        agent_id:STATE.agents.agent_id,
        mission_id:m.mission_id,
        declaration:m.declaration,
        justificatif:m.justificatif
      });
    }
  });

  showToasts("toastAgentsSave","Enregistr√© ‚úÖ",true);

  // overlay si tout est fait
  const allDone = missions.length>0 && missions.every(x=>x.declaration==="Fait");
  if(allDone){
    // image si dispo
    const img = $("doneImg");
    img.src = "missions-accomplies.jpg";
    img.onerror = () => { /* si pas d'image, on n'affiche pas */ $("doneOverlay").classList.remove("show"); };
    $("doneOverlay").classList.add("show");
  } else {
    $("doneOverlay").classList.remove("show");
  }

  setLoadings(btn,false);
}

/* overlay close */
$("doneImg").addEventListener("dblclick", ()=> $("doneOverlay").classList.remove("show"));
(function(){
  let lastTap = 0;
  $("doneImg").addEventListener("touchend", ()=>{
    const now = Date.now();
    if(now - lastTap < 350) $("doneOverlay").classList.remove("show");
    lastTap = now;
  }, {passive:true});
})();

/* =========================================================
   INIT
   ========================================================= */
function bootstrap(){
  renderAgentsPublics();
  renderAdminsPeriods();
  renderAdminsAgents();
  renderAdminsMissions();
  renderAgentsPeriods([]);
  renderAgentMissions([]);
  renderAdminsGroup([]);
  renderAdminsActive([],[]);
  renderAdminsRetours([]);
}
bootstrap();
showViews("agents");
</script>
</body>
</html>
