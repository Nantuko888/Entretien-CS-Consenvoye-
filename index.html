<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Entretien CS Consenvoye</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1724; --panel2:#111b2b;
      --stroke:rgba(255,255,255,.12);
      --text:#e8eef9; --muted:rgba(232,238,249,.72);
      --accent:#ff7a00; --accent2:#ffb000;
      --danger:#ff3b30; --ok:#1fd36b;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --r:18px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial, "Noto Sans", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:var(--font);color:var(--text);
      background:
        radial-gradient(900px 420px at 20% 20%, rgba(255,122,0,.18), transparent 65%),
        radial-gradient(900px 420px at 80% 10%, rgba(255,176,0,.12), transparent 60%),
        linear-gradient(180deg, #06080b, var(--bg));
      min-height:100vh;
    }
    .wrap{max-width:1180px;margin:0 auto;padding:18px 14px 40px}
    h1{margin:0;font-size:30px;font-weight:900;letter-spacing:.2px;color:#ff8d1a;text-shadow:0 2px 14px rgba(255,122,0,.18);text-align:center;}
    .subtitle{margin:6px 0 0;color:var(--muted);font-size:12px;text-align:center}
    .tabsCenter{margin:14px 0 18px;display:flex;justify-content:center;}
    .tabs{display:flex;gap:8px;align-items:center;border:1px solid var(--stroke);background:rgba(255,255,255,.02);padding:6px;border-radius:999px;box-shadow:var(--shadow);}
    .tab{border:0;background:transparent;color:var(--muted);padding:10px 14px;border-radius:999px;cursor:pointer;font-weight:900;font-size:13px;}
    .tab.active{background:linear-gradient(90deg, rgba(255,122,0,.26), rgba(255,176,0,.18));color:var(--text);}
    .btn{appearance:none;border:1px solid var(--stroke);background:rgba(255,255,255,.03);color:var(--text);border-radius:999px;padding:10px 14px;cursor:pointer;font-weight:900;font-size:13px;transition:.15s transform ease,.15s background ease,.15s border-color ease;white-space:nowrap;}
    .btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.2);background:rgba(255,255,255,.06)}
    .btn.primary{background:linear-gradient(90deg, var(--accent), var(--accent2));border-color:transparent;color:#0b0f14;box-shadow:0 12px 26px rgba(255,122,0,.18);}
    .btn.danger{background:rgba(255,59,48,.14);border-color:rgba(255,59,48,.35);color:#ffd0cd}
    .btn.small{padding:8px 12px;font-size:12px}
    .btn.loading,
    .btn.primary.loading{
      background: linear-gradient(90deg, #1fd36b, #7dff9c) !important;
      border-color: transparent !important;
      color:#0b0f14 !important;
      box-shadow: 0 12px 26px rgba(31,211,107,.18) !important;
      cursor: wait !important;
      opacity: 0.95;
    }
    .btn.loading::after{content:" ‚è≥";font-weight:900}
    .btn[disabled]{opacity:.65;cursor:not-allowed}
    .card{border:1px solid var(--stroke);background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));border-radius:var(--r);padding:16px;box-shadow:var(--shadow);}
    .headRow{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;flex-wrap:wrap}
    .h2{margin:0;font-size:15px;font-weight:900}
    .status{font-size:12px;font-weight:900;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.02);color:var(--muted);display:inline-flex;align-items:center;gap:8px;white-space:nowrap;}
    .status.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.10);color:#bdf6d2}
    .status.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.10);color:#ffd0cd}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
    input, select, textarea{width:100%;padding:11px 12px;border-radius:12px;border:1px solid var(--stroke);background:rgba(0,0,0,.25);color:var(--text);outline:none;font-size:13px;}
    textarea{min-height:86px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .row > *{flex:1;min-width:220px}
    .divider{height:1px;background:rgba(255,255,255,.09);margin:14px 0}
    .twoCol{display:grid;gap:12px}
    @media(min-width:1000px){ .twoCol{grid-template-columns: 1fr 1fr;} }
    .toast{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);background:rgba(255,255,255,.02);color:var(--muted);font-size:13px;display:none}
    .toast.show{display:block}
    .toast.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.08);color:#c9f9db}
    .toast.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.08);color:#ffd0cd}

    .scrollBox{
      max-height:260px;
      overflow:auto;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.18);
    }
    .listItem{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08)}
    .listItem:last-child{border-bottom:0}
    .left{min-width:0}
    .title{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sub{color:rgba(232,238,249,.55);font-size:12px;margin-top:2px}
    .pillRow{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .pillBtn{border:1px solid var(--stroke);background:rgba(255,255,255,.03);color:var(--text);border-radius:999px;padding:8px 12px;font-weight:900;font-size:12px;cursor:pointer}
    .pillBtn.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.10);color:#c9f9db}
    .pillBtn.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.10);color:#ffd0cd}

    /* Missions (agent) */
    .missionRow{display:flex;gap:10px;align-items:flex-start;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08)}
    .missionRow:last-child{border-bottom:0}
    .missionRow .mLeft{flex:1;min-width:0}
    .missionRow .mTitle{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .missionRow select{max-width:180px}
    .missionRow input{max-width:420px}

    /* overlay done */
    .overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.66);
      display:none;align-items:center;justify-content:center;z-index:9999;
      padding:18px;
    }
    .overlay.show{display:flex}
    .overlay img{
      max-width:min(520px, 92vw);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.18);
      box-shadow:0 18px 50px rgba(0,0,0,.55);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Entretien du centre de secours de Consenvoye</h1>
    <div class="subtitle">JTUB (GitHub) ‚Ä¢ Sheets (moteur)</div>

    <div class="tabsCenter">
      <div class="tabs">
        <button class="tab active" id="tabAgents" onclick="showView('agents')">üßë‚Äçüöí Agent</button>
        <button class="tab" id="tabAdmins" onclick="showView('admins')">üõ°Ô∏è Admin</button>
        <button class="btn" id="btnReload" onclick="bootAll()">Recharger</button>
      </div>
    </div>

    <!-- ===== AGENT ===== -->
    <div id="viewAgents" class="card">
      <div class="headRow">
        <div class="h2">Espace agent</div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <button class="btn small" id="btnAgentsKey" style="display:none" onclick="toggleAgentsKey()">üîë</button>
          <button class="btn small danger" id="btnAgentsLogout" style="display:none" onclick="agentsLogouts()">D√©connexion</button>
          <div class="status" id="pillAgentsStatus">Agent : non connect√©</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Agent</label>
          <select id="agentsSel"></select>
        </div>
        <div>
          <label>Code</label>
          <input id="agentsCode" placeholder="Code agent" />
        </div>
        <div class="right">
          <button class="btn primary" id="btnAgentsLogin" onclick="agentsLogins(event)">Se connecter</button>
        </div>
      </div>
      <div id="toastAgentsLogin" class="toast"></div>

      <div id="boxAgentsKey" style="display:none;margin-top:12px">
        <div class="divider"></div>
        <div class="h2" style="margin:0 0 8px 0">Changer mon code</div>
        <div class="row">
          <div>
            <label>Ancien code</label>
            <input id="agentsOldCode" placeholder="Ancien code" />
          </div>
          <div>
            <label>Nouveau code (min 4)</label>
            <input id="agentsNewCode" placeholder="Nouveau code" />
          </div>
          <div class="right">
            <button class="btn primary" id="btnAgentsChange" onclick="agentsChangeCodes(event)">Valider</button>
          </div>
        </div>
        <div id="toastAgentsChange" class="toast"></div>
      </div>

      <div id="boxAgentsWork" style="display:none;margin-top:12px">
        <div class="divider"></div>
        <div class="row">
          <div>
            <label>P√©riode</label>
            <select id="agentsPeriodsSel"></select>
          </div>
          <div class="right">
            <button class="btn primary" id="btnAgentsLoad" onclick="agentsLoadPeriods(event)">Charger</button>
          </div>
        </div>
        <div id="toastAgentsLoad" class="toast"></div>

        <div class="divider"></div>
        <label>Remarque g√©n√©rale (facultatif)</label>
        <textarea id="agentsRemark" placeholder="Remarque g√©n√©rale‚Ä¶"></textarea>

        <div class="divider"></div>
        <div class="scrollBox" id="boxAgentsMissions">
          <div class="listItem"><div class="left"><div class="title">Choisis une p√©riode puis ‚ÄúCharger‚Äù.</div></div></div>
        </div>

        <div class="divider"></div>
        <div class="row">
          <div class="right">
            <button class="btn primary" id="btnAgentsSave" onclick="agentsSaves(event)">Enregistrer</button>
          </div>
        </div>
        <div id="toastAgentsSave" class="toast"></div>
      </div>
    </div>

    <!-- ===== ADMIN ===== -->
    <div id="viewAdmins" class="card" style="display:none">
      <div class="headRow">
        <div class="h2">Espace admin</div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <button class="btn small" id="btnAdminsKey" style="display:none" onclick="toggleAdminsKey()">üîë</button>
          <button class="btn small danger" id="btnAdminsLogout" style="display:none" onclick="adminsLogouts()">D√©connexion</button>
          <div class="status" id="pillAdminsStatus">Admin : non connect√©</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Code admin</label>
          <input id="adminsCode" placeholder="Code admin" />
        </div>
        <div class="right">
          <button class="btn primary" id="btnAdminsLogin" onclick="adminsLogins(event)">Se connecter</button>
        </div>
      </div>
      <div id="toastAdminsLogin" class="toast"></div>

      <div id="boxAdminsKey" style="display:none;margin-top:12px">
        <div class="divider"></div>
        <div class="h2" style="margin:0 0 8px 0">Changer le code admin</div>
        <div class="row">
          <div>
            <label>Ancien code</label>
            <input id="adminsOldCode" placeholder="Ancien code" />
          </div>
          <div>
            <label>Nouveau code (min 4)</label>
            <input id="adminsNewCode" placeholder="Nouveau code" />
          </div>
          <div class="right">
            <button class="btn primary" id="btnAdminsChange" onclick="adminsChangeCodes(event)">Valider</button>
          </div>
        </div>
        <div id="toastAdminsChange" class="toast"></div>
      </div>

      <div id="boxAdminsWork" style="display:none;margin-top:12px">
        <div class="divider"></div>

        <div class="twoCol">
          <!-- agents -->
          <div class="card">
            <div class="headRow"><div class="h2">Agents</div></div>
            <div class="row">
              <div>
                <label>Nom</label>
                <input id="adminsNewAgentName" placeholder="Nom Pr√©nom" />
              </div>
              <div>
                <label>Code</label>
                <input id="adminsNewAgentCode" value="0000" />
              </div>
              <div class="right">
                <button class="btn primary" id="btnAdminsAddAgent" onclick="adminsAddAgents(event)">Ajouter</button>
              </div>
            </div>
            <div id="toastAdminsAgents" class="toast"></div>

            <div class="divider"></div>
            <div class="scrollBox" id="boxAdminsAgents">
              <div class="listItem"><div class="left"><div class="title">‚Äî</div></div></div>
            </div>
          </div>

          <!-- catalog -->
          <div class="card">
            <div class="headRow"><div class="h2">Catalogue missions</div></div>
            <div class="row">
              <div>
                <label>Libell√©</label>
                <input id="adminsNewMissionLib" placeholder="Ex : Nettoyage" />
              </div>
              <div class="right">
                <button class="btn primary" id="btnAdminsAddMission" onclick="adminsAddMissions(event)">Ajouter</button>
              </div>
            </div>
            <div id="toastAdminsMissions" class="toast"></div>

            <div class="divider"></div>
            <div class="scrollBox" id="boxAdminsMissions">
              <div class="listItem"><div class="left"><div class="title">‚Äî</div></div></div>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="twoCol">
          <!-- period / group / responsable -->
          <div class="card">
            <div class="headRow">
              <div class="h2">P√©riode / Groupe / Responsable</div>
              <div class="status" id="pillResponsable">Responsable : ‚Äî</div>
            </div>
            <div class="row">
              <div>
                <label>P√©riode</label>
                <select id="adminsPeriodsSel"></select>
              </div>
              <div class="right">
                <button class="btn primary" id="btnAdminsLoadPeriod" onclick="adminsLoadPeriods(event)">Charger</button>
              </div>
            </div>
            <div id="toastAdminsPeriod" class="toast"></div>

            <div class="divider"></div>
            <div class="row">
              <div>
                <label>Ajouter au groupe</label>
                <select id="adminsAddToGroupsSel"></select>
              </div>
              <div class="right">
                <button class="btn primary" id="btnAdminsAddToGroup" onclick="adminsAddToGroups(event)">Ajouter</button>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>Responsable</label>
                <select id="adminsResponsablesSel"></select>
              </div>
              <div class="right">
                <button class="btn primary" id="btnAdminsSetResponsable" onclick="adminsSetResponsables(event)">D√©finir</button>
              </div>
            </div>

            <div class="divider"></div>
            <div class="scrollBox" id="boxAdminsGroup">
              <div class="listItem"><div class="left"><div class="title">Aucun groupe charg√©.</div></div></div>
            </div>
          </div>

          <!-- active missions -->
          <div class="card">
            <div class="headRow"><div class="h2">Missions actives (par p√©riode)</div></div>
            <div class="row">
              <div class="right">
                <button class="btn" id="btnAdminsLoadActive" onclick="adminsLoadActiveMissions(event)">Charger</button>
              </div>
              <div class="right">
                <button class="btn primary" id="btnAdminsSaveActive" onclick="adminsSaveActiveMissions(event)">Enregistrer missions actives</button>
              </div>
            </div>
            <div id="toastAdminsActive" class="toast"></div>

            <div class="divider"></div>
            <div class="scrollBox" id="boxAdminsActiveMissions">
              <div class="listItem"><div class="left"><div class="title">Charge une p√©riode, puis ‚ÄúCharger‚Äù.</div></div></div>
            </div>

            <div class="divider"></div>
            <div class="h2" style="margin:0 0 8px 0">Retours (Partiel / Non fait)</div>
            <div class="row">
              <div class="right">
                <button class="btn" id="btnAdminsLoadRetours" onclick="adminsLoadRetours(event)">Charger retours</button>
              </div>
            </div>
            <div id="toastAdminsRetours" class="toast"></div>
            <div class="divider"></div>
            <div class="scrollBox" id="boxAdminsRetours">
              <div class="listItem"><div class="left"><div class="title">‚Äî</div></div></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Overlay missions accomplies -->
  <div class="overlay" id="doneOverlay" title="Double-clic pour fermer">
    <img id="doneImg" src="missions-accomplies.jpg" alt="missions accomplies" />
  </div>

<script>
/* =========================
   CONFIG
   ========================= */
const API_EXEC = "https://script.google.com/macros/s/AKfycbwTo8mKf9yDCmFDZbT03-nbxv5QVLcMjNEGuvlL25alCktBLX9P-G3i4NTVMw048DE/exec"; // <-- A REMPLACER

/* =========================
   UTILS
   ========================= */
function $(id){ return document.getElementById(id); }
function esc(s){ return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function showToast(id, msg, ok){
  const el=$(id); if(!el) return;
  el.className="toast show " + (ok ? "ok":"bad");
  el.textContent = msg || "";
}
function hideToast(id){
  const el=$(id); if(!el) return;
  el.className="toast"; el.textContent="";
}
function setPill(id, txt, kind){
  const el=$(id); if(!el) return;
  el.textContent=txt;
  el.className="status " + (kind==="ok"?"ok":kind==="bad"?"bad":"");
}
function setLoading(btn, on){
  if(!btn) return;
  btn.classList.toggle("loading", !!on);
  btn.disabled = !!on;
}

/* JSONP propre (pas de eval, ok CSP GitHub) */
function apiJsonp(action, params){
  return new Promise((resolve, reject)=>{
    const cb = "__cb_" + Math.random().toString(36).slice(2);
    const script = document.createElement("script");

    window[cb] = (data)=>{
      try{ delete window[cb]; }catch(_){}
      try{ script.remove(); }catch(_){}
      resolve(data);
    };

    const q = new URLSearchParams();
    q.set("action", action);
    q.set("callback", cb);
    Object.entries(params||{}).forEach(([k,v])=>{
      if(v===undefined || v===null) return;
      q.set(k, String(v));
    });

    script.src = API_EXEC + "?" + q.toString();
    script.onerror = ()=>{
      try{ delete window[cb]; }catch(_){}
      try{ script.remove(); }catch(_){}
      reject(new Error("jsonp_error"));
    };
    document.head.appendChild(script);
  });
}

/* =========================
   STATE
   ========================= */
const STATE = {
  admins: { ok:false, code:"" },
  agents: { ok:false, agent_id:"", name:"", must_change:false },
  data: { agentsPublic:[], agents:[], missions:[], periods:[], group:[], activeMissions:[], retours:[] },
  current: { period_id:"" },
};

/* =========================
   VIEW
   ========================= */
function showView(v){
  $("tabAgents").classList.toggle("active", v==="agents");
  $("tabAdmins").classList.toggle("active", v==="admins");
  $("viewAgents").style.display = (v==="agents") ? "" : "none";
  $("viewAdmins").style.display = (v==="admins") ? "" : "none";
}

/* =========================
   BOOT
   ========================= */
async function bootAll(){
  setLoading($("btnReload"), true);
  try{
    await agentsBootstraps();
    if(STATE.admins.ok) await adminsBootstraps();
  }catch(_){}
  setLoading($("btnReload"), false);
}

async function agentsBootstraps(){
  // charge liste agents public
  const sel = $("agentsSel");
  sel.innerHTML = `<option value="">‚Äî Chargement‚Ä¶ ‚Äî</option>`;
  try{
    const res = await apiJsonp("listAgentsPublics", {});
    if(!res || !res.ok) throw new Error("bad");
    STATE.data.agentsPublic = res.agents || [];
    sel.innerHTML = `<option value="">‚Äî Choisir agent ‚Äî</option>` +
      STATE.data.agentsPublic.map(a=>`<option value="${esc(a.agent_id)}">${esc(a.name)}</option>`).join("");
  }catch(e){
    sel.innerHTML = `<option value="">‚Äî Erreur chargement ‚Äî</option>`;
  }
}

async function adminsBootstraps(){
  await adminsLoadPeriods();
  await adminsListAgents();
  await adminsListMissions();
}

/* =========================
   ADMIN
   ========================= */
function toggleAdminsKey(){
  const b=$("boxAdminsKey");
  b.style.display = (b.style.display==="none"||!b.style.display) ? "" : "none";
}

function adminsLogouts(){
  STATE.admins.ok=false; STATE.admins.code="";
  setPill("pillAdminsStatus","Admin : non connect√©","");
  $("boxAdminsWork").style.display="none";
  $("btnAdminsKey").style.display="none";
  $("btnAdminsLogout").style.display="none";
  hideToast("toastAdminsLogin");
}

async function adminsLogins(ev){
  hideToast("toastAdminsLogin");
  const btn = ev?.target || $("btnAdminsLogin");
  const code = $("adminsCode").value.trim();
  if(!code){ showToast("toastAdminsLogin","Code requis.", false); return; }
  setLoading(btn,true);
  try{
    const res = await apiJsonp("adminLogin", { code });
    if(!res || !res.ok){ showToast("toastAdminsLogin","Code admin incorrect.", false); setPill("pillAdminsStatus","Admin : non connect√©","bad"); return; }
    STATE.admins.ok=true; STATE.admins.code=code;
    setPill("pillAdminsStatus","Admin : connect√© ‚úÖ","ok");
    $("boxAdminsWork").style.display="";
    $("btnAdminsKey").style.display="";
    $("btnAdminsLogout").style.display="";
    showToast("toastAdminsLogin","Admin connect√© ‚úÖ", true);
    await adminsBootstraps();
    await adminsListPeriods();
  }catch(e){
    showToast("toastAdminsLogin","Erreur r√©seau.", false);
  }finally{
    setLoading(btn,false);
  }
}

async function adminsChangeCodes(ev){
  hideToast("toastAdminsChange");
  const btn = ev?.target || $("btnAdminsChange");
  if(!STATE.admins.ok){ showToast("toastAdminsChange","Non connect√©.", false); return; }
  const old_code=$("adminsOldCode").value.trim();
  const new_code=$("adminsNewCode").value.trim();
  if(!old_code || !new_code){ showToast("toastAdminsChange","Ancien + nouveau requis.", false); return; }
  setLoading(btn,true);
  try{
    const res = await apiJsonp("adminChangeCode", { admin_code: STATE.admins.code, old_code, new_code });
    if(!res || !res.ok){ showToast("toastAdminsChange",(res&&res.message)||"Erreur", false); return; }
    showToast("toastAdminsChange","Code admin modifi√© ‚úÖ", true);
    STATE.admins.code = new_code; // garde session
    $("adminsCode").value = new_code;
  }catch(e){
    showToast("toastAdminsChange","Erreur r√©seau.", false);
  }finally{
    setLoading(btn,false);
  }
}

async function adminsLoadPeriods(){
  const sel = $("adminsPeriodsSel");
  sel.innerHTML = `<option value="">Chargement‚Ä¶</option>`;
  try{
    const res = await apiJsonp("adminListPeriods", { admin_code: STATE.admins.code });
    if(!res || !res.ok) throw new Error("bad");
    STATE.data.periods = res.periods || [];
    sel.innerHTML = `<option value="">‚Äî Choisir p√©riode ‚Äî</option>` +
      STATE.data.periods.filter(p=>p.active).map(p=>`<option value="${esc(p.period_id)}">${esc(p.label)}</option>`).join("");
  }catch(e){
    sel.innerHTML = `<option value="">‚Äî Erreur ‚Äî</option>`;
  }
}

async function adminsListAgents(){
  const box=$("boxAdminsAgents");
  box.innerHTML = `<div class="listItem"><div class="left"><div class="title">Chargement‚Ä¶</div></div></div>`;
  try{
    const res = await apiJsonp("adminListAgents", { admin_code: STATE.admins.code });
    if(!res || !res.ok) throw new Error("bad");
    STATE.data.agents = res.agents || [];

    // select addToGroup
    const addSel=$("adminsAddToGroupsSel");
    addSel.innerHTML = `<option value="">‚Äî Choisir agent ‚Äî</option>` +
      STATE.data.agents.filter(a=>a.active).map(a=>`<option value="${esc(a.agent_id)}">${esc(a.name)}</option>`).join("");

    box.innerHTML = (STATE.data.agents.length? STATE.data.agents : [{name:"‚Äî",active:false,agent_id:""}]).map(a=>`
      <div class="listItem">
        <div class="left">
          <div class="title">${esc(a.name||"‚Äî")}</div>
          <div class="sub">${a.active ? "Actif ‚úÖ" : "Inactif ‚ùå"}</div>
        </div>
        ${a.agent_id ? `
        <div class="pillRow">
          <button class="pillBtn ok" onclick="adminsToggleAgents('${esc(a.agent_id)}', ${a.active?'false':'true'})">${a.active?'D√©sactiver':'Activer'}</button>
          <button class="pillBtn" onclick="adminsResetAgents('${esc(a.agent_id)}')">Reset 0000</button>
          <button class="pillBtn bad" onclick="adminsDeleteAgents('${esc(a.agent_id)}')">Supprimer</button>
        </div>` : ``}
      </div>
    `).join("");
  }catch(e){
    box.innerHTML = `<div class="listItem"><div class="left"><div class="title">Erreur.</div></div></div>`;
  }
}

async function adminsAddAgents(ev){
  hideToast("toastAdminsAgents");
  const btn = ev?.target || $("btnAdminsAddAgent");
  if(!STATE.admins.ok){ showToast("toastAdminsAgents","Non connect√©.", false); return; }
  const name=$("adminsNewAgentName").value.trim();
  const code=$("adminsNewAgentCode").value.trim() || "0000";
  if(!name){ showToast("toastAdminsAgents","Nom requis.", false); return; }
  setLoading(btn,true);
  try{
    const res=await apiJsonp("adminAddAgent",{ admin_code: STATE.admins.code, name, code });
    if(!res || !res.ok){ showToast("toastAdminsAgents",(res&&res.message)||"Erreur", false); return; }
    showToast("toastAdminsAgents","Agent ajout√© ‚úÖ", true);
    $("adminsNewAgentName").value="";
    $("adminsNewAgentCode").value="0000";
    await adminsListAgents();
    await agentsBootstraps(); // maj liste publique
  }catch(e){ showToast("toastAdminsAgents","Erreur r√©seau.", false); }
  finally{ setLoading(btn,false); }
}

async function adminsToggleAgents(agent_id, active){
  if(!STATE.admins.ok) return;
  await apiJsonp("adminToggleAgent", { admin_code: STATE.admins.code, agent_id, active: active ? "TRUE":"FALSE" });
  await adminsListAgents();
  await agentsBootstraps();
}

async function adminsResetAgents(agent_id){
  if(!STATE.admins.ok) return;
  await apiJsonp("adminResetAgentCode", { admin_code: STATE.admins.code, agent_id });
  await adminsListAgents();
}

async function adminsDeleteAgents(agent_id){
  if(!STATE.admins.ok) return;
  if(!confirm("Supprimer d√©finitivement cet agent ?")) return;
  await apiJsonp("adminDeleteAgent", { admin_code: STATE.admins.code, agent_id });
  await adminsListAgents();
  await agentsBootstraps();
}

async function adminsListMissions(){
  const box=$("boxAdminsMissions");
  box.innerHTML = `<div class="listItem"><div class="left"><div class="title">Chargement‚Ä¶</div></div></div>`;
  try{
    const res = await apiJsonp("adminListMissions", { admin_code: STATE.admins.code });
    if(!res || !res.ok) throw new Error("bad");
    STATE.data.missions = res.missions || [];
    box.innerHTML = (STATE.data.missions.length? STATE.data.missions : [{label:"‚Äî",active:false,mission_id:""}]).map(m=>`
      <div class="listItem">
        <div class="left">
          <div class="title">${esc(m.label||"‚Äî")}</div>
          <div class="sub">${m.active ? "Actif ‚úÖ" : "Inactif ‚ùå"}</div>
        </div>
        ${m.mission_id ? `
        <div class="pillRow">
          <button class="pillBtn ok" onclick="adminsToggleMissions('${esc(m.mission_id)}', ${m.active?'false':'true'})">${m.active?'D√©sactiver':'Activer'}</button>
          <button class="pillBtn bad" onclick="adminsDeleteMissions('${esc(m.mission_id)}')">Supprimer</button>
        </div>` : ``}
      </div>
    `).join("");
  }catch(e){
    box.innerHTML = `<div class="listItem"><div class="left"><div class="title">Erreur.</div></div></div>`;
  }
}

async function adminsAddMissions(ev){
  hideToast("toastAdminsMissions");
  const btn = ev?.target || $("btnAdminsAddMission");
  if(!STATE.admins.ok){ showToast("toastAdminsMissions","Non connect√©.", false); return; }
  const label=$("adminsNewMissionLib").value.trim();
  if(!label){ showToast("toastAdminsMissions","Libell√© requis.", false); return; }
  setLoading(btn,true);
  try{
    const res=await apiJsonp("adminAddMission",{ admin_code: STATE.admins.code, label });
    if(!res || !res.ok){ showToast("toastAdminsMissions",(res&&res.message)||"Erreur", false); return; }
    showToast("toastAdminsMissions","Mission ajout√©e ‚úÖ", true);
    $("adminsNewMissionLib").value="";
    await adminsListMissions();
  }catch(e){ showToast("toastAdminsMissions","Erreur r√©seau.", false); }
  finally{ setLoading(btn,false); }
}

async function adminsToggleMissions(mission_id, active){
  if(!STATE.admins.ok) return;
  await apiJsonp("adminToggleMission",{ admin_code: STATE.admins.code, mission_id, active: active ? "TRUE":"FALSE" });
  await adminsListMissions();
}

async function adminsDeleteMissions(mission_id){
  if(!STATE.admins.ok) return;
  if(!confirm("Supprimer d√©finitivement cette mission ?")) return;
  await apiJsonp("adminDeleteMission",{ admin_code: STATE.admins.code, mission_id });
  await adminsListMissions();
}

  async function adminsListPeriods(){
  try{
    const res = await apiJsonp("adminListPeriods", {
      admin_code: STATE.admins.code
    });

    if(!res || !res.ok) return;

    STATE.data.periods = res.periods || [];

    $("adminsPeriodsSel").innerHTML =
      `<option value="">‚Äî Choisir une p√©riode ‚Äî</option>` +
      STATE.data.periods.map(p =>
        `<option value="${p.period_id}">${p.label}</option>`
      ).join("");

  }catch(e){
    console.error("adminsListPeriods error", e);
  }
}

async function adminsLoadPeriods(ev){
  hideToast("toastAdminsPeriod");
  const btn = ev?.target || $("btnAdminsLoadPeriod");
  const pid = $("adminsPeriodsSel").value;
  if(!pid){ showToast("toastAdminsPeriod","Choisis une p√©riode.", false); return; }
  setLoading(btn,true);
  try{
    const res = await apiJsonp("adminLoadPeriod", { admin_code: STATE.admins.code, period_id: pid });

if(!res || !res.ok){
  showToast("toastAdminsPeriod", (res && res.message) || "Erreur", false);
  return; // ‚úÖ IMPORTANT : on stoppe ici
}

    STATE.current.period_id = pid;
    STATE.data.group = res.group || [];
    setPill("pillResponsable","Responsable : " + (res.responsable_name || "‚Äî"), res.responsable_name ? "ok" : "");
    // responsable select
    $("adminsResponsablesSel").innerHTML =
      `<option value="">‚Äî Choisir ‚Äî</option>` +
      STATE.data.group.map(a=>`<option value="${esc(a.agent_id)}">${esc(a.name)}</option>`).join("");
    // group list
    renderAdminsGroup();
    showToast("toastAdminsPeriod","P√©riode charg√©e ‚úÖ", true);
    // auto: refresh active missions + retours
    await adminsLoadActiveMissions();
    await adminsLoadRetours();
  }catch(e){
    showToast("toastAdminsPeriod","Erreur r√©seau.", false);
  }finally{
    setLoading(btn,false);
  }
}

function renderAdminsGroup(){
  const box=$("boxAdminsGroup");
  if(!STATE.data.group.length){
    box.innerHTML = `<div class="listItem"><div class="left"><div class="title">Groupe vide.</div></div></div>`;
    return;
  }
  box.innerHTML = STATE.data.group.map(a=>`
    <div class="listItem">
      <div class="left"><div class="title">${esc(a.name)}</div></div>
      <div class="pillRow">
        <button class="pillBtn bad" onclick="adminsRemoveFromGroups('${esc(a.agent_id)}')">Retirer</button>
      </div>
    </div>
  `).join("");
}

async function adminsAddToGroups(ev){
  hideToast("toastAdminsPeriod");
  const btn = ev?.target || $("btnAdminsAddToGroup");
  const pid = STATE.current.period_id || $("adminsPeriodsSel").value;
  const agent_id = $("adminsAddToGroupsSel").value;
  if(!pid || !agent_id){ showToast("toastAdminsPeriod","P√©riode + agent requis.", false); return; }
  setLoading(btn,true);
  try{
    const res=await apiJsonp("adminAddToGroup",{ admin_code: STATE.admins.code, period_id: pid, agent_id });
    if(!res || !res.ok){ showToast("toastAdminsPeriod",(res&&res.message)||"Erreur", false); return; }
    await adminsLoadPeriods({target:$("btnAdminsLoadPeriod")});
  }catch(e){ showToast("toastAdminsPeriod","Erreur r√©seau.", false); }
  finally{ setLoading(btn,false); }
}

async function adminsRemoveFromGroups(agent_id){
  hideToast("toastAdminsPeriod");
  const pid = STATE.current.period_id || $("adminsPeriodsSel").value;
  if(!pid) return;
  await apiJsonp("adminRemoveFromGroup",{ admin_code: STATE.admins.code, period_id: pid, agent_id });
  await adminsLoadPeriods({target:$("btnAdminsLoadPeriod")});
}

async function adminsSetResponsables(ev){
  hideToast("toastAdminsPeriod");
  const btn = ev?.target || $("btnAdminsSetResponsable");
  const pid = STATE.current.period_id || $("adminsPeriodsSel").value;
  const agent_id = $("adminsResponsablesSel").value;
  if(!pid || !agent_id){ showToast("toastAdminsPeriod","Choisis un responsable.", false); return; }
  setLoading(btn,true);
  try{
    const res=await apiJsonp("adminSetResponsable",{ admin_code: STATE.admins.code, period_id: pid, agent_id });
    if(!res || !res.ok){ showToast("toastAdminsPeriod",(res&&res.message)||"Erreur", false); return; }
    await adminsLoadPeriods({target:$("btnAdminsLoadPeriod")});
  }catch(e){ showToast("toastAdminsPeriod","Erreur r√©seau.", false); }
  finally{ setLoading(btn,false); }
}

async function adminsLoadActiveMissions(ev){
  hideToast("toastAdminsActive");
  const btn = ev?.target || $("btnAdminsLoadActive");
  const pid = STATE.current.period_id || $("adminsPeriodsSel").value;
  if(!pid){ showToast("toastAdminsActive","Choisis une p√©riode.", false); return; }
  if(btn) setLoading(btn,true);
  try{
    const res=await apiJsonp("adminGetActiveMissions",{ admin_code: STATE.admins.code, period_id: pid });
    if(!res || !res.ok){ showToast("toastAdminsActive",(res&&res.message)||"Erreur", false); return; }
    STATE.data.activeMissions = res.active || [];
    const all = res.all || [];
    const on = new Set(STATE.data.activeMissions.map(x=>String(x.mission_id)));
    const box = $("boxAdminsActiveMissions");
    box.innerHTML = all.map(m=>`
      <label class="listItem" style="cursor:pointer">
        <div class="left"><div class="title">${esc(m.label)}</div></div>
        <div class="pillRow" style="justify-content:flex-end">
          <input type="checkbox" data-mid="${esc(m.mission_id)}" ${on.has(String(m.mission_id))?"checked":""} />
        </div>
      </label>
    `).join("") || `<div class="listItem"><div class="left"><div class="title">Aucune mission.</div></div></div>`;
    showToast("toastAdminsActive","Charg√© ‚úÖ", true);
  }catch(e){
    showToast("toastAdminsActive","Erreur r√©seau.", false);
  }finally{
    if(btn) setLoading(btn,false);
  }
}

async function adminsSaveActiveMissions(ev){
  hideToast("toastAdminsActive");
  const btn = ev?.target || $("btnAdminsSaveActive");
  const pid = STATE.current.period_id || $("adminsPeriodsSel").value;
  if(!pid){ showToast("toastAdminsActive","Choisis une p√©riode.", false); return; }
  setLoading(btn,true);
  try{
    const checks = Array.from($("boxAdminsActiveMissions").querySelectorAll('input[type="checkbox"][data-mid]'));
    const ids = checks.filter(c=>c.checked).map(c=>c.getAttribute("data-mid"));
    const res=await apiJsonp("adminSaveActiveMissions",{ admin_code: STATE.admins.code, period_id: pid, mission_ids: JSON.stringify(ids) });
    if(!res || !res.ok){ showToast("toastAdminsActive",(res&&res.message)||"Erreur", false); return; }
    showToast("toastAdminsActive","Enregistr√© ‚úÖ", true);
  }catch(e){
    showToast("toastAdminsActive","Erreur r√©seau.", false);
  }finally{
    setLoading(btn,false);
  }
}

async function adminsLoadRetours(ev){
  hideToast("toastAdminsRetours");
  const btn = ev?.target || $("btnAdminsLoadRetours");
  const pid = STATE.current.period_id || $("adminsPeriodsSel").value;
  if(!pid){ showToast("toastAdminsRetours","Choisis une p√©riode.", false); return; }
  if(btn) setLoading(btn,true);
  try{
    const res=await apiJsonp("adminGetRetours",{ admin_code: STATE.admins.code, period_id: pid });
    if(!res || !res.ok){ showToast("toastAdminsRetours",(res&&res.message)||"Erreur", false); return; }
    const items = res.items || [];
    const box=$("boxAdminsRetours");
    box.innerHTML = items.length ? items.map(it=>`
      <div class="listItem">
        <div class="left">
          <div class="title">${esc(it.agent)} ‚Äî ${esc(it.mission)}</div>
          <div class="sub">${esc(it.declaration)}${it.justificatif ? " ‚Ä¢ " + esc(it.justificatif) : ""}</div>
        </div>
      </div>
    `).join("") : `<div class="listItem"><div class="left"><div class="title">Aucun retour.</div></div></div>`;
    showToast("toastAdminsRetours","Charg√© ‚úÖ", true);
  }catch(e){
    showToast("toastAdminsRetours","Erreur r√©seau.", false);
  }finally{
    if(btn) setLoading(btn,false);
  }
}

/* =========================
   AGENT
   ========================= */
function toggleAgentsKey(){
  const b=$("boxAgentsKey");
  b.style.display = (b.style.display==="none"||!b.style.display) ? "" : "none";
}

function agentsLogouts(){
  STATE.agents.ok=false; STATE.agents.agent_id=""; STATE.agents.name=""; STATE.agents.must_change=false;
  setPill("pillAgentsStatus","Agent : non connect√©","");
  $("boxAgentsWork").style.display="none";
  $("btnAgentsKey").style.display="none";
  $("btnAgentsLogout").style.display="none";
  $("boxAgentsKey").style.display="none";
  hideToast("toastAgentsLogin");
}

async function agentsLogins(ev){
  hideToast("toastAgentsLogin");
  const btn = ev?.target || $("btnAgentsLogin");
  const agent_id = $("agentsSel").value;
  const code = $("agentsCode").value.trim();
  if(!agent_id || !code){ showToast("toastAgentsLogin","S√©lection + code requis.", false); return; }

  setLoading(btn,true);
  try{
    const res = await apiJsonp("agentLogin", { agent_id, code });
    if(!res || !res.ok){
      showToast("toastAgentsLogin", (res&&res.message)||"Code incorrect.", false);
      setPill("pillAgentsStatus","Agent : non connect√©","bad");
      return;
    }

    STATE.agents.ok=true;
    STATE.agents.agent_id = res.agent.agent_id;
    STATE.agents.name = res.agent.name;
    STATE.agents.must_change = !!res.agent.must_change;

    setPill("pillAgentsStatus","Agent : " + STATE.agents.name, "ok");
    $("btnAgentsLogout").style.display="";
    $("btnAgentsKey").style.display="";

    // p√©riodes autoris√©es
    const psel=$("agentsPeriodsSel");
    const periods = res.periods || [];
    psel.innerHTML = `<option value="">‚Äî Choisir p√©riode ‚Äî</option>` +
      periods.map(p=>`<option value="${esc(p.period_id)}">${esc(p.label)}</option>`).join("");

    $("boxAgentsWork").style.display = "";

    // force changement au premier login
    if(STATE.agents.must_change){
      $("boxAgentsKey").style.display = "";
      showToast("toastAgentsLogin","‚ö†Ô∏è Changement de code obligatoire.", false);
    }else{
      showToast("toastAgentsLogin","Connect√© ‚úÖ", true);
    }
  }catch(e){
    showToast("toastAgentsLogin","Erreur r√©seau.", false);
  }finally{
    setLoading(btn,false);
  }
}

async function agentsChangeCodes(ev){
  hideToast("toastAgentsChange");
  const btn = ev?.target || $("btnAgentsChange");
  if(!STATE.agents.ok){ showToast("toastAgentsChange","Non connect√©.", false); return; }
  const old_code=$("agentsOldCode").value.trim();
  const new_code=$("agentsNewCode").value.trim();
  if(!old_code || !new_code){ showToast("toastAgentsChange","Ancien + nouveau requis.", false); return; }
  setLoading(btn,true);
  try{
    const res = await apiJsonp("agentChangeCode", { agent_id: STATE.agents.agent_id, old_code, new_code });
    if(!res || !res.ok){ showToast("toastAgentsChange",(res&&res.message)||"Erreur", false); return; }
    showToast("toastAgentsChange","Code modifi√© ‚úÖ", true);
    $("agentsCode").value = new_code;
    STATE.agents.must_change=false;
  }catch(e){
    showToast("toastAgentsChange","Erreur r√©seau.", false);
  }finally{
    setLoading(btn,false);
  }
}

async function agentsLoadPeriods(ev){
  hideToast("toastAgentsLoad");
  const btn = ev?.target || $("btnAgentsLoad");
  if(!STATE.agents.ok){ showToast("toastAgentsLoad","Non connect√©.", false); return; }
  const pid = $("agentsPeriodsSel").value;
  if(!pid){ showToast("toastAgentsLoad","Choisis une p√©riode.", false); return; }
  setLoading(btn,true);
  try{
    const res = await apiJsonp("agentLoadPeriod", { agent_id: STATE.agents.agent_id, period_id: pid });
    if(!res || !res.ok){ showToast("toastAgentsLoad",(res&&res.message)||"Erreur", false); return; }

    // remark existant
    $("agentsRemark").value = res.remark || "";

    // missions
    const list = res.missions || [];
    const box = $("boxAgentsMissions");
    if(!list.length){
      box.innerHTML = `<div class="listItem"><div class="left"><div class="title">Aucune mission.</div></div></div>`;
    }else{
      box.innerHTML = list.map(m=>`
        <div class="missionRow">
          <div class="mLeft">
            <div class="mTitle">${esc(m.label)}</div>
          </div>
          <div>
            <select data-mid="${esc(m.mission_id)}" class="decSel">
              <option value="" ${m.declaration===""?"selected":""}>‚Äî</option>
              <option value="Fait" ${m.declaration==="Fait"?"selected":""}>Fait</option>
              <option value="Partiel" ${m.declaration==="Partiel"?"selected":""}>Partiel</option>
              <option value="Non fait" ${m.declaration==="Non fait"?"selected":""}>Non fait</option>
            </select>
          </div>
          <div style="flex:1;min-width:220px">
            <input class="justifInp" data-mid="${esc(m.mission_id)}" placeholder="Justificatif si Partiel / Non fait" value="${esc(m.justificatif||"")}" />
          </div>
        </div>
      `).join("");
    }

    showToast("toastAgentsLoad","Charg√© ‚úÖ", true);
  }catch(e){
    showToast("toastAgentsLoad","Erreur r√©seau.", false);
  }finally{
    setLoading(btn,false);
  }
}

async function agentsSaves(ev){
  hideToast("toastAgentsSave");
  const btn = ev?.target || $("btnAgentsSave");
  if(!STATE.agents.ok){ showToast("toastAgentsSave","Non connect√©.", false); return; }
  const pid = $("agentsPeriodsSel").value;
  if(!pid){ showToast("toastAgentsSave","Choisis une p√©riode.", false); return; }

  const decs = Array.from(document.querySelectorAll("#boxAgentsMissions .decSel"));
  const justifs = Array.from(document.querySelectorAll("#boxAgentsMissions .justifInp"));
  const items = decs.map(sel=>{
    const mid = sel.getAttribute("data-mid");
    const j = justifs.find(x=>x.getAttribute("data-mid")===mid);
    return { mission_id: mid, declaration: sel.value, justificatif: (j?j.value:"") };
  });

  const remark = $("agentsRemark").value.trim();

  setLoading(btn,true);
  try{
    const res = await apiJsonp("agentSaveDeclarations", {
      agent_id: STATE.agents.agent_id,
      period_id: pid,
      remark,
      items: JSON.stringify(items)
    });
    if(!res || !res.ok){ showToast("toastAgentsSave",(res&&res.message)||"Erreur", false); return; }
    showToast("toastAgentsSave","Enregistr√© ‚úÖ", true);

    // overlay si tout est "Fait"
    const allDone = items.length>0 && items.every(x=>x.declaration==="Fait");
    if(allDone) $("doneOverlay").classList.add("show");
    else $("doneOverlay").classList.remove("show");
  }catch(e){
    showToast("toastAgentsSave","Erreur r√©seau.", false);
  }finally{
    setLoading(btn,false);
  }
}

/* Overlay close (double clic / double tap) */
$("doneImg").addEventListener("dblclick", ()=> $("doneOverlay").classList.remove("show"));
$("doneImg").addEventListener("touchend", ()=>{
  const now=Date.now();
  if(!window.__lt){ window.__lt=now; return; }
  if(now-window.__lt<350) $("doneOverlay").classList.remove("show");
  window.__lt=now;
});

/* INIT simple (pas d‚ÄôIIFE pi√©geuse) */
document.addEventListener("DOMContentLoaded", async ()=>{
  showView("agents");
  setPill("pillAdminsStatus","Admin : non connect√©","");
  setPill("pillAgentsStatus","Agent : non connect√©","");
  await agentsBootstraps();
});
</script>
</body>
</html>
