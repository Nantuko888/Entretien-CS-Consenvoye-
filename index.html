<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Entretien CS Consenvoye</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1724;
      --stroke:rgba(255,255,255,.12);
      --text:#e8eef9; --muted:rgba(232,238,249,.72);
      --accent:#ff7a00; --accent2:#ffb000;
      --ok:#1fd36b; --bad:#ff3b30;
      --r:18px;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --font:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,"Noto Sans",sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:var(--font);color:var(--text);
      background:
        radial-gradient(900px 420px at 20% 20%, rgba(255,122,0,.18), transparent 65%),
        radial-gradient(900px 420px at 80% 10%, rgba(255,176,0,.12), transparent 60%),
        linear-gradient(180deg,#06080b,var(--bg));
      min-height:100vh;
      overflow-x:hidden;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px 14px 40px}
    h1{margin:0;text-align:center;font-weight:900;color:#ff8d1a;text-shadow:0 2px 14px rgba(255,122,0,.18)}
    .sub{margin:6px 0 12px;text-align:center;color:var(--muted);font-size:12px}
    .tabs{display:flex;justify-content:center;gap:10px;margin:12px 0 18px}
    .tab{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      padding:10px 14px;border-radius:999px;
      font-weight:900;cursor:pointer;
    }
    .tab.active{background:linear-gradient(90deg, rgba(255,122,0,.26), rgba(255,176,0,.18));color:var(--text)}
    .card{border:1px solid var(--stroke);background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border-radius:var(--r);box-shadow:var(--shadow);padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    .row>*{flex:1;min-width:210px}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
    input,select,textarea{
      width:100%;padding:11px 12px;border-radius:12px;border:1px solid var(--stroke);
      background:rgba(0,0,0,.25);color:var(--text);outline:none;font-size:14px;
    }
    textarea{min-height:90px;resize:vertical}
    .btn{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);
      color:var(--text);
      border-radius:999px;
      padding:10px 14px;
      font-weight:900;cursor:pointer;
      transition:.15s;
      white-space:nowrap;
    }
    .btn.primary{border-color:transparent;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#0b0f14}
    .btn.ghost{background:transparent}
    .btn.bad{background:rgba(255,59,48,.12);border-color:rgba(255,59,48,.35);color:#ffd0cd}
    .btn.ok{background:rgba(31,211,107,.12);border-color:rgba(31,211,107,.35);color:#bdf6d2}
    .btn.loading{background:linear-gradient(90deg,#1fd36b,#7dff9c)!important;color:#0b0f14!important;border-color:transparent!important;cursor:wait!important}
    .btn.loading::after{content:" ‚è≥"}
    .status{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--stroke);background:rgba(255,255,255,.02);
      border-radius:999px;padding:6px 10px;color:var(--muted);font-weight:900;font-size:12px}
    .status.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.10);color:#bdf6d2}
    .status.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.10);color:#ffd0cd}
    .head{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
    .h2{font-weight:900}
    .toolRow{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .keybtn{border:1px solid var(--stroke);background:rgba(255,255,255,.04);color:var(--text);
      border-radius:999px;padding:8px 10px;font-weight:900;cursor:pointer}
    .toast{margin-top:10px;border-radius:12px;padding:10px 12px;border:1px solid var(--stroke);background:rgba(255,255,255,.02);color:var(--muted);display:none}
    .toast.show{display:block}
    .toast.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.08);color:#c9f9db}
    .toast.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.08);color:#ffd0cd}
    .divider{height:1px;background:rgba(255,255,255,.09);margin:12px 0}
    .grid2{display:grid;gap:12px}
    @media(min-width:1000px){.grid2{grid-template-columns:1fr 1fr}}
    .scrollBox{border:1px solid var(--stroke);background:rgba(0,0,0,.18);border-radius:14px;max-height:280px;overflow:auto}
    .listRow{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08)}
    .listRow:last-child{border-bottom:0}
    .name{font-weight:900}
    .muted{color:rgba(232,238,249,.62);font-size:12px}
    .checks{padding:6px}
    .checkRow{display:flex;align-items:center;gap:12px;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08)}
    .checkRow:last-child{border-bottom:0}
    .checkRow input{width:22px;height:22px}
    .checkLabel{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    /* overlay image missions accomplies */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;padding:14px;z-index:9999}
    .overlay.show{display:flex}
    .overlay img{max-width:min(92vw,560px);max-height:88vh;border-radius:18px;box-shadow:0 24px 80px rgba(0,0,0,.55)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Entretien CS Consenvoye</h1>
    <div class="sub">JTUB (GitHub) ‚Ä¢ Sheets (moteur)</div>

    <div class="tabs">
      <button class="tab active" id="tabAgent" onclick="showView('agent')">üßë‚Äçüöí Agent</button>
      <button class="tab" id="tabAdmin" onclick="showView('admin')">üõ°Ô∏è Admin</button>
    </div>

    <!-- AGENT -->
    <div id="viewAgent" class="card">
      <div class="head">
        <div class="h2">Espace agent</div>
        <div class="toolRow">
          <button class="keybtn" id="agentKey" title="Changer mon code" onclick="toggleAgentKey()" style="display:none;">üîë</button>
          <button class="btn bad" id="agentLogout" onclick="agentLogout()" style="display:none;">D√©connexion</button>
          <div class="status" id="agentStatus">Agent : non connect√©</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Agent</label>
          <select id="agentSel"></select>
        </div>
        <div>
          <label>Code</label>
          <input id="agentCode" placeholder="Code agent" />
        </div>
        <div>
          <button class="btn primary" id="btnAgentLogin" onclick="agentLogin()">Se connecter</button>
        </div>
      </div>

      <div id="agentToast" class="toast"></div>

      <div id="agentKeyBox" style="display:none;margin-top:12px;">
        <div class="divider"></div>
        <div class="h2" style="margin-bottom:8px;">Changer mon code</div>
        <div class="row">
          <div><label>Ancien code</label><input id="agentOldCode" /></div>
          <div><label>Nouveau code (min 4)</label><input id="agentNewCode" /></div>
          <div><button class="btn primary" id="btnAgentChangeCode" onclick="agentChangeCode()">Valider</button></div>
        </div>
        <div id="agentChangeToast" class="toast"></div>
      </div>

      <div id="agentWork" style="display:none;">
        <div class="divider"></div>
        <div class="row">
          <div>
            <label>P√©riode</label>
            <select id="agentPeriodSel">
              <option value="">‚Äî Choisir p√©riode ‚Äî</option>
            </select>
          </div>
          <div>
            <button class="btn primary" id="btnAgentLoad" onclick="agentLoadPeriod()">Charger</button>
          </div>
        </div>

        <div class="divider"></div>
        <label>Remarque g√©n√©rale (facultatif)</label>
        <textarea id="agentRemark" placeholder="Remarque g√©n√©rale‚Ä¶"></textarea>

        <div class="divider"></div>
        <div class="h2">Missions du mois</div>
        <div class="scrollBox">
          <div id="agentMissions" class="checks">
            <div class="muted" style="padding:10px">Choisis une p√©riode puis ‚ÄúCharger‚Äù.</div>
          </div>
        </div>

        <div class="divider"></div>
        <button class="btn primary" id="btnAgentSave" onclick="agentSave()">Enregistrer</button>
        <div id="agentSaveToast" class="toast"></div>
      </div>
    </div>

    <!-- ADMIN -->
    <div id="viewAdmin" class="card" style="display:none;margin-top:14px;">
      <div class="head">
        <div class="h2">Espace admin</div>
        <div class="toolRow">
          <button class="keybtn" id="adminKey" title="Changer le code admin" onclick="toggleAdminKey()" style="display:none;">üîë</button>
          <button class="btn bad" id="adminLogout" onclick="adminLogout()" style="display:none;">D√©connexion</button>
          <div class="status" id="adminStatus">Admin : non connect√©</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Code admin</label>
          <input id="adminCode" placeholder="Code admin" />
        </div>
        <div>
          <button class="btn primary" id="btnAdminLogin" onclick="adminLogin()">Se connecter</button>
        </div>
      </div>
      <div id="adminToast" class="toast"></div>

      <div id="adminKeyBox" style="display:none;margin-top:12px;">
        <div class="divider"></div>
        <div class="h2" style="margin-bottom:8px;">Changer le code admin</div>
        <div class="row">
          <div><label>Nouveau code (min 4)</label><input id="adminNewCode"/></div>
          <div><button class="btn primary" id="btnAdminChange" onclick="adminChangeCode()">Valider</button></div>
        </div>
        <div id="adminChangeToast" class="toast"></div>
      </div>

      <div id="adminBody" style="display:none;margin-top:12px;">
        <div class="divider"></div>

        <div class="grid2">
          <div class="card">
            <div class="head"><div class="h2">Agents</div></div>
            <div class="row">
              <div><label>Nom</label><input id="newAgentName" placeholder="Nom Pr√©nom"/></div>
              <div><label>Code</label><input id="newAgentCode" value="0000"/></div>
              <div><button class="btn primary" id="btnAddAgent" onclick="adminAddAgent()">Ajouter</button></div>
            </div>
            <div id="adminAgentToast" class="toast"></div>
            <div class="divider"></div>
            <div class="scrollBox" id="adminAgentsBox"></div>
          </div>

          <div class="card">
            <div class="head"><div class="h2">Catalogue missions</div></div>
            <div class="row">
              <div><label>Libell√©</label><input id="newMissionLib" placeholder="Ex : Nettoyage"/></div>
              <div><button class="btn primary" id="btnAddMission" onclick="adminAddMission()">Ajouter</button></div>
            </div>
            <div id="adminMissionToast" class="toast"></div>
            <div class="divider"></div>
            <div class="scrollBox" id="adminMissionsBox"></div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="card">
          <div class="head">
            <div class="h2">P√©riode / Groupe / Missions actives / Retours</div>
            <div class="status" id="respStatus">Responsable : ‚Äî</div>
          </div>

          <div class="row">
            <div>
              <label>P√©riode</label>
              <select id="periodeSel"></select>
            </div>
            <div><button class="btn primary" id="btnLoadPeriod" onclick="adminLoadPeriod()">Charger</button></div>
          </div>

          <div class="divider"></div>

          <div class="grid2">
            <div class="card">
              <div class="h2">Groupe</div>
              <div class="row" style="margin-top:10px;">
                <div>
                  <label>Ajouter au groupe</label>
                  <select id="addToGroupSel"></select>
                </div>
                <div><button class="btn primary" id="btnAddToGroup" onclick="adminAddToGroup()">Ajouter</button></div>
              </div>
              <div class="row" style="margin-top:10px;">
                <div>
                  <label>Responsable</label>
                  <select id="responsableSel"></select>
                </div>
                <div><button class="btn primary" id="btnSetResp" onclick="adminSetResponsable()">D√©finir</button></div>
              </div>
              <div id="adminGroupToast" class="toast"></div>
              <div class="divider"></div>
              <div class="scrollBox" id="adminGroupBox"></div>
            </div>

            <div class="card">
              <div class="h2">Missions actives</div>
              <div class="muted" style="margin:6px 0 10px">Coche/d√©coche pour la p√©riode.</div>
              <div class="scrollBox"><div id="monthBox" class="checks"></div></div>
              <div class="divider"></div>
              <button class="btn primary" id="btnSaveMonth" onclick="adminSaveMonthMissions()">Enregistrer missions actives</button>
              <div id="adminMonthToast" class="toast"></div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="card">
            <div class="head"><div class="h2">Retours (Partiel / Non fait)</div></div>
            <button class="btn" id="btnRetours" onclick="adminLoadRetours()">Charger retours</button>
            <div class="divider"></div>
            <div class="scrollBox" id="retoursBox"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- overlay missions accomplies -->
  <div class="overlay" id="doneOverlay" ondblclick="hideDone()">
    <img src="./missions-accomplies.jpg" alt="Missions accomplies"/>
  </div>

<script>
  /********************
   * 1) METS TON URL /exec ICI (OBLIGATOIRE)
   ********************/
  const API_EXEC = "COLLE_ICI_TON_URL_EXEC"; // ex: https://script.google.com/macros/s/XXXXX/exec

  // JSONP sans eval (OK CSP)
  function jsonp(params){
    return new Promise((resolve, reject)=>{
      const cb = "cb_" + Math.random().toString(36).slice(2);
      const url = API_EXEC + "?" + new URLSearchParams({ ...params, callback: cb }).toString();
      const s = document.createElement("script");
      let done = false;

      window[cb] = (data)=>{
        done = true;
        cleanup();
        resolve(data);
      };

      function cleanup(){
        try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
        if (s && s.parentNode) s.parentNode.removeChild(s);
      }

      s.onerror = ()=>{
        if(done) return;
        cleanup();
        reject(new Error("load_error"));
      };

      document.head.appendChild(s);
      s.src = url;
    });
  }

  function setToast(id, msg, ok){
    const el = document.getElementById(id);
    el.className = "toast show " + (ok ? "ok":"bad");
    el.textContent = msg;
  }
  function clearToast(id){
    const el = document.getElementById(id);
    el.className = "toast";
    el.textContent = "";
  }
  function setLoading(btn, on){
    if(!btn) return;
    btn.classList.toggle("loading", !!on);
    btn.disabled = !!on;
  }

  function showView(v){
    document.getElementById("tabAgent").classList.toggle("active", v==="agent");
    document.getElementById("tabAdmin").classList.toggle("active", v==="admin");
    document.getElementById("viewAgent").style.display = (v==="agent") ? "" : "none";
    document.getElementById("viewAdmin").style.display = (v==="admin") ? "" : "none";
  }

  // ---------------- STATE
  let ADMIN = { ok:false, code:"" };
  let AGENT = { ok:false, agent_id:"", nom:"", code:"", must_change:false };
  let DATA = { agents:[], catalog:[], periodes:[] };
  let CURRENT_PERIOD = "";

  // ---------------- INIT
  (async function init(){
    await loadPublicAgents();
    showView("agent");
  })();

  async function loadPublicAgents(){
    const sel = document.getElementById("agentSel");
    sel.innerHTML = `<option value="">Chargement‚Ä¶</option>`;
    try{
      const res = await jsonp({ action:"listAgentsPublic" });
      if(!res || !res.ok) throw new Error("bad");
      DATA.agents = res.agents || [];
      sel.innerHTML = `<option value="">‚Äî Choisir agent ‚Äî</option>` +
        DATA.agents.map(a=>`<option value="${a.agent_id}">${a.nom}</option>`).join("");
    }catch(e){
      sel.innerHTML = `<option value="">‚Äî Erreur chargement ‚Äî</option>`;
    }
  }

  // ---------------- ADMIN
  async function adminLogin(){
    clearToast("adminToast");
    const code = document.getElementById("adminCode").value.trim();
    const btn = document.getElementById("btnAdminLogin");
    if(!code){ setToast("adminToast","Code requis.", false); return; }
    setLoading(btn,true);

    try{
      const res = await jsonp({ action:"adminLogin", admin_code: code });
      if(res && res.ok){
        ADMIN = { ok:true, code };
        document.getElementById("adminStatus").className = "status ok";
        document.getElementById("adminStatus").textContent = "Admin : connect√©";
        document.getElementById("adminBody").style.display = "";
        document.getElementById("adminKey").style.display = "";
        document.getElementById("adminLogout").style.display = "";
        setToast("adminToast","Admin connect√© ‚úÖ", true);
        await adminBootstrap();
      }else{
        ADMIN = { ok:false, code:"" };
        document.getElementById("adminStatus").className = "status bad";
        document.getElementById("adminStatus").textContent = "Admin : non connect√©";
        setToast("adminToast","Code admin incorrect.", false);
      }
    }catch(e){
      setToast("adminToast","Erreur r√©seau (load_error).", false);
    }finally{
      setLoading(btn,false);
    }
  }

  function adminLogout(){
    ADMIN = { ok:false, code:"" };
    document.getElementById("adminBody").style.display = "none";
    document.getElementById("adminKey").style.display = "none";
    document.getElementById("adminLogout").style.display = "none";
    document.getElementById("adminStatus").className = "status";
    document.getElementById("adminStatus").textContent = "Admin : non connect√©";
    clearToast("adminToast");
  }

  function toggleAdminKey(){
    const box = document.getElementById("adminKeyBox");
    box.style.display = (box.style.display === "none" || !box.style.display) ? "" : "none";
  }

  async function adminChangeCode(){
    clearToast("adminChangeToast");
    const new_code = document.getElementById("adminNewCode").value.trim();
    const btn = document.getElementById("btnAdminChange");
    if(!ADMIN.ok) return;
    if(new_code.length < 4){ setToast("adminChangeToast","Min 4 caract√®res.", false); return; }
    setLoading(btn,true);
    try{
      const res = await jsonp({ action:"adminChangeCode", admin_code: ADMIN.code, new_code });
      if(res && res.ok){
        ADMIN.code = new_code;
        document.getElementById("adminCode").value = new_code;
        setToast("adminChangeToast","Code admin modifi√© ‚úÖ", true);
      } else {
        setToast("adminChangeToast","Erreur modification.", false);
      }
    }catch(e){
      setToast("adminChangeToast","Erreur r√©seau.", false);
    }finally{
      setLoading(btn,false);
    }
  }

  async function adminBootstrap(){
    await adminLoadPeriodes();
    await adminListAgents();
    await adminListCatalog();
  }

  async function adminLoadPeriodes(){
    const sel = document.getElementById("periodeSel");
    sel.innerHTML = `<option value="">Chargement‚Ä¶</option>`;
    try{
      const res = await jsonp({ action:"adminListPeriodes", admin_code: ADMIN.code });
      if(!res || !res.ok) throw new Error("bad");
      DATA.periodes = res.periodes || [];
      sel.innerHTML = `<option value="">‚Äî Choisir p√©riode ‚Äî</option>` +
        DATA.periodes.filter(p=>p.actif).map(p=>`<option value="${p.period_id}">${p.libelle}</option>`).join("");
    }catch(e){
      sel.innerHTML = `<option value="">‚Äî Erreur ‚Äî</option>`;
    }
  }

  async function adminListAgents(){
    const box = document.getElementById("adminAgentsBox");
    box.innerHTML = `<div class="muted" style="padding:10px">Chargement‚Ä¶</div>`;
    try{
      const res = await jsonp({ action:"adminListAgents", admin_code: ADMIN.code });
      if(!res || !res.ok) throw new Error("bad");
      const list = res.agents || [];
      const addSel = document.getElementById("addToGroupSel");
      addSel.innerHTML = `<option value="">‚Äî Choisir agent ‚Äî</option>` +
        list.filter(a=>a.actif).map(a=>`<option value="${a.agent_id}">${a.nom}</option>`).join("");

      box.innerHTML = list.map(a=>`
        <div class="listRow">
          <div>
            <div class="name">${a.nom}</div>
            <div class="muted">${a.actif ? "Actif ‚úÖ":"Inactif ‚ùå"}</div>
          </div>
          <div class="toolRow">
            <button class="btn ${a.actif?'ok':'ghost'}" onclick="adminToggleAgent('${a.agent_id}', ${a.actif?0:1})">${a.actif?'Actif':'Activer'}</button>
            <button class="btn" onclick="adminResetAgentCode('${a.agent_id}')">Reset 0000</button>
            <button class="btn bad" onclick="adminDeleteAgent('${a.agent_id}')">Supprimer</button>
          </div>
        </div>
      `).join("");
    }catch(e){
      box.innerHTML = `<div class="muted" style="padding:10px">Erreur chargement.</div>`;
    }
  }

  async function adminAddAgent(){
    clearToast("adminAgentToast");
    const nom = document.getElementById("newAgentName").value.trim();
    const code = document.getElementById("newAgentCode").value.trim() || "0000";
    const btn = document.getElementById("btnAddAgent");
    if(!nom){ setToast("adminAgentToast","Nom requis.", false); return; }
    setLoading(btn,true);
    try{
      const res = await jsonp({ action:"adminAddAgent", admin_code: ADMIN.code, nom, code });
      if(res && res.ok){
        setToast("adminAgentToast","Agent ajout√© ‚úÖ", true);
        document.getElementById("newAgentName").value="";
        document.getElementById("newAgentCode").value="0000";
        await adminListAgents();
        await loadPublicAgents();
      }else{
        setToast("adminAgentToast","Erreur ajout.", false);
      }
    }catch(e){
      setToast("adminAgentToast","Erreur r√©seau.", false);
    }finally{
      setLoading(btn,false);
    }
  }

  async function adminToggleAgent(agent_id, toActive){
    await jsonp({ action:"adminToggleAgent", admin_code: ADMIN.code, agent_id, actif: toActive ? "TRUE":"FALSE" });
    await adminListAgents();
    await loadPublicAgents();
  }

  async function adminDeleteAgent(agent_id){
    if(!confirm("Supprimer d√©finitivement ?")) return;
    await jsonp({ action:"adminDeleteAgent", admin_code: ADMIN.code, agent_id });
    await adminListAgents();
    await loadPublicAgents();
  }

  async function adminResetAgentCode(agent_id){
    await jsonp({ action:"adminResetAgentCode", admin_code: ADMIN.code, agent_id });
    await adminListAgents();
  }

  async function adminListCatalog(){
    const box = document.getElementById("adminMissionsBox");
    box.innerHTML = `<div class="muted" style="padding:10px">Chargement‚Ä¶</div>`;
    try{
      const res = await jsonp({ action:"adminListCatalog", admin_code: ADMIN.code });
      if(!res || !res.ok) throw new Error("bad");
      const list = res.catalog || [];
      box.innerHTML = list.map(m=>`
        <div class="listRow">
          <div>
            <div class="name">${m.libelle}</div>
            <div class="muted">${m.actif ? "Active ‚úÖ":"Inactive ‚ùå"}</div>
          </div>
          <div class="toolRow">
            <button class="btn ${m.actif?'ok':'ghost'}" onclick="adminToggleMission('${m.mission_id}', ${m.actif?0:1})">${m.actif?'Active':'Activer'}</button>
            <button class="btn bad" onclick="adminDeleteMission('${m.mission_id}')">Supprimer</button>
          </div>
        </div>
      `).join("");
    }catch(e){
      box.innerHTML = `<div class="muted" style="padding:10px">Erreur chargement.</div>`;
    }
  }

  async function adminAddMission(){
    clearToast("adminMissionToast");
    const libelle = document.getElementById("newMissionLib").value.trim();
    const btn = document.getElementById("btnAddMission");
    if(!libelle){ setToast("adminMissionToast","Libell√© requis.", false); return; }
    setLoading(btn,true);
    try{
      const res = await jsonp({ action:"adminAddMission", admin_code: ADMIN.code, libelle });
      if(res && res.ok){
        setToast("adminMissionToast","Mission ajout√©e ‚úÖ", true);
        document.getElementById("newMissionLib").value="";
        await adminListCatalog();
        if(CURRENT_PERIOD) await adminGetMonthMissions();
      }else{
        setToast("adminMissionToast","Erreur ajout.", false);
      }
    }catch(e){
      setToast("adminMissionToast","Erreur r√©seau.", false);
    }finally{
      setLoading(btn,false);
    }
  }

  async function adminToggleMission(mission_id, toActive){
    await jsonp({ action:"adminToggleMission", admin_code: ADMIN.code, mission_id, actif: toActive ? "TRUE":"FALSE" });
    await adminListCatalog();
    if(CURRENT_PERIOD) await adminGetMonthMissions();
  }
  async function adminDeleteMission(mission_id){
    if(!confirm("Supprimer d√©finitivement ?")) return;
    await jsonp({ action:"adminDeleteMission", admin_code: ADMIN.code, mission_id });
    await adminListCatalog();
    if(CURRENT_PERIOD) await adminGetMonthMissions();
  }

  async function adminLoadPeriod(){
    clearToast("adminGroupToast");
    const pid = document.getElementById("periodeSel").value;
    const btn = document.getElementById("btnLoadPeriod");
    if(!pid){ setToast("adminGroupToast","Choisis une p√©riode.", false); return; }
    setLoading(btn,true);
    try{
      const res = await jsonp({ action:"adminLoadPeriod", admin_code: ADMIN.code, period_id: pid });
      if(!res || !res.ok) throw new Error("bad");
      CURRENT_PERIOD = pid;

      // responsable
      document.getElementById("respStatus").className = "status " + (res.responsable ? "ok":"");
      document.getElementById("respStatus").textContent = "Responsable : " + (res.responsable ? res.responsable.nom : "‚Äî");

      // groupe list
      const groupBox = document.getElementById("adminGroupBox");
      const group = res.group || [];
      groupBox.innerHTML = group.length ? group.map(a=>`
        <div class="listRow">
          <div class="name">${a.nom}</div>
          <button class="btn bad" onclick="adminRemoveFromGroup('${a.agent_id}')">Retirer</button>
        </div>
      `).join("") : `<div class="muted" style="padding:10px">Aucun agent dans le groupe.</div>`;

      // responsable select
      const rsel = document.getElementById("responsableSel");
      rsel.innerHTML = `<option value="">‚Äî Choisir ‚Äî</option>` +
        group.map(a=>`<option value="${a.agent_id}">${a.nom}</option>`).join("");

      await adminGetMonthMissions();
      await adminLoadRetours();

      setToast("adminGroupToast","P√©riode charg√©e ‚úÖ", true);
    }catch(e){
      setToast("adminGroupToast","Erreur chargement p√©riode.", false);
    }finally{
      setLoading(btn,false);
    }
  }

  async function adminAddToGroup(){
    const pid = document.getElementById("periodeSel").value;
    const aid = document.getElementById("addToGroupSel").value;
    const btn = document.getElementById("btnAddToGroup");
    if(!pid || !aid) { setToast("adminGroupToast","P√©riode + agent requis.", false); return; }
    setLoading(btn,true);
    try{
      const res = await jsonp({ action:"adminAddToGroup", admin_code: ADMIN.code, period_id: pid, agent_id: aid });
      if(res && res.ok){
        await adminLoadPeriod();
      }else{
        setToast("adminGroupToast","Erreur ajout.", false);
      }
    }catch(e){
      setToast("adminGroupToast","Erreur r√©seau.", false);
    }finally{
      setLoading(btn,false);
    }
  }

  async function adminRemoveFromGroup(agent_id){
    const pid = document.getElementById("periodeSel").value;
    await jsonp({ action:"adminRemoveFromGroup", admin_code: ADMIN.code, period_id: pid, agent_id });
    await adminLoadPeriod();
  }

  async function adminSetResponsable(){
    const pid = document.getElementById("periodeSel").value;
    const aid = document.getElementById("responsableSel").value;
    const btn = document.getElementById("btnSetResp");
    if(!pid || !aid){ setToast("adminGroupToast","Choisis un responsable.", false); return; }
    setLoading(btn,true);
    try{
      const res = await jsonp({ action:"adminSetResponsable", admin_code: ADMIN.code, period_id: pid, agent_id: aid });
      if(res && res.ok){
        await adminLoadPeriod();
      }else{
        setToast("adminGroupToast","Erreur responsable.", false);
      }
    }finally{
      setLoading(btn,false);
    }
  }

  // missions actives
  async function adminGetMonthMissions(){
    const box = document.getElementById("monthBox");
    box.innerHTML = `<div class="muted" style="padding:10px">Chargement‚Ä¶</div>`;
    const res = await jsonp({ action:"adminGetMonthMissions", admin_code: ADMIN.code, period_id: CURRENT_PERIOD });
    if(!res || !res.ok){ box.innerHTML = `<div class="muted" style="padding:10px">Erreur.</div>`; return; }

    const on = new Set((res.missionsOn||[]).map(m=>m.mission_id));
    box.innerHTML = (res.missionsAll||[]).map(m=>`
      <div class="checkRow">
        <input type="checkbox" data-mid="${m.mission_id}" ${on.has(m.mission_id)?"checked":""}/>
        <div style="flex:1;min-width:0">
          <div class="checkLabel">${m.libelle}</div>
        </div>
      </div>
    `).join("");
  }

  async function adminSaveMonthMissions(){
    clearToast("adminMonthToast");
    const btn = document.getElementById("btnSaveMonth");
    setLoading(btn,true);
    try{
      const mids = Array.from(document.querySelectorAll('#monthBox input[type="checkbox"][data-mid]'))
        .filter(c=>c.checked).map(c=>c.getAttribute("data-mid"));
      const res = await jsonp({
        action:"adminSaveMonthMissions",
        admin_code: ADMIN.code,
        period_id: CURRENT_PERIOD,
        ids: mids.join(",")
      });
      if(res && res.ok){
        setToast("adminMonthToast","Missions actives enregistr√©es ‚úÖ", true);
      }else{
        setToast("adminMonthToast","Erreur enregistrement.", false);
      }
    }catch(e){
      setToast("adminMonthToast","Erreur r√©seau.", false);
    }finally{
      setLoading(btn,false);
    }
  }

  async function adminLoadRetours(){
    const box = document.getElementById("retoursBox");
    box.innerHTML = `<div class="muted" style="padding:10px">Chargement‚Ä¶</div>`;
    try{
      const res = await jsonp({ action:"adminGetRetours", admin_code: ADMIN.code, period_id: CURRENT_PERIOD });
      if(!res || !res.ok){ box.innerHTML = `<div class="muted" style="padding:10px">Erreur.</div>`; return; }
      const items = res.items || [];
      if(!items.length){
        box.innerHTML = `<div class="muted" style="padding:10px">Aucun retour.</div>`;
        return;
      }
      box.innerHTML = items.map(it=>`
        <div class="listRow">
          <div>
            <div class="name">${it.agent}</div>
            <div class="muted">${it.mission}</div>
          </div>
          <div class="status bad">${it.declaration}</div>
        </div>
      `).join("");
    }catch(e){
      box.innerHTML = `<div class="muted" style="padding:10px">Erreur.</div>`;
    }
  }

  // ---------------- AGENT
  function toggleAgentKey(){
    const box = document.getElementById("agentKeyBox");
    box.style.display = (box.style.display === "none" || !box.style.display) ? "" : "none";
  }

  function agentLogout(){
    AGENT = { ok:false, agent_id:"", nom:"", code:"", must_change:false };
    document.getElementById("agentStatus").className = "status";
    document.getElementById("agentStatus").textContent = "Agent : non connect√©";
    document.getElementById("agentWork").style.display = "none";
    document.getElementById("agentKey").style.display = "none";
    document.getElementById("agentLogout").style.display = "none";
    document.getElementById("agentKeyBox").style.display = "none";
    document.getElementById("agentMissions").innerHTML = `<div class="muted" style="padding:10px">Choisis une p√©riode puis ‚ÄúCharger‚Äù.</div>`;
    clearToast("agentToast");
    clearToast("agentSaveToast");
  }

  async function agentLogin(){
    clearToast("agentToast");
    const btn = document.getElementById("btnAgentLogin");
    const agent_id = document.getElementById("agentSel").value;
    const code = document.getElementById("agentCode").value.trim();
    if(!agent_id || !code){ setToast("agentToast","S√©lection + code requis.", false); return; }
    setLoading(btn,true);
    try{
      const res = await jsonp({ action:"agentLogin", agent_id, code });
      if(!res || !res.ok){
        setToast("agentToast", res && res.message ? res.message : "Erreur connexion.", false);
        return;
      }
      AGENT = {
        ok:true,
        agent_id: res.agent.agent_id,
        nom: res.agent.nom,
        code,
        must_change: !!res.agent.must_change
      };

      document.getElementById("agentStatus").className = "status ok";
      document.getElementById("agentStatus").textContent = "Agent : " + AGENT.nom;
      document.getElementById("agentWork").style.display = "";
      document.getElementById("agentKey").style.display = "";
      document.getElementById("agentLogout").style.display = "";

      // p√©riodes
      const psel = document.getElementById("agentPeriodSel");
      psel.innerHTML = `<option value="">‚Äî Choisir p√©riode ‚Äî</option>` +
        (res.periodes || []).map(p=>`<option value="${p.period_id}">${p.libelle}</option>`).join("");

      // obligation 1√®re connexion
      if(AGENT.must_change){
        setToast("agentToast","‚ö†Ô∏è Tu dois changer ton code (üîë) avant de continuer.", false);
        document.getElementById("agentKeyBox").style.display = "";
      }else{
        setToast("agentToast","Connect√© ‚úÖ", true);
      }
    }catch(e){
      setToast("agentToast","Erreur r√©seau (load_error).", false);
    }finally{
      setLoading(btn,false);
    }
  }

  async function agentChangeCode(){
    clearToast("agentChangeToast");
    const old_code = document.getElementById("agentOldCode").value.trim();
    const new_code = document.getElementById("agentNewCode").value.trim();
    const btn = document.getElementById("btnAgentChangeCode");
    if(!AGENT.ok) return;
    if(new_code.length < 4){ setToast("agentChangeToast","Min 4 caract√®res.", false); return; }
    setLoading(btn,true);
    try{
      const res = await jsonp({ action:"agentChangeCode", agent_id: AGENT.agent_id, old_code, new_code });
      if(res && res.ok){
        AGENT.code = new_code;
        document.getElementById("agentCode").value = new_code;
        setToast("agentChangeToast","Code modifi√© ‚úÖ", true);
        document.getElementById("agentKeyBox").style.display = "none";
      }else{
        setToast("agentChangeToast", res && res.message ? res.message : "Erreur", false);
      }
    }catch(e){
      setToast("agentChangeToast","Erreur r√©seau.", false);
    }finally{
      setLoading(btn,false);
    }
  }

  async function agentLoadPeriod(){
    clearToast("agentSaveToast");
    const pid = document.getElementById("agentPeriodSel").value;
    const btn = document.getElementById("btnAgentLoad");
    if(!AGENT.ok) return;
    if(AGENT.must_change){ setToast("agentSaveToast","Change ton code d‚Äôabord (üîë).", false); return; }
    if(!pid){ setToast("agentSaveToast","Choisis une p√©riode.", false); return; }
    setLoading(btn,true);
    try{
      const res = await jsonp({ action:"agentLoadPeriod", agent_id: AGENT.agent_id, code: AGENT.code, period_id: pid });
      if(!res || !res.ok){ setToast("agentSaveToast", res && res.message ? res.message : "Erreur", false); return; }

      document.getElementById("agentRemark").value = res.remarque || "";

      const list = res.missions || [];
      const box = document.getElementById("agentMissions");
      if(!list.length){
        box.innerHTML = `<div class="muted" style="padding:10px">Aucune mission active.</div>`;
        return;
      }

      box.innerHTML = list.map(m=>`
        <div class="checkRow" data-mid="${m.mission_id}">
          <input type="checkbox" class="done" ${m.declaration==="Fait" ? "checked":""}/>
          <div style="flex:1;min-width:0">
            <div class="checkLabel">${m.libelle}</div>
            <div class="muted">D√©claration :
              <select class="dec">
                <option value="" ${m.declaration===""?"selected":""}>‚Äî</option>
                <option value="Fait" ${m.declaration==="Fait"?"selected":""}>Fait</option>
                <option value="Partiel" ${m.declaration==="Partiel"?"selected":""}>Partiel</option>
                <option value="Non fait" ${m.declaration==="Non fait"?"selected":""}>Non fait</option>
              </select>
            </div>
            <div class="muted" style="margin-top:6px">
              Justificatif :
              <input class="justif" value="${(m.justificatif||"").replace(/"/g,"&quot;")}" placeholder="si Partiel/Non fait"/>
            </div>
          </div>
        </div>
      `).join("");

      // aligne checkbox <-> select (si check => Fait)
      box.querySelectorAll(".checkRow").forEach(row=>{
        const cb = row.querySelector(".done");
        const sel = row.querySelector(".dec");
        cb.addEventListener("change", ()=>{
          if(cb.checked) sel.value = "Fait";
          if(!cb.checked && sel.value==="Fait") sel.value = "";
        });
      });

      setToast("agentSaveToast","Charg√© ‚úÖ", true);
    }catch(e){
      setToast("agentSaveToast","Erreur r√©seau.", false);
    }finally{
      setLoading(btn,false);
    }
  }

  async function agentSave(){
    const btn = document.getElementById("btnAgentSave");
    const pid = document.getElementById("agentPeriodSel").value;
    if(!AGENT.ok || !pid) return;

    setLoading(btn,true);
    try{
      const rows = Array.from(document.querySelectorAll("#agentMissions .checkRow[data-mid]"));
      const items = rows.map(r=>{
        return {
          mission_id: r.getAttribute("data-mid"),
          declaration: r.querySelector(".dec").value,
          justificatif: r.querySelector(".justif").value
        };
      });
      const remarque = document.getElementById("agentRemark").value.trim();

      const res = await jsonp({
        action:"agentSaveDeclarations",
        agent_id: AGENT.agent_id,
        code: AGENT.code,
        period_id: pid,
        items: JSON.stringify(items),
        remarque
      });

      if(res && res.ok){
        setToast("agentSaveToast","Enregistr√© ‚úÖ", true);
        if(res.all_done){
          showDone();
        }
      }else{
        setToast("agentSaveToast", res && res.message ? res.message : "Erreur", false);
      }
    }catch(e){
      setToast("agentSaveToast","Erreur r√©seau.", false);
    }finally{
      setLoading(btn,false);
    }
  }

  function showDone(){
    const ov = document.getElementById("doneOverlay");
    ov.classList.add("show");
  }
  function hideDone(){
    const ov = document.getElementById("doneOverlay");
    ov.classList.remove("show");
  }
</script>
</body>
</html>
