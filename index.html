<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Entretien CS Consenvoye</title>

  <!-- IMPORTANT : mets ton URL /exec Apps Script ici -->
  <script>
    const API_EXEC = "https://script.google.com/macros/s/AKfycbwTo8mKf9yDCmFDZbT03-nbxv5QVLcMjNEGuvlL25alCktBLX9P-G3i4NTVMw048DE/exec";
  </script>

  <script src="./adapter.js"></script>

  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1724; --panel2:#111b2b;
      --stroke:rgba(255,255,255,.12);
      --text:#e8eef9; --muted:rgba(232,238,249,.72);
      --accent:#ff7a00; --accent2:#ffb000;
      --danger:#ff3b30; --ok:#1fd36b;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --r:18px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial, "Noto Sans", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:var(--font);color:var(--text);
      background:
        radial-gradient(900px 420px at 20% 20%, rgba(255,122,0,.18), transparent 65%),
        radial-gradient(900px 420px at 80% 10%, rgba(255,176,0,.12), transparent 60%),
        linear-gradient(180deg, #06080b, var(--bg));
      min-height:100vh;
      overflow-x:hidden;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:22px 14px 46px}
    h1{margin:0;font-size:30px;font-weight:900;letter-spacing:.2px;color:#ff8d1a;text-shadow:0 2px 14px rgba(255,122,0,.18);text-align:center;}
    .subtitle{margin:6px 0 0;color:var(--muted);font-size:12px;text-align:center}
    .tabsCenter{margin:14px 0 18px;display:flex;justify-content:center;}
    .tabs{display:flex;gap:8px;align-items:center;border:1px solid var(--stroke);background:rgba(255,255,255,.02);padding:6px;border-radius:999px;box-shadow:var(--shadow);}
    .tab{border:0;background:transparent;color:var(--muted);padding:10px 14px;border-radius:999px;cursor:pointer;font-weight:900;font-size:13px;}
    .tab.active{background:linear-gradient(90deg, rgba(255,122,0,.26), rgba(255,176,0,.18));color:var(--text);}
    .btn{
      appearance:none;border:1px solid var(--stroke);background:rgba(255,255,255,.03);
      color:var(--text);border-radius:999px;padding:10px 14px;cursor:pointer;
      font-weight:900;font-size:13px;transition:.15s transform ease,.15s background ease,.15s border-color ease;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.2);background:rgba(255,255,255,.06)}
    .btn.primary{background:linear-gradient(90deg, var(--accent), var(--accent2));border-color:transparent;color:#0b0f14;box-shadow:0 12px 26px rgba(255,122,0,.18);}
    .btn.danger{background:rgba(255,59,48,.14);border-color:rgba(255,59,48,.35);color:#ffd0cd}
    .btn.small{padding:8px 12px;font-size:12px}
    .btn.loading,
    .btn.primary.loading{
      background: linear-gradient(90deg, #1fd36b, #7dff9c) !important;
      border-color: transparent !important;
      color:#0b0f14 !important;
      box-shadow: 0 12px 26px rgba(31,211,107,.18) !important;
      cursor: wait !important;
      opacity: 0.95;
    }
    .btn.loading::after{ content:" ‚è≥"; font-weight:900; }
    .btn[disabled]{opacity:.6;cursor:not-allowed}

    .card{border:1px solid var(--stroke);background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));border-radius:var(--r);padding:16px;box-shadow:var(--shadow);}
    .headRow{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;flex-wrap:wrap}
    .h2{margin:0;font-size:15px;font-weight:900}
    .status{font-size:12px;font-weight:900;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.02);color:var(--muted);display:inline-flex;align-items:center;gap:8px;white-space:nowrap;}
    .status.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.10);color:#bdf6d2}
    .status.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.10);color:#ffd0cd}
    .pillBtn{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.04);
      color:var(--text);
      border-radius:999px;
      padding:9px 12px;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .pillBtn:hover{background:rgba(255,255,255,.06)}
    .pillBtn.key{background:rgba(255,176,0,.12);border-color:rgba(255,176,0,.28)}
    .pillBtn.logout{background:rgba(255,59,48,.10);border-color:rgba(255,59,48,.28);color:#ffd0cd}

    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
    input, select, textarea{
      width:100%;padding:11px 12px;border-radius:12px;border:1px solid var(--stroke);
      background:rgba(0,0,0,.25);color:var(--text);outline:none;font-size:13px;
    }
    textarea{min-height:90px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .row > *{flex:1;min-width:220px}
    .divider{height:1px;background:rgba(255,255,255,.09);margin:14px 0}
    .twoCol{display:grid;gap:12px}
    @media(min-width:1000px){ .twoCol{grid-template-columns: 1fr 1.2fr;} }

    .toast{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);background:rgba(255,255,255,.02);color:var(--muted);font-size:13px;display:none}
    .toast.show{display:block}
    .toast.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.08);color:#c9f9db}
    .toast.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.08);color:#ffd0cd}

    /* SCROLL LISTES */
    .scrollBox{
      max-height:260px;
      overflow:auto;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.18);
    }
    .listItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .listItem:last-child{border-bottom:0}
    .listLeft{min-width:0}
    .listTitle{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .listSub{font-size:12px;color:rgba(232,238,249,.55)}
    .pillRow{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .ghost{color:rgba(232,238,249,.55)}

    /* Missions (checkbox) align√©es */
    .mRow{display:flex;align-items:center;gap:12px;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08)}
    .mRow:last-child{border-bottom:0}
    .mRow input[type="checkbox"]{width:18px;height:18px;flex:0 0 auto;cursor:pointer}
    .mLabel{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* popup change code */
    .modalBack{
      position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;padding:16px;
      z-index:9999;
    }
    .modalBack.show{display:flex}
    .modal{
      width:min(520px, 100%);
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(17,27,43,.98), rgba(15,23,36,.98));
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:16px;
    }

    /* Image "missions accomplies" */
    .doneWrap{
      display:none;
      margin-top:12px;
      border-radius:18px;
      overflow:hidden;
      border:1px solid var(--stroke);
    }
    .doneWrap.show{display:block}
    .doneWrap img{display:block;width:100%;height:auto}

    @media (max-width: 700px){
      .wrap{max-width:none;width:100%;margin:0;padding:12px}
      input, select, textarea, button, .btn{width:100% !important;min-height:44px;font-size:16px}
      .row > *{min-width:100% !important}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Entretien du centre de secours de Consenvoye</h1>
    <div class="subtitle">JTUB (GitHub) ‚Ä¢ Sheets (moteur)</div>

    <div class="tabsCenter">
      <div class="tabs">
        <button class="tab active" id="tabAgent" onclick="showView('agent')">üßë‚Äçüöí Agent</button>
        <button class="tab" id="tabAdmin" onclick="showView('admin')">üõ°Ô∏è Admin</button>
        <button class="btn" onclick="hardReload()">Recharger</button>
      </div>
    </div>

    <!-- ================= AGENT ================= -->
    <div id="viewAgent" class="card">
      <div class="headRow">
        <div class="h2">Espace agent</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;align-items:center">
          <button id="agentKey" class="pillBtn key" style="display:none" onclick="openChangeCode('agent')">üîë Changer mon code</button>
          <button id="agentLogout" class="pillBtn logout" style="display:none" onclick="agentLogout()">D√©connexion</button>
          <div class="status" id="agentStatus">Agent : non connect√©</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Agent</label>
          <select id="agentSel"></select>
        </div>
        <div>
          <label>Code</label>
          <input id="agentCode" placeholder="Code agent" />
        </div>
        <div class="right">
          <button class="btn primary" id="btnAgentLogin" onclick="agentLogin(event)">Se connecter</button>
        </div>
      </div>

      <div id="agentToast" class="toast"></div>

      <div class="divider"></div>

      <div id="agentWork" style="display:none">
        <div class="headRow">
          <div class="h2">P√©riode</div>
          <div class="status" id="agentPeriodPill">‚Äî</div>
        </div>

        <div class="row">
          <div>
            <label>Choisir p√©riode</label>
            <select id="agentPeriodeSel"></select>
          </div>
          <div class="right">
            <button class="btn primary" id="btnAgentLoadPeriode" onclick="agentLoadPeriode(event)">Charger</button>
          </div>
        </div>

        <div class="divider"></div>

        <div>
          <label>Remarque g√©n√©rale (facultatif)</label>
          <textarea id="agentRemark" placeholder="Remarque g√©n√©rale..."></textarea>
        </div>

        <div class="divider"></div>

        <div class="headRow">
          <div class="h2">Missions du mois</div>
          <div class="status" id="agentMissionsPill">‚Äî</div>
        </div>

        <div class="scrollBox" id="agentMissionsBox">
          <div class="listItem"><div class="ghost">Choisis une p√©riode puis ‚ÄúCharger‚Äù.</div></div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div></div>
          <div class="right">
            <button class="btn primary" id="btnAgentSave" onclick="agentSave(event)">Enregistrer</button>
          </div>
        </div>

        <div id="agentSaveToast" class="toast"></div>

        <!-- Image missions accomplies -->
        <div id="doneWrap" class="doneWrap" ondblclick="hideDoneImage()">
          <!-- On branchera l'image plus tard, sans casser. -->
          <img id="doneImg" alt="missions accomplies" src="" />
        </div>
      </div>
    </div>

    <!-- ================= ADMIN ================= -->
    <div id="viewAdmin" class="card" style="display:none">
      <div class="headRow">
        <div class="h2">Espace admin</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;align-items:center">
          <button id="adminKey" class="pillBtn key" style="display:none" onclick="openChangeCode('admin')">üîë Changer le code</button>
          <button id="adminLogout" class="pillBtn logout" style="display:none" onclick="adminLogout()">D√©connexion</button>
          <div class="status" id="adminStatus">Admin : non connect√©</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Code admin</label>
          <input id="adminCode" placeholder="Code admin" />
        </div>
        <div class="right">
          <button class="btn primary" id="btnAdminLogin" onclick="adminLogin(event)">Se connecter</button>
        </div>
      </div>

      <div id="adminToast" class="toast"></div>

      <div id="adminBody" style="display:none">
        <div class="divider"></div>

        <div class="twoCol">
          <!-- Agents -->
          <div class="card">
            <div class="headRow"><div class="h2">üë• Agents</div><div class="status" id="agentsCountPill">‚Äî</div></div>
            <div class="row">
              <div>
                <label>Nom</label>
                <input id="newAgentName" placeholder="Nom Pr√©nom" />
              </div>
              <div>
                <label>Code</label>
                <input id="newAgentCode" value="0000" />
              </div>
              <div class="right">
                <button class="btn primary" id="btnAddAgent" onclick="adminAddAgent(event)">Ajouter</button>
              </div>
            </div>
            <div id="adminAgentToast" class="toast"></div>
            <div class="divider"></div>
            <div class="scrollBox" id="adminAgentsBox">
              <div class="listItem"><div class="ghost">‚Äî</div></div>
            </div>
          </div>

          <!-- Catalogue missions -->
          <div class="card">
            <div class="headRow"><div class="h2">üìö Catalogue missions</div><div class="status" id="catalogCountPill">‚Äî</div></div>
            <div class="row">
              <div>
                <label>Libell√©</label>
                <input id="newMissionLib" placeholder="Ex : Nettoyage" />
              </div>
              <div class="right">
                <button class="btn primary" id="btnAddMission" onclick="adminAddMission(event)">Ajouter</button>
              </div>
            </div>
            <div id="adminMissionToast" class="toast"></div>
            <div class="divider"></div>
            <div class="scrollBox" id="adminCatalogBox">
              <div class="listItem"><div class="ghost">‚Äî</div></div>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- P√©riode / Groupe / Missions actives / Retours -->
        <div class="card">
          <div class="headRow">
            <div class="h2">üìÖ P√©riode / Groupe / Missions actives / Retours</div>
            <div class="status" id="responsablePill">Responsable : ‚Äî</div>
          </div>

          <div class="row">
            <div>
              <label>P√©riode</label>
              <select id="adminPeriodeSel"></select>
            </div>
            <div class="right">
              <button class="btn primary" id="btnLoadPeriode" onclick="adminLoadPeriode(event)">Charger</button>
            </div>
          </div>

          <div id="adminPeriodeToast" class="toast"></div>

          <div class="divider"></div>

          <div class="twoCol">
            <!-- Groupe -->
            <div class="card">
              <div class="headRow"><div class="h2">Groupe</div></div>

              <div class="row">
                <div>
                  <label>Ajouter au groupe</label>
                  <select id="addToGroupSel"></select>
                </div>
                <div class="right">
                  <button class="btn primary" id="btnAddToGroup" onclick="adminAddToGroup(event)">Ajouter</button>
                </div>
              </div>

              <div class="row" style="margin-top:10px">
                <div>
                  <label>Responsable</label>
                  <select id="responsableSel"></select>
                </div>
                <div class="right">
                  <button class="btn primary" id="btnSetResponsable" onclick="adminSetResponsable(event)">D√©finir</button>
                </div>
              </div>

              <div id="adminGroupToast" class="toast"></div>

              <div class="divider"></div>

              <div class="scrollBox" id="adminGroupBox">
                <div class="listItem"><div class="ghost">Charge une p√©riode.</div></div>
              </div>
            </div>

            <!-- Missions actives -->
            <div class="card">
              <div class="headRow"><div class="h2">Missions actives</div></div>

              <div class="scrollBox" id="adminMonthMissionsBox">
                <div class="listItem"><div class="ghost">Charge une p√©riode.</div></div>
              </div>

              <div class="divider"></div>

              <div class="row">
                <div></div>
                <div class="right">
                  <button class="btn primary" id="btnSaveMonthMissions" onclick="adminSaveMonthMissions(event)">Enregistrer missions actives</button>
                </div>
              </div>

              <div id="adminMonthToast" class="toast"></div>
            </div>
          </div>

          <div class="divider"></div>

          <!-- Retours -->
          <div class="card">
            <div class="headRow"><div class="h2">Retours (Partiel / Non fait)</div></div>
            <div class="row">
              <div></div>
              <div class="right">
                <button class="btn" id="btnLoadRetours" onclick="adminLoadRetours(event)">Charger retours</button>
              </div>
            </div>
            <div class="divider"></div>
            <div class="scrollBox" id="adminRetoursBox">
              <div class="listItem"><div class="ghost">‚Äî</div></div>
            </div>
            <div id="adminRetoursToast" class="toast"></div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- MODAL changement code -->
  <div id="modalBack" class="modalBack" onclick="closeModalIfBack(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="headRow">
        <div class="h2" id="modalTitle">Changer le code</div>
        <button class="btn small" onclick="closeModal()">Fermer</button>
      </div>

      <div class="row">
        <div>
          <label>Ancien code</label>
          <input id="oldCode" placeholder="Ancien code" />
        </div>
        <div>
          <label>Nouveau code (min 4)</label>
          <input id="newCode" placeholder="Nouveau code" />
        </div>
        <div class="right">
          <button class="btn primary" id="btnChangeCode" onclick="submitChangeCode(event)">Valider</button>
        </div>
      </div>

      <div id="modalToast" class="toast"></div>
      <div class="ghost" style="margin-top:10px" id="modalHint"></div>
    </div>
  </div>

<script>
/* ========= UI helpers ========= */
function $(id){ return document.getElementById(id); }
function esc(s){ return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function setLoading(btn, on){
  if(!btn) return;
  btn.classList.toggle("loading", !!on);
  btn.disabled = !!on;
}
function toast(id,msg,ok){
  const el=$(id); if(!el) return;
  el.className = "toast show " + (ok ? "ok" : "bad");
  el.textContent = msg || "";
}
function toastHide(id){
  const el=$(id); if(!el) return;
  el.className = "toast"; el.textContent="";
}
function setStatus(id, txt, ok){
  const el=$(id); if(!el) return;
  el.textContent = txt;
  el.className = "status " + (ok===true ? "ok" : ok===false ? "bad":"");
}

/* ========= state ========= */
const STATE = {
  admin: { ok:false, code:"", periode_id:"" },
  agent: { ok:false, agent_id:"", name:"", must_change:false, periode_id:"" },
  data: { agents:[], catalog:[], periodes:[], group:[], missionsAll:[], missionsOn:[], retours:[] }
};

/* ========= Tabs ========= */
function showView(v){
  $("tabAgent").classList.toggle("active", v==="agent");
  $("tabAdmin").classList.toggle("active", v==="admin");
  $("viewAgent").style.display = (v==="agent") ? "" : "none";
  $("viewAdmin").style.display = (v==="admin") ? "" : "none";
}
function hardReload(){ location.reload(); }

/* ========= API (JSONP) ========= */
async function api(action, params){
  // essaye l'action puis variantes "pluriels" / legacy
  const tries = [];
  tries.push(action);

  // Variantes courantes (pour √©viter de ‚Äútourner en rond‚Äù)
  if(action === "adminLoadPeriode") tries.push("adminLoadPeriod");
  if(action === "agentLoadPeriode") tries.push("agentLoadPeriod");
  if(action === "agentListPeriodes") tries.push("agentListPeriods");
  if(action === "adminListPeriodes") tries.push("adminListPeriods");
  if(action === "adminGetMonthMissions") tries.push("adminGetMonthMission");
  if(action === "adminSaveMonthMissions") tries.push("adminSaveMonthMission");
  if(action === "adminGetRetours") tries.push("adminRetours");

  let lastErr = null;
  for(const a of tries){
    try{
      const res = await jsonpRequest(API_EXEC, Object.assign({ action: a }, params || {}));
      if(res && res.ok === false && (res.error === "unknown_action" || res.error === "action_inconnue")){
        lastErr = res; continue;
      }
      return res;
    }catch(e){
      lastErr = e;
    }
  }
  throw lastErr || new Error("api_failed");
}

/* ========= Boot ========= */
(async function init(){
  showView("agent");
  setStatus("agentStatus","Agent : non connect√©", null);
  setStatus("adminStatus","Admin : non connect√©", null);

  // Liste agents publique pour le select agent (pas d‚ÄôID affich√©, juste nom)
  await loadAgentsPublic();
})();

async function loadAgentsPublic(){
  const sel = $("agentSel");
  sel.innerHTML = `<option value="">‚Äî Chargement‚Ä¶ ‚Äî</option>`;
  try{
    // endpoint "public"
    const res = await api("listAgentsPublic", {});
    const agents = (res && res.agents) ? res.agents : [];
    STATE.data.agents = agents;
    sel.innerHTML = `<option value="">‚Äî Choisir agent ‚Äî</option>` +
      agents.filter(a=>a.actif!==false).map(a => `<option value="${esc(a.agent_id)}">${esc(a.nom)}</option>`).join("");
  }catch(e){
    sel.innerHTML = `<option value="">‚Äî Erreur chargement ‚Äî</option>`;
  }
}

/* ========= AGENT ========= */
async function agentLogin(ev){
  toastHide("agentToast");
  const btn = $("btnAgentLogin");
  const agent_id = $("agentSel").value;
  const code = $("agentCode").value.trim();

  if(!agent_id || !code){
    toast("agentToast","S√©lectionne un agent + code.", false);
    return;
  }

  setLoading(btn,true);
  try{
    const res = await api("agentLogin", { agent_id, code });
    if(!res || !res.ok){
      toast("agentToast", msgFR(res && (res.message||res.error)) || "Code incorrect.", false);
      setStatus("agentStatus","Agent : non connect√©", false);
      setLoading(btn,false);
      return;
    }

    STATE.agent.ok = true;
    STATE.agent.agent_id = res.agent?.agent_id || agent_id;
    STATE.agent.name = res.agent?.nom || "";
    STATE.agent.must_change = !!res.agent?.must_change;

    setStatus("agentStatus", "Agent : " + (STATE.agent.name || "connect√©"), true);
    $("agentLogout").style.display = "";
    $("agentKey").style.display = "";
    $("agentWork").style.display = "";

    // p√©riodes
    const psel = $("agentPeriodeSel");
    const periodes = res.periodes || [];
    STATE.data.periodes = periodes;
    psel.innerHTML = `<option value="">‚Äî Choisir p√©riode ‚Äî</option>` +
      periodes.map(p => `<option value="${esc(p.periode_id || p.period_id)}">${esc(p.libelle || p.periode_id || p.period_id)}</option>`).join("");

    $("agentPeriodPill").textContent = "‚Äî";
    $("agentMissionsPill").textContent = "‚Äî";
    $("agentMissionsBox").innerHTML = `<div class="listItem"><div class="ghost">Choisis une p√©riode puis ‚ÄúCharger‚Äù.</div></div>`;
    $("doneWrap").classList.remove("show");
    $("doneImg").src = "";

    // changement obligatoire
    if(STATE.agent.must_change){
      openChangeCode("agent", true);
    }

  }catch(e){
    toast("agentToast","Erreur r√©seau.", false);
  }finally{
    setLoading(btn,false);
  }
}

function agentLogout(){
  STATE.agent = { ok:false, agent_id:"", name:"", must_change:false, periode_id:"" };
  setStatus("agentStatus","Agent : non connect√©", null);
  $("agentLogout").style.display = "none";
  $("agentKey").style.display = "none";
  $("agentWork").style.display = "none";
  $("agentCode").value = "";
  $("agentRemark").value = "";
  $("doneWrap").classList.remove("show");
  $("doneImg").src = "";
}

async function agentLoadPeriode(ev){
  toastHide("agentSaveToast");
  const btn = $("btnAgentLoadPeriode");
  if(!STATE.agent.ok){ toast("agentToast","Connecte-toi d‚Äôabord.", false); return; }

  const periode_id = $("agentPeriodeSel").value;
  if(!periode_id){ toast("agentToast","Choisis une p√©riode.", false); return; }

  setLoading(btn,true);
  try{
    const res = await api("agentLoadPeriode", { agent_id: STATE.agent.agent_id, periode_id });
    if(!res || !res.ok){
      toast("agentToast", msgFR(res && (res.message||res.error)) || "Erreur chargement p√©riode.", false);
      return;
    }

    STATE.agent.periode_id = periode_id;
    $("agentPeriodPill").textContent = (res.periode?.libelle || res.periode?.periode_id || periode_id);

    const missions = res.missions || [];
    if(!missions.length){
      $("agentMissionsBox").innerHTML = `<div class="listItem"><div class="ghost">Aucune mission pour cette p√©riode.</div></div>`;
      $("agentMissionsPill").textContent = "0 mission";
      return;
    }

    $("agentMissionsPill").textContent = missions.length + " missions";
    $("agentMissionsBox").innerHTML = missions.map(m => {
      const dec = String(m.declaration || "").trim(); // "Fait" / "Partiel" / "Non fait" / ""
      const just = String(m.justificatif || "");
      const mid = String(m.mission_id || "");
      return `
        <div class="mRow" data-mid="${esc(mid)}">
          <input type="checkbox" ${dec==="Fait" ? "checked":""} />
          <div style="flex:1;min-width:0">
            <div class="mLabel">${esc(m.libelle || m.mission || "")}</div>
            <div class="listSub">Partiel / Non fait : justificatif requis</div>
            <input class="justif" placeholder="Justificatif (si Partiel / Non fait)" value="${esc(just)}" />
            <div class="row" style="margin-top:8px">
              <div>
                <select class="decl">
                  <option value="" ${dec===""?"selected":""}>‚Äî</option>
                  <option value="Fait" ${dec==="Fait"?"selected":""}>Fait</option>
                  <option value="Partiel" ${dec==="Partiel"?"selected":""}>Partiel</option>
                  <option value="Non fait" ${dec==="Non fait"?"selected":""}>Non fait</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      `;
    }).join("");

    // Image ‚Äúmissions accomplies‚Äù si toutes faites (on l‚Äôaffiche si backend renvoie all_done)
    if(res.all_done === true){
      showDoneImage();
    }else{
      $("doneWrap").classList.remove("show");
    }

  }catch(e){
    toast("agentToast","Erreur r√©seau.", false);
  }finally{
    setLoading(btn,false);
  }
}

async function agentSave(ev){
  toastHide("agentSaveToast");
  const btn = $("btnAgentSave");
  if(!STATE.agent.ok){ toast("agentToast","Connecte-toi d‚Äôabord.", false); return; }
  if(!STATE.agent.periode_id){ toast("agentToast","Charge une p√©riode d‚Äôabord.", false); return; }

  // r√©colte
  const items = Array.from($("agentMissionsBox").querySelectorAll(".mRow")).map(row=>{
    const mid = row.getAttribute("data-mid");
    const decl = row.querySelector(".decl")?.value || "";
    const checked = row.querySelector('input[type="checkbox"]')?.checked || false;
    // si checkbox coche = Fait (priorit√©)
    const finalDecl = checked ? "Fait" : decl;
    const justificatif = row.querySelector(".justif")?.value || "";
    return { mission_id: mid, declaration: finalDecl, justificatif };
  });

  // validation : justificatif si Partiel / Non fait
  const needJust = items.filter(x => (x.declaration==="Partiel" || x.declaration==="Non fait") && !String(x.justificatif||"").trim());
  if(needJust.length){
    toast("agentSaveToast","Justificatif obligatoire si Partiel / Non fait.", false);
    return;
  }

  // confirmation
  if(!confirm("Confirmer l‚Äôenregistrement des missions ?")) return;

  const remark = $("agentRemark").value || "";

  setLoading(btn,true);
  try{
    const res = await api("agentSaveDeclarations", {
      agent_id: STATE.agent.agent_id,
      periode_id: STATE.agent.periode_id,
      items: JSON.stringify(items),
      remark
    });

    if(!res || !res.ok){
      toast("agentSaveToast", msgFR(res && (res.message||res.error)) || "Erreur enregistrement.", false);
      return;
    }

    toast("agentSaveToast","Enregistr√© ‚úÖ", true);

    // si backend renvoie all_done, on affiche image
    if(res.all_done === true){
      showDoneImage();
    }else{
      $("doneWrap").classList.remove("show");
    }

  }catch(e){
    toast("agentSaveToast","Erreur r√©seau.", false);
  }finally{
    setLoading(btn,false);
  }
}

/* image missions accomplies (double-clic pour masquer) */
function showDoneImage(){
  // on branchera l'image plus tard : si tu mets un fichier √† la racine, tu pourras mettre "missions_accomplies.jpg"
  // sinon laisse vide ‚Üí rien ne casse.
  const img = $("doneImg");
  if(!img.src){
    // placeholder neutre : tu mettras le vrai fichier plus tard
    img.src = "";
  }
  $("doneWrap").classList.add("show");
}
function hideDoneImage(){
  $("doneWrap").classList.remove("show");
}

/* ========= ADMIN ========= */
async function adminLogin(ev){
  toastHide("adminToast");
  const btn = $("btnAdminLogin");
  const code = $("adminCode").value.trim();
  if(!code){ toast("adminToast","Code admin requis.", false); return; }

  setLoading(btn,true);
  try{
    const res = await api("adminLogin", { code });
    if(!res || !res.ok){
      toast("adminToast","Erreur connexion admin.", false);
      setStatus("adminStatus","Admin : non connect√©", false);
      return;
    }

    STATE.admin.ok = true;
    STATE.admin.code = code;

    setStatus("adminStatus","Admin : connect√©", true);
    $("adminBody").style.display = "";
    $("adminLogout").style.display = "";
    $("adminKey").style.display = "";

    await adminBootstrap();

  }catch(e){
    toast("adminToast","Erreur r√©seau.", false);
  }finally{
    setLoading(btn,false);
  }
}

function adminLogout(){
  STATE.admin = { ok:false, code:"", periode_id:"" };
  setStatus("adminStatus","Admin : non connect√©", null);
  $("adminBody").style.display = "none";
  $("adminLogout").style.display = "none";
  $("adminKey").style.display = "none";
}

async function adminBootstrap(){
  // Charge p√©riodes + agents + catalog
  await Promise.all([
    adminLoadPeriodes(),
    adminListAgents(),
    adminListCatalog()
  ]);
}

async function adminLoadPeriodes(){
  const sel = $("adminPeriodeSel");
  sel.innerHTML = `<option value="">‚Äî Chargement‚Ä¶ ‚Äî</option>`;
  try{
    const res = await api("adminListPeriodes", { admin_code: STATE.admin.code });
    const periodes = res.periodes || [];
    STATE.data.periodes = periodes;

    sel.innerHTML = `<option value="">‚Äî Choisir p√©riode ‚Äî</option>` +
      periodes.map(p => `<option value="${esc(p.periode_id || p.period_id)}">${esc(p.libelle || p.periode_id || p.period_id)}</option>`).join("");
  }catch(e){
    sel.innerHTML = `<option value="">‚Äî Erreur ‚Äî</option>`;
  }
}

async function adminListAgents(){
  toastHide("adminAgentToast");
  const box = $("adminAgentsBox");
  box.innerHTML = `<div class="listItem"><div class="ghost">Chargement‚Ä¶</div></div>`;
  try{
    const res = await api("adminListAgents", { admin_code: STATE.admin.code });
    const agents = res.agents || [];
    STATE.data.agents = agents;

    $("agentsCountPill").textContent = agents.length + " agents";

    if(!agents.length){
      box.innerHTML = `<div class="listItem"><div class="ghost">Aucun agent.</div></div>`;
      return;
    }

    box.innerHTML = agents.map(a=>`
      <div class="listItem">
        <div class="listLeft">
          <div class="listTitle">${esc(a.nom || a.name)}</div>
          <div class="listSub">${(a.actif===false) ? "Inactif ‚ùå" : "Actif ‚úÖ"}</div>
        </div>
        <div class="pillRow">
          <button class="btn small" onclick="adminToggleAgent('${esc(a.agent_id)}', ${a.actif===false})">${(a.actif===false) ? "Activer" : "D√©sactiver"}</button>
          <button class="btn small" onclick="adminResetAgentCode('${esc(a.agent_id)}')">Reset 0000</button>
          <button class="btn small danger" onclick="adminDeleteAgent('${esc(a.agent_id)}')">Supprimer</button>
        </div>
      </div>
    `).join("");

    // select ajout groupe
    const addSel = $("addToGroupSel");
    addSel.innerHTML = `<option value="">‚Äî Choisir agent ‚Äî</option>` +
      agents.filter(x=>x.actif!==false).map(x=>`<option value="${esc(x.agent_id)}">${esc(x.nom || x.name)}</option>`).join("");

  }catch(e){
    box.innerHTML = `<div class="listItem"><div class="ghost">Erreur chargement agents.</div></div>`;
  }
}

async function adminAddAgent(ev){
  toastHide("adminAgentToast");
  const btn = $("btnAddAgent");
  const name = $("newAgentName").value.trim();
  const code = $("newAgentCode").value.trim() || "0000";
  if(!name){ toast("adminAgentToast","Nom requis.", false); return; }

  setLoading(btn,true);
  try{
    const res = await api("adminAddAgent", { admin_code: STATE.admin.code, name, code });
    if(!res || !res.ok){
      toast("adminAgentToast", msgFR(res && (res.message||res.error)) || "Erreur ajout.", false);
      return;
    }
    toast("adminAgentToast","Agent ajout√© ‚úÖ", true);
    $("newAgentName").value = "";
    $("newAgentCode").value = "0000";
    await adminListAgents();
    await loadAgentsPublic(); // MAJ dropdown agent c√¥t√© agent
  }catch(e){
    toast("adminAgentToast","Erreur r√©seau.", false);
  }finally{
    setLoading(btn,false);
  }
}

async function adminToggleAgent(agent_id, makeActive){
  toastHide("adminAgentToast");
  try{
    const res = await api("adminToggleAgent", { admin_code: STATE.admin.code, agent_id, actif: makeActive ? "TRUE":"FALSE" });
    if(!res || !res.ok){
      toast("adminAgentToast","Erreur toggle.", false);
      return;
    }
    await adminListAgents();
    await loadAgentsPublic();
  }catch(e){
    toast("adminAgentToast","Erreur r√©seau.", false);
  }
}

async function adminResetAgentCode(agent_id){
  toastHide("adminAgentToast");
  try{
    const res = await api("adminResetAgentCode", { admin_code: STATE.admin.code, agent_id, code:"0000" });
    if(!res || !res.ok){
      toast("adminAgentToast","Erreur reset.", false);
      return;
    }
    toast("adminAgentToast","Code reset ‚úÖ", true);
  }catch(e){
    toast("adminAgentToast","Erreur r√©seau.", false);
  }
}

async function adminDeleteAgent(agent_id){
  if(!confirm("Supprimer d√©finitivement cet agent ?")) return;
  toastHide("adminAgentToast");
  try{
    const res = await api("adminDeleteAgent", { admin_code: STATE.admin.code, agent_id });
    if(!res || !res.ok){
      toast("adminAgentToast","Erreur suppression.", false);
      return;
    }
    toast("adminAgentToast","Agent supprim√© ‚úÖ", true);
    await adminListAgents();
    await loadAgentsPublic();
  }catch(e){
    toast("adminAgentToast","Erreur r√©seau.", false);
  }
}

async function adminListCatalog(){
  toastHide("adminMissionToast");
  const box = $("adminCatalogBox");
  box.innerHTML = `<div class="listItem"><div class="ghost">Chargement‚Ä¶</div></div>`;
  try{
    const res = await api("adminListCatalog", { admin_code: STATE.admin.code });
    const catalog = res.catalog || [];
    STATE.data.catalog = catalog;

    $("catalogCountPill").textContent = catalog.length + " missions";

    if(!catalog.length){
      box.innerHTML = `<div class="listItem"><div class="ghost">Aucune mission.</div></div>`;
      return;
    }

    box.innerHTML = catalog.map(m=>`
      <div class="listItem">
        <div class="listLeft">
          <div class="listTitle">${esc(m.libelle || m.name)}</div>
          <div class="listSub">${(m.actif===false) ? "Inactive ‚ùå" : "Active ‚úÖ"}</div>
        </div>
        <div class="pillRow">
          <button class="btn small" onclick="adminToggleMission('${esc(m.mission_id)}', ${m.actif===false})">${(m.actif===false) ? "Activer" : "D√©sactiver"}</button>
          <button class="btn small danger" onclick="adminDeleteMission('${esc(m.mission_id)}')">Supprimer</button>
        </div>
      </div>
    `).join("");

  }catch(e){
    box.innerHTML = `<div class="listItem"><div class="ghost">Erreur chargement missions.</div></div>`;
  }
}

async function adminAddMission(ev){
  toastHide("adminMissionToast");
  const btn = $("btnAddMission");
  const libelle = $("newMissionLib").value.trim();
  if(!libelle){ toast("adminMissionToast","Libell√© requis.", false); return; }

  setLoading(btn,true);
  try{
    const res = await api("adminAddMission", { admin_code: STATE.admin.code, libelle });
    if(!res || !res.ok){
      toast("adminMissionToast","Erreur ajout mission.", false);
      return;
    }
    toast("adminMissionToast","Mission ajout√©e ‚úÖ", true);
    $("newMissionLib").value = "";
    await adminListCatalog();
  }catch(e){
    toast("adminMissionToast","Erreur r√©seau.", false);
  }finally{
    setLoading(btn,false);
  }
}

async function adminToggleMission(mission_id, makeActive){
  toastHide("adminMissionToast");
  try{
    const res = await api("adminToggleMission", { admin_code: STATE.admin.code, mission_id, actif: makeActive ? "TRUE":"FALSE" });
    if(!res || !res.ok){
      toast("adminMissionToast","Erreur toggle mission.", false);
      return;
    }
    await adminListCatalog();
  }catch(e){
    toast("adminMissionToast","Erreur r√©seau.", false);
  }
}

async function adminDeleteMission(mission_id){
  if(!confirm("Supprimer d√©finitivement cette mission ?")) return;
  toastHide("adminMissionToast");
  try{
    const res = await api("adminDeleteMission", { admin_code: STATE.admin.code, mission_id });
    if(!res || !res.ok){
      toast("adminMissionToast","Erreur suppression mission.", false);
      return;
    }
    toast("adminMissionToast","Mission supprim√©e ‚úÖ", true);
    await adminListCatalog();
  }catch(e){
    toast("adminMissionToast","Erreur r√©seau.", false);
  }
}

/* ---- p√©riode / groupe / missions actives ---- */
async function adminLoadPeriode(ev){
  toastHide("adminPeriodeToast");
  const btn = $("btnLoadPeriode");
  const periode_id = $("adminPeriodeSel").value;
  if(!periode_id){ toast("adminPeriodeToast","Choisis une p√©riode.", false); return; }

  setLoading(btn,true);
  try{
    const res = await api("adminLoadPeriode", { admin_code: STATE.admin.code, periode_id });
    if(!res || !res.ok){
      toast("adminPeriodeToast","Erreur chargement p√©riode.", false);
      return;
    }
    STATE.admin.periode_id = periode_id;
    toast("adminPeriodeToast","P√©riode charg√©e ‚úÖ", true);

    // Groupe
    const group = res.group || [];
    STATE.data.group = group;

    $("responsablePill").textContent = "Responsable : " + (res.responsable?.nom || "‚Äî");

    $("adminGroupBox").innerHTML = group.length ? group.map(a=>`
      <div class="listItem">
        <div class="listLeft">
          <div class="listTitle">${esc(a.nom)}</div>
          <div class="listSub">Dans le groupe</div>
        </div>
        <div class="pillRow">
          <button class="btn small danger" onclick="adminRemoveFromGroup('${esc(a.agent_id)}')">Retirer</button>
        </div>
      </div>
    `).join("") : `<div class="listItem"><div class="ghost">Aucun agent dans le groupe.</div></div>`;

    // Responsable select = group
    const rsel = $("responsableSel");
    rsel.innerHTML = `<option value="">‚Äî Choisir ‚Äî</option>` +
      group.map(a=>`<option value="${esc(a.agent_id)}">${esc(a.nom)}</option>`).join("");

    // missions actives (checkbox list)
    await adminGetMonthMissions(true);

  }catch(e){
    toast("adminPeriodeToast","Erreur r√©seau.", false);
  }finally{
    setLoading(btn,false);
  }
}

async function adminAddToGroup(ev){
  toastHide("adminGroupToast");
  const btn = $("btnAddToGroup");
  if(!STATE.admin.periode_id){ toast("adminGroupToast","Charge une p√©riode d‚Äôabord.", false); return; }

  const agent_id = $("addToGroupSel").value;
  if(!agent_id){ toast("adminGroupToast","Choisis un agent.", false); return; }

  setLoading(btn,true);
  try{
    const res = await api("adminAddAgentToGroup", { admin_code: STATE.admin.code, periode_id: STATE.admin.periode_id, agent_id });
    if(!res || !res.ok){
      toast("adminGroupToast", msgFR(res && (res.message||res.error)) || "Erreur ajout groupe.", false);
      return;
    }
    toast("adminGroupToast","Ajout groupe ‚úÖ", true);
    // Recharge UNE SEULE FOIS (pas de sapin de No√´l)
    await adminLoadPeriode({}); 
  }catch(e){
    toast("adminGroupToast","Erreur r√©seau.", false);
  }finally{
    setLoading(btn,false);
  }
}

async function adminSetResponsable(ev){
  toastHide("adminGroupToast");
  const btn = $("btnSetResponsable");
  if(!STATE.admin.periode_id){ toast("adminGroupToast","Charge une p√©riode d‚Äôabord.", false); return; }

  const agent_id = $("responsableSel").value;
  if(!agent_id){ toast("adminGroupToast","Choisis un responsable.", false); return; }

  setLoading(btn,true);
  try{
    const res = await api("adminSetResponsable", { admin_code: STATE.admin.code, periode_id: STATE.admin.periode_id, agent_id });
    if(!res || !res.ok){
      toast("adminGroupToast", msgFR(res && (res.message||res.error)) || "Erreur responsable.", false);
      return;
    }
    toast("adminGroupToast","Responsable d√©fini ‚úÖ", true);
    await adminLoadPeriode({});
  }catch(e){
    toast("adminGroupToast","Erreur r√©seau.", false);
  }finally{
    setLoading(btn,false);
  }
}

async function adminRemoveFromGroup(agent_id){
  toastHide("adminGroupToast");
  if(!STATE.admin.periode_id) return;
  try{
    const res = await api("adminRemoveAgentFromGroup", { admin_code: STATE.admin.code, periode_id: STATE.admin.periode_id, agent_id });
    if(!res || !res.ok){
      toast("adminGroupToast","Erreur retrait.", false);
      return;
    }
    toast("adminGroupToast","Retir√© ‚úÖ", true);
    await adminLoadPeriode({});
  }catch(e){
    toast("adminGroupToast","Erreur r√©seau.", false);
  }
}

/* missions actives */
async function adminGetMonthMissions(silent){
  toastHide("adminMonthToast");
  if(!STATE.admin.periode_id) return;

  const box = $("adminMonthMissionsBox");
  box.innerHTML = `<div class="listItem"><div class="ghost">Chargement‚Ä¶</div></div>`;

  try{
    const res = await api("adminGetMonthMissions", { admin_code: STATE.admin.code, periode_id: STATE.admin.periode_id });
    if(!res || !res.ok){
      box.innerHTML = `<div class="listItem"><div class="ghost">Erreur.</div></div>`;
      if(!silent) toast("adminMonthToast","Erreur chargement missions.", false);
      return;
    }

    const all = res.missionsAll || [];
    const onIds = new Set((res.missionsOn||[]).map(m => String(m.mission_id)));

    if(!all.length){
      box.innerHTML = `<div class="listItem"><div class="ghost">Aucune mission catalogue.</div></div>`;
      return;
    }

    box.innerHTML = all.map(m => `
      <div class="mRow">
        <input type="checkbox" data-mid="${esc(m.mission_id)}" ${onIds.has(String(m.mission_id)) ? "checked":""} />
        <div style="flex:1;min-width:0">
          <div class="mLabel">${esc(m.libelle)}</div>
        </div>
      </div>
    `).join("");

    if(!silent) toast("adminMonthToast","Missions charg√©es ‚úÖ", true);

  }catch(e){
    box.innerHTML = `<div class="listItem"><div class="ghost">Erreur r√©seau.</div></div>`;
  }
}

async function adminSaveMonthMissions(ev){
  toastHide("adminMonthToast");
  const btn = $("btnSaveMonthMissions");
  if(!STATE.admin.periode_id){ toast("adminMonthToast","Charge une p√©riode d‚Äôabord.", false); return; }

  const ids = Array.from($("adminMonthMissionsBox").querySelectorAll('input[type="checkbox"][data-mid]'))
    .filter(x=>x.checked)
    .map(x=>x.getAttribute("data-mid"));

  setLoading(btn,true);
  try{
    const res = await api("adminSaveMonthMissions", {
      admin_code: STATE.admin.code,
      periode_id: STATE.admin.periode_id,
      ids: JSON.stringify(ids)
    });

    if(!res || !res.ok){
      toast("adminMonthToast","Erreur sauvegarde.", false);
      return;
    }
    toast("adminMonthToast","Enregistr√© ‚úÖ", true);
  }catch(e){
    toast("adminMonthToast","Erreur r√©seau.", false);
  }finally{
    setLoading(btn,false);
  }
}

/* retours */
async function adminLoadRetours(ev){
  toastHide("adminRetoursToast");
  const btn = $("btnLoadRetours");
  if(!STATE.admin.periode_id){ toast("adminRetoursToast","Charge une p√©riode d‚Äôabord.", false); return; }

  setLoading(btn,true);
  try{
    const res = await api("adminGetRetours", { admin_code: STATE.admin.code, periode_id: STATE.admin.periode_id });
    if(!res || !res.ok){
      toast("adminRetoursToast","Erreur chargement retours.", false);
      return;
    }

    const items = res.items || [];
    const box = $("adminRetoursBox");

    if(!items.length){
      box.innerHTML = `<div class="listItem"><div class="ghost">Aucun retour.</div></div>`;
      toast("adminRetoursToast","Aucun retour ‚úÖ", true);
      return;
    }

    box.innerHTML = items.map(it=>`
      <div class="listItem">
        <div class="listLeft">
          <div class="listTitle">${esc(it.agent || "")}</div>
          <div class="listSub">${esc(it.mission || "")} ‚Ä¢ ${esc(it.declaration || "")}</div>
          <div class="listSub">${esc(it.justificatif || "")}</div>
        </div>
      </div>
    `).join("");

    toast("adminRetoursToast","Retours charg√©s ‚úÖ", true);

  }catch(e){
    toast("adminRetoursToast","Erreur r√©seau.", false);
  }finally{
    setLoading(btn,false);
  }
}

/* ========= CHANGE CODE modal (admin + agent) ========= */
let MODAL_MODE = null; // "admin" | "agent"
let MODAL_FORCE = false;

function openChangeCode(mode, force){
  MODAL_MODE = mode;
  MODAL_FORCE = !!force;
  toastHide("modalToast");

  $("oldCode").value = "";
  $("newCode").value = "";

  if(mode === "admin"){
    $("modalTitle").textContent = "Changer le code admin";
    $("modalHint").textContent = "Le changement est appliqu√© imm√©diatement. (Min 4 caract√®res)";
  }else{
    $("modalTitle").textContent = "Changer mon code agent";
    $("modalHint").textContent = MODAL_FORCE ? "Changement obligatoire √† la premi√®re connexion." : "Min 4 caract√®res.";
  }
  $("modalBack").classList.add("show");
}

function closeModalIfBack(ev){
  if(!MODAL_FORCE) closeModal();
}
function closeModal(){
  if(MODAL_FORCE) return; // obligatoire -> pas de fermeture
  $("modalBack").classList.remove("show");
}
async function submitChangeCode(ev){
  toastHide("modalToast");
  const btn = $("btnChangeCode");
  const old_code = $("oldCode").value.trim();
  const new_code = $("newCode").value.trim();

  if(!old_code || !new_code){
    toast("modalToast","Ancien + nouveau requis.", false);
    return;
  }
  if(new_code.length < 4){
    toast("modalToast","Nouveau code min 4.", false);
    return;
  }

  setLoading(btn,true);
  try{
    let res;
    if(MODAL_MODE === "admin"){
      if(!STATE.admin.ok) { toast("modalToast","Admin non connect√©.", false); setLoading(btn,false); return; }
      res = await api("adminChangeCode", { admin_code: STATE.admin.code, old_code, new_code });
      if(res && res.ok){
        // met √† jour code en m√©moire
        STATE.admin.code = new_code;
      }
    }else{
      if(!STATE.agent.ok) { toast("modalToast","Agent non connect√©.", false); setLoading(btn,false); return; }
      res = await api("agentChangeCode", { agent_id: STATE.agent.agent_id, old_code, new_code });
      if(res && res.ok){
        STATE.agent.must_change = false;
        MODAL_FORCE = false;
      }
    }

    if(!res || !res.ok){
      toast("modalToast", msgFR(res && (res.message||res.error)) || "Erreur.", false);
      return;
    }

    toast("modalToast","Code modifi√© ‚úÖ", true);
    $("modalBack").classList.remove("show");

  }catch(e){
    toast("modalToast","Erreur r√©seau.", false);
  }finally{
    setLoading(btn,false);
  }
}

/* ========= message mapping ========= */
function msgFR(m){
  const s = String(m||"");
  const map = {
    "unauthorized":"Non autoris√©",
    "bad_code":"Code incorrect",
    "bad_old_code":"Ancien code incorrect",
    "agent_unknown":"Agent inconnu",
    "agent_not_found":"Agent introuvable",
    "missing_params":"Param√®tres manquants",
    "new_code_min_4":"Nouveau code min 4",
    "action_inconnue":"Action inconnue",
    "unknown_action":"Action inconnue"
  };
  return map[s] || (s ? s : "");
}

/* ========= Expose functions (onclick) ========= */
window.showView = showView;
window.hardReload = hardReload;

window.agentLogin = agentLogin;
window.agentLogout = agentLogout;
window.agentLoadPeriode = agentLoadPeriode;
window.agentSave = agentSave;
window.hideDoneImage = hideDoneImage;

window.adminLogin = adminLogin;
window.adminLogout = adminLogout;
window.adminAddAgent = adminAddAgent;
window.adminToggleAgent = adminToggleAgent;
window.adminResetAgentCode = adminResetAgentCode;
window.adminDeleteAgent = adminDeleteAgent;

window.adminAddMission = adminAddMission;
window.adminToggleMission = adminToggleMission;
window.adminDeleteMission = adminDeleteMission;

window.adminLoadPeriode = adminLoadPeriode;
window.adminAddToGroup = adminAddToGroup;
window.adminSetResponsable = adminSetResponsable;
window.adminRemoveFromGroup = adminRemoveFromGroup;

window.adminSaveMonthMissions = adminSaveMonthMissions;
window.adminLoadRetours = adminLoadRetours;

window.openChangeCode = openChangeCode;
window.closeModal = closeModal;
window.closeModalIfBack = closeModalIfBack;
window.submitChangeCode = submitChangeCode;
</script>
</body>
</html>
