<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Entretien CS Consenvoye</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1724; --panel2:#111b2b;
      --stroke:rgba(255,255,255,.12);
      --text:#e8eef9; --muted:rgba(232,238,249,.72);
      --accent:#ff7a00; --accent2:#ffb000;
      --danger:#ff3b30; --ok:#1fd36b;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --r:18px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial, "Noto Sans", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:var(--font);color:var(--text);
      background:
        radial-gradient(900px 420px at 20% 20%, rgba(255,122,0,.18), transparent 65%),
        radial-gradient(900px 420px at 80% 10%, rgba(255,176,0,.12), transparent 60%),
        linear-gradient(180deg, #06080b, var(--bg));
      min-height:100vh;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:22px 14px 46px}
    h1{margin:0;font-size:30px;font-weight:900;letter-spacing:.2px;color:#ff8d1a;text-shadow:0 2px 14px rgba(255,122,0,.18);text-align:center;}
    .subtitle{margin:6px 0 0;color:var(--muted);font-size:12px;text-align:center}
    .tabsCenter{margin:14px 0 18px;display:flex;justify-content:center;}
    .tabs{display:flex;gap:8px;align-items:center;border:1px solid var(--stroke);background:rgba(255,255,255,.02);padding:6px;border-radius:999px;box-shadow:var(--shadow);}
    .tab{border:0;background:transparent;color:var(--muted);padding:10px 14px;border-radius:999px;cursor:pointer;font-weight:900;font-size:13px;}
    .tab.active{background:linear-gradient(90deg, rgba(255,122,0,.26), rgba(255,176,0,.18));color:var(--text);}
    .btn{appearance:none;border:1px solid var(--stroke);background:rgba(255,255,255,.03);color:var(--text);border-radius:999px;padding:10px 14px;cursor:pointer;font-weight:900;font-size:13px;transition:.15s transform ease,.15s background ease,.15s border-color ease;white-space:nowrap;}
    .btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.2);background:rgba(255,255,255,.06)}
    .btn.primary{background:linear-gradient(90deg, var(--accent), var(--accent2));border-color:transparent;color:#0b0f14;box-shadow:0 12px 26px rgba(255,122,0,.18);}
    .btn.info{
  background: linear-gradient(90deg, #2f80ff, #59c7ff);
  border-color: transparent;
  color: #0b0f14;
  box-shadow: 0 12px 26px rgba(47,128,255,.18);
}
    .btn.danger{background:rgba(255,59,48,.14);border-color:rgba(255,59,48,.35);color:#ffd0cd}
    .btn.small{padding:8px 12px;font-size:12px}
    .btn.loading,.btn.primary.loading{
      background: linear-gradient(90deg, #1fd36b, #7dff9c) !important;
      border-color: transparent !important;
      color:#0b0f14 !important;
      box-shadow: 0 12px 26px rgba(31,211,107,.18) !important;
      cursor: wait !important;
      opacity: 0.95;
    }
    .btn.loading::after{content:" ‚è≥";font-weight:900;}
    .btn[disabled]{opacity:.65;cursor:not-allowed;}
    .card{border:1px solid var(--stroke);background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));border-radius:var(--r);padding:16px;box-shadow:var(--shadow);}
    .headRow{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;flex-wrap:wrap}
    .h2{margin:0;font-size:15px;font-weight:900}
    .status{
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 700;
  line-height: 1;
  white-space: nowrap;
  width: auto;
}

    .status.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.10);color:#bdf6d2}
    .status.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.10);color:#ffd0cd}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
    input, select, textarea{width:100%;padding:11px 12px;border-radius:12px;border:1px solid var(--stroke);background:rgba(0,0,0,.25);color:var(--text);outline:none;font-size:13px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .row > *{flex:1;min-width:220px}
    .divider{height:1px;background:rgba(255,255,255,.09);margin:14px 0}
    .table{width:100%;border-collapse:collapse;border-radius:14px;border:1px solid var(--stroke);background:rgba(0,0,0,.18);overflow:hidden}
    .table th,.table td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);font-size:13px;vertical-align:middle}
    .table th{color:var(--muted);text-align:left;font-weight:900}
    .table tr:last-child td{border-bottom:0}
    .ghost{color:rgba(232,238,249,.55)}
    .twoColBlock{display:grid;gap:12px}
    @media(min-width:1000px){ .twoColBlock{grid-template-columns: 1fr 1.2fr;} }
    .toast{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);background:rgba(255,255,255,.02);color:var(--muted);font-size:13px;display:none}
    .toast.show{display:block}
    .toast.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.08);color:#c9f9db}
    .toast.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.08);color:#ffd0cd}
    .scrollBox{max-height:260px;overflow:auto;border-radius:14px;border:1px solid rgba(255,255,255,.08)}
    .checkRow{display:flex;align-items:center;gap:12px;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08)}
    .checkRow:last-child{border-bottom:0}
    .checkRow input[type="checkbox"]{width:18px;height:18px;flex:0 0 auto;}
    .checkRow .title{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .pillBtn{border:1px solid var(--stroke);background:rgba(255,255,255,.04);color:var(--text);border-radius:999px;padding:10px 12px;font-weight:900;font-size:13px;cursor:pointer;}
    .keyBtn{border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.04);border-radius:999px;padding:8px 10px;cursor:pointer}
    .keyBtn:hover{background:rgba(255,255,255,.08)}
    .topActions{display:flex;gap:8px;align-items:center;justify-content:flex-end;flex-wrap:wrap}
    .doneOverlay{
      position:fixed;inset:0;background:rgba(0,0,0,.72);
      display:none;align-items:center;justify-content:center;padding:18px;z-index:9999;
    }
    .doneOverlay.show{display:flex}
    .doneOverlay img{
      max-width:min(520px, 92vw);
      max-height:86vh;
      border-radius:18px;
      box-shadow:0 20px 60px rgba(0,0,0,.6);
      border:1px solid rgba(255,255,255,.18);
    }
    /* Mobile: √©viter ‚Äútrop gros‚Äù */
    @media (max-width: 700px){
      .wrap{padding:12px}
      h1{font-size:24px}
      .btn{padding:10px 12px;font-size:13px}
      input,select,textarea{font-size:14px}
      .row > *{min-width:100%}
      .scrollBox{max-height:220px}
    }
    /* Bouton Valider agent ‚Äì bleu clair */
#btnAgentsValidate {
    background: linear-gradient(135deg, #4da3ff, #79c2ff);
    color: #06213d;
    border: none;
}

#btnAgentsValidate:hover {
    background: linear-gradient(135deg, #3a94f7, #66b6f0);
}
    .status {
  display: flex;
  flex-direction: column; /* ‚¨ÖÔ∏è cl√© du probl√®me */
  align-items: flex-start;
  gap: 2px;
  white-space: normal; /* ‚¨ÖÔ∏è emp√™che le nowrap */
}

.status.ok {
  font-weight: 600;
}
    badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;

  margin-left: 10px;
  padding: 4px 12px;

  border-radius: 999px; /* pill / bouton */
  font-size: 0.85em;
  font-weight: 600;

  line-height: 1;
  white-space: nowrap;
}
    .badge.green {
  background: linear-gradient(135deg, rgba(31,211,107,0.25), rgba(31,211,107,0.1));
  color: #1fd36b;
  border: 1px solid rgba(31,211,107,0.5);
}
.badge.red {
  background: linear-gradient(135deg, rgba(255,59,48,0.25), rgba(255,59,48,0.1));
  color: #ff3b30;
  border: 1px solid rgba(255,59,48,0.5);
}
.count{
  display:inline-flex;
  align-items:center;
  justify-content:center;

  min-width:36px;
  height:30px;
  padding:0 14px;
  margin-left:12px;

  border-radius:999px;

  font-weight:800;
  font-size:14px;
  line-height:1;

  border:1px solid rgba(255,255,255,.15);
  box-shadow:
    inset 0 0 0 1px rgba(0,0,0,.15),
    0 6px 14px rgba(0,0,0,.25);

  user-select:none;
  cursor:default;
}

/* ACTIFS */
.count.green{
  background:linear-gradient(135deg, #1fd36b, #0fa958);
  color:#052e18;
}

/* INACTIFS */
.count.red{
  background:linear-gradient(135deg, #ff6b6b, #d83a3a);
  color:#3b0b0b;
}
.titleWrap{
  display:flex;
  justify-content:center;
  margin: 6px 0 10px;
}
.titleImg{
  width: min(900px, 92vw);
  height: auto;
  display:block;
  filter: drop-shadow(0 14px 28px rgba(0,0,0,.55));
}
@media (max-width: 700px){
  .titleImg{ width: min(760px, 96vw); }
}
    /* ===== TITRE FEU RESPONSIVE ===== */
.hero-title {
  display: flex;
  justify-content: center;
  align-items: center;

  margin: 12px 0 8px 0; /* r√©duit l'espace haut/bas */
}

.hero-title img {
  width: auto;
  max-width: 90vw;

  /* CL√â DU PROBL√àME */
  max-height: 28vh;

  object-fit: contain;
}

/* ===== MOBILE : titre un peu plus grand ===== */
@media (max-width: 768px) {
  .hero-title img {
    max-height: 36vh;
  }
}
/* R√©glage sp√©cifique PC */
@media (min-width: 1024px) {
  .hero {
    height: 10vh; /* ‚Üì diminue la hauteur sur PC */
    max-height: 180px; /* s√©curit√© */
  }

  .title-img {
    max-height: 150px; /* ‚Üì taille max du titre feu */
  }
}
    .infoBanner{
  margin: 10px 0;
  padding: 12px;
  border-radius: 10px;
  background: rgba(255, 80, 80, 0.15);
  border: 1px solid rgba(255, 80, 80, 0.4);
  color: #ffb3b3;
  font-weight: 600;
}
/* Pilotage centralis√© via data-* sur #viewAgents */
#viewAgents[data-period-open="0"] #btnAgentsSave,
#viewAgents[data-period-open="0"] #btnAgentsValidate{
  display:none !important;
}

#viewAgents[data-period-open="0"] #periodClosedInfo{
  display:block !important;
}

#viewAgents[data-period-open="1"] #periodClosedInfo{
  display:none !important;
}

/* En p√©riode ouverte : Save visible */
#viewAgents[data-period-open="1"] #btnAgentsSave{
  display:inline-flex !important;
}

/* Valider visible SEULEMENT si responsable */
#viewAgents[data-period-open="1"][data-is-resp="1"] #btnAgentsValidate{
  display:inline-flex !important;
}
#viewAgents[data-period-open="1"][data-is-resp="0"] #btnAgentsValidate{
  display:none !important;
}
.status.blue {
  background: rgba(0, 120, 255, 0.18);
  border: 1px solid rgba(0, 120, 255, 0.45);
  color: #cfe5ff;
}
.badge{
  display:inline-block;
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:900;
  line-height:1;
  border:1px solid rgba(255,255,255,.18);
}

.badge.blue{
  background: rgba(0,120,255,0.18);
  border-color: rgba(0,120,255,0.45);
  color:#cfe5ff;
}
 /* ===== STEP 1 : Header Agent sur une seule ligne ===== */
#viewAgents .headRow{
  flex-wrap: nowrap !important; /* √©vite que √ßa passe √† la ligne */
  align-items: center;
}

#viewAgents .topActions{
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: nowrap !important; /* √©vite que üîë / D√©co / badge se cassent */
  min-width: 0;
}

/* Ordre visuel : üîë | badge Agent | D√©connexion */
#btnAgentsKey{ order: 1; }
#pillAgentsStatus{
  order: 2;
  flex: 1; /* prend l'espace entre üîë et D√©co */
  text-align: center;
  min-width: 0;
}
#btnAgentsLogout{ order: 3; }

/* Mobile : un peu plus compact */
@media (max-width: 700px){
  #viewAgents .topActions{ gap: 8px; }
  #pillAgentsStatus{ font-size: 12px; }
}
/* STEP 1 : badge agent √† la place du select */
#agentsAgentBadge{
  width: 100%;
  padding: 12px 14px;
  border-radius: 12px;
  justify-content: center; /* texte centr√© */
  text-align: center;
}
  #pillAgentsStatus:empty {
  display: none;
}
/* Tables : header fixe pendant le scroll */
.scrollBox{
  max-height: 320px; /* ‚Üê tu peux ajuster */
  overflow-y: auto;
}


.table{
  border-collapse: separate; /* sticky + collapse = buggy selon navigateurs */
  border-spacing: 0;
}

.table thead th{
  position: sticky;
  top: 0;
  z-index: 2;

  background: #1f4fd8; /* coh√©rent avec ton th√®me */
  backdrop-filter: blur(6px);
}

.table thead th::after{
  content:"";
  position:absolute;
  left:0; right:0; bottom:-1px;
  height:1px;
  background: rgba(255,255,255,.10); /* ligne de s√©paration */
}

/* Tables : header fixe pendant le scroll */
.scrollBox{
  overflow: auto; /* d√©j√† chez toi, mais on s√©curise */
}

.table{
  border-collapse: separate; /* sticky + collapse = buggy selon navigateurs */
  border-spacing: 0;
}

.table thead th{
  position: sticky;
  top: 0;
  z-index: 2;

  background: rgba(15, 23, 36, .96); /* coh√©rent avec ton th√®me */
  backdrop-filter: blur(6px);
}

.table thead th::after{
  content:"";
  position:absolute;
  left:0; right:0; bottom:-1px;
  height:1px;
  background: rgba(255,255,255,.10); /* ligne de s√©paration */
}
.scrollBox{
  max-height: 320px;
  overflow-y: auto;
}

/* HEADER FIXE */
.scrollBox thead th{
  position: sticky;
  top: 0;
  z-index: 5;
  background: #0f2a44; /* ton bleu */
}
/* ===== FIX STICKY HEADER TABLES (b√©ton) ===== */
.scrollBox{
  max-height: 320px !important;
  overflow-y: auto !important;
  overflow-x: auto !important;
  position: relative !important;
}

/* IMPORTANT: la table ne doit pas g√©rer l'overflow */
.table{
  overflow: visible !important;
  border-collapse: separate !important;
  border-spacing: 0 !important;
}

/* Header fixe */
.scrollBox .table thead th{
  position: sticky !important;
  top: 0 !important;
  z-index: 50 !important;
  background: rgba(15,23,36,.98) !important;
}

  .passwordField{
  position: relative;
  width: 100%;
}

.passwordField input{
  width: 100%;
  padding-right: 44px; /* espace pour l‚Äô≈ìil */
}

.togglePwd{
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  cursor: pointer;
  font-size: 18px;
  opacity: 0.6;
}

.togglePwd:hover{
  opacity: 1;
}
/* ===== PC ONLY : ajustement boutons p√©riode ===== */
@media (min-width: 1024px) {

  .row.period-actions {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .admin-actions {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  /* Charger groupe : plus compact */
  #btnAdminsLoadPeriod {
    padding: 8px 14px;
    min-width: auto;
    width: auto;
    font-size: 14px;
  }

  /* D√©verrouiller : petit bouton discret */
  #btnAdminsUnlockPeriod {
    padding: 6px 10px;
    min-width: auto;
    width: auto;
    font-size: 13px;
    line-height: 1;
  }
}
/* ===== PC ONLY : boutons Charger / D√©verrouiller ===== */
@media (min-width: 1024px) {

  .admin-actions {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  #btnAdminsLoadPeriod,
  #btnAdminsUnlockPeriod {
    padding: 7px 14px;
    min-width: 0;
    width: auto;
    font-size: 14px;
    line-height: 1;
    height: 34px;
  }
}
/* Bouton toggle Activer/D√©sactiver : m√™me largeur + couleurs */
.btn.toggle {
  min-width: 110px; /* garde la m√™me taille */
  justify-content: center; /* centre le texte */
}

/* Etat "Activer" (vert) */
.btn.toggle.on{
  background: rgba(31,211,107,.14);
  border-color: rgba(31,211,107,.35);
  color: #bdf6d2;
}

/* Etat "D√©sactiver" (rouge) */
.btn.toggle.off{
  background: rgba(255,59,48,.14);
  border-color: rgba(255,59,48,.35);
  color: #ffd0cd;
}
.btn.success{
  background: rgba(31,211,107,.14);
  border-color: rgba(31,211,107,.35);
  color: #bdf6d2;
}

  </style>
</head>

<body>
  <div class="wrap">
    <div class="titleWrap">
  <img src="assets/titre-feu.png" alt="Entretien du centre de secours de Consenvoye" class="titleImg">
</div>

      <div class="tabsCenter">
      <div class="tabs">
        <button class="tab active" id="tabAgents" onclick="showView('agents')">üßë‚Äçüöí Agent</button>
        <button class="tab" id="tabAdmins" onclick="showView('admins')">üõ°Ô∏è Admin</button>
        <button class="btn" id="btnRefresh" onclick="softRefresh(event)">Recharger</button>

      </div>
    </div>

    <!-- ========= AGENT ========= -->
    <div id="viewAgents" class="card">
      <div class="headRow">
        <div class="h2"><span class="status blue">Espace agent</span></div>
        <div class="topActions">
          <button class="keyBtn" id="btnAgentsKey" style="display:none" title="Changer mon code" onclick="toggleAgentsKey()">üîë</button>
          <button class="btn danger small" id="btnAgentsLogout" style="display:none" onclick="agentsLogout()">D√©connexion</button>
          <div class="status" id="pillAgentsStatus">Agent : non connect√©</div>
        </div>
      </div>

      <div class="row" id="agentsLoginRow">

  <div id="agentsAgentSlot">
    <label>Agent</label>
    <select id="agentsSel"></select>

    <!-- Badge agent (sera affich√© apr√®s connexion) -->
    <div id="agentsAgentBadge" class="status ok" style="display:none"></div>
  </div>

  <div id="agentsCodeCol">
    <label>Code</label>
    <div class="passwordField">
  <input id="agentsCode" type="password" placeholder="Code agent" />
  <button type="button" class="togglePwd" onclick="togglePassword('agentsCode', this)">üëÅÔ∏è</button>
</div>

  </div>

  <div class="right" id="agentsLoginBtnCol">
    <button class="btn primary" id="btnAgentsLogin" onclick="agentsLogin(event)">Se connecter</button>
  </div>

</div>


      <div id="toastAgentsLogin" class="toast"></div>

      <!-- changer code agent -->
      <div id="boxAgentsKey" style="display:none;margin-top:12px">
        <div class="divider"></div>
        <div class="h2" style="margin:0 0 8px 0">Changer mon code</div>
        <div class="row">
          <div>
            <label>Ancien code</label>
            <input id="agentsOldCode" placeholder="Ancien code" />
          </div>
          <div>
            <label>Nouveau code (min 4)</label>
            <input id="agentsNewCode" placeholder="Nouveau code (min 4)" />
          </div>
          <div class="right">
            <button class="btn primary" id="btnAgentsChange" onclick="agentsChangeCode(event)">Valider</button>
          </div>
        </div>
        <div id="toastAgentsChange" class="toast"></div>
      </div>

      <!-- Missions agent -->
      <div id="boxAgentsWork" style="display:none;margin-top:14px">
        <div class="divider"></div>

        <div class="headRow">
  <div class="status blue">P√©riode</div>
</div>

        <div class="row">
          <div>
             <label>P√©riode</label>
                        <select id="agentsPeriodsSel"></select>
          </div>
          <div class="right">
            <button class="btn primary" id="btnAgentsLoad" onclick="agentsLoadPeriod(event)">Charger</button>
          </div>
        </div>
        <div id="toastAgentsLoad" class="toast"></div>

        <div class="divider"></div>

        <div id="boxAgentsTeam" class="card" style="display:none; margin-bottom:10px">

  <div class="headRow">
    <div class="status blue">√âquipe du mois</div>
    <div id="agentsResponsable" class="status blue"></div>
  </div>

  <div id="agentsTeamList" class="list"></div>

</div>
        
        <div class="divider"></div>
        <div class="h2"><span class="badge blue">Missions du mois</span></div>
                <div id="boxAgentsMissions" class="scrollBox">
          <div class="ghost" style="padding:10px">Choisis une p√©riode puis ‚ÄúCharger‚Äù.</div>
        </div>

           <div id="boxAgentsAfterLoad" style="display:none;justify-content:flex-end;margin-top:10px;gap:10px">

             <div id="periodClosedInfo" class="infoBanner" style="display:none; margin-bottom:12px;">
  ‚õî Vous n‚Äô√™tes pas autoris√© √† enregistrer ou valider cette p√©riode.<br>
  üìÖ L‚Äôouverture se fait en d√©but de mois.
</div>
           

         <label>Remarque g√©n√©rale (facultatif)</label>
<textarea id="agentsRemark" rows="3" placeholder="Remarque g√©n√©rale..."></textarea>
  
</div><button class="btn primary" id="btnAgentsSave" style="display:none" onclick="agentsSave(event)">Enregistrer</button>
<button class="btn info" id="btnAgentsValidate" style="display:none" onclick="agentsValidate(event)">Valider</button>

        <div id="toastAgentsSave" class="toast"></div>
      </div>
    </div>

    <!-- ========= ADMIN ========= -->
    <div id="viewAdmins" class="card" style="display:none">
      <div class="headRow">
        <div class="h2"><span class="status blue">Espace admin</span></div>
        <div class="topActions">
          <button class="keyBtn" id="btnAdminsKey" style="display:none" title="Changer code admin" onclick="toggleAdminsKey()">üîë</button>
          <button class="btn danger small" id="btnAdminsLogout" style="display:none" onclick="adminsLogout()">D√©connexion</button>
          <div class="status" id="pillAdminsStatus">Admin : non connect√©</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Code admin</label>
          <div class="passwordField">
  <input id="adminsCode" type="password" placeholder="Code admin" />
  <button type="button" class="togglePwd" onclick="togglePassword('adminsCode', this)">üëÅÔ∏è</button>
</div>
        </div>
        <div class="right">
          <button class="btn primary" id="btnAdminsLogin" onclick="adminsLogin(event)">Se connecter</button>
        </div>
      </div>
      <div id="toastAdminsLogin" class="toast"></div>

      <!-- changer code admin -->
      <div id="boxAdminsKey" style="display:none;margin-top:12px">
        <div class="divider"></div>
        <div class="h2" style="margin:0 0 8px 0">Changer le code admin</div>
        <div class="row">
          <div>
            <label>Ancien code</label>
            <input id="adminsOldCode" placeholder="Ancien code" />
          </div>
          <div>
            <label>Nouveau code (min 4)</label>
            <input id="adminsNewCode" placeholder="Nouveau code (min 4)" />
          </div>
          <div class="right">
            <button class="btn primary" id="btnAdminsChange" onclick="adminsChangeCode(event)">Valider</button>
          </div>
        </div>
        <div id="toastAdminsChange" class="toast"></div>
      </div>

      <div id="boxAdminsWork" style="display:none;margin-top:14px">
        <div class="divider"></div>

        <!-- Agents + Missions en 2 colonnes (comme ta version ‚Äúpas mal‚Äù) -->
        <div class="twoColBlock">
          <div class="card">
            <div class="headRow"><div class="h2">üë• Ajouter agent</div></div>
            <div class="row">
              <div>
                <label>Nom</label>
                <input id="adminsNewAgentName" placeholder="Nom Pr√©nom" />
              </div>
              <div>
                <label>Code</label>
                <input id="adminsNewAgentCode" value="0000" />
              </div>
              <div class="right">
                <button class="btn primary" id="btnAdminsAddAgent" onclick="adminsAddAgent(event)">Ajouter</button>
              </div>
            </div>
            <div id="toastAdminsAgents" class="toast"></div>
          </div>

          <div class="card">
            <div class="headRow"><div class="h2">
  üë• Agents
          
  <span id="agentsCountTotal"></span>
  <span id="agentsCountActive" class="count green"></span>
  <span id="agentsCountInactive" class="count red"></span>
</div></div>
            <div class="scrollBox">
              <table class="table">
                <thead><tr><th>Nom</th><th>Actif</th><th>Actions</th></tr></thead>
                <tbody id="adminsAgentsTable"><tr><td class="ghost" colspan="3">‚Äî</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="twoColBlock">
          <div class="card">
            <div class="headRow"><div class="h2">üìö Catalogue missions</div></div>
            <label>Libell√©</label>
            <input id="adminsNewMissionLib" placeholder="Ex : Nettoyage communs" />
            <div class="right" style="margin-top:10px">
              <button class="btn primary" id="btnAdminsAddMission" onclick="adminsAddMission(event)">Ajouter</button>
            </div>
            <div id="toastAdminsMissions" class="toast"></div>
          </div>

          <div class="card">
            <div class="headRow"><div class="h2">üìã Liste missions</div></div>
            <div class="scrollBox">
              <table class="table">
                <thead><tr><th>Libell√©</th><th>Actif</th><th>Actions</th></tr></thead>
                <tbody id="adminsMissionsTable"><tr><td class="ghost" colspan="3">‚Äî</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- P√©riode / Groupe / Responsable (√† gauche) + Missions actives (√† droite) -->
        <div class="twoColBlock">
          <div class="card">
            <div class="headRow">
              <div class="h2">üìÖ P√©riode / Groupe / Responsable</div>
              <div class="status" id="pillResponsable">Responsable : ‚Äî</div>
            </div>

            <div class="row">
              <div>
                <label>P√©riode</label>
                <select id="adminsPeriodsSel"></select>
              </div>
              <div class="right">
                <button class="btn primary" id="btnAdminsLoadPeriod" onclick="adminsLoadPeriod(event)">Charger</button>
                <button class="btn danger" id="btnAdminsUnlockPeriod" onclick="adminsUnlockPeriod(event)">D√©verrouiller</button>

              </div>
            </div>
            <div id="toastAdminsPeriod" class="toast"></div>

            <div class="divider"></div>

            <div class="row">
              <div>
                <label>Ajouter au groupe</label>
                <select id="adminsAddToGroupSel"></select>
              </div>
              <div class="right">
                <button class="btn primary" id="btnAdminsAddToGroup" onclick="adminsAddToGroup(event)">Ajouter au groupe</button>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>Responsable</label>
                <select id="adminsResponsablesSel"></select>
              </div>
              <div class="right">
                <button class="btn primary" id="btnAdminsSetResp" onclick="adminsSetResponsable(event)">D√©finir</button>
              </div>
            </div>

            <div class="divider"></div>

            <div class="h2" style="margin:0 0 8px 0">Groupe</div>
            <div class="scrollBox">
              <table class="table">
                <thead><tr><th>Nom</th><th>Action</th></tr></thead>
                <tbody id="adminsGroupTable"><tr><td class="ghost" colspan="2">Aucun groupe charg√©.</td></tr></tbody>
              </table>
            </div>
          </div>

          <div class="card">
            <div class="headRow"><div class="h2">‚úÖ Missions actives du mois</div></div>
            <div class="row">
              <div class="right" style="display:flex;gap:8px;justify-content:flex-end;width:100%">
                <button class="btn" id="btnAdminsLoadActive" onclick="adminsLoadActiveMissions(event)">Charger</button>
                <button class="btn primary" id="btnAdminsSaveActive" onclick="adminsSaveActiveMissions(event)">Enregistrer</button>
              </div>
            </div>
            <div id="toastAdminsActive" class="toast"></div>

            <div class="divider"></div>

            <div class="scrollBox" id="adminsActiveBox">
              <div class="ghost" style="padding:10px">Charge une p√©riode, puis ‚ÄúCharger‚Äù.</div>
            </div>

            <div class="divider"></div>

            <div class="h2" style="margin:0 0 8px 0">R√©sum√©</div>
            <div class="scrollBox">
              <table class="table">
                <thead><tr><th>Mission</th></tr></thead>
                <tbody id="adminsActiveSummary"><tr><td class="ghost">‚Äî</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="card">
          <div class="headRow"><div class="h2">üìå Retours (Non fait / Partiel)</div></div>
          <div class="row">
            <div class="right">
              <button class="btn" id="btnAdminsLoadRetours" onclick="adminsLoadRetours(event)">Charger (par p√©riode)</button>
            </div>
          </div>
          <div id="toastAdminsRetours" class="toast"></div>
          <div class="divider"></div>
          <div class="scrollBox">
            <table class="table">
              <thead><tr><th>P√©riode</th><th>Agent</th><th>Mission</th><th>D√©claration</th><th>Justificatif</th><th>Remarque</th></tr></thead>
              <tbody id="adminsRetoursTable"><tr><td class="ghost" colspan="6">‚Äî</td></tr></tbody>
            </table>
          </div>
        </div>

      </div>
    </div>

  </div>

  <!-- overlay image ‚Äúmissions accomplies‚Äù -->
  <div class="doneOverlay" id="doneOverlay">
    <!-- mets le fichier √† la racine GitHub : missions-accomplies.png -->
    <img id="doneImg" src="assets/missions-accomplies.png" alt="missions accomplies" />
  </div>

<script>
/* ===============================
   CONFIG (COLLE TON /exec ICI)
   =============================== */
const API_EXEC = "https://script.google.com/macros/s/AKfycbwTo8mKf9yDCmFDZbT03-nbxv5QVLcMjNEGuvlL25alCktBLX9P-G3i4NTVMw048DE/exec"; // <-- remplace par ton /exec Apps Script

/* ===============================
   OUTILS
   =============================== */
function $(id){ return document.getElementById(id); }
  
function setAgentPeriodLocked(locked){
  // locked = true -> interdit de modifier + boutons masqu√©s + banni√®re affich√©e
  // locked = false -> autoris√© + boutons visibles + banni√®re cach√©e

  const btnSave = $("btnAgentsSave");
  const btnVal = $("btnAgentsValidate");
  const info = $("periodClosedInfo");
  const remark = $("agentsRemark");
  const box = $("boxAgentsMissions");

  // 1) Banni√®re
  if (info) info.style.display = locked ? "block" : "none";

  // 2) Boutons
  if (btnSave) {
    btnSave.style.display = locked ? "none" : "";
    btnSave.disabled = !!locked;
  }
  if (btnVal) {
    // Valider seulement si p√©riode ouverte ET responsable
    const showVal = (!locked && !!STATE.agentWork?.is_responsable);
    btnVal.style.display = showVal ? "" : "none";
    btnVal.disabled = !showVal;
  }

  // 3) Remarque g√©n√©rale
  if (remark) remark.disabled = !!locked;

  // 4) Missions : select + justificatif
  if (box){
    box.querySelectorAll(".decSel").forEach(sel => { sel.disabled = !!locked; });
    box.querySelectorAll(".justifInp").forEach(inp => { inp.disabled = !!locked; });
  }
}

function esc(s){ return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function showToast(id, msg, ok){
  const el = $(id); if(!el) return;
  el.className = "toast show " + (ok ? "ok":"bad");
  el.textContent = msg || "";
}
function hideToast(id){
  const el = $(id); if(!el) return;
  el.className = "toast"; el.textContent="";
}
function setLoading(btn, on){
  if(!btn) return;
  btn.classList.toggle("loading", !!on);
  btn.disabled = !!on;
}
function setPill(id, text, kind){
  const el = $(id); if(!el) return;
  el.textContent = text;
  el.className = "status " + (kind==="ok" ? "ok" : (kind==="bad" ? "bad":""));
}
function showView(which){
  $("tabAgents").classList.toggle("active", which==="agents");
  $("tabAdmins").classList.toggle("active", which==="admins");
  $("viewAgents").style.display = (which==="agents") ? "" : "none";
  $("viewAdmins").style.display = (which==="admins") ? "" : "none";
}

/* ===============================
   JSONP (√©vite CORS GitHub -> Apps Script)
   =============================== */
function apiCall(action, params){
  return new Promise((resolve, reject)=>{
    const cb = "cb_" + action + "_" + Date.now() + "_" + Math.random().toString(16).slice(2);
    window[cb] = (data)=>{ try{ delete window[cb]; }catch(_){}
      try{ script.remove(); }catch(_){}
      resolve(data);
    };
    const q = new URLSearchParams();
    q.set("action", action);
    q.set("callback", cb);
    for(const [k,v] of Object.entries(params||{})){
      if(v===undefined || v===null) continue;
      q.set(k, String(v));
    }
    const script = document.createElement("script");
    script.src = API_EXEC + "?" + q.toString();
    script.onerror = ()=>{ try{ delete window[cb]; }catch(_){}
      reject(new Error("network"));
    };
    document.head.appendChild(script);
  });
}

/* ===============================
   STATE
   =============================== */
const STATE = {
  agentsPublic: [],
  admins: { ok:false, code:"" },
  agents: { ok:false, agent_id:"", name:"", must_change:false },
  periods: [],
  current: { period_id:"", group:[], responsable:null, activeMissions:[] },
  agentWork: { period_id:"", missions:[] },
  catalogById: {}
};

/* ===============================
   BOOTSTRAP
   =============================== */
async function bootstrap(){
  // agents public (dropdown agent)
  try{
    const res = await apiCall("listAgentsPublics", {});
    if(res && res.ok){
      STATE.agentsPublic = res.agents || [];
      renderAgentsSelect();
      renderAdminsAddToGroupSelect(); // m√™me liste
    }else{
      $("agentsSel").innerHTML = `<option value="">‚Äî Erreur chargement ‚Äî</option>`;
    }
  }catch(_){
    $("agentsSel").innerHTML = `<option value="">‚Äî Erreur chargement ‚Äî</option>`;
  }

  // p√©riodes (admin + agent)
  try{
    const res = await apiCall("listPeriodesPublics", {});
    if(res && res.ok){
      STATE.periods = res.periodes || [];
      renderPeriodsSelects();
    }else{
      $("adminsPeriodsSel").innerHTML = `<option value="">‚Äî</option>`;
      $("agentsPeriodsSel").innerHTML = `<option value="">‚Äî</option>`;
    }
  }catch(_){
    $("adminsPeriodsSel").innerHTML = `<option value="">‚Äî</option>`;
    $("agentsPeriodsSel").innerHTML = `<option value="">‚Äî</option>`;
  }
}

function renderAgentsSelect(){
  const sel = $("agentsSel");
  sel.innerHTML = `<option value="">‚Äî Choisir agent ‚Äî</option>` +
    (STATE.agentsPublic||[]).filter(a=>a.actif).map(a =>
      `<option value="${esc(a.agent_id)}">${esc(a.nom)}</option>`
    ).join("");
}

  function formatPeriodLabel(p){
  const id = String(p?.period_id || "").trim();

  // Affichage propre depuis period_id: "2026-01" -> "Janvier 2026"
  const m = id.match(/^(\d{4})-(\d{2})$/);
  if(m){
    const y = m[1];
    const mm = parseInt(m[2],10);
    const mois = ["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"];
    if(mm>=1 && mm<=12) return `${mois[mm-1]} ${y}`;
  }
  return id || "‚Äî";
}

function renderPeriodsSelects(){
  const opts =
    '<option value="">‚Äî Choisir p√©riode ‚Äî</option>' +
    (STATE.periods||[])
      .filter(p => p.actif)
      .map(p =>
        `<option value="${esc(p.period_id)}">
          ${esc(formatPeriodLabel(p))}
        </option>`
      )
      .join("");

  // ADMIN
  const adminSel = $("adminsPeriodsSel");
  if (adminSel) adminSel.innerHTML = opts;

  // AGENT
  const agentSel = $("agentsPeriodsSel");
  if (agentSel) agentSel.innerHTML = opts;
}

function renderAdminsAddToGroupSelect(){
  $("adminsAddToGroupSel").innerHTML = `<option value="">‚Äî Choisir agent ‚Äî</option>` +
    (STATE.agentsPublic||[]).filter(a=>a.actif).map(a =>
      `<option value="${esc(a.agent_id)}">${esc(a.nom)}</option>`
    ).join("");
}

/* ===============================
   ADMIN
   =============================== */
async function adminsLogin(ev){
  hideToast("toastAdminsLogin");
  const btn = ev?.target || $("btnAdminsLogin");
  const code = $("adminsCode").value.trim();
  if(!code){ showToast("toastAdminsLogin","Code requis.", false); return; }

  setLoading(btn,true);
  try{
    const res = await apiCall("adminLogin", { code });
    if(!res || !res.ok){
      setPill("pillAdminsStatus","Admin : non connect√©","bad");
      showToast("toastAdminsLogin","Code admin incorrect.", false);
      return;
    }
    STATE.admins.ok = true;
    STATE.admins.code = code;
    setPill("pillAdminsStatus","Admin : connect√© ‚úÖ","ok");
    $("btnAdminsKey").style.display="";
    $("btnAdminsLogout").style.display="";
    $("boxAdminsWork").style.display="";

    await adminsRefreshAll();
    showToast("toastAdminsLogin","Admin connect√© ‚úÖ", true);
  }catch(e){
    showToast("toastAdminsLogin","Erreur r√©seau.", false);
  }finally{
    setLoading(btn,false);
  }
}

function adminsLogout(){
  STATE.admins = { ok:false, code:"" };
  $("boxAdminsWork").style.display="none";
  $("btnAdminsKey").style.display="none";
  $("btnAdminsLogout").style.display="none";
  $("boxAdminsKey").style.display="none";
  $("adminsCode").value = "";
  $("adminsOldCode").value = "";
  $("adminsNewCode").value = "";
  setPill("pillAdminsStatus","Admin : non connect√©","bad");
  hideToast("toastAdminsLogin");
}

function toggleAdminsKey(){
  const box = $("boxAdminsKey");
  box.style.display = (box.style.display==="none" ? "" : "none");
}

async function adminsChangeCode(ev){
  hideToast("toastAdminsChange");
  if(!STATE.admins.ok){ showToast("toastAdminsChange","Non connect√©.", false); return; }

  const btn = ev?.target || $("btnAdminsChange");
  const old_code = $("adminsOldCode").value.trim();
  const new_code = $("adminsNewCode").value.trim();
  if(!old_code || !new_code){ showToast("toastAdminsChange","Champs requis.", false); return; }

  setLoading(btn,true);
  try{
    const res = await apiCall("adminChangeCode", { admin_code: STATE.admins.code, old_code, new_code });
    if(!res || !res.ok){
      showToast("toastAdminsChange",(res&&res.message)||"Erreur", false);
      return;
    }
    STATE.admins.code = new_code;
    $("adminsCode").value = new_code;
    $("adminsOldCode").value = "";
    $("adminsNewCode").value = "";
    showToast("toastAdminsChange","Code modifi√© ‚úÖ", true);
  }catch(_){
    showToast("toastAdminsChange","Erreur r√©seau.", false);
  }finally{
    setLoading(btn,false);
  }
}

async function adminsRefreshAll(){
  await Promise.all([
    adminsListAgents(),
    adminsListMissions(),
    adminsListPeriods()
  ]);
}

async function adminsListAgents(){
  if(!STATE.admins.ok) return;
  const tb = $("adminsAgentsTable");
    try{
    const res = await apiCall("adminListAgents", { admin_code: STATE.admins.code });
    if(!res || !res.ok) throw new Error("bad");
    const list = res.agents || [];
     list.forEach(a => { a.actif = (a.actif === true); });
      // TRI alphab√©tique (ignore majuscules/accents)
list.sort((a,b)=>
  String(a.nom||"").localeCompare(String(b.nom||""), "fr", { sensitivity:"base" })
);

      // === Compteurs agents ===
const total = list.length;
const active = list.filter(a => a.actif).length;
const inactive = total - active;

$("agentsCountTotal").textContent = ` (${total})`;
$("agentsCountActive").textContent = ` üü¢ ${active}`;
$("agentsCountInactive").textContent = ` üî¥ ${inactive}`;

   tb.innerHTML = list.map(a => `
<tr>
  <td>${esc(a.nom)}</td>
  <td>${a.actif ? "Oui" : "Non"}</td>
  <td class="right">

  <button
  type="button"
  class="btn small toggle ${a.actif ? 'off' : 'on'}"
  data-actif="${a.actif ? '1' : '0'}"
  onclick="adminsToggleAgent(event, '${esc(a.agent_id)}')">
  ${a.actif ? "D√©sactiver" : "Activer"}
</button>

    <button type="button" class="btn small"
      onclick="adminsResetAgentCode(event, '${a.agent_id}')">
      Reset 0000
    </button>

    <button class="btn small danger"
      onclick="adminsDeleteAgent('${a.agent_id}')">
      Retirer
    </button>

  </td>
</tr>
`).join("");

    // met √† jour dropdown ‚Äúajouter au groupe‚Äù
    const pub = await apiCall("listAgentsPublics", {});
    if(pub && pub.ok){
      STATE.agentsPublic = pub.agents || [];
      renderAgentsSelect();
      renderAdminsAddToGroupSelect();
    }
      function adminsToggleAgentUI(btn, agent_id){
 
  // 2) envoi serveur (sans d√©pendre du refresh UI)
  apiCall("adminToggleAgent", {
    admin_code: STATE.admins.code,
    agent_id: String(agent_id).trim(),
    actif: willActivate ? "TRUE" : "FALSE"
  });

  // optionnel: rafra√Æchir la liste apr√®s 400ms (si √ßa marche chez toi)
  setTimeout(() => { adminsListAgents(); }, 400);
}

  }catch(e){
    tb.innerHTML = `<tr><td class="ghost" colspan="3">Erreur.</td></tr>`;
  }
}

async function adminsAddAgent(ev){
  hideToast("toastAdminsAgents");
  if(!STATE.admins.ok){ showToast("toastAdminsAgents","Non connect√©.",false); return; }
  const btn = ev?.target || $("btnAdminsAddAgent");
  const name = $("adminsNewAgentName").value.trim();
  const code = $("adminsNewAgentCode").value.trim() || "0000";
  if(!name){ showToast("toastAdminsAgents","Nom requis.",false); return; }

  setLoading(btn,true);
  try{
    const res = await apiCall("adminAddAgent", { admin_code: STATE.admins.code, name, code });
    if(!res || !res.ok){
      showToast("toastAdminsAgents",(res&&res.message)||"Erreur",false); return;
    }
    showToast("toastAdminsAgents","Agent ajout√© ‚úÖ",true);
    $("adminsNewAgentName").value="";
    $("adminsNewAgentCode").value="0000";
    await adminsListAgents();
  }catch(_){
    showToast("toastAdminsAgents","Erreur r√©seau.",false);
    const pub = await apiCall("listAgentsPublics", {});
if (pub && pub.ok) {
  STATE.agentsPublic = pub.agents || [];
  renderAgentsSelect();
}

  }finally{
    setLoading(btn,false);
  }
}
  
async function adminsToggleAgent(event, agent_id){
  const btn = event.currentTarget;
  if (!STATE.admins.ok) {
    showToast("toastAdminsAgents", "Non connect√©", false);
    return;
  }

  // ===== UI OPTIMISTE (INSTANTAN√â) =====
  const row = btn.closest("tr");
  const tdActif = row?.children?.[1];

  const wasActive = (tdActif && tdActif.textContent.trim().toLowerCase() === "oui");
  const nowActive = !wasActive;

 // reset couleurs
btn.classList.remove("btn-danger", "btn-success");

// appliquer la bonne couleur
if (nowActive) {
  btn.classList.add("btn-danger"); // D√©sactiver = rouge
} else {
  btn.classList.add("btn-success"); // Activer = vert
}

// sync dataset
btn.dataset.actif = nowActive ? "1" : "0";
  
  // colonne Actif
  if (tdActif) tdActif.textContent = nowActive ? "Oui" : "Non";

  // ‚úÖ Compteurs : recalcul rapide depuis le tableau (pas de dataset)
const rows = Array.from(document.querySelectorAll("#adminsAgentsTable tr"));
let active = 0, total = 0;

rows.forEach(r => {
  const td = r.children && r.children[1];
  if (!td) return;
  const v = td.textContent.trim().toLowerCase();
  if (v !== "oui" && v !== "non") return; // ignore placeholders
  total++;
  if (v === "oui") active++;
});

const inactive = total - active;

const elTotal = document.getElementById("agentsCountTotal");
const elActive = document.getElementById("agentsCountActive");
const elInactive = document.getElementById("agentsCountInactive");

if (elTotal) elTotal.textContent = ` (${total})`;
if (elActive) elActive.textContent = ` üü¢ ${active}`;
if (elInactive) elInactive.textContent = ` üî¥ ${inactive}`;

// ===== UI INSTANTAN√âE (AVANT SERVEUR) =====
btn.dataset.actif = nowActive ? "1" : "0";
btn.textContent = nowActive ? "D√©sactiver" : "Activer";
if (tdActif) tdActif.textContent = nowActive ? "Oui" : "Non";

// couleurs (CSS on/off)
btn.classList.remove("on", "off");
btn.classList.add(nowActive ? "off" : "on");
  // ===== APPEL SERVEUR (EN FOND) =====
  try {
    const res = await apiCall("adminToggleAgent", {
      admin_code: STATE.admins.code,
      agent_id: String(agent_id).trim(),
      actif: "toggle"
    });

    if (!res || !res.ok) throw new Error(res?.message || "Erreur toggle");
    // ‚úÖ synchro imm√©diate UI avec la v√©rit√© serveur
const row = btn.closest("tr");
const tdActif = row?.children?.[1];

const isActiveSrv = (res.actif === true) || (String(res.actif).trim().toUpperCase() === "TRUE");

if (tdActif) tdActif.textContent = isActiveSrv ? "Oui" : "Non";

// bouton = action possible
btn.textContent = isActiveSrv ? "D√©sactiver" : "Activer";
btn.classList.remove("btn-danger", "btn-success");
btn.classList.add(isActiveSrv ? "btn-danger" : "btn-success");

// dataset align√©
btn.dataset.actif = isActiveSrv ? "1" : "0";


  } catch (e) {
    // ROLLBACK si erreur
    btn.dataset.actif = wasActive ? "1" : "0";
    btn.textContent = wasActive ? "D√©sactiver" : "Activer";
    if (tdActif) tdActif.textContent = wasActive ? "Oui" : "Non";

    showToast("toastAdminsAgents", "Erreur r√©seau", false);
  }
}


async function adminsResetAgentCode(ev, agent_id){
  if(ev){ ev.preventDefault(); ev.stopPropagation(); }
  if(!STATE.admins.ok) return;

  const btn = ev?.target || null;
  setLoading(btn, true);

  try{
    const res = await apiCall("adminResetAgentCode", { admin_code: STATE.admins.code, agent_id });

    if(!res || !res.ok){
      showToast("toastAdminsAgents", (res && (res.message || res.error)) || "Erreur", false);
      return;
    }

    showToast("toastAdminsAgents", "Reset 0000 ‚úÖ", true);

    // Recharge juste la liste (sans reload page)
    await adminsListAgents();

  }catch(e){
    showToast("toastAdminsAgents", "Erreur r√©seau.", false);
  }finally{
    setLoading(btn, false);
  }
}

async function adminsDeleteAgent(agent_id){
  if(!STATE.admins.ok) return;
  if(!confirm("Supprimer d√©finitivement cet agent ?")) return;
  try{
    await apiCall("adminDeleteAgent", { admin_code: STATE.admins.code, agent_id });
    await adminsListAgents();
  }catch(_){}
}

async function adminsListMissions(){
  if(!STATE.admins.ok) return;
  const tb = $("adminsMissionsTable");
  tb.innerHTML = `<tr><td class="ghost" colspan="3">Chargement‚Ä¶</td></tr>`;
  try{
    const res = await apiCall("adminListCatalog", { admin_code: STATE.admins.code });
    if(!res || !res.ok) throw new Error("bad");
    const list = res.catalog || [];
    // NORMALISATION du bool√©en actif (Sheets renvoie "TRUE"/"FALSE")
list.forEach(m => {
  m.actif = (m.actif === true) || (String(m.actif ?? "").trim().toUpperCase() === "TRUE");
});

    STATE.catalogById = {};
list.forEach(m => {
  STATE.catalogById[String(m.mission_id)] = m.libelle || m.mission_id;
});
    tb.innerHTML = list.map(m=>`
      <tr>
        <td>${esc(m.libelle)}</td>
        <td>${m.actif ? "Oui":"Non"}</td>
        <td class="right">
 <button
  type="button"
  class="btn small toggle ${m.actif ? 'off' : 'on'}"
  onclick="adminsToggleMission(event, '${esc(m.mission_id)}')">
  ${m.actif ? 'D√©sactiver' : 'Activer'}
</button>
  <button type="button"
          class="btn small danger"
          onclick="adminsDeleteMission(event, '${esc(m.mission_id)}', this)">
    Supprimer
  </button>
</td>

      </tr>
    `).join("");
  }catch(e){
  console.error("adminsListMissions ERROR", e);
  tb.innerHTML = `<tr><td class="ghost" colspan="3">Erreur (voir console)</td></tr>`;
}
}

async function adminsAddMission(ev){
  hideToast("toastAdminsMissions");
  if(!STATE.admins.ok){ showToast("toastAdminsMissions","Non connect√©.",false); return; }
  const btn = ev?.target || $("btnAdminsAddMission");
  const libelle = $("adminsNewMissionLib").value.trim();
  if(!libelle){ showToast("toastAdminsMissions","Libell√© requis.",false); return; }

  setLoading(btn,true);
  try{
    const res = await apiCall("adminAddMission", { admin_code: STATE.admins.code, libelle });
    if(!res || !res.ok){
      showToast("toastAdminsMissions",(res&&res.message)||"Erreur",false); return;
    }
    showToast("toastAdminsMissions","Mission ajout√©e ‚úÖ",true);
    $("adminsNewMissionLib").value="";
    await adminsListMissions();
  }catch(_){
    showToast("toastAdminsMissions","Erreur r√©seau.",false);
  }finally{
    setLoading(btn,false);
  }
}
async function adminsToggleMission(event, mission_id) {
  const btn = event.currentTarget;

  if (!STATE.admins.ok) {
    showToast("toastAdminsMissions", "Non connect√©", false);
    return;
  }

  // --- UI optimiste (instantan√©) ---
  const row = btn.closest("tr");
  const tdActif = row?.children?.[1];

  const wasActive = tdActif.textContent.trim().toLowerCase() === "oui";
  const nowActive = !wasActive;

  // texte colonne Actif
  tdActif.textContent = nowActive ? "Oui" : "Non";

  // bouton
  btn.textContent = nowActive ? "D√©sactiver" : "Activer";
  btn.classList.remove("btn-danger", "btn-success");
  btn.classList.add(nowActive ? "btn-danger" : "btn-success");

  try {
    const res = await apiCall("adminToggleMission", {
      admin_code: STATE.admins.code,
      mission_id: String(mission_id).trim()
    });

    if (!res || !res.ok) {
      throw new Error("toggle failed");
    }

  } catch (e) {
    // rollback UI si erreur
    tdActif.textContent = wasActive ? "Oui" : "Non";
    btn.textContent = wasActive ? "D√©sactiver" : "Activer";
    btn.classList.remove("btn-danger", "btn-success");
    btn.classList.add(wasActive ? "btn-danger" : "btn-success");

    showToast("toastAdminsMissions", "Erreur r√©seau", false);
  }
}

async function adminsDeleteMission(mission_id){
  if(!STATE.admins.ok) return;
  if(!confirm("Supprimer d√©finitivement cette mission ?")) return;
  try{
    await apiCall("adminDeleteMission", { admin_code: STATE.admins.code, mission_id });
    await adminsListMissions();
  }catch(_){}
}

async function adminsListPeriods(){
  if(!STATE.admins.ok) return;
  try{
    const res = await apiCall("adminListPeriodes", { admin_code: STATE.admins.code });
    if(!res || !res.ok) return;
    STATE.periods = res.periodes || [];
    renderPeriodsSelects();
  }catch(_){}
}

async function adminsLoadPeriod(ev){
  hideToast("toastAdminsPeriod");
  if(!STATE.admins.ok){ showToast("toastAdminsPeriod","Non connect√©.",false); return; }
  const btn = ev?.internal ? null : (ev?.target || $("btnAdminsLoadPeriod"));
  const period_id = $("adminsPeriodsSel").value;
  if(!period_id){ showToast("toastAdminsPeriod","Choisis une p√©riode.",false); return; }

  if (btn) setLoading(btn,true);
  try{
    const res = await apiCall("adminLoadPeriod", { admin_code: STATE.admins.code, period_id });
    if(!res || !res.ok){
      showToast("toastAdminsPeriod",(res&&res.message)||"Erreur",false); return;
    }
    STATE.current.period_id = period_id;
    STATE.current.group = res.group || [];
    STATE.current.responsable = res.responsable || null;

    setPill("pillResponsable","Responsable : " + (STATE.current.responsable ? STATE.current.responsable.nom : "‚Äî"), STATE.current.responsable ? "ok" : "");
    renderGroupTable();
    renderResponsablesSelect();

        showToast("toastAdminsPeriod","P√©riode charg√©e ‚úÖ",true);
    
    // Auto-refresh uniquement quand l'utilisateur clique "Charger groupe"
if (!ev?.internal) {
  await adminsLoadActiveMissions({ target: $("btnAdminsLoadActive"), internal:true });
  await adminsLoadRetours({ target: $("btnAdminsLoadRetours"), internal:true });
}

    // NE PAS d√©clencher d‚Äôautres chargements automatiques (sinon ‚Äúsapin de No√´l‚Äù)
    // => missions actives / retours = manuels via boutons
  }catch(_){
    showToast("toastAdminsPeriod","Erreur r√©seau.",false);
  }finally{
    if (btn) setLoading(btn,false);
  }
}

function renderGroupTable(){
  const tb = $("adminsGroupTable");
  const g = STATE.current.group || [];
  if(!g.length){
    tb.innerHTML = `<tr><td class="ghost" colspan="2">Aucun groupe charg√©.</td></tr>`;
    return;
  }
  tb.innerHTML = g.map(a=>`
    <tr>
      <td>${esc(a.nom)}</td>
      <td class="right"><button class="btn small danger" onclick="adminsRemoveFromGroup('${esc(a.agent_id)}')">Retirer</button></td>
    </tr>
  `).join("");
}
function renderResponsablesSelect(){
  const sel = $("adminsResponsablesSel");
  sel.innerHTML = `<option value="">‚Äî Choisir ‚Äî</option>` +
    (STATE.current.group||[]).map(a=>`<option value="${esc(a.agent_id)}">${esc(a.nom)}</option>`).join("");
}

async function adminsAddToGroup(ev){
  hideToast("toastAdminsPeriod");
  if(!STATE.admins.ok){ showToast("toastAdminsPeriod","Non connect√©.",false); return; }
  const btn = ev?.target || $("btnAdminsAddToGroup");
  const period_id = STATE.current.period_id || $("adminsPeriodsSel").value;
  const agent_id = $("adminsAddToGroupSel").value;
  if(!period_id){ showToast("toastAdminsPeriod","Charge une p√©riode d‚Äôabord.",false); return; }
  if(!agent_id){ showToast("toastAdminsPeriod","Choisis un agent.",false); return; }

  setLoading(btn,true);
  try{
    const res = await apiCall("adminAddToGroup", { admin_code: STATE.admins.code, period_id, agent_id });
    if(!res || !res.ok){
      showToast("toastAdminsPeriod",(res&&res.message)||"Erreur",false); return;
    }
    // recharge le groupe uniquement (pas les autres)
    await adminsLoadPeriod({ target: $("btnAdminsLoadPeriod"), internal:true });
  }catch(_){
    showToast("toastAdminsPeriod","Erreur r√©seau.",false);
  }finally{
    setLoading(btn,false);
  }
}

async function adminsRemoveFromGroup(agent_id){
  hideToast("toastAdminsPeriod");
  if(!STATE.admins.ok) return;

  const period_id = STATE.current.period_id;
  if(!period_id) return;
  // Anti double-clic + feedback simple (safe)
const btn = event?.target;
if (btn && btn.tagName === "BUTTON") setLoading(btn, true);


  try{
    const res = await apiCall("adminRemoveFromGroup", {
      admin_code: STATE.admins.code,
      period_id,
      agent_id
    });

    if(!res || !res.ok){
      showToast(
        "toastAdminsPeriod",
        (res && res.message) || "Erreur",
        false
      );
      if (btn && btn.tagName === "BUTTON") setLoading(btn, false);
      return;
    }

    await adminsLoadPeriod({
      target: $("btnAdminsLoadPeriod"),
      internal: true
    });

  }catch(_){
    showToast("toastAdminsPeriod","Erreur r√©seau.",false);
  }
}

async function adminsSetResponsable(ev){
  hideToast("toastAdminsPeriod");
  if(!STATE.admins.ok){ showToast("toastAdminsPeriod","Non connect√©.",false); return; }
  const btn = ev?.target || $("btnAdminsSetResp");
  const period_id = STATE.current.period_id || $("adminsPeriodsSel").value;
  const agent_id = $("adminsResponsablesSel").value;
  if(!period_id){ showToast("toastAdminsPeriod","Charge une p√©riode d‚Äôabord.",false); return; }
  if(!agent_id){ showToast("toastAdminsPeriod","Choisis un responsable.",false); return; }

  setLoading(btn,true);
  try{
    const res = await apiCall("adminSetResponsable", { admin_code: STATE.admins.code, period_id, agent_id });
    if(!res || !res.ok){
      showToast("toastAdminsPeriod",(res&&res.message)||"Erreur",false); return;
    }
    await adminsLoadPeriod({ target: $("btnAdminsLoadPeriod"), internal:true });
  }catch(_){
    showToast("toastAdminsPeriod","Erreur r√©seau.",false);
  }finally{
    setLoading(btn,false);
  }
}

async function adminsLoadActiveMissions(ev){
  hideToast("toastAdminsActive");
  if(!STATE.admins.ok){ showToast("toastAdminsActive","Non connect√©.",false); return; }
  const btn = ev?.target || $("btnAdminsLoadActive");
  const period_id = STATE.current.period_id;
  if(!period_id){ showToast("toastAdminsActive","Charge une p√©riode d‚Äôabord.",false); return; }

  setLoading(btn,true);
  try{
    const res = await apiCall("adminGetMonthMissions", { admin_code: STATE.admins.code, period_id });
    if(!res || !res.ok){
      showToast("toastAdminsActive",(res&&res.message)||"Erreur",false); return;
    }
    renderActiveCheckboxes(res.missionsAll||[], res.missionsOn||[]);
    renderActiveSummary(res.missionsOn||[]);
    showToast("toastAdminsActive","Charg√© ‚úÖ",true);
  }catch(_){
    showToast("toastAdminsActive","Erreur r√©seau.",false);
  }finally{
    setLoading(btn,false);
  }
}

function renderActiveCheckboxes(all, onList){
  const on = new Set((onList||[]).map(x=>String(x.mission_id)));
  const box = $("adminsActiveBox");
  if(!all.length){
    box.innerHTML = `<div class="ghost" style="padding:10px">Aucune mission.</div>`;
    return;
  }
  box.innerHTML = all.map(m=>`
    <div class="checkRow">
      <input type="checkbox" data-mid="${esc(m.mission_id)}" ${on.has(String(m.mission_id))?"checked":""}/>
      <div style="min-width:0;flex:1">
        <div class="title">${esc(m.libelle)}</div>
      </div>
    </div>
  `).join("");
}

function renderActiveSummary(list){
  const tb = $("adminsActiveSummary");
  if(!tb) return;

  const arr = (list || []).map(x => {
    const mid = (typeof x === "string") ? x : (x && x.mission_id);
    if(!mid) return null;

    const lib =
      (typeof x === "string")
        ? (STATE.catalogById[String(mid)] || String(mid))
        : (x.libelle || STATE.catalogById[String(mid)] || String(mid));

    return { lib };
  }).filter(Boolean);

  if(!arr.length){
    tb.innerHTML = `<tr><td class="ghost">‚Äî</td></tr>`;
    return;
  }

  tb.innerHTML = arr.map(r => `<tr><td>${esc(r.lib)}</td></tr>`).join("");
}


async function adminsSaveActiveMissions(ev){
  hideToast("toastAdminsActive");
  if(!STATE.admins.ok){ showToast("toastAdminsActive","Non connect√©.",false); return; }
  const btn = ev?.target || $("btnAdminsSaveActive");
  const period_id = STATE.current.period_id;
  if(!period_id){ showToast("toastAdminsActive","Charge une p√©riode d‚Äôabord.",false); return; }

  const checks = Array.from($("adminsActiveBox").querySelectorAll('input[type="checkbox"][data-mid]'));
  const ids = checks.filter(c=>c.checked).map(c=>c.getAttribute("data-mid"));

  setLoading(btn,true);
  try{
    const res = await apiCall("adminSaveMonthMissions", { admin_code: STATE.admins.code, period_id, ids: JSON.stringify(ids) });
    if(!res || !res.ok){
      showToast("toastAdminsActive",(res&&res.message)||"Erreur",false); return;
    }
    renderActiveSummary(res.missionsOn||ids);
    showToast("toastAdminsActive","Enregistr√© ‚úÖ",true);
  }catch(_){
    showToast("toastAdminsActive","Erreur r√©seau.",false);
  }finally{
    setLoading(btn,false);
  }
}

async function adminsLoadRetours(ev){
  hideToast("toastAdminsRetours");
  if(!STATE.admins.ok){ showToast("toastAdminsRetours","Non connect√©.",false); return; }
  const btn = ev?.target || $("btnAdminsLoadRetours");
  const period_id = STATE.current.period_id;
  if(!period_id){ showToast("toastAdminsRetours","Charge une p√©riode d‚Äôabord.",false); return; }

  setLoading(btn,true);
  try{
    const res = await apiCall("adminGetRetours", { admin_code: STATE.admins.code, period_id });
    if(!res || !res.ok){
      showToast("toastAdminsRetours",(res&&res.message)||"Erreur",false); return;
    }
    const tb = $("adminsRetoursTable");
    const items = res.items || [];
    if(!items.length){
      tb.innerHTML = `<tr><td class="ghost" colspan="6">Aucun retour.</td></tr>`;
    }else{
      tb.innerHTML = items.map(it=>`
        <tr>
          <td>${esc(it.period_id)}</td>
          <td>${esc(it.agent)}</td>
          <td>${esc(it.mission)}</td>
          <td>${esc(it.declaration)}</td>
          <td>${esc(it.justificatif)}</td>
          <td>${esc(it.remark||"")}</td>
        </tr>
      `).join("");
    }
    showToast("toastAdminsRetours","Charg√© ‚úÖ",true);
  }catch(_){
    showToast("toastAdminsRetours","Erreur r√©seau.",false);
  }finally{
    setLoading(btn,false);
  }
}

  async function adminsUnlockPeriod(ev){
  hideToast("toastAdminsPeriod");
  if(!STATE.admins.ok){ showToast("toastAdminsPeriod","Non connect√©.",false); return; }

  const btn = ev?.target || $("btnAdminsUnlockPeriod");

  // p√©riode courante (priorit√© √† celle d√©j√† charg√©e)
  const period_id = STATE.current.period_id || $("adminsPeriodsSel").value;
  if(!period_id){ showToast("toastAdminsPeriod","Choisis/charge une p√©riode d‚Äôabord.",false); return; }

  if(!confirm("D√©verrouiller la p√©riode pour le responsable ?\n\n‚ö†Ô∏è Le responsable pourra √† nouveau modifier et enregistrer.")){
    return;
  }

  setLoading(btn,true);
  try{
    const res = await apiCall("adminUnlockPeriod", { admin_code: STATE.admins.code, period_id });
    if(!res || !res.ok){
      showToast("toastAdminsPeriod",(res&&res.message)||"Erreur",false);
      return;
    }

    showToast("toastAdminsPeriod","D√©verrouill√© ‚úÖ",true);

    // Recharge juste le groupe/responsable (sans sapin)
    await adminsLoadPeriod({ target: $("btnAdminsLoadPeriod"), internal:true });

  }catch(_){
    showToast("toastAdminsPeriod","Erreur r√©seau.",false);
  }finally{
    setLoading(btn,false);
  }
}

/* ===============================
   AGENT
   =============================== */
async function agentsLogin(ev){
  hideToast("toastAgentsLogin");
  const btn = ev?.target || $("btnAgentsLogin");
  const agent_id = $("agentsSel").value;
  const code = $("agentsCode").value.trim();
  if(!agent_id || !code){ showToast("toastAgentsLogin","S√©lection + code requis.",false); return; }

  setLoading(btn,true);
  try{
    const res = await apiCall("agentLogin", { agent_id, code });
    if(!res || !res.ok){
      setPill("pillAgentsStatus","Agent : non connect√©","bad");
      showToast("toastAgentsLogin","Code incorrect.",false);
      return;
    }
    STATE.agents.ok = true;
    STATE.agents.agent_id = res.agent.agent_id;
    STATE.agents.name = res.agent.nom;
    STATE.agents.must_change = !!res.agent.must_change;
    if (STATE.agents.must_change || code === "0000") {
  $("boxAgentsKey").style.display = "";
  $("boxAgentsWork").style.display = "none";
  showToast(
    "toastAgentsLogin",
    "‚ö†Ô∏è Changement de code obligatoire (premi√®re connexion ou reset).",
    true
  );
  return;
}

    setPill("pillAgentsStatus","","ok");
    $("btnAgentsKey").style.display="";
    $("btnAgentsLogout").style.display="";
    $("boxAgentsWork").style.display="";
    // UI: remplacer le select agent par le badge, et cacher Code + Se connecter
$("agentsSel").style.display = "none";
$("agentsAgentBadge").style.display = "";
$("agentsAgentBadge").textContent = "Agent : " + STATE.agents.name;

$("agentsCodeCol").style.display = "none";
$("agentsLoginBtnCol").style.display = "none";


    // p√©riodes autoris√©es
    $("agentsPeriodsSel").innerHTML =
      `<option value="">‚Äî Choisir p√©riode ‚Äî</option>` +
      (res.periodes||[]).map(p=>`<option value="${esc(p.period_id)}">${esc(formatPeriodLabel(p))}</option>`)
.join("");

    // impose changement code √† la 1√®re connexion si must_change
    if(STATE.agents.must_change){
      $("boxAgentsKey").style.display="";
      showToast("toastAgentsLogin","Premi√®re connexion : change ton code (üîë).", true);
    }else{
      hideToast("toastAgentsLogin");
    }

  }catch(_){
    showToast("toastAgentsLogin","Erreur r√©seau.",false);
  }finally{
    setLoading(btn,false);
  }
}

function agentsLogout(){
  STATE.agents = { ok:false, agent_id:"", name:"", must_change:false };
  $("btnAgentsKey").style.display="none";
  $("btnAgentsLogout").style.display="none";
  $("boxAgentsKey").style.display="none";
  $("boxAgentsWork").style.display="none";
  setPill("pillAgentsStatus","","");
  setPill("pillAgentsPeriod","P√©riode : ‚Äî","");
  $("agentsPeriodsSel").innerHTML = `<option value="">‚Äî Choisir p√©riode ‚Äî</option>`;
  $("boxAgentsMissions").innerHTML = `<div class="ghost" style="padding:10px">Choisis une p√©riode puis ‚ÄúCharger‚Äù.</div>`;
  $("agentsRemark").value="";
  hideToast("toastAgentsLogin");
  location.reload();
}

function toggleAgentsKey(){
  const box = $("boxAgentsKey");
  box.style.display = (box.style.display==="none" ? "" : "none");
}

async function agentsChangeCode(ev){
  hideToast("toastAgentsChange");
  if(!STATE.agents.ok){ showToast("toastAgentsChange","Non connect√©.",false); return; }
  const btn = ev?.target || $("btnAgentsChange");
  const old_code = $("agentsOldCode").value.trim();
  const new_code = $("agentsNewCode").value.trim();
  if(!old_code || !new_code){ showToast("toastAgentsChange","Champs requis.",false); return; }

  setLoading(btn,true);
  try{
    const res = await apiCall("agentChangeCode", { agent_id: STATE.agents.agent_id, old_code, new_code });
    if(!res || !res.ok){
      showToast("toastAgentsChange",(res&&res.message)||"Erreur",false); return;
    }
    STATE.agents.must_change = false;
    // fermer le tableau de changement de code
$("boxAgentsKey").style.display = "none";

// d√©bloquer la suite (missions)
$("boxAgentsWork").style.display = "";

// garder la cl√© disponible
$("btnAgentsKey").style.display = "";
    $("agentsOldCode").value="";
    $("agentsNewCode").value="";
    showToast("toastAgentsChange","Code modifi√© ‚úÖ",true);
    setTimeout(() => {
  location.reload();
}, 800);

  }catch(_){
    showToast("toastAgentsChange","Erreur r√©seau.",false);
  }finally{
    setLoading(btn,false);
  }
}

function toPeriodYM(period_id, label){
  // 1) si period_id contient d√©j√† YYYY-MM, on le prend
  const m = String(period_id || "").match(/\d{4}-\d{2}/);
  if (m) return m[0];

  // 2) sinon on tente de parser "Janvier 2026"
  const txt = String(label || "").trim().toLowerCase();

  const months = {
    "janvier":"01", "f√©vrier":"02", "fevrier":"02", "mars":"03", "avril":"04",
    "mai":"05", "juin":"06", "juillet":"07", "ao√ªt":"08", "aout":"08",
    "septembre":"09", "octobre":"10", "novembre":"11", "d√©cembre":"12", "decembre":"12"
  };

  const year = (txt.match(/\b(20\d{2})\b/) || [])[1];
  const monthName = Object.keys(months).find(k => txt.includes(k));
  if (!year || !monthName) return "";

  return `${year}-${months[monthName]}`;
}

  
async function agentsLoadPeriod(ev){
  hideToast("toastAgentsLoad");
  if(!STATE.agents.ok){ showToast("toastAgentsLoad","Non connect√©.",false); return; }
  const btn = ev?.target || $("btnAgentsLoad");
  const period_id = $("agentsPeriodsSel").value;
  if(!period_id){ showToast("toastAgentsLoad","Choisis une p√©riode.",false); return; }

  setLoading(btn,true);
  try{
    const res = await apiCall("agentLoadPeriod", { agent_id: STATE.agents.agent_id, period_id });
    if(!res || !res.ok){
      showToast("toastAgentsLoad",(res&&res.message)||"Erreur",false); return;
    }
    // ===== OUVERTURE / FERMETURE AUTOMATIQUE =====
STATE.agentWork.is_period_open = !!res.is_period_open;
STATE.agentWork.is_responsable = !!res.is_responsable;

setAgentPeriodLocked(!STATE.agentWork.is_period_open);
    STATE.agentWork.period_id = period_id;
    STATE.agentWork.missions = res.missions || [];
    STATE.agentWork.is_responsable = !!res.is_responsable;
    $("boxAgentsAfterLoad").style.display = "";

    setPill("pillAgentsPeriod","P√©riode : " + ($("agentsPeriodsSel").selectedOptions[0]?.textContent || period_id), "ok");


    renderAgentMissions(res.missions || []);
    renderAgentTeam(res.group || [], res.responsable || null);
    setAgentPeriodLocked(!STATE.agentWork.is_period_open);
    console.log("TEAM GROUP =", res.group);
console.log("RESPONSABLE =", res.responsable);
    $("boxAgentsAfterLoad").style.display = "";

    showToast("toastAgentsLoad","Charg√© ‚úÖ",true);
  }catch(_){
    showToast("toastAgentsLoad","Erreur r√©seau.",false);
  }finally{
    setLoading(btn,false);
  }
}

function renderAgentMissions(list){
  const box = $("boxAgentsMissions");
  if(!list.length){
    box.innerHTML = `<div class="ghost" style="padding:10px">Aucune mission.</div>`;
    return;
  }
  // IMPORTANT: pas de checkbox ‚ÄúFait‚Äù s√©par√©e. Juste le select.
  box.innerHTML = list.map(m=>`
    <div class="checkRow" style="align-items:flex-start">
      <div style="flex:1;min-width:0">
        <div class="title">${esc(m.libelle)}</div>
        <div style="margin-top:8px;display:flex;gap:10px;flex-wrap:wrap">
          <div style="flex:1;min-width:220px">
            <select class="decSel"
               data-mid="${esc(m.mission_id)}"
                onchange="onAgentDeclarationChange(this)">
              <option value="" ${m.declaration===""?"selected":""}>‚Äî</option>
              <option value="Fait" ${m.declaration==="Fait"?"selected":""}>Fait</option>
              <option value="Partiel" ${m.declaration==="Partiel"?"selected":""}>Partiel</option>
              <option value="Non fait" ${m.declaration==="Non fait"?"selected":""}>Non fait</option>
            </select>
          </div>
          <div class="justifRow"
     data-mid="${esc(m.mission_id)}"
     style="display:none;margin-top:8px;width:100%;">
  <input type="text"
         class="justifInp"
         data-mid="${esc(m.mission_id)}"
         placeholder="Justificatif obligatoire si Partiel / Non fait"
         value="${esc(m.justificatif||"")}" />
</div>
          </div>
        </div>
      </div>
    </div>
  `).join("");
  box.querySelectorAll(".decSel").forEach(onAgentDeclarationChange);
}

  function renderAgentTeam(group, responsable){
  const box = $("boxAgentsTeam");
  const list = $("agentsTeamList");
  const resp = $("agentsResponsable");

  if(!box || !list || !resp) return;

 const g = Array.isArray(group) ? [...group] : [];

g.sort((a, b) =>
  (a.nom || a.name || "").localeCompare(
    (b.nom || b.name || ""),
    "fr",
    { sensitivity: "base" }
  )
);


  if(!g.length){
    box.style.display = "none";
    list.innerHTML = "";
    resp.textContent = "";
    resp.className = "status";
    return;
  }

  box.style.display = "";
  list.innerHTML = g.map(a => `<div class="checkRow"><div class="title">${esc(a.nom || a.name || "")}</div></div>`).join("");

  if (responsable && (responsable.nom || responsable.name)) {
  resp.innerHTML = `
    <div>Responsable</div>
    <div>${esc(responsable.nom || responsable.name)}</div>
  `;
  resp.className = "status ok";
} else {
  resp.innerHTML = `<div>Responsable</div>`;
  resp.className = "status";
}
}

 function onAgentDeclarationChange(sel){
  // couleur selon la valeur
  if(sel.value === "Fait"){
    sel.style.background = "rgba(31,211,107,.25)";
    sel.style.borderColor = "rgba(31,211,107,.6)";
    sel.style.color = "#bdf6d2";
  } else if(sel.value === "Partiel"){
    sel.style.background = "rgba(255,192,0,.25)";
    sel.style.borderColor = "rgba(255,192,0,.7)";
    sel.style.color = "#ffe9a6";
  } else if(sel.value === "Non fait"){
    sel.style.background = "rgba(255,59,48,.22)";
    sel.style.borderColor = "rgba(255,59,48,.6)";
    sel.style.color = "#ffd0cd";
  } else {
    // valeur vide
    sel.style.background = "";
    sel.style.borderColor = "";
    sel.style.color = "";
  }

  // logique existante justificatif
  const mid = sel.dataset.mid;
  const row = document.querySelector(`.justifRow[data-mid="${mid}"]`);
  if(!row) return;

  if(sel.value === "Partiel" || sel.value === "Non fait"){
    row.style.display = "block";
  } else {
    row.style.display = "none";
    const input = row.querySelector("input");
    if(input) input.value = "";
  }
}


async function softRefresh(ev){
  const btn = ev?.target || document.getElementById("btnRefresh");
  if(btn) setLoading(btn,true);

  // on m√©morise l‚Äôonglet affich√© pour ne pas ‚Äúrevenir au d√©but‚Äù
  const isAdminsView = document.getElementById("viewAdmins")?.style.display !== "none";

  // on m√©morise les s√©lections actuelles
  const keep = {
    agentSel: document.getElementById("agentsSel")?.value || "",
    agentsPeriodSel: document.getElementById("agentsPeriodsSel")?.value || "",
    adminsPeriodSel: document.getElementById("adminsPeriodsSel")?.value || ""
  };

  try{
    // 1) Recharger les listes globales (agents publics + p√©riodes)
    await bootstrap();

    // restaurer s√©lections si encore valides
    if(keep.agentSel) document.getElementById("agentsSel").value = keep.agentSel;
    if(keep.agentsPeriodSel) document.getElementById("agentsPeriodsSel").value = keep.agentsPeriodSel;
    if(keep.adminsPeriodSel) document.getElementById("adminsPeriodsSel").value = keep.adminsPeriodSel;

    // 2) Admin connect√© -> refresh admin
    if(STATE?.admins?.ok){
      // rafra√Æchir listes
      await adminsListAgents();
      await adminsListMissions();
      await adminsListPeriods();

      // si une p√©riode est d√©j√† charg√©e, on recharge le groupe (sans toucher missions actives/retours)
      if(STATE.current?.period_id){
        await adminsLoadPeriod({ target: document.getElementById("btnAdminsLoadPeriod") });
      }
    }

    // 3) Agent connect√© -> refresh agent
    if(STATE?.agents?.ok){
      // si une p√©riode agent est charg√©e, on recharge les missions de la p√©riode
      if(STATE.agentWork?.period_id){
        // remet le select sur la p√©riode courante, puis recharge
        const sel = document.getElementById("agentsPeriodsSel");
        if(sel) sel.value = STATE.agentWork.period_id;
        await agentsLoadPeriod({ target: document.getElementById("btnAgentsLoad") });
      }
    }

    // on restaure l‚Äôonglet affich√© (sans reset)
    if(isAdminsView) showView("admins"); else showView("agents");

    // petit feedback simple
    // (si tu veux pas de toast global, tu peux supprimer ces 2 lignes)
    if(STATE?.admins?.ok) showToast("toastAdminsLogin", "Rafra√Æchi ‚úÖ", true);
    if(STATE?.agents?.ok) showToast("toastAgentsLogin", "Rafra√Æchi ‚úÖ", true);

  }catch(e){
    // feedback minimal
    if(STATE?.admins?.ok) showToast("toastAdminsLogin", "Erreur refresh.", false);
    if(STATE?.agents?.ok) showToast("toastAgentsLogin", "Erreur refresh.", false);
  }finally{
    if(btn) setLoading(btn,false);
  }
}

  
async function agentsSave(ev){
  hideToast("toastAgentsSave");
  if(!STATE.agents.ok){ showToast("toastAgentsSave","Non connect√©.",false); return; }
  const btn = ev?.target || $("btnAgentsSave");
  const period_id = STATE.agentWork.period_id;
  if(!period_id){ showToast("toastAgentsSave","Charge une p√©riode.",false); return; }

  // collecte d√©clarations
  const decs = Array.from($("boxAgentsMissions").querySelectorAll(".decSel")).map(sel=>{
    const mid = sel.getAttribute("data-mid");
    const just = $("boxAgentsMissions").querySelector(`.justifInp[data-mid="${CSS.escape(mid)}"]`);
    return {
      mission_id: mid,
      declaration: sel.value,
      justificatif: just ? just.value.trim() : ""
    };
  });
   // ‚õî Interdire l'enregistrement si toutes les missions ne sont pas renseign√©es
if (decs.some(d => !d.declaration)) {
  showToast("toastAgentsSave", "Tu dois renseigner toutes les missions avant d‚Äôenregistrer.", false);
  return;
}

  for (const d of decs) {
  if ((d.declaration === "Partiel" || d.declaration === "Non fait") && !d.justificatif) {
    showToast("toastAgentsSave", "Justificatif obligatoire si Partiel / Non fait.", false);
    return;
  }
}

  const remark = $("agentsRemark").value.trim();

  // (on l‚Äôaffiche apr√®s succ√®s seulement)

  setLoading(btn,true);
  try{
    const res = await apiCall("agentSaveDeclarations", {
      agent_id: STATE.agents.agent_id,
      period_id,
      remark,
      items: JSON.stringify(decs)
    });
    if(!res || !res.ok){
      showToast("toastAgentsSave",(res&&res.message)||"Erreur",false);
      return;
    }
    showToast("toastAgentsSave","Enregistr√© ‚úÖ",true);
  
  }catch(_){
    showToast("toastAgentsSave","Erreur r√©seau.",false);
  }finally{
    setLoading(btn,false);
  }
}
async function agentsValidate(ev){
  hideToast("toastAgentsSave"); // on r√©utilise le toast du bloc missions
  if(!STATE.agents.ok){ showToast("toastAgentsSave","Non connect√©.",false); return; }

  if(!confirm("Confirmer la validation ?\n\n‚ö†Ô∏è Apr√®s validation, la saisie sera verrouill√©e et ne pourra plus √™tre modifi√©e.")){
  return;
}
  const btn = ev?.target || $("btnAgentsValidate");
  const period_id = STATE.agentWork.period_id;
  if(!period_id){ showToast("toastAgentsSave","Charge une p√©riode.",false); return; }

  // 1) V√©rif locale : toutes les missions doivent √™tre remplies
  const decs = Array.from($("boxAgentsMissions").querySelectorAll(".decSel")).map(sel=>{
    const mid = sel.getAttribute("data-mid");
    const just = $("boxAgentsMissions").querySelector(`.justifInp[data-mid="${CSS.escape(mid)}"]`);
    return {
      mission_id: mid,
      declaration: sel.value,
      justificatif: just ? just.value.trim() : ""
    };
  });

  if(!decs.length){
    showToast("toastAgentsSave","Aucune mission √† valider.",false);
    return;
  }

  for(const d of decs){
    if(!d.declaration){
      showToast("toastAgentsSave","Tu dois renseigner toutes les missions avant de valider.",false);
      return;
    }
    if((d.declaration==="Partiel" || d.declaration==="Non fait") && !d.justificatif){
      showToast("toastAgentsSave","Justificatif obligatoire si Partiel / Non fait.",false);
      return;
    }
  }

  // 2) On enregistre d‚Äôabord (pour √™tre s√ªr que tout est bien stock√©)
  // -> on appelle ta fonction existante agentsSave(ev)
  await agentsSave({ target: $("btnAgentsSave") });

  // 3) Puis on demande le verrouillage au serveur
  setLoading(btn,true);
  try{
    const res = await apiCall("agentValidatePeriod", {
      agent_id: STATE.agents.agent_id,
      period_id
    });

    if(!res || !res.ok){
      showToast("toastAgentsSave",(res&&res.message)||"Erreur validation",false);
      return;
    }

    showToast("toastAgentsSave","‚úÖ Valid√© ‚Äî saisie verrouill√©e",true);
    // üéâ Overlay uniquement √† la validation si tout est "Fait"
const allDone =
  decs.length > 0 &&
  decs.every(d => String(d.declaration || "").trim() === "Fait");

if (allDone) {
  $("doneOverlay").classList.add("show");
}

    // 4) UI en lecture seule
    // d√©sactive tous les selects + champs justificatif + remarque + boutons
    $("boxAgentsMissions").querySelectorAll("select, input").forEach(el=> el.disabled = true);
    $("agentsRemark").disabled = true;
    $("btnAgentsSave").disabled = true;
    $("btnAgentsValidate").disabled = true;

  }catch(e){
    showToast("toastAgentsSave","Erreur r√©seau.",false);
  }finally{
    setLoading(btn,false);
  }
}

/* double click / double tap pour fermer l‚Äôimage */
$("doneImg").addEventListener("dblclick", ()=> $("doneOverlay").classList.remove("show"));
$("doneImg").addEventListener("touchend", (e)=>{
  const now = Date.now();
  if(!window.__lastTap){ window.__lastTap = now; return; }
  if(now - window.__lastTap < 350){
    $("doneOverlay").classList.remove("show");
  }
  window.__lastTap = now;
});

/* ===============================
   EVENTS INIT
   =============================== */
(function init(){
  showView("agents");
  setPill("pillAdminsStatus","Admin : non connect√©","bad");
  setPill("pillAgentsStatus","Agent : non connect√©","bad");
  bootstrap();
})();

  function togglePassword(inputId, btn){
  const input = document.getElementById(inputId);
  if(!input) return;

  if(input.type === "password"){
    input.type = "text";
    btn.textContent = "üôà";
  } else {
    input.type = "password";
    btn.textContent = "üëÅÔ∏è";
  }
}
</script>
</body>
</html>


‚ÄÉ
