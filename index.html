<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Entretien CS Consenvoye</title>

  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1724; --panel2:#111b2b;
      --stroke:rgba(255,255,255,.12);
      --text:#e8eef9; --muted:rgba(232,238,249,.72);
      --accent:#ff7a00; --accent2:#ffb000;
      --danger:#ff3b30; --ok:#1fd36b;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --r:18px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial, "Noto Sans", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:var(--font);color:var(--text);
      background:
        radial-gradient(900px 420px at 20% 20%, rgba(255,122,0,.18), transparent 65%),
        radial-gradient(900px 420px at 80% 10%, rgba(255,176,0,.12), transparent 60%),
        linear-gradient(180deg, #06080b, var(--bg));
      min-height:100vh;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px 14px 46px}
    h1{margin:0;font-size:30px;font-weight:950;letter-spacing:.2px;color:#ff8d1a;text-shadow:0 2px 14px rgba(255,122,0,.18);text-align:center;}
    .subtitle{margin:6px 0 0;color:var(--muted);font-size:12px;text-align:center}

    .tabsCenter{margin:14px 0 18px;display:flex;justify-content:center;}
    .tabs{
      display:flex;gap:8px;align-items:center;border:1px solid var(--stroke);
      background:rgba(255,255,255,.02);padding:6px;border-radius:999px;box-shadow:var(--shadow);
    }
    .tab{border:0;background:transparent;color:var(--muted);padding:10px 14px;border-radius:999px;cursor:pointer;font-weight:950;font-size:13px;}
    .tab.active{background:linear-gradient(90deg, rgba(255,122,0,.26), rgba(255,176,0,.18));color:var(--text);}

    .btn{
      appearance:none;border:1px solid var(--stroke);background:rgba(255,255,255,.03);color:var(--text);
      border-radius:999px;padding:10px 14px;cursor:pointer;font-weight:950;font-size:13px;
      transition:.15s transform ease,.15s background ease,.15s border-color ease;white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.2);background:rgba(255,255,255,.06)}
    .btn.primary{
      background:linear-gradient(90deg, var(--accent), var(--accent2));
      border-color:transparent;color:#0b0f14;box-shadow:0 12px 26px rgba(255,122,0,.18);
    }
    /* ‚úÖ Demande: boutons jaunes ‚Üí verts pendant chargement */
    .btn.primary.loading{
      background:linear-gradient(90deg, var(--ok), #7dff9c) !important;
      color:#0b0f14 !important;
      border-color:transparent !important;
      box-shadow:0 12px 26px rgba(31,211,107,.18) !important;
      cursor:wait !important;
    }
    .btn.loading::after{content:" ‚è≥";font-weight:950}
    .btn[disabled]{opacity:.7;cursor:not-allowed}

    .btn.danger{background:rgba(255,59,48,.14);border-color:rgba(255,59,48,.35);color:#ffd0cd}
    .btn.small{padding:8px 12px;font-size:12px}

    .card{
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border-radius:var(--r);padding:16px;box-shadow:var(--shadow);
    }
    .headRow{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;flex-wrap:wrap}
    .h2{margin:0;font-size:15px;font-weight:950}
    .status{
      font-size:12px;font-weight:950;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.02);color:var(--muted);display:inline-flex;align-items:center;gap:8px;white-space:nowrap;
    }
    .status.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.10);color:#bdf6d2}
    .status.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.10);color:#ffd0cd}

    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
    input, select, textarea{
      width:100%;padding:11px 12px;border-radius:12px;border:1px solid var(--stroke);
      background:rgba(0,0,0,.25);color:var(--text);outline:none;font-size:14px;
    }
    textarea{min-height:90px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .row > *{flex:1;min-width:220px}
    .divider{height:1px;background:rgba(255,255,255,.09);margin:14px 0}

    .twoColBlock{display:grid;gap:12px}
    @media(min-width:1000px){ .twoColBlock{grid-template-columns: 1fr 1.2fr;} }

    .toast{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);background:rgba(255,255,255,.02);color:var(--muted);font-size:13px;display:none}
    .toast.show{display:block}
    .toast.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.08);color:#c9f9db}
    .toast.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.08);color:#ffd0cd}

    .scrollBox{max-height:280px;overflow:auto;border-radius:14px;border:1px solid var(--stroke);background:rgba(0,0,0,.18)}
    .itemRow{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08)}
    .itemRow:last-child{border-bottom:0}

    .tag{font-size:12px;font-weight:950;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.02)}
    .tag.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.10);color:#bdf6d2}
    .tag.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.10);color:#ffd0cd}
    .muted{color:var(--muted)}
    .grid2{display:grid;gap:10px}
    @media(min-width:900px){ .grid2{grid-template-columns:1fr 1fr} }

    /* Mobile */
    @media(max-width:700px){
      .wrap{max-width:none;width:100%;padding:12px}
      .row > *{min-width:100%}
      input,select,textarea,button,.btn{width:100%;min-height:44px;font-size:16px}
      .tabs{width:100%;justify-content:space-between}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Entretien du centre de secours de Consenvoye</h1>
    <div class="subtitle">Interface compl√®te (mode local) ‚Ä¢ API plus tard</div>

    <!-- ‚úÖ Agent / Admin dans le bon ordre -->
    <div class="tabsCenter">
      <div class="tabs">
        <button class="tab active" id="tabAgent" onclick="UI.show('agent')">üßë‚Äçüöí Agent</button>
        <button class="tab" id="tabAdmin" onclick="UI.show('admin')">üõ°Ô∏è Admin</button>
        <button class="btn" onclick="APP.resetDemo()">Recharger</button>
      </div>
    </div>

    <!-- ================= AGENT ================= -->
    <div id="viewAgent" class="card">
      <div class="headRow">
        <div class="h2">Connexion agent</div>
        <div class="status" id="agentStatus">Agent : non connect√©</div>
      </div>

      <div class="row">
        <div>
          <label>Agent</label>
          <select id="agentSel"></select>
        </div>
        <div>
          <label>Code</label>
          <input id="agentCode" placeholder="Code agent" />
        </div>
        <div>
          <button class="btn primary" id="btnAgentLogin" onclick="AGENT.login(event)">Se connecter</button>
        </div>
      </div>

      <div id="agentToast" class="toast"></div>

      <!-- üîí Changement obligatoire -->
      <div id="forcePw" class="toast bad" style="display:none">
        <b>Changement de code obligatoire</b><br>
        Premier acc√®s / reset d√©tect√© : tu dois d√©finir un nouveau code.
        <div class="divider"></div>
        <div class="row">
          <div>
            <label>Ancien code</label>
            <input id="oldAgentCode" placeholder="0000" />
          </div>
          <div>
            <label>Nouveau code (min 4 chiffres)</label>
            <input id="newAgentCode2" placeholder="1234" />
          </div>
          <div>
            <label>Confirmer</label>
            <input id="newAgentCode3" placeholder="1234" />
          </div>
          <div>
            <button class="btn primary" id="btnAgentChangePw" onclick="AGENT.changeCode(event)">Changer</button>
          </div>
        </div>
      </div>

      <div id="agentArea" style="display:none;margin-top:14px;">
        <div class="divider"></div>

        <div class="grid2">
          <div class="card">
            <div class="headRow">
              <div class="h2">P√©riode</div>
              <div class="status" id="agentPeriodPill">‚Äî</div>
            </div>
            <label>P√©riode (o√π tu es affect√©)</label>
            <select id="agentPeriodSel"></select>
            <div style="margin-top:10px">
              <button class="btn primary" id="btnAgentLoad" onclick="AGENT.loadMissions(event)">Charger</button>
            </div>
          </div>

          <div class="card">
            <div class="headRow">
              <div class="h2">Responsable</div>
              <div class="status" id="agentRespPill">‚Äî</div>
            </div>
            <div class="muted">Affich√© quand la p√©riode est charg√©e.</div>
            <div class="divider"></div>
            <div class="muted" style="font-size:13px">
              R√®gle : si une mission est <b>Partiel</b> ou <b>Non fait</b>, un justificatif est obligatoire.
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="card">
          <div class="headRow">
            <div class="h2">Missions du mois</div>
            <div class="status" id="agentSavePill">‚Äî</div>
          </div>

          <!-- ‚úÖ Zone ‚Äútout est accompli‚Äù -->
          <div id="allDoneBox" class="toast ok" style="display:none">
            <b id="allDoneText">Toutes les missions sont accomplies ‚úÖ</b>
            <div id="allDoneImgWrap" style="margin-top:10px;display:none">
              <img id="allDoneImg" alt="Bravo" style="width:100%;border-radius:14px;border:1px solid var(--stroke)" />
            </div>
          </div>

          <div id="agentMissionsBox" class="scrollBox">
            <div class="itemRow"><span class="muted">Choisis une p√©riode puis ‚ÄúCharger‚Äù.</span></div>
          </div>

          <div style="margin-top:10px" class="row">
            <div class="muted" style="align-self:center">Enregistrer uniquement tes changements.</div>
            <div>
              <button class="btn primary" id="btnAgentSave" onclick="AGENT.save(event)">Enregistrer</button>
            </div>
          </div>

          <div id="agentSaveToast" class="toast"></div>
        </div>
      </div>
    </div>

    <!-- ================= ADMIN ================= -->
    <div id="viewAdmin" class="card" style="display:none">
      <div class="headRow">
        <div class="h2">Connexion admin</div>
        <div class="status" id="adminStatus">Admin : non connect√©</div>
      </div>

      <div class="row">
        <div>
          <label>Code admin</label>
          <input id="adminCode" type="password" placeholder="Code admin" />
        </div>
        <div>
          <button class="btn primary" id="btnAdminLogin" onclick="ADMIN.login(event)">Se connecter</button>
        </div>
      </div>
      <div id="adminToast" class="toast"></div>

      <div id="adminArea" style="display:none;margin-top:14px;">
        <div class="divider"></div>

        <div class="card">
          <div class="headRow"><div class="h2">Changer le code admin</div></div>
          <div class="row">
            <div>
              <label>Ancien code</label>
              <input id="oldAdminCode" type="password" placeholder="ancien code" />
            </div>
            <div>
              <label>Nouveau code</label>
              <input id="newAdminCode" type="password" placeholder="nouveau code (min 4)" />
            </div>
            <div>
              <button class="btn primary" onclick="ADMIN.changeCode(event)">Changer</button>
            </div>
          </div>
          <div id="adminCodeToast" class="toast"></div>
        </div>

        <div class="divider"></div>

        <div class="twoColBlock">
          <div class="card">
            <div class="headRow"><div class="h2">üë• Agents</div><div class="status ok">Local</div></div>

            <div class="row">
              <div>
                <label>Nom Pr√©nom</label>
                <input id="newAgentName" placeholder="Ex : V√©nante Pierre" />
              </div>
              <div>
                <label>Code</label>
                <input id="newAgentCode" value="0000" />
              </div>
              <div>
                <button class="btn primary" onclick="ADMIN.addAgent(event)">Ajouter</button>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>Reset code (0000)</label>
                <select id="resetAgentSel"></select>
              </div>
              <div>
                <button class="btn primary" onclick="ADMIN.resetAgent(event)">Reset 0000</button>
              </div>
            </div>

            <div id="adminAgentsToast" class="toast"></div>
          </div>

          <div class="card">
            <div class="headRow"><div class="h2">Liste agents</div></div>
            <div id="adminAgentsList" class="scrollBox"></div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="twoColBlock">
          <div class="card">
            <div class="headRow"><div class="h2">üìö Catalogue missions</div></div>
            <label>Libell√©</label>
            <input id="newMissionLib" placeholder="Ex : Nettoyage communs" />
            <div style="margin-top:10px">
              <button class="btn primary" onclick="ADMIN.addMission(event)">Ajouter</button>
            </div>
            <div id="adminMissionsToast" class="toast"></div>
          </div>

          <div class="card">
            <div class="headRow"><div class="h2">Liste missions</div></div>
            <div id="adminMissionsList" class="scrollBox"></div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="twoColBlock">
          <div class="card">
            <div class="headRow"><div class="h2">üß© Groupe par p√©riode</div><div class="status" id="adminRespPill">Responsable : ‚Äî</div></div>
            <div class="row">
              <div>
                <label>P√©riode</label>
                <select id="periodeSel"></select>
              </div>
              <div>
                <button class="btn primary" onclick="ADMIN.loadPeriod(event)">Charger groupe</button>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>Ajouter au groupe</label>
                <select id="addToGroupSel"></select>
              </div>
              <div>
                <button class="btn primary" onclick="ADMIN.addToGroup(event)">Ajouter</button>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>D√©finir responsable</label>
                <select id="responsableSel"></select>
              </div>
              <div>
                <button class="btn primary" onclick="ADMIN.setResponsable(event)">D√©finir</button>
              </div>
            </div>

            <div id="adminGroupToast" class="toast"></div>
          </div>

          <div class="card">
            <div class="headRow"><div class="h2">Agents du groupe</div></div>
            <div id="adminGroupList" class="scrollBox"></div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="twoColBlock">
          <div class="card">
            <div class="headRow"><div class="h2">Missions du mois (actives)</div></div>
            <div class="row">
              <div class="muted" style="align-self:center">Active/d√©sactive les missions pour la p√©riode.</div>
              <div><button class="btn primary" onclick="ADMIN.loadMonthMissions(event)">Charger</button></div>
            </div>

            <div id="adminMonthBox" class="scrollBox" style="margin-top:10px"></div>

            <div style="margin-top:10px">
              <button class="btn primary" onclick="ADMIN.saveMonthMissions(event)">Enregistrer</button>
            </div>
            <div id="adminMonthToast" class="toast"></div>
          </div>

          <div class="card">
            <div class="headRow"><div class="h2">Missions actives (r√©sum√©)</div></div>
            <div id="adminMonthActiveList" class="scrollBox"></div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="card">
          <div class="headRow"><div class="h2">üìå Retours (Partiel / Non fait)</div></div>
          <div class="row">
            <div class="muted" style="align-self:center">Affich√© pour la p√©riode s√©lectionn√©e.</div>
            <div><button class="btn primary" onclick="ADMIN.loadRetours(event)">Charger</button></div>
          </div>
          <div id="adminRetoursList" class="scrollBox" style="margin-top:10px"></div>
          <div id="adminRetoursToast" class="toast"></div>
        </div>

      </div>
    </div>
  </div>

<script>
  // ===== CONFIG ‚ÄúTout accompli‚Äù (tu me donneras texte+image plus tard) =====
  const ALL_DONE_TEXT = "Toutes les missions sont accomplies ‚úÖ";
  const ALL_DONE_IMAGE_URL = ""; // <- mets une URL d‚Äôimage plus tard si tu veux

  // ===== Helpers UI =====
  const UI = {
    toast(id, msg, ok){
      const el = document.getElementById(id);
      if(!el) return;
      if(!msg){ el.className="toast"; el.textContent=""; return; }
      el.className = "toast show " + (ok ? "ok":"bad");
      el.textContent = msg || "";
    },
    clearToast(id){
      const el = document.getElementById(id);
      if(!el) return;
      el.className = "toast";
      el.textContent = "";
    },
    status(id, ok, txt){
      const el = document.getElementById(id);
      el.textContent = txt;
      el.className = "status " + (ok ? "ok":"bad");
    },
    show(which){
      document.getElementById("tabAgent").classList.toggle("active", which==="agent");
      document.getElementById("tabAdmin").classList.toggle("active", which==="admin");
      document.getElementById("viewAgent").style.display = (which==="agent") ? "" : "none";
      document.getElementById("viewAdmin").style.display = (which==="admin") ? "" : "none";
    }
  };

  // ===== Boutons loading (vert tant que √ßa charge) =====
  function setLoading(btn, on){
    if(!btn) return;
    btn.classList.toggle("loading", !!on);
    btn.disabled = !!on;
  }
  function withLoading(btn, fn){
    setLoading(btn, true);
    const done = ()=>setLoading(btn,false);
    try{
      const r = fn(done);
      // si la fonction renvoie une Promise, on g√®re automatiquement
      if(r && typeof r.then === "function"){
        r.finally(done);
      }
    }catch(e){
      done();
      throw e;
    }
  }

  // ===== Donn√©es DEMO (local) =====
  const LS_KEY = "cs_entretien_full_local_v1";
  const DEMO = {
    adminCode: "1234",
    agents: [
      { agent_id:"A-3476b9ab", nom:"V√©nante Pierre", code:"0000", actif:true },
      { agent_id:"A-6c290cae", nom:"Laleuuw Franck", code:"0000", actif:true },
      { agent_id:"A-7a8a4f8d", nom:"Bamm√© Melody", code:"0000", actif:true },
      { agent_id:"A-2c37da4d", nom:"V√©nante Am√©lie", code:"0000", actif:true },
      { agent_id:"A-46f9df6d", nom:"Michel Marianne", code:"0000", actif:true },
      { agent_id:"A-253f2ed1", nom:"S√©n√©chal Benjar", code:"0000", actif:true },
    ],
    missionsCatalog: [
      { mission_id:"M-1", libelle:"Boire un coup", actif:true },
      { mission_id:"M-2", libelle:"Laver vitres", actif:true },
      { mission_id:"M-3", libelle:"Nettoyage communs", actif:true },
      { mission_id:"M-4", libelle:"Pression v√©hicules", actif:true },
      { mission_id:"M-5", libelle:"Rangement mat√©riel", actif:true },
    ],
    periodes: [
      { period_id:"2026-01", libelle:"Janvier 2026" },
      { period_id:"2026-02", libelle:"F√©vrier 2026" },
      { period_id:"2026-03", libelle:"Mars 2026" },
    ],
    groupByPeriod: {
      "2026-01": { group:["A-3476b9ab","A-6c290cae","A-7a8a4f8d"], responsable:"A-3476b9ab" },
      "2026-02": { group:["A-3476b9ab","A-2c37da4d"], responsable:"A-2c37da4d" },
      "2026-03": { group:["A-46f9df6d"], responsable:"A-46f9df6d" },
    },
    monthMissionsOn: { // actifs par p√©riode
      "2026-01": ["M-1","M-2","M-3"],
      "2026-02": ["M-2","M-4"],
      "2026-03": ["M-3","M-5"],
    },
    declarations: { // period -> agent -> mission -> {declaration, justificatif}
      "2026-01": {
        "A-3476b9ab": {
          "M-1": {declaration:"Fait", justificatif:""},
          "M-2": {declaration:"Partiel", justificatif:"Manque produit"},
          "M-3": {declaration:"", justificatif:""}
        }
      }
    }
  };

  const APP = {
    data:null,
    load(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        this.data = raw ? JSON.parse(raw) : structuredClone(DEMO);
      }catch(_){
        this.data = structuredClone(DEMO);
      }
    },
    save(){
      localStorage.setItem(LS_KEY, JSON.stringify(this.data));
    },
    resetDemo(){
      if(!confirm("Recharger la d√©mo (remise √† z√©ro) ?")) return;
      this.data = structuredClone(DEMO);
      this.save();
      location.reload();
    }
  };

  // ===== ADMIN =====
  const ADMIN = {
    ok:false,
    pid:"",
    login(evt){
      const btn = evt?.target;
      withLoading(btn, (done)=>{
        UI.clearToast("adminToast");
        const code = (document.getElementById("adminCode").value||"").trim();
        if(!code){ UI.toast("adminToast","Code requis.", false); done(); return; }
        if(code !== APP.data.adminCode){
          this.ok=false;
          UI.status("adminStatus", false, "Admin : non connect√©");
          UI.toast("adminToast","Code incorrect.", false);
          document.getElementById("adminArea").style.display="none";
          done(); return;
        }
        this.ok=true;
        UI.status("adminStatus", true, "Admin : connect√©");
        UI.toast("adminToast","Connect√© ‚úÖ", true);
        document.getElementById("adminArea").style.display="";
        this.renderAll();
        done();
      });
    },
    changeCode(evt){
      const btn = evt?.target;
      withLoading(btn, (done)=>{
        if(!this.ok){ done(); return; }
        const oldC = (document.getElementById("oldAdminCode").value||"").trim();
        const newC = (document.getElementById("newAdminCode").value||"").trim();
        if(oldC !== APP.data.adminCode){ UI.toast("adminCodeToast","Ancien code incorrect.", false); done(); return; }
        if(newC.length < 4){ UI.toast("adminCodeToast","Nouveau code trop court (min 4).", false); done(); return; }
        APP.data.adminCode = newC;
        APP.save();
        document.getElementById("oldAdminCode").value="";
        document.getElementById("newAdminCode").value="";
        UI.toast("adminCodeToast","Code admin chang√© ‚úÖ", true);
        done();
      });
    },
    renderAll(){
      this.renderAgents();
      this.renderMissions();
      this.refreshAgentSelects();
      this.renderPeriodDependent();
    },
    refreshAgentSelects(){
      const active = APP.data.agents.filter(a=>a.actif);
      document.getElementById("resetAgentSel").innerHTML =
        `<option value="">‚Äî Choisir agent ‚Äî</option>` + active.map(a=>`<option value="${a.agent_id}">${a.nom}</option>`).join("");
      document.getElementById("addToGroupSel").innerHTML =
        `<option value="">‚Äî Choisir agent ‚Äî</option>` + active.map(a=>`<option value="${a.agent_id}">${a.nom}</option>`).join("");
    },
    renderAgents(){
      const box = document.getElementById("adminAgentsList");
      const list = APP.data.agents.slice().sort((a,b)=>a.nom.localeCompare(b.nom));
      box.innerHTML = list.map(a=>{
        const badge = a.actif ? `<span class="tag ok">Actif ‚úÖ</span>` : `<span class="tag bad">Inactif ‚ùå</span>`;
        return `
          <div class="itemRow">
            <div>
              <div style="font-weight:950">${a.nom}</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end">
              ${badge}
              <button class="btn small" onclick="ADMIN.toggleAgent('${a.agent_id}')">${a.actif?'D√©sactiver':'Activer'}</button>
              <button class="btn small" onclick="ADMIN.resetAgentCode('${a.agent_id}')">Reset 0000</button>
              <button class="btn small danger" onclick="ADMIN.deleteAgent('${a.agent_id}')">Supprimer</button>
            </div>
          </div>`;
      }).join("");
    },
    addAgent(evt){
      const btn = evt?.target;
      withLoading(btn,(done)=>{
        if(!this.ok){ done(); return; }
        const nom = (document.getElementById("newAgentName").value||"").trim();
        const code = (document.getElementById("newAgentCode").value||"0000").trim() || "0000";
        if(!nom){ UI.toast("adminAgentsToast","Nom requis.", false); done(); return; }
        APP.data.agents.push({ agent_id:"A-"+Math.random().toString(16).slice(2,10), nom, code, actif:true });
        document.getElementById("newAgentName").value="";
        document.getElementById("newAgentCode").value="0000";
        APP.save();
        UI.toast("adminAgentsToast","Agent ajout√© ‚úÖ", true);
        bootstrapUI();
        done();
      });
    },
    resetAgent(evt){
      const btn = evt?.target;
      withLoading(btn,(done)=>{
        if(!this.ok){ done(); return; }
        const id = document.getElementById("resetAgentSel").value;
        if(!id){ UI.toast("adminAgentsToast","Choisis un agent.", false); done(); return; }
        this.resetAgentCode(id);
        done();
      });
    },
    resetAgentCode(id){
      if(!this.ok) return;
      const a = APP.data.agents.find(x=>x.agent_id===id);
      if(!a) return;
      a.code = "0000";
      APP.save();
      UI.toast("adminAgentsToast","Reset ‚úÖ (changement obligatoire √† la prochaine connexion)", true);
    },
    toggleAgent(id){
      if(!this.ok) return;
      const a = APP.data.agents.find(x=>x.agent_id===id);
      if(!a) return;
      a.actif = !a.actif;
      APP.save();
      UI.toast("adminAgentsToast","Statut modifi√© ‚úÖ", true);
      bootstrapUI();
    },
    deleteAgent(id){
      if(!this.ok) return;
      if(!confirm("Supprimer d√©finitivement cet agent ?")) return;
      APP.data.agents = APP.data.agents.filter(x=>x.agent_id!==id);
      APP.save();
      UI.toast("adminAgentsToast","Supprim√© ‚úÖ", true);
      bootstrapUI();
    },

    renderMissions(){
      const box = document.getElementById("adminMissionsList");
      const list = APP.data.missionsCatalog.slice().sort((a,b)=>a.libelle.localeCompare(b.libelle));
      box.innerHTML = list.map(m=>{
        const badge = m.actif ? `<span class="tag ok">Actif ‚úÖ</span>` : `<span class="tag bad">Inactif ‚ùå</span>`;
        return `
          <div class="itemRow">
            <div>
              <div style="font-weight:950">${m.libelle}</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end">
              ${badge}
              <button class="btn small" onclick="ADMIN.toggleMission('${m.mission_id}')">${m.actif?'D√©sactiver':'Activer'}</button>
              <button class="btn small danger" onclick="ADMIN.deleteMission('${m.mission_id}')">Supprimer</button>
            </div>
          </div>`;
      }).join("");
    },
    addMission(evt){
      const btn = evt?.target;
      withLoading(btn,(done)=>{
        if(!this.ok){ done(); return; }
        const lib = (document.getElementById("newMissionLib").value||"").trim();
        if(!lib){ UI.toast("adminMissionsToast","Libell√© requis.", false); done(); return; }
        APP.data.missionsCatalog.push({ mission_id:"M-"+Math.random().toString(16).slice(2,8), libelle:lib, actif:true });
        document.getElementById("newMissionLib").value="";
        APP.save();
        UI.toast("adminMissionsToast","Mission ajout√©e ‚úÖ", true);
        bootstrapUI();
        done();
      });
    },
    toggleMission(id){
      if(!this.ok) return;
      const m = APP.data.missionsCatalog.find(x=>x.mission_id===id);
      if(!m) return;
      m.actif = !m.actif;
      APP.save();
      UI.toast("adminMissionsToast","Statut modifi√© ‚úÖ", true);
      bootstrapUI();
    },
    deleteMission(id){
      if(!this.ok) return;
      if(!confirm("Supprimer d√©finitivement cette mission ?")) return;
      APP.data.missionsCatalog = APP.data.missionsCatalog.filter(x=>x.mission_id!==id);
      Object.keys(APP.data.monthMissionsOn).forEach(pid=>{
        APP.data.monthMissionsOn[pid] = (APP.data.monthMissionsOn[pid]||[]).filter(mid=>mid!==id);
      });
      APP.save();
      UI.toast("adminMissionsToast","Supprim√©e ‚úÖ", true);
      bootstrapUI();
    },

    loadPeriod(evt){
      const btn = evt?.target;
      withLoading(btn,(done)=>{
        if(!this.ok){ done(); return; }
        const pid = document.getElementById("periodeSel").value;
        if(!pid){ UI.toast("adminGroupToast","Choisis une p√©riode.", false); done(); return; }
        this.pid = pid;
        this.renderPeriodDependent();
        UI.toast("adminGroupToast","P√©riode charg√©e ‚úÖ", true);
        done();
      });
    },
    renderPeriodDependent(){
      const pid = this.pid || document.getElementById("periodeSel").value || "";
      const gBox = document.getElementById("adminGroupList");
      const respPill = document.getElementById("adminRespPill");
      const rSel = document.getElementById("responsableSel");

      if(!pid){
        respPill.textContent = "Responsable : ‚Äî";
        gBox.innerHTML = `<div class="itemRow"><span class="muted">Choisis une p√©riode.</span></div>`;
        rSel.innerHTML = `<option value="">‚Äî</option>`;
        document.getElementById("adminMonthBox").innerHTML = `<div class="itemRow"><span class="muted">Choisis une p√©riode.</span></div>`;
        document.getElementById("adminMonthActiveList").innerHTML = `<div class="itemRow"><span class="muted">‚Äî</span></div>`;
        document.getElementById("adminRetoursList").innerHTML = `<div class="itemRow"><span class="muted">‚Äî</span></div>`;
        return;
      }

      const gp = APP.data.groupByPeriod[pid] || { group:[], responsable:null };
      const groupAgents = gp.group.map(aid=>APP.data.agents.find(a=>a.agent_id===aid)).filter(Boolean);
      const respAgent = gp.responsable ? APP.data.agents.find(a=>a.agent_id===gp.responsable) : null;

      respPill.textContent = "Responsable : " + (respAgent ? respAgent.nom : "‚Äî");

      gBox.innerHTML = groupAgents.length
        ? groupAgents.map(a=>`
          <div class="itemRow">
            <div><div style="font-weight:950">${a.nom}</div></div>
            <button class="btn small danger" onclick="ADMIN.removeFromGroup('${a.agent_id}')">Retirer</button>
          </div>`).join("")
        : `<div class="itemRow"><span class="muted">Aucun agent dans le groupe.</span></div>`;

      rSel.innerHTML = `<option value="">‚Äî Choisir responsable ‚Äî</option>` +
        groupAgents.map(a=>`<option value="${a.agent_id}">${a.nom}</option>`).join("");

      this.renderMonthMissions(pid);
      this.renderRetours(pid);
    },
    addToGroup(evt){
      const btn = evt?.target;
      withLoading(btn,(done)=>{
        if(!this.ok){ done(); return; }
        const pid = document.getElementById("periodeSel").value;
        const aid = document.getElementById("addToGroupSel").value;
        if(!pid || !aid){ UI.toast("adminGroupToast","Choisis p√©riode + agent.", false); done(); return; }
        APP.data.groupByPeriod[pid] = APP.data.groupByPeriod[pid] || { group:[], responsable:null };
        const arr = APP.data.groupByPeriod[pid].group;
        if(!arr.includes(aid)) arr.push(aid);
        APP.save();
        this.pid = pid;
        this.renderPeriodDependent();
        UI.toast("adminGroupToast","Agent ajout√© ‚úÖ", true);
        done();
      });
    },
    removeFromGroup(aid){
      if(!this.ok) return;
      const pid = this.pid || document.getElementById("periodeSel").value;
      if(!pid) return;
      const gp = APP.data.groupByPeriod[pid] || { group:[], responsable:null };
      gp.group = gp.group.filter(x=>x!==aid);
      if(gp.responsable===aid) gp.responsable=null;
      APP.data.groupByPeriod[pid]=gp;
      APP.save();
      this.renderPeriodDependent();
      UI.toast("adminGroupToast","Retir√© ‚úÖ", true);
    },
    setResponsable(evt){
      const btn = evt?.target;
      withLoading(btn,(done)=>{
        if(!this.ok){ done(); return; }
        const pid = this.pid || document.getElementById("periodeSel").value;
        const aid = document.getElementById("responsableSel").value;
        if(!pid || !aid){ UI.toast("adminGroupToast","Choisis un responsable.", false); done(); return; }
        APP.data.groupByPeriod[pid] = APP.data.groupByPeriod[pid] || { group:[], responsable:null };
        if(!APP.data.groupByPeriod[pid].group.includes(aid)){
          UI.toast("adminGroupToast","Le responsable doit √™tre dans le groupe.", false);
          done(); return;
        }
        APP.data.groupByPeriod[pid].responsable = aid;
        APP.save();
        this.renderPeriodDependent();
        UI.toast("adminGroupToast","Responsable d√©fini ‚úÖ", true);
        done();
      });
    },

    loadMonthMissions(evt){
      const btn = evt?.target;
      withLoading(btn,(done)=>{
        if(!this.ok){ done(); return; }
        const pid = this.pid || document.getElementById("periodeSel").value;
        if(!pid){ UI.toast("adminMonthToast","Choisis une p√©riode.", false); done(); return; }
        this.renderMonthMissions(pid);
        UI.toast("adminMonthToast","Charg√© ‚úÖ", true);
        done();
      });
    },
    renderMonthMissions(pid){
      const box = document.getElementById("adminMonthBox");
      const activeBox = document.getElementById("adminMonthActiveList");

      const all = APP.data.missionsCatalog.filter(m=>m.actif);
      const on = new Set((APP.data.monthMissionsOn[pid]||[]).map(String));

      if(!all.length){
        box.innerHTML = `<div class="itemRow"><span class="muted">Aucune mission catalogue active.</span></div>`;
        activeBox.innerHTML = `<div class="itemRow"><span class="muted">‚Äî</span></div>`;
        return;
      }

      box.innerHTML = all.map(m=>{
        const checked = on.has(String(m.mission_id)) ? "checked" : "";
        return `
          <label class="itemRow" style="cursor:pointer">
            <div style="display:flex;align-items:center;gap:10px;min-width:0">
              <input type="checkbox" data-mid="${m.mission_id}" ${checked} />
              <div style="font-weight:950;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${m.libelle}</div>
            </div>
          </label>`;
      }).join("");

      const activeIds = (APP.data.monthMissionsOn[pid]||[]);
      activeBox.innerHTML = activeIds.length
        ? activeIds.map(id=>APP.data.missionsCatalog.find(m=>m.mission_id===id)).filter(Boolean).map(m=>`
            <div class="itemRow">
              <div style="font-weight:950">${m.libelle}</div>
              <span class="tag ok">Active</span>
            </div>`).join("")
        : `<div class="itemRow"><span class="muted">Aucune mission active.</span></div>`;
    },
    saveMonthMissions(evt){
      const btn = evt?.target;
      withLoading(btn,(done)=>{
        if(!this.ok){ done(); return; }
        const pid = this.pid || document.getElementById("periodeSel").value;
        if(!pid){ UI.toast("adminMonthToast","Choisis une p√©riode.", false); done(); return; }
        const checks = Array.from(document.querySelectorAll('#adminMonthBox input[type="checkbox"][data-mid]'));
        const ids = checks.filter(c=>c.checked).map(c=>c.getAttribute("data-mid"));
        APP.data.monthMissionsOn[pid] = ids;
        APP.save();
        this.renderMonthMissions(pid);
        UI.toast("adminMonthToast","Enregistr√© ‚úÖ", true);
        done();
      });
    },

    loadRetours(evt){
      const btn = evt?.target;
      withLoading(btn,(done)=>{
        if(!this.ok){ done(); return; }
        const pid = this.pid || document.getElementById("periodeSel").value;
        if(!pid){ UI.toast("adminRetoursToast","Choisis une p√©riode.", false); done(); return; }
        this.renderRetours(pid);
        UI.toast("adminRetoursToast","Charg√© ‚úÖ", true);
        done();
      });
    },
    renderRetours(pid){
      const box = document.getElementById("adminRetoursList");
      const declP = APP.data.declarations[pid] || {};
      const activeIds = new Set((APP.data.monthMissionsOn[pid]||[]).map(String));

      const items = [];
      Object.keys(declP).forEach(aid=>{
        const agent = APP.data.agents.find(a=>a.agent_id===aid);
        const perAgent = declP[aid] || {};
        Object.keys(perAgent).forEach(mid=>{
          if(!activeIds.has(String(mid))) return;
          const d = perAgent[mid] || {};
          if(d.declaration === "Partiel" || d.declaration === "Non fait"){
            const m = APP.data.missionsCatalog.find(x=>x.mission_id===mid);
            items.push({
              agent: agent ? agent.nom : "‚Äî",
              mission: m ? m.libelle : "‚Äî",
              declaration: d.declaration || "",
              justificatif: d.justificatif || ""
            });
          }
        });
      });

      box.innerHTML = items.length
        ? items.map(it=>`
            <div class="itemRow" style="align-items:flex-start">
              <div style="min-width:0">
                <div style="font-weight:950">${it.agent}</div>
                <div class="muted" style="font-size:13px;margin-top:2px">${it.mission}</div>
                <div style="margin-top:8px">
                  <span class="tag ${it.declaration==="Non fait"?"bad":"ok"}">${it.declaration}</span>
                </div>
                <div class="muted" style="font-size:13px;margin-top:8px">
                  Justif : ${it.justificatif ? it.justificatif : "‚Äî"}
                </div>
              </div>
            </div>`).join("")
        : `<div class="itemRow"><span class="muted">Aucun retour (tout est fait).</span></div>`;
    }
  };

  // ===== AGENT =====
  const AGENT = {
    ok:false,
    agent:null,
    pid:"",
    renderAll(){
      // agent periods select depends on group membership
      const pSel = document.getElementById("agentPeriodSel");
      if(!this.ok || !this.agent){
        pSel.innerHTML = `<option value="">‚Äî</option>`;
        document.getElementById("agentMissionsBox").innerHTML = `<div class="itemRow"><span class="muted">Choisis une p√©riode puis ‚ÄúCharger‚Äù.</span></div>`;
        document.getElementById("agentRespPill").textContent = "‚Äî";
        document.getElementById("agentPeriodPill").textContent = "‚Äî";
        return;
      }
      const periods = APP.data.periodes.filter(p=>{
        const gp = APP.data.groupByPeriod[p.period_id];
        return gp && (gp.group||[]).includes(this.agent.agent_id);
      });
      pSel.innerHTML = `<option value="">‚Äî Choisir p√©riode ‚Äî</option>` + periods.map(p=>`<option value="${p.period_id}">${p.libelle}</option>`).join("");
    },
    login(evt){
      const btn = evt?.target;
      withLoading(btn,(done)=>{
        UI.clearToast("agentToast");
        const id = document.getElementById("agentSel").value;
        const code = (document.getElementById("agentCode").value||"").trim();
        if(!id || !code){ UI.toast("agentToast","S√©lection + code requis.", false); done(); return; }

        const a = APP.data.agents.find(x=>x.agent_id===id);
        if(!a || !a.actif){ UI.toast("agentToast","Agent inactif.", false); done(); return; }

        if(code !== String(a.code||"").trim()){
          this.ok=false; this.agent=null;
          UI.status("agentStatus", false, "Agent : non connect√©");
          UI.toast("agentToast","Code incorrect.", false);
          document.getElementById("agentArea").style.display="none";
          document.getElementById("forcePw").style.display="none";
          done(); return;
        }

        // ‚úÖ Obligatoire si code = 0000
        if(code === "0000"){
          this.ok=false; this.agent=a;
          UI.status("agentStatus", false, "Agent : changement obligatoire");
          document.getElementById("forcePw").style.display="block";
          document.getElementById("agentArea").style.display="none";
          UI.toast("agentToast","Change ton code pour continuer.", false);
          done(); return;
        }

        this.ok=true; this.agent=a;
        UI.status("agentStatus", true, "Agent : " + a.nom);
        UI.toast("agentToast","Connect√© ‚úÖ", true);
        document.getElementById("forcePw").style.display="none";
        document.getElementById("agentArea").style.display="";
        this.renderAll();
        done();
      });
    },
    changeCode(evt){
      const btn = evt?.target;
      withLoading(btn,(done)=>{
        const a = this.agent;
        if(!a){ done(); return; }
        const oldC = (document.getElementById("oldAgentCode").value||"").trim();
        const n1 = (document.getElementById("newAgentCode2").value||"").trim();
        const n2 = (document.getElementById("newAgentCode3").value||"").trim();

        if(oldC !== String(a.code||"").trim()){ UI.toast("agentToast","Ancien code incorrect.", false); done(); return; }
        if(n1 !== n2){ UI.toast("agentToast","Confirmation diff√©rente.", false); done(); return; }
        if(!/^\d{4,}$/.test(n1)){ UI.toast("agentToast","Nouveau code = au moins 4 chiffres.", false); done(); return; }
        if(n1 === "0000"){ UI.toast("agentToast","0000 interdit.", false); done(); return; }

        a.code = n1;
        APP.save();
        document.getElementById("oldAgentCode").value="";
        document.getElementById("newAgentCode2").value="";
        document.getElementById("newAgentCode3").value="";
        document.getElementById("forcePw").style.display="none";
        UI.toast("agentToast","Code chang√© ‚úÖ reconnecte-toi.", true);
        UI.status("agentStatus", false, "Agent : non connect√©");
        document.getElementById("agentCode").value="";
        done();
      });
    },
    loadMissions(evt){
      const btn = evt?.target;
      withLoading(btn,(done)=>{
        if(!this.ok || !this.agent){ done(); return; }
        const pid = document.getElementById("agentPeriodSel").value;
        if(!pid){ UI.toast("agentSaveToast","Choisis une p√©riode.", false); done(); return; }
        this.pid = pid;

        const pObj = APP.data.periodes.find(p=>p.period_id===pid);
        document.getElementById("agentPeriodPill").textContent = pObj ? pObj.libelle : pid;

        const gp = APP.data.groupByPeriod[pid] || { group:[], responsable:null };
        const respName = gp.responsable ? (APP.data.agents.find(x=>x.agent_id===gp.responsable)?.nom || "‚Äî") : "‚Äî";
        document.getElementById("agentRespPill").textContent = "Resp : " + respName;

        const active = new Set((APP.data.monthMissionsOn[pid]||[]).map(String));
        const missions = APP.data.missionsCatalog.filter(m=>m.actif && active.has(String(m.mission_id)));

        // ensure decl store
        APP.data.declarations[pid] = APP.data.declarations[pid] || {};
        APP.data.declarations[pid][this.agent.agent_id] = APP.data.declarations[pid][this.agent.agent_id] || {};
        const per = APP.data.declarations[pid][this.agent.agent_id];

        const box = document.getElementById("agentMissionsBox");
        if(!missions.length){
          box.innerHTML = `<div class="itemRow"><span class="muted">Aucune mission attribu√©e.</span></div>`;
          AGENT._updateAllDone(false);
          done(); return;
        }

        box.innerHTML = missions.map(m=>{
          const d = per[m.mission_id] || { declaration:"", justificatif:"" };
          return `
            <div class="itemRow" style="align-items:flex-start">
              <div style="min-width:0;flex:1">
                <div style="font-weight:950">${m.libelle}</div>
                <div class="row" style="margin-top:10px">
                  <div>
                    <label>D√©claration</label>
                    <select data-mid="${m.mission_id}" class="aDec">
                      <option value="" ${d.declaration===""?"selected":""}>‚Äî</option>
                      <option value="Fait" ${d.declaration==="Fait"?"selected":""}>Fait</option>
                      <option value="Partiel" ${d.declaration==="Partiel"?"selected":""}>Partiel</option>
                      <option value="Non fait" ${d.declaration==="Non fait"?"selected":""}>Non fait</option>
                    </select>
                  </div>
                  <div>
                    <label>Justificatif (si Partiel/Non fait)</label>
                    <input data-mid="${m.mission_id}" class="aJust" placeholder="Justificatif"
                           value="${d.justificatif||""}" />
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join("");

        document.getElementById("agentSavePill").textContent = "‚Äî";
        document.getElementById("agentSavePill").className = "status";
        UI.toast("agentSaveToast","Missions charg√©es ‚úÖ", true);

        // check if all done already
        AGENT._updateAllDone(AGENT._areAllDone());
        done();
      });
    },
    save(evt){
      const btn = evt?.target;
      withLoading(btn,(done)=>{
        if(!this.ok || !this.agent || !this.pid){ UI.toast("agentSaveToast","Connecte-toi + charge une p√©riode.", false); done(); return; }
        const pid = this.pid;
        const aid = this.agent.agent_id;

        APP.data.declarations[pid] = APP.data.declarations[pid] || {};
        APP.data.declarations[pid][aid] = APP.data.declarations[pid][aid] || {};
        const per = APP.data.declarations[pid][aid];

        const decs = Array.from(document.querySelectorAll("#agentMissionsBox .aDec"));
        const justs = Array.from(document.querySelectorAll("#agentMissionsBox .aJust"));

        const byMid = {};
        decs.forEach(sel=>{
          const mid = sel.getAttribute("data-mid");
          byMid[mid] = byMid[mid] || {};
          byMid[mid].declaration = sel.value;
        });
        justs.forEach(inp=>{
          const mid = inp.getAttribute("data-mid");
          byMid[mid] = byMid[mid] || {};
          byMid[mid].justificatif = (inp.value||"").trim();
        });

        // validation: justificatif si Partiel/Non fait
        for(const mid of Object.keys(byMid)){
          const d = byMid[mid];
          const need = (d.declaration==="Partiel" || d.declaration==="Non fait");
          if(need && !d.justificatif){
            UI.toast("agentSaveToast","Justificatif obligatoire si Partiel/Non fait.", false);
            document.getElementById("agentSavePill").className="status bad";
            document.getElementById("agentSavePill").textContent="Erreur";
            done(); return;
          }
        }

        Object.keys(byMid).forEach(mid=>{
          per[mid] = { declaration: byMid[mid].declaration || "", justificatif: byMid[mid].justificatif || "" };
        });

        APP.save();

        document.getElementById("agentSavePill").className="status ok";
        document.getElementById("agentSavePill").textContent="Enregistr√© ‚úÖ";
        UI.toast("agentSaveToast","Enregistr√© ‚úÖ", true);

        // check ‚Äúall done‚Äù
        AGENT._updateAllDone(AGENT._areAllDone());

        done();
      });
    },
    _areAllDone(){
      const pid = this.pid;
      if(!pid || !this.agent) return false;
      const active = new Set((APP.data.monthMissionsOn[pid]||[]).map(String));
      const missions = APP.data.missionsCatalog.filter(m=>m.actif && active.has(String(m.mission_id)));
      if(!missions.length) return false;

      const per = (((APP.data.declarations[pid]||{})[this.agent.agent_id])||{});
      // ‚ÄúToutes accomplies‚Äù = toutes d√©clar√©es "Fait"
      return missions.every(m => (per[m.mission_id] && per[m.mission_id].declaration === "Fait"));
    },
    _updateAllDone(allDone){
      const doneBox = document.getElementById("allDoneBox");
      const listBox = document.getElementById("agentMissionsBox");
      const textEl = document.getElementById("allDoneText");
      const imgWrap = document.getElementById("allDoneImgWrap");
      const img = document.getElementById("allDoneImg");

      if(allDone){
        textEl.textContent = ALL_DONE_TEXT;
        doneBox.style.display = "";
        listBox.style.display = "none";

        if(ALL_DONE_IMAGE_URL){
          img.src = ALL_DONE_IMAGE_URL;
          imgWrap.style.display = "";
        }else{
          imgWrap.style.display = "none";
        }
      }else{
        doneBox.style.display = "none";
        listBox.style.display = "";
      }
    }
  };

  function bootstrapUI(){
    // agent list (actifs seulement)
    document.getElementById("agentSel").innerHTML =
      `<option value="">‚Äî Choisir agent ‚Äî</option>` +
      APP.data.agents.filter(a=>a.actif).map(a=>`<option value="${a.agent_id}">${a.nom}</option>`).join("");

    // periods (admin select)
    document.getElementById("periodeSel").innerHTML =
      `<option value="">‚Äî Choisir p√©riode ‚Äî</option>` +
      APP.data.periodes.map(p=>`<option value="${p.period_id}">${p.libelle}</option>`).join("");

    ADMIN.renderAll();
    AGENT.renderAll();
  }

  // init
  APP.load();
  bootstrapUI();
</script>
</body>
</html>
