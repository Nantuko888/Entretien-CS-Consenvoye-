<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Entretien CS Consenvoye</title>

  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1724; --panel2:#111b2b;
      --stroke:rgba(255,255,255,.12);
      --text:#e8eef9; --muted:rgba(232,238,249,.72);
      --accent:#ff7a00; --accent2:#ffb000;
      --danger:#ff3b30; --ok:#1fd36b;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --r:18px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial, "Noto Sans", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:var(--font);color:var(--text);
      background:
        radial-gradient(900px 420px at 20% 20%, rgba(255,122,0,.18), transparent 65%),
        radial-gradient(900px 420px at 80% 10%, rgba(255,176,0,.12), transparent 60%),
        linear-gradient(180deg, #06080b, var(--bg));
      min-height:100vh;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px 14px 46px}
    h1{margin:0;font-size:30px;font-weight:950;letter-spacing:.2px;color:#ff8d1a;text-shadow:0 2px 14px rgba(255,122,0,.18);text-align:center;}
    .subtitle{margin:6px 0 0;color:var(--muted);font-size:12px;text-align:center}
    .tabsCenter{margin:14px 0 18px;display:flex;justify-content:center;}
    .tabs{display:flex;gap:8px;align-items:center;border:1px solid var(--stroke);background:rgba(255,255,255,.02);padding:6px;border-radius:999px;box-shadow:var(--shadow);}
    .tab{border:0;background:transparent;color:var(--muted);padding:10px 14px;border-radius:999px;cursor:pointer;font-weight:950;font-size:13px;}
    .tab.active{background:linear-gradient(90deg, rgba(255,122,0,.26), rgba(255,176,0,.18));color:var(--text);}
    .btn{appearance:none;border:1px solid var(--stroke);background:rgba(255,255,255,.03);color:var(--text);
      border-radius:999px;padding:10px 14px;cursor:pointer;font-weight:950;font-size:13px;
      transition:.15s transform ease,.15s background ease,.15s border-color ease;white-space:nowrap;}
    .btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.2);background:rgba(255,255,255,.06)}
    .btn.primary{background:linear-gradient(90deg, var(--accent), var(--accent2));border-color:transparent;color:#0b0f14;box-shadow:0 12px 26px rgba(255,122,0,.18);}
    .card{border:1px solid var(--stroke);background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));border-radius:var(--r);padding:16px;box-shadow:var(--shadow);}
    .headRow{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;flex-wrap:wrap}
    .h2{margin:0;font-size:15px;font-weight:950}
    .status{font-size:12px;font-weight:950;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.02);color:var(--muted);display:inline-flex;align-items:center;gap:8px;white-space:nowrap;}
    .status.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.10);color:#bdf6d2}
    .status.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.10);color:#ffd0cd}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
    input{width:100%;padding:11px 12px;border-radius:12px;border:1px solid var(--stroke);background:rgba(0,0,0,.25);color:var(--text);outline:none;font-size:16px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .row > *{flex:1;min-width:220px}
    .list{margin-top:12px;display:grid;gap:10px}
    .item{border:1px solid var(--stroke);background:rgba(0,0,0,.18);border-radius:14px;padding:12px;display:flex;justify-content:space-between;gap:12px;align-items:center}
    .item .name{font-weight:950}
    .tag{font-size:12px;font-weight:950;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.02)}
    .tag.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.10);color:#bdf6d2}
    .tag.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.10);color:#ffd0cd}
    .toast{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);background:rgba(255,255,255,.02);color:var(--muted);font-size:13px;display:none}
    .toast.show{display:block}
    .toast.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.08);color:#c9f9db}
    .toast.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.08);color:#ffd0cd}
    @media(max-width:700px){
      .wrap{max-width:none;width:100%;padding:12px}
      .row > *{min-width:100%}
      input,button,.btn{width:100%;min-height:44px;font-size:16px}
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>Entretien CS Consenvoye</h1>
  <div class="subtitle">Version GitHub ‚Ä¢ Import Agents auto ‚Ä¢ (IDs masqu√©s)</div>

  <div class="tabsCenter">
    <div class="tabs">
      <button class="tab active" id="tabAdmin" onclick="UI.show('admin')">üõ°Ô∏è Admin</button>
      <button class="tab" id="tabAgent" onclick="UI.show('agent')">üßë‚Äçüöí Agent</button>
      <button class="btn" onclick="ADMIN.reload()">Recharger</button>
    </div>
  </div>

  <!-- ADMIN -->
  <div id="viewAdmin" class="card">
    <div class="headRow">
      <div class="h2">Connexion admin</div>
      <div class="status" id="adminStatus">Admin : non connect√©</div>
    </div>

    <div id="adminLoginBox">
      <div class="row">
        <div>
          <label>Code admin</label>
          <input id="adminCode" type="password" placeholder="Code admin" />
        </div>
        <div>
          <button class="btn primary" onclick="ADMIN.login()">Se connecter</button>
        </div>
      </div>
      <div id="adminToast" class="toast"></div>
    </div>

    <div id="adminPanel" style="display:none;margin-top:14px;">
      <div class="headRow">
        <div class="h2">Agents</div>
        <div class="status ok">Import auto</div>
      </div>

      <div class="row">
        <div>
          <label>Recherche</label>
          <input id="searchAgents" placeholder="Tape un nom‚Ä¶" oninput="ADMIN.render()" />
        </div>
        <div>
          <button class="btn" onclick="ADMIN.loadAgents()">Charger les agents</button>
        </div>
      </div>

      <div id="agentsBox" class="list"></div>
    </div>
  </div>

  <!-- AGENT (placeholder propre, sans missions) -->
  <div id="viewAgent" class="card" style="display:none">
    <div class="headRow">
      <div class="h2">Espace agent</div>
      <div class="status">√Ä brancher ensuite</div>
    </div>
    <div class="toast show">On branche l‚Äôagent apr√®s. Pour l‚Äôinstant on s√©curise l‚Äôimport auto des agents.</div>
  </div>

</div>

<script>
/* ===================== CONFIG ===================== */
/* üî¥ Mets ici ton URL /exec Apps Script */
const API_EXEC = "COLLE_ICI_TON_URL_EXEC";

/* ===================== JSONP helper ===================== */
function jsonp(params, timeoutMs=6000){
  return new Promise((resolve, reject)=>{
    const cb = "cb_" + Math.random().toString(36).slice(2);
    params.callback = cb;

    let done = false;
    const timer = setTimeout(()=>{
      if(done) return;
      done = true;
      cleanup();
      reject(new Error("timeout"));
    }, timeoutMs);

    function cleanup(){
      clearTimeout(timer);
      try{ delete window[cb]; }catch(_){}
      if(s && s.parentNode) s.parentNode.removeChild(s);
    }

    window[cb] = (data)=>{
      if(done) return;
      done = true;
      cleanup();
      resolve(data);
    };

    const qs = new URLSearchParams(params).toString();
    const s = document.createElement("script");
    s.src = API_EXEC + "?" + qs + "&_=" + Date.now(); // anti-cache
    s.onerror = ()=>{
      if(done) return;
      done = true;
      cleanup();
      reject(new Error("load_error"));
    };

    document.head.appendChild(s);
  });
}

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

const UI = {
  show(which){
    document.getElementById("tabAdmin").classList.toggle("active", which==="admin");
    document.getElementById("tabAgent").classList.toggle("active", which==="agent");
    document.getElementById("viewAdmin").style.display = (which==="admin") ? "" : "none";
    document.getElementById("viewAgent").style.display = (which==="agent") ? "" : "none";
  },
  toast(id, msg, ok){
    const el = document.getElementById(id);
    if(!msg){ el.className="toast"; el.textContent=""; return; }
    el.className = "toast show " + (ok ? "ok":"bad");
    el.textContent = msg;
  },
  status(id, ok, txt){
    const el = document.getElementById(id);
    el.textContent = txt;
    el.className = "status " + (ok ? "ok":"bad");
  }
};

const ADMIN = {
  ok:false,
  code:"",
  agents:[],
  login(){
    const code = (document.getElementById("adminCode").value||"").trim();
    if(!code){ UI.toast("adminToast","Code requis.", false); return; }
    UI.toast("adminToast","Connexion‚Ä¶", true);

    jsonp({ action:"adminLogin", CODE: code })
      .then(res=>{
        if(res && res.ok === true){
          this.ok = true;
          this.code = code;
          UI.status("adminStatus", true, "Admin : connect√©");
          UI.toast("adminToast","Connect√© ‚úÖ", true);
          document.getElementById("adminPanel").style.display = "";
          // auto-load
          this.loadAgents();
        }else{
          this.ok = false; this.code="";
          UI.status("adminStatus", false, "Admin : non connect√©");
          UI.toast("adminToast","Code incorrect.", false);
        }
      })
      .catch(err=>{
        this.ok=false; this.code="";
        UI.status("adminStatus", false, "Admin : non connect√©");
        UI.toast("adminToast","Erreur: "+err.message, false);
      });
  },
  reload(){
    if(!this.ok){ UI.toast("adminToast","Connecte-toi d‚Äôabord.", false); return; }
    this.loadAgents();
  },
  loadAgents(){
    if(!this.ok) return;
    const box = document.getElementById("agentsBox");
    box.innerHTML = `<div class="toast show">Chargement‚Ä¶</div>`;

    jsonp({ action:"listAgents", CODE: this.code })
      .then(res=>{
        if(!res || !res.ok){
          box.innerHTML = `<div class="toast show bad">Erreur chargement agents</div>`;
          return;
        }
        this.agents = res.agents || [];
        this.render();
      })
      .catch(err=>{
        box.innerHTML = `<div class="toast show bad">Erreur: ${escapeHtml(err.message)}</div>`;
      });
  },
  render(){
    const box = document.getElementById("agentsBox");
    const q = (document.getElementById("searchAgents").value||"").trim().toLowerCase();

    let list = this.agents.slice();
    if(q) list = list.filter(a => String(a.nom||"").toLowerCase().includes(q));

    if(!list.length){
      box.innerHTML = `<div class="toast show">Aucun r√©sultat.</div>`;
      return;
    }

    box.innerHTML = list.map(a=>{
      const badge = a.actif
        ? `<span class="tag ok">Actif ‚úÖ</span>`
        : `<span class="tag bad">Inactif ‚ùå</span>`;
      return `
        <div class="item">
          <div>
            <div class="name">${escapeHtml(a.nom)}</div>
            <div class="meta" style="font-size:12px;color:var(--muted);margin-top:2px;">(ID masqu√©)</div>
          </div>
          ${badge}
        </div>
      `;
    }).join("");
  }
};
</script>
</body>
</html>
