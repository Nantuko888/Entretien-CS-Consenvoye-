<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Entretien CS Consenvoye</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1724; --panel2:#111b2b;
      --stroke:rgba(255,255,255,.12);
      --text:#e8eef9; --muted:rgba(232,238,249,.72);
      --accent:#ff7a00; --accent2:#ffb000;
      --danger:#ff3b30; --ok:#1fd36b;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --r:18px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial, "Noto Sans", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:var(--font);color:var(--text);
      background:
        radial-gradient(900px 420px at 20% 20%, rgba(255,122,0,.18), transparent 65%),
        radial-gradient(900px 420px at 80% 10%, rgba(255,176,0,.12), transparent 60%),
        linear-gradient(180deg, #06080b, var(--bg));
      min-height:100vh;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:22px 14px 46px}
    h1{margin:0;font-size:30px;font-weight:900;letter-spacing:.2px;color:#ff8d1a;text-shadow:0 2px 14px rgba(255,122,0,.18);text-align:center;}
    .subtitle{margin:6px 0 0;color:var(--muted);font-size:12px;text-align:center}

    .tabsCenter{margin:14px 0 18px;display:flex;justify-content:center;}
    .tabs{display:flex;gap:8px;align-items:center;border:1px solid var(--stroke);background:rgba(255,255,255,.02);padding:6px;border-radius:999px;box-shadow:var(--shadow);}
    .tab{border:0;background:transparent;color:var(--muted);padding:10px 14px;border-radius:999px;cursor:pointer;font-weight:900;font-size:13px;}
    .tab.active{background:linear-gradient(90deg, rgba(255,122,0,.26), rgba(255,176,0,.18));color:var(--text);}

    .btn{appearance:none;border:1px solid var(--stroke);background:rgba(255,255,255,.03);color:var(--text);
      border-radius:999px;padding:10px 14px;cursor:pointer;font-weight:900;font-size:13px;transition:.15s transform ease,.15s background ease,.15s border-color ease;white-space:nowrap;}
    .btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.2);background:rgba(255,255,255,.06)}
    .btn.primary{background:linear-gradient(90deg, var(--accent), var(--accent2));border-color:transparent;color:#0b0f14;box-shadow:0 12px 26px rgba(255,122,0,.18);}
    .btn.danger{background:rgba(255,59,48,.14);border-color:rgba(255,59,48,.35);color:#ffd0cd}
    .btn.small{padding:8px 12px;font-size:12px}

    /* bouton "loading" -> VERT */
    .btn.loading,.btn.primary.loading{
      background: linear-gradient(90deg, #1fd36b, #7dff9c) !important;
      border-color: transparent !important;
      color:#0b0f14 !important;
      box-shadow: 0 12px 26px rgba(31,211,107,.18) !important;
      cursor: wait !important;
      opacity: .95;
    }
    .btn.loading::after{content:" ‚è≥"; font-weight:900;}
    .btn[disabled]{opacity:.6;cursor:not-allowed;}

    .card{border:1px solid var(--stroke);background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border-radius:var(--r);padding:16px;box-shadow:var(--shadow);}
    .headRow{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;flex-wrap:wrap}
    .h2{margin:0;font-size:15px;font-weight:900}
    .status{font-size:12px;font-weight:900;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.02);color:var(--muted);display:inline-flex;align-items:center;gap:8px;white-space:nowrap;}
    .status.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.10);color:#bdf6d2}
    .status.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.10);color:#ffd0cd}

    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
    input, select, textarea{width:100%;padding:11px 12px;border-radius:12px;border:1px solid var(--stroke);
      background:rgba(0,0,0,.25);color:var(--text);outline:none;font-size:13px;}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .row > *{flex:1;min-width:220px}
    .divider{height:1px;background:rgba(255,255,255,.09);margin:14px 0}

    .twoColBlock{display:grid;gap:12px}
    @media(min-width:1000px){ .twoColBlock{grid-template-columns: 1fr 1.2fr;} }

    /* MOBILE: tout empil√© */
    @media(max-width:900px){ .row > *{min-width:100%} .twoColBlock{grid-template-columns:1fr;} }

    .scrollBox{max-height:260px;overflow:auto;border-radius:14px;border:1px solid var(--stroke);background:rgba(0,0,0,.18)}
    .listItem{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08)}
    .listItem:last-child{border-bottom:0}
    .ghost{color:rgba(232,238,249,.55)}
    .pill{font-size:12px;font-weight:900;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.02);color:var(--muted)}
    .pill.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.10);color:#bdf6d2}
    .pill.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.10);color:#ffd0cd}

    .toast{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);background:rgba(255,255,255,.02);color:var(--muted);font-size:13px;display:none}
    .toast.show{display:block}
    .toast.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.08);color:#c9f9db}
    .toast.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.08);color:#ffd0cd}

    .keyBtn{
      border:1px solid var(--stroke); background:rgba(255,255,255,.03);
      color:var(--text); border-radius:999px; padding:8px 10px; cursor:pointer; font-weight:900;
      display:inline-flex; align-items:center; gap:8px;
    }

    /* Overlay image missions accomplies */
    #doneOverlay{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.65); z-index:9999; padding:14px;
    }
    #doneOverlay img{
      max-width:min(520px, 92vw);
      border-radius:18px;
      box-shadow:0 20px 60px rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.14);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Entretien du centre de secours de Consenvoye</h1>
    <div class="subtitle">JTUB (GitHub) ‚Ä¢ Sheets (moteur)</div>

    <div class="tabsCenter">
      <div class="tabs">
        <button class="tab active" id="tabAgent" onclick="showView('agent')">üßë‚Äçüöí Agent</button>
        <button class="tab" id="tabAdmin" onclick="showView('admin')">üõ°Ô∏è Admin</button>
        <button class="btn" id="btnReload" onclick="bootstrap()">Recharger</button>
      </div>
    </div>

    <!-- ===== AGENT ===== -->
    <div id="viewAgent" class="card">
      <div class="headRow">
        <div class="h2">Espace agent</div>
        <div style="display:flex; gap:8px; align-items:center">
          <button class="keyBtn" id="btnAgentKey" style="display:none" onclick="toggleBox('agentKeyBox')">üîë</button>
          <button class="btn danger small" id="btnAgentLogout" style="display:none" onclick="agentLogout()">D√©connexion</button>
          <div class="status" id="agentStatus">Agent : non connect√©</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Agent</label>
          <select id="agentSel"></select>
        </div>
        <div>
          <label>Code</label>
          <input id="agentCode" placeholder="Code agent" />
        </div>
        <div class="right">
          <button class="btn primary" id="btnAgentLogin" onclick="agentLogin(event)">Se connecter</button>
        </div>
      </div>

      <div id="agentToast" class="toast"></div>

      <div id="agentKeyBox" style="display:none; margin-top:12px">
        <div class="divider"></div>
        <div class="h2">Changer mon code</div>
        <div class="row" style="margin-top:10px">
          <div><label>Ancien code</label><input id="agentOld" placeholder="Ancien code"/></div>
          <div><label>Nouveau code (min 4)</label><input id="agentNew" placeholder="Nouveau code"/></div>
          <div class="right"><button class="btn primary" id="btnAgentChange" onclick="agentChangePassword(event)">Valider</button></div>
        </div>
        <div id="agentChangeToast" class="toast"></div>
      </div>

      <div id="agentWork" style="display:none">
        <div class="divider"></div>

        <div class="row">
          <div>
            <label>P√©riode</label>
            <select id="agentPeriodSel">
              <option value="">‚Äî Choisir p√©riode ‚Äî</option>
            </select>
          </div>
          <div class="right">
            <button class="btn primary" id="btnAgentLoad" onclick="agentLoadPeriod(event)">Charger</button>
          </div>
        </div>

        <div class="divider"></div>

        <label>Remarque g√©n√©rale (facultatif)</label>
        <textarea id="agentGeneral" rows="3" placeholder="Remarque g√©n√©rale‚Ä¶"></textarea>

        <div class="divider"></div>

        <div class="scrollBox" id="agentMissionsBox">
          <div class="ghost" style="padding:10px">Choisis une p√©riode puis ‚ÄúCharger‚Äù.</div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div class="right">
            <button class="btn primary" id="btnAgentSave" onclick="agentSave(event)">Enregistrer</button>
          </div>
        </div>

        <div id="agentSaveToast" class="toast"></div>
      </div>
    </div>

    <!-- ===== ADMIN ===== -->
    <div id="viewAdmin" class="card" style="display:none">
      <div class="headRow">
        <div class="h2">Espace admin</div>
        <div style="display:flex; gap:8px; align-items:center">
          <button class="keyBtn" id="btnAdminKey" style="display:none" onclick="toggleBox('adminKeyBox')">üîë</button>
          <button class="btn danger small" id="btnAdminLogout" style="display:none" onclick="adminLogout()">D√©connexion</button>
          <div class="status" id="adminStatus">Admin : non connect√©</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Code admin</label>
          <input id="adminCode" placeholder="Code admin"/>
        </div>
        <div class="right">
          <button class="btn primary" id="btnAdminLogin" onclick="adminLogin(event)">Se connecter</button>
        </div>
      </div>
      <div id="adminToast" class="toast"></div>

      <div id="adminKeyBox" style="display:none; margin-top:12px">
        <div class="divider"></div>
        <div class="h2">Changer le code admin</div>
        <div class="row" style="margin-top:10px">
          <div><label>Ancien code</label><input id="adminOld" placeholder="Ancien code"/></div>
          <div><label>Nouveau code (min 4)</label><input id="adminNew" placeholder="Nouveau code"/></div>
          <div class="right"><button class="btn primary" id="btnAdminChange" onclick="adminChangePassword(event)">Valider</button></div>
        </div>
        <div id="adminChangeToast" class="toast"></div>
      </div>

      <div id="adminWork" style="display:none; margin-top:12px">

        <div class="twoColBlock">

          <!-- COL GAUCHE : actions -->
          <div class="card">
            <div class="h2">Agents</div>
            <div class="row" style="margin-top:10px">
              <div><label>Nom</label><input id="newAgentName" placeholder="Nom Pr√©nom"/></div>
              <div><label>Code</label><input id="newAgentPass" value="0000"/></div>
              <div class="right"><button class="btn primary" id="btnAddAgent" onclick="adminAddAgent(event)">Ajouter</button></div>
            </div>

            <div class="divider"></div>

            <div class="h2">Catalogue missions</div>
            <div class="row" style="margin-top:10px">
              <div><label>Libell√©</label><input id="newMissionLib" placeholder="Ex : Nettoyage"/></div>
              <div class="right"><button class="btn primary" id="btnAddMission" onclick="adminAddMission(event)">Ajouter</button></div>
            </div>

            <div class="divider"></div>

            <div class="h2">P√©riode / Groupe / Missions actives / Retours</div>
            <div class="row" style="margin-top:10px">
              <div><label>P√©riode</label><select id="periodeSel"></select></div>
              <div class="right"><button class="btn primary" id="btnLoadPeriod" onclick="adminLoadPeriod(event)">Charger</button></div>
            </div>

            <div class="row" style="margin-top:10px">
              <div><label>Ajouter au groupe</label><select id="addToGroupSel"></select></div>
              <div class="right"><button class="btn primary" id="btnAddToGroup" onclick="adminAddToGroup(event)">Ajouter</button></div>
            </div>

            <div class="row" style="margin-top:10px">
              <div><label>Responsable</label><select id="responsableSel"></select></div>
              <div class="right"><button class="btn primary" id="btnSetResp" onclick="adminSetResponsable(event)">D√©finir</button></div>
            </div>

            <div class="divider"></div>

            <div class="row">
              <div class="right"><button class="btn primary" id="btnLoadMonth" onclick="adminLoadMonth(event)">Charger missions actives</button></div>
            </div>

            <div class="row" style="margin-top:10px">
              <div class="right"><button class="btn primary" id="btnSaveMonth" onclick="adminSaveMonth(event)">Enregistrer missions actives</button></div>
            </div>

            <div class="row" style="margin-top:10px">
              <div class="right"><button class="btn" id="btnLoadRetours" onclick="adminLoadRetours(event)">Charger retours</button></div>
            </div>

            <div id="adminWorkToast" class="toast"></div>
          </div>

          <!-- COL DROITE : listes -->
          <div class="card">
            <div class="h2">Liste agents</div>
            <div class="scrollBox" style="margin-top:10px" id="agentsBox">
              <div class="ghost" style="padding:10px">‚Äî</div>
            </div>

            <div class="divider"></div>

            <div class="h2">Liste missions</div>
            <div class="scrollBox" style="margin-top:10px" id="missionsBox">
              <div class="ghost" style="padding:10px">‚Äî</div>
            </div>

            <div class="divider"></div>

            <div class="h2">Groupe</div>
            <div class="scrollBox" style="margin-top:10px" id="groupBox">
              <div class="ghost" style="padding:10px">‚Äî</div>
            </div>

            <div class="divider"></div>

            <div class="h2">Missions actives</div>
            <div class="scrollBox" style="margin-top:10px" id="monthBox">
              <div class="ghost" style="padding:10px">‚Äî</div>
            </div>

            <div class="divider"></div>

            <div class="h2">Retours (Partiel / Non fait)</div>
            <div class="scrollBox" style="margin-top:10px" id="retoursBox">
              <div class="ghost" style="padding:10px">‚Äî</div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Overlay image missions accomplies -->
  <div id="doneOverlay" ondblclick="hideDone()">
    <!-- mets ton image √† la racine plus tard : missions-accomplies.jpg -->
    <img src="missions-accomplies.jpg" alt="Missions accomplies"/>
  </div>

<script>
/*** === CONFIG === ***/
const API_EXEC = "https://script.google.com/macros/s/AKfycbwTo8mKf9yDCmFDZbT03-nbxv5QVLcMjNEGuvlL25alCktBLX9P-G3i4NTVMw048DE/exec"; // <- remplace par ton /exec

/*** === Utils === ***/
function esc(s){ return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

function showView(v){
  document.getElementById("tabAgent").classList.toggle("active", v==="agent");
  document.getElementById("tabAdmin").classList.toggle("active", v==="admin");
  document.getElementById("viewAgent").style.display = (v==="agent") ? "" : "none";
  document.getElementById("viewAdmin").style.display = (v==="admin") ? "" : "none";
}

function toast(id, msg, ok){
  const el = document.getElementById(id);
  el.className = "toast show " + (ok ? "ok":"bad");
  el.textContent = msg || "";
}
function clearToast(id){
  const el = document.getElementById(id);
  el.className = "toast";
  el.textContent = "";
}

function setLoading(btn, on){
  if(!btn) return;
  btn.classList.toggle("loading", !!on);
  btn.disabled = !!on;
}

function toggleBox(id){
  const el = document.getElementById(id);
  el.style.display = (el.style.display === "none" || !el.style.display) ? "block" : "none";
}

/*** JSONP (pas de CORS, pas d'eval) ***/
function jsonp(action, params={}){
  return new Promise((resolve, reject)=>{
    const cb = "CB_" + Math.random().toString(36).slice(2);
    const url = new URL(API_EXEC);
    url.searchParams.set("action", action);
    url.searchParams.set("callback", cb);
    Object.entries(params).forEach(([k,v])=> url.searchParams.set(k, (typeof v === "string" ? v : JSON.stringify(v))));

    const s = document.createElement("script");
    window[cb] = (data)=>{
      try { resolve(data); }
      finally {
        delete window[cb];
        s.remove();
      }
    };
    s.onerror = ()=>{
      delete window[cb];
      s.remove();
      reject(new Error("load_error"));
    };
    s.src = url.toString();
    document.head.appendChild(s);
  });
}

/*** === STATE === ***/
let DATA = { agents:[], periodes:[] };
let ADMIN = { ok:false, code:"" };
let AGENT = { ok:false, agent_id:"", nom:"", code:"" };

/*** === BOOTSTRAP === ***/
async function bootstrap(){
  const btn = document.getElementById("btnReload");
  setLoading(btn, true);
  try{
    const res = await jsonp("bootstrapPublic", {});
    if(!res || !res.ok) throw new Error("bootstrap_failed");
    DATA.agents = res.agents || [];
    DATA.periodes = res.periodes || [];
    fillAgentSelect();
    fillPeriodeSelect();
    // si admin connect√© -> refresh
    if(ADMIN.ok){
      await adminRefreshLists();
    }
  }catch(e){
    // rien
  }finally{
    setLoading(btn, false);
  }
}

function fillAgentSelect(){
  const sel = document.getElementById("agentSel");
  sel.innerHTML = `<option value="">‚Äî Choisir agent ‚Äî</option>`;
  (DATA.agents||[]).filter(a=>a.actif).forEach(a=>{
    sel.innerHTML += `<option value="${esc(a.agent_id)}">${esc(a.nom)}</option>`;
  });
}
function fillPeriodeSelect(){
  const sel = document.getElementById("periodeSel");
  sel.innerHTML = `<option value="">‚Äî Choisir p√©riode ‚Äî</option>`;
  (DATA.periodes||[]).forEach(p=>{
    if(!p.actif) return;
    sel.innerHTML += `<option value="${esc(p.period_id)}">${esc(p.libelle || p.period_id)}</option>`;
  });
}

/*** === ADMIN === ***/
async function adminLogin(ev){
  clearToast("adminToast");
  const btn = document.getElementById("btnAdminLogin");
  const code = document.getElementById("adminCode").value.trim();
  if(!code) return;
  setLoading(btn, true);
  try{
    const res = await jsonp("adminLogin", { code });
    if(!res || !res.ok){
      ADMIN = { ok:false, code:"" };
      document.getElementById("adminStatus").className = "status bad";
      document.getElementById("adminStatus").textContent = "Admin : non connect√©";
      toast("adminToast", "Code admin incorrect.", false);
      return;
    }
    ADMIN = { ok:true, code };
    document.getElementById("adminStatus").className = "status ok";
    document.getElementById("adminStatus").textContent = "Admin : connect√© ‚úÖ";
    document.getElementById("btnAdminLogout").style.display = "";
    document.getElementById("btnAdminKey").style.display = "";
    document.getElementById("adminWork").style.display = "";
    toast("adminToast", "Admin connect√© ‚úÖ", true);
    await adminRefreshLists();
  }catch(e){
    toast("adminToast", "Erreur r√©seau.", false);
  }finally{
    setLoading(btn, false);
  }
}

function adminLogout(){
  ADMIN = { ok:false, code:"" };
  document.getElementById("adminStatus").className = "status";
  document.getElementById("adminStatus").textContent = "Admin : non connect√©";
  document.getElementById("btnAdminLogout").style.display = "none";
  document.getElementById("btnAdminKey").style.display = "none";
  document.getElementById("adminWork").style.display = "none";
}

async function adminChangePassword(ev){
  clearToast("adminChangeToast");
  const btn = document.getElementById("btnAdminChange");
  const oldC = document.getElementById("adminOld").value.trim();
  const nextC = document.getElementById("adminNew").value.trim();
  if(!oldC || !nextC) return;
  setLoading(btn, true);
  try{
    const res = await jsonp("adminChangePassword", { CODE: ADMIN.code, old: oldC, next: nextC });
    if(!res || !res.ok){ toast("adminChangeToast", res?.message || "Erreur", false); return; }
    toast("adminChangeToast", res.message || "OK", true);
    // met √† jour le code admin en m√©moire
    ADMIN.code = nextC;
    document.getElementById("adminCode").value = nextC;
  }catch(e){
    toast("adminChangeToast", "Erreur r√©seau.", false);
  }finally{
    setLoading(btn, false);
  }
}

async function adminRefreshLists(){
  await Promise.all([adminListAgents(), adminListCatalog()]);
}

async function adminListAgents(){
  const res = await jsonp("adminListAgents", { CODE: ADMIN.code });
  const box = document.getElementById("agentsBox");
  if(!res || !res.ok){ box.innerHTML = `<div class="ghost" style="padding:10px">Erreur.</div>`; return; }
  const list = (res.agents||[]);
  // select addToGroup
  const addSel = document.getElementById("addToGroupSel");
  addSel.innerHTML = `<option value="">‚Äî Choisir agent ‚Äî</option>` +
    list.filter(a=>a.actif).map(a=>`<option value="${esc(a.agent_id)}">${esc(a.nom)}</option>`).join("");

  box.innerHTML = list.map(a=>`
    <div class="listItem">
      <div><b>${esc(a.nom)}</b><div class="ghost" style="font-size:12px">${a.actif?"Actif ‚úÖ":"Inactif ‚ùå"}</div></div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end">
        <button class="btn small" onclick="adminToggleAgent('${esc(a.agent_id)}', ${a.actif ? "false":"true"})">${a.actif?"D√©sactiver":"Activer"}</button>
        <button class="btn small" onclick="adminResetAgent('${esc(a.agent_id)}')">Reset 0000</button>
        <button class="btn small danger" onclick="adminDeleteAgent('${esc(a.agent_id)}')">Supprimer</button>
      </div>
    </div>
  `).join("") || `<div class="ghost" style="padding:10px">Aucun agent.</div>`;
}

async function adminAddAgent(ev){
  clearToast("adminWorkToast");
  const btn = document.getElementById("btnAddAgent");
  const nom = document.getElementById("newAgentName").value.trim();
  const code = document.getElementById("newAgentPass").value.trim() || "0000";
  if(!nom) return;
  setLoading(btn, true);
  try{
    const res = await jsonp("adminAddAgent", { CODE: ADMIN.code, nom, code });
    if(!res || !res.ok){ toast("adminWorkToast", res?.message || "Erreur", false); return; }
    toast("adminWorkToast", res.message || "OK", true);
    document.getElementById("newAgentName").value="";
    document.getElementById("newAgentPass").value="0000";
    await adminListAgents();
    await bootstrap();
  }catch(e){
    toast("adminWorkToast", "Erreur r√©seau.", false);
  }finally{
    setLoading(btn, false);
  }
}

async function adminToggleAgent(agent_id, actif){
  await jsonp("adminToggleAgent", { CODE: ADMIN.code, agent_id, actif: String(actif) });
  await adminListAgents();
  await bootstrap();
}

async function adminResetAgent(agent_id){
  await jsonp("adminResetAgent", { CODE: ADMIN.code, agent_id });
  await adminListAgents();
}

async function adminDeleteAgent(agent_id){
  if(!confirm("Supprimer d√©finitivement cet agent ?")) return;
  await jsonp("adminDeleteAgent", { CODE: ADMIN.code, agent_id });
  await adminListAgents();
  await bootstrap();
}

async function adminListCatalog(){
  const res = await jsonp("adminListCatalog", { CODE: ADMIN.code });
  const box = document.getElementById("missionsBox");
  if(!res || !res.ok){ box.innerHTML = `<div class="ghost" style="padding:10px">Erreur.</div>`; return; }
  const list = (res.catalog||[]);
  box.innerHTML = list.map(m=>`
    <div class="listItem">
      <div><b>${esc(m.libelle)}</b><div class="ghost" style="font-size:12px">${m.actif?"Active ‚úÖ":"Inactive ‚ùå"}</div></div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end">
        <button class="btn small" onclick="adminToggleMission('${esc(m.mission_id)}', ${m.actif ? "false":"true"})">${m.actif?"D√©sactiver":"Activer"}</button>
        <button class="btn small danger" onclick="adminDeleteMission('${esc(m.mission_id)}')">Supprimer</button>
      </div>
    </div>
  `).join("") || `<div class="ghost" style="padding:10px">Aucune mission.</div>`;
}

async function adminAddMission(ev){
  clearToast("adminWorkToast");
  const btn = document.getElementById("btnAddMission");
  const libelle = document.getElementById("newMissionLib").value.trim();
  if(!libelle) return;
  setLoading(btn, true);
  try{
    const res = await jsonp("adminAddMission", { CODE: ADMIN.code, libelle });
    if(!res || !res.ok){ toast("adminWorkToast", res?.message || "Erreur", false); return; }
    toast("adminWorkToast", res.message || "OK", true);
    document.getElementById("newMissionLib").value="";
    await adminListCatalog();
  }catch(e){
    toast("adminWorkToast", "Erreur r√©seau.", false);
  }finally{
    setLoading(btn, false);
  }
}

async function adminToggleMission(mission_id, actif){
  await jsonp("adminToggleMission", { CODE: ADMIN.code, mission_id, actif: String(actif) });
  await adminListCatalog();
}

async function adminDeleteMission(mission_id){
  if(!confirm("Supprimer d√©finitivement cette mission ?")) return;
  await jsonp("adminDeleteMission", { CODE: ADMIN.code, mission_id });
  await adminListCatalog();
}

async function adminLoadPeriod(ev){
  clearToast("adminWorkToast");
  const btn = document.getElementById("btnLoadPeriod");
  const period_id = document.getElementById("periodeSel").value;
  if(!period_id) return;
  setLoading(btn, true);
  try{
    const res = await jsonp("adminLoadPeriod", { CODE: ADMIN.code, period_id });
    if(!res || !res.ok){ toast("adminWorkToast", res?.message || "Erreur", false); return; }

    // responsable select
    const rsel = document.getElementById("responsableSel");
    rsel.innerHTML = `<option value="">‚Äî Choisir ‚Äî</option>` +
      (res.group||[]).map(a=>`<option value="${esc(a.agent_id)}">${esc(a.nom)}</option>`).join("");

    // group box
    const gbox = document.getElementById("groupBox");
    gbox.innerHTML = (res.group||[]).map(a=>`
      <div class="listItem">
        <div><b>${esc(a.nom)}</b></div>
        <button class="btn small danger" onclick="adminRemoveFromGroup('${esc(res.period_id)}','${esc(a.agent_id)}')">Retirer</button>
      </div>
    `).join("") || `<div class="ghost" style="padding:10px">Aucun agent.</div>`;

    // month box = missions actives (check)
    await adminLoadMonth({noBtn:true});
    await adminLoadRetours({noBtn:true});

    toast("adminWorkToast", "P√©riode charg√©e ‚úÖ", true);
  }catch(e){
    toast("adminWorkToast", "Erreur r√©seau.", false);
  }finally{
    setLoading(btn, false);
  }
}

async function adminAddToGroup(ev){
  clearToast("adminWorkToast");
  const btn = document.getElementById("btnAddToGroup");
  const period_id = document.getElementById("periodeSel").value;
  const agent_id = document.getElementById("addToGroupSel").value;
  if(!period_id || !agent_id) return;
  setLoading(btn, true);
  try{
    const res = await jsonp("adminAddToGroup", { CODE: ADMIN.code, period_id, agent_id });
    if(!res || !res.ok){ toast("adminWorkToast", res?.message || "Erreur", false); return; }
    toast("adminWorkToast", res.message || "OK", true);
    await adminLoadPeriod({}); // recharge
  }catch(e){
    toast("adminWorkToast", "Erreur r√©seau.", false);
  }finally{
    setLoading(btn, false);
  }
}

async function adminRemoveFromGroup(period_id, agent_id){
  await jsonp("adminRemoveFromGroup", { CODE: ADMIN.code, period_id, agent_id });
  await adminLoadPeriod({});
}

async function adminSetResponsable(ev){
  clearToast("adminWorkToast");
  const btn = document.getElementById("btnSetResp");
  const period_id = document.getElementById("periodeSel").value;
  const agent_id = document.getElementById("responsableSel").value;
  if(!period_id || !agent_id) return;
  setLoading(btn, true);
  try{
    const res = await jsonp("adminSetResponsable", { CODE: ADMIN.code, period_id, agent_id });
    if(!res || !res.ok){ toast("adminWorkToast", res?.message || "Erreur", false); return; }
    toast("adminWorkToast", res.message || "OK", true);
  }catch(e){
    toast("adminWorkToast", "Erreur r√©seau.", false);
  }finally{
    setLoading(btn, false);
  }
}

async function adminLoadMonth(opts={}){
  const btn = opts.noBtn ? null : document.getElementById("btnLoadMonth");
  if(btn) setLoading(btn, true);
  try{
    const period_id = document.getElementById("periodeSel").value;
    if(!period_id) return;
    const res = await jsonp("adminGetMonthMissions", { CODE: ADMIN.code, period_id });
    const box = document.getElementById("monthBox");
    if(!res || !res.ok){ box.innerHTML = `<div class="ghost" style="padding:10px">Erreur.</div>`; return; }

    const on = new Set((res.missionsOn||[]).map(x=>x.mission_id));
    box.innerHTML = (res.missionsAll||[]).map(m=>`
      <div class="listItem">
        <div><b>${esc(m.libelle)}</b></div>
        <input type="checkbox" data-mid="${esc(m.mission_id)}" ${on.has(m.mission_id)?"checked":""}/>
      </div>
    `).join("") || `<div class="ghost" style="padding:10px">‚Äî</div>`;
  }finally{
    if(btn) setLoading(btn, false);
  }
}

async function adminSaveMonth(ev){
  clearToast("adminWorkToast");
  const btn = document.getElementById("btnSaveMonth");
  const period_id = document.getElementById("periodeSel").value;
  if(!period_id) return;
  setLoading(btn, true);
  try{
    const checks = Array.from(document.querySelectorAll("#monthBox input[type=checkbox][data-mid]"));
    const ids = checks.filter(c=>c.checked).map(c=>c.getAttribute("data-mid"));
    const res = await jsonp("adminSaveMonthMissions", { CODE: ADMIN.code, period_id, ids });
    if(!res || !res.ok){ toast("adminWorkToast", res?.message || "Erreur", false); return; }
    toast("adminWorkToast", res.message || "OK", true);
    await adminLoadMonth({noBtn:true});
  }catch(e){
    toast("adminWorkToast", "Erreur r√©seau.", false);
  }finally{
    setLoading(btn, false);
  }
}

async function adminLoadRetours(opts={}){
  const btn = opts.noBtn ? null : document.getElementById("btnLoadRetours");
  if(btn) setLoading(btn, true);
  try{
    const period_id = document.getElementById("periodeSel").value;
    if(!period_id) return;
    const res = await jsonp("adminRetours", { CODE: ADMIN.code, period_id });
    const box = document.getElementById("retoursBox");
    if(!res || !res.ok){ box.innerHTML = `<div class="ghost" style="padding:10px">Erreur.</div>`; return; }
    const items = res.items || [];
    box.innerHTML = items.map(it=>`
      <div class="listItem">
        <div>
          <b>${esc(it.agent)}</b>
          <div class="ghost" style="font-size:12px">${esc(it.declaration)} ‚Ä¢ ${esc(it.justificatif||"")}</div>
        </div>
        <span class="pill ${it.declaration==="Non fait"?"bad":"ok"}">${esc(it.declaration)}</span>
      </div>
    `).join("") || `<div class="ghost" style="padding:10px">Aucun retour.</div>`;
  }finally{
    if(btn) setLoading(btn, false);
  }
}

/*** === AGENT === ***/
async function agentLogin(ev){
  clearToast("agentToast");
  const btn = document.getElementById("btnAgentLogin");
  const agent_id = document.getElementById("agentSel").value;
  const code = document.getElementById("agentCode").value.trim();
  if(!agent_id || !code) return;

  setLoading(btn, true);
  try{
    const res = await jsonp("agentLogin", { agent_id, code });
    if(!res || !res.ok){
      AGENT = { ok:false, agent_id:"", nom:"", code:"" };
      document.getElementById("agentStatus").className = "status bad";
      document.getElementById("agentStatus").textContent = "Agent : non connect√©";
      toast("agentToast", "Code agent incorrect.", false);
      return;
    }
    AGENT = { ok:true, agent_id, nom: res.agent.nom, code };
    document.getElementById("agentStatus").className = "status ok";
    document.getElementById("agentStatus").textContent = "Agent : " + res.agent.nom;
    document.getElementById("btnAgentLogout").style.display = "";
    document.getElementById("btnAgentKey").style.display = "";
    document.getElementById("agentWork").style.display = "";

    // p√©riodes
    const psel = document.getElementById("agentPeriodSel");
    psel.innerHTML = `<option value="">‚Äî Choisir p√©riode ‚Äî</option>` +
      (res.periodes||[]).map(p=>`<option value="${esc(p.period_id)}">${esc(p.libelle)}</option>`).join("");

    toast("agentToast", res.mustChange ? "Code = 0000 : change ton code üîë obligatoire." : "Connect√© ‚úÖ", true);

    // force change code si 0000
    if(res.mustChange){
      document.getElementById("agentKeyBox").style.display = "block";
    }
  }catch(e){
    toast("agentToast", "Erreur r√©seau.", false);
  }finally{
    setLoading(btn, false);
  }
}

function agentLogout(){
  AGENT = { ok:false, agent_id:"", nom:"", code:"" };
  document.getElementById("agentStatus").className = "status";
  document.getElementById("agentStatus").textContent = "Agent : non connect√©";
  document.getElementById("btnAgentLogout").style.display = "none";
  document.getElementById("btnAgentKey").style.display = "none";
  document.getElementById("agentWork").style.display = "none";
  document.getElementById("agentKeyBox").style.display = "none";
}

async function agentChangePassword(ev){
  clearToast("agentChangeToast");
  const btn = document.getElementById("btnAgentChange");
  const oldC = document.getElementById("agentOld").value.trim();
  const nextC = document.getElementById("agentNew").value.trim();
  if(!oldC || !nextC) return;

  setLoading(btn, true);
  try{
    const res = await jsonp("agentChangePassword", { agent_id: AGENT.agent_id, old: oldC, next: nextC });
    if(!res || !res.ok){ toast("agentChangeToast", res?.message || "Erreur", false); return; }
    toast("agentChangeToast", res.message || "OK", true);
    // met √† jour code en m√©moire
    AGENT.code = nextC;
    document.getElementById("agentCode").value = nextC;
    document.getElementById("agentOld").value = "";
    document.getElementById("agentNew").value = "";
    // replie si tu veux
  }catch(e){
    toast("agentChangeToast", "Erreur r√©seau.", false);
  }finally{
    setLoading(btn, false);
  }
}

async function agentLoadPeriod(ev){
  clearToast("agentSaveToast");
  const btn = document.getElementById("btnAgentLoad");
  const period_id = document.getElementById("agentPeriodSel").value;
  if(!AGENT.ok || !period_id) return;

  setLoading(btn, true);
  try{
    const res = await jsonp("agentLoadPeriod", { agent_id: AGENT.agent_id, code: AGENT.code, period_id });
    if(!res || !res.ok){
      toast("agentSaveToast", res?.message || "Erreur", false);
      return;
    }

    document.getElementById("agentGeneral").value = res.general_remarque || "";

    const box = document.getElementById("agentMissionsBox");
    const missions = res.missions || [];
    if(!missions.length){
      box.innerHTML = `<div class="ghost" style="padding:10px">Aucune mission active pour cette p√©riode.</div>`;
      return;
    }

    box.innerHTML = missions.map(m=>`
      <div class="listItem" data-mid="${esc(m.mission_id)}">
        <div style="min-width:0">
          <b style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(m.libelle)}</b>
          <div class="ghost" style="font-size:12px">
            <select class="decSel">
              <option value="" ${m.declaration===""?"selected":""}>‚Äî</option>
              <option value="Fait" ${m.declaration==="Fait"?"selected":""}>Fait</option>
              <option value="Partiel" ${m.declaration==="Partiel"?"selected":""}>Partiel</option>
              <option value="Non fait" ${m.declaration==="Non fait"?"selected":""}>Non fait</option>
            </select>
          </div>
        </div>
        <div style="min-width:220px;max-width:340px;width:100%">
          <input class="justifInp" placeholder="Justificatif (si Partiel/Non fait)" value="${esc(m.justificatif||"")}"/>
        </div>
      </div>
    `).join("");

    toast("agentSaveToast", "Missions charg√©es ‚úÖ", true);
  }catch(e){
    toast("agentSaveToast", "Erreur r√©seau.", false);
  }finally{
    setLoading(btn, false);
  }
}

async function agentSave(ev){
  clearToast("agentSaveToast");
  const btn = document.getElementById("btnAgentSave");
  const period_id = document.getElementById("agentPeriodSel").value;
  if(!AGENT.ok || !period_id) return;

  setLoading(btn, true);
  try{
    const rows = Array.from(document.querySelectorAll("#agentMissionsBox .listItem[data-mid]"));
    const items = rows.map(r=>{
      const mid = r.getAttribute("data-mid");
      const dec = r.querySelector(".decSel")?.value || "";
      const just = r.querySelector(".justifInp")?.value || "";
      return { mission_id: mid, declaration: dec, justificatif: just };
    });
    const general = document.getElementById("agentGeneral").value || "";

    const res = await jsonp("agentSave", { agent_id: AGENT.agent_id, code: AGENT.code, period_id, items, general });
    if(!res || !res.ok){ toast("agentSaveToast", res?.message || "Erreur", false); return; }

    toast("agentSaveToast", "Enregistr√© ‚úÖ", true);

    // Si toutes missions = Fait => overlay image
    const allDone = items.length && items.every(x => x.declaration === "Fait");
    if(allDone){
      showDone();
    }
  }catch(e){
    toast("agentSaveToast", "Erreur r√©seau.", false);
  }finally{
    setLoading(btn, false);
  }
}

/*** overlay image missions accomplies ***/
function showDone(){
  const ov = document.getElementById("doneOverlay");
  ov.style.display = "flex";
}
function hideDone(){
  const ov = document.getElementById("doneOverlay");
  ov.style.display = "none";
}

/*** init ***/
bootstrap();
</script>
</body>
</html>
