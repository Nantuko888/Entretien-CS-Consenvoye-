<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Entretien CS Consenvoye</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1724; --panel2:#111b2b;
      --stroke:rgba(255,255,255,.12);
      --text:#e8eef9; --muted:rgba(232,238,249,.72);
      --accent:#ff7a00; --accent2:#ffb000;
      --danger:#ff3b30; --ok:#1fd36b;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --r:18px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial, "Noto Sans", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:var(--font);color:var(--text);
      background:
        radial-gradient(900px 420px at 20% 20%, rgba(255,122,0,.18), transparent 65%),
        radial-gradient(900px 420px at 80% 10%, rgba(255,176,0,.12), transparent 60%),
        linear-gradient(180deg, #06080b, var(--bg));
      min-height:100vh;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px 14px 46px}
    h1{margin:0;font-size:30px;font-weight:950;letter-spacing:.2px;color:#ff8d1a;text-shadow:0 2px 14px rgba(255,122,0,.18);text-align:center;}
    .subtitle{margin:6px 0 0;color:var(--muted);font-size:12px;text-align:center}
    .tabsCenter{margin:14px 0 18px;display:flex;justify-content:center;}
    .tabs{
      display:flex;gap:8px;align-items:center;border:1px solid var(--stroke);
      background:rgba(255,255,255,.02);padding:6px;border-radius:999px;box-shadow:var(--shadow);
    }
    .tab{border:0;background:transparent;color:var(--muted);padding:10px 14px;border-radius:999px;cursor:pointer;font-weight:950;font-size:13px;}
    .tab.active{background:linear-gradient(90deg, rgba(255,122,0,.26), rgba(255,176,0,.18));color:var(--text);}
    .btn{
      appearance:none;border:1px solid var(--stroke);background:rgba(255,255,255,.03);color:var(--text);
      border-radius:999px;padding:10px 14px;cursor:pointer;font-weight:950;font-size:13px;
      transition:.15s transform ease,.15s background ease,.15s border-color ease;white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.2);background:rgba(255,255,255,.06)}
    .btn.primary{background:linear-gradient(90deg, var(--accent), var(--accent2));border-color:transparent;color:#0b0f14;box-shadow:0 12px 26px rgba(255,122,0,.18);}
    .btn.danger{background:rgba(255,59,48,.14);border-color:rgba(255,59,48,.35);color:#ffd0cd}
    .btn.small{padding:8px 12px;font-size:12px}
    .card{
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border-radius:var(--r);padding:16px;box-shadow:var(--shadow);
    }
    .headRow{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;flex-wrap:wrap}
    .h2{margin:0;font-size:15px;font-weight:950}
    .status{
      font-size:12px;font-weight:950;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.02);color:var(--muted);display:inline-flex;align-items:center;gap:8px;white-space:nowrap;
    }
    .status.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.10);color:#bdf6d2}
    .status.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.10);color:#ffd0cd}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
    input, select, textarea{
      width:100%;padding:11px 12px;border-radius:12px;border:1px solid var(--stroke);
      background:rgba(0,0,0,.25);color:var(--text);outline:none;font-size:14px;
    }
    textarea{min-height:90px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .row > *{flex:1;min-width:220px}
    .divider{height:1px;background:rgba(255,255,255,.09);margin:14px 0}
    .twoColBlock{display:grid;gap:12px}
    @media(min-width:1000px){ .twoColBlock{grid-template-columns: 1fr 1.2fr;} }
    .toast{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);background:rgba(255,255,255,.02);color:var(--muted);font-size:13px;display:none}
    .toast.show{display:block}
    .toast.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.08);color:#c9f9db}
    .toast.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.08);color:#ffd0cd}
    .scrollBox{max-height:280px;overflow:auto;border-radius:14px;border:1px solid var(--stroke);background:rgba(0,0,0,.18)}
    .itemRow{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08)}
    .itemRow:last-child{border-bottom:0}
    .tag{font-size:12px;font-weight:950;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.02)}
    .tag.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.10);color:#bdf6d2}
    .tag.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.10);color:#ffd0cd}
    .muted{color:var(--muted)}
    .grid2{display:grid;gap:10px}
    @media(min-width:900px){ .grid2{grid-template-columns:1fr 1fr} }

    /* Mobile */
    @media(max-width:700px){
      .wrap{max-width:none;width:100%;padding:12px}
      .row > *{min-width:100%}
      input,select,textarea,button,.btn{width:100%;min-height:44px;font-size:16px}
      .tabs{width:100%;justify-content:space-between}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Entretien du centre de secours de Consenvoye</h1>
    <div class="subtitle">Agent : saisie ‚Ä¢ Admin : configuration ‚Ä¢ Justificatif obligatoire si <b>Partiel</b> / <b>Non fait</b></div>

    <!-- ‚úÖ Agent / Admin dans le bon ordre -->
    <div class="tabsCenter">
      <div class="tabs">
        <button class="tab active" id="tabAgent" onclick="UI.show('agent')">üßë‚Äçüöí Agent</button>
        <button class="tab" id="tabAdmin" onclick="UI.show('admin')">üõ°Ô∏è Admin</button>
        <button class="btn" onclick="APP.resetDemo()">Recharger</button>
      </div>
    </div>

    <!-- ================= AGENT ================= -->
    <div id="viewAgent" class="card">
      <div class="headRow">
        <div class="h2">Connexion agent</div>
        <div class="status" id="agentStatus">Agent : non connect√©</div>
      </div>

      <div class="row">
        <div>
          <label>Agent</label>
          <select id="agentSel"></select>
        </div>
        <div>
          <label>Code</label>
          <input id="agentCode" placeholder="Code agent" />
        </div>
        <div>
          <button class="btn primary" onclick="AGENT.login()">Se connecter</button>
        </div>
      </div>

      <div id="agentToast" class="toast"></div>

      <div id="agentArea" style="display:none;margin-top:14px;">
        <div class="divider"></div>

        <div class="grid2">
          <div class="card">
            <div class="headRow">
              <div class="h2">P√©riode</div>
              <div class="status" id="agentPeriodPill">‚Äî</div>
            </div>
            <label>P√©riode (o√π tu es affect√©)</label>
            <select id="agentPeriodSel"></select>
            <div style="margin-top:10px">
              <button class="btn primary" onclick="AGENT.loadMissions()">Charger</button>
            </div>
          </div>

          <div class="card">
            <div class="headRow">
              <div class="h2">Responsable</div>
              <div class="status" id="agentRespPill">‚Äî</div>
            </div>
            <div class="muted">Affich√© quand la p√©riode est charg√©e.</div>
            <div class="divider"></div>
            <div class="muted" style="font-size:13px">
              R√®gle : si une mission est <b>Partiel</b> ou <b>Non fait</b>, un justificatif est obligatoire.
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="card">
          <div class="headRow">
            <div class="h2">Missions du mois</div>
            <div class="status" id="agentSavePill">‚Äî</div>
          </div>
          <div id="agentMissionsBox" class="scrollBox">
            <div class="itemRow"><span class="muted">Choisis une p√©riode puis ‚ÄúCharger‚Äù.</span></div>
          </div>

          <div style="margin-top:10px" class="row">
            <div class="muted" style="align-self:center">Enregistrer uniquement tes changements.</div>
            <div>
              <button class="btn primary" onclick="AGENT.save()">Enregistrer</button>
            </div>
          </div>

          <div id="agentSaveToast" class="toast"></div>
        </div>
      </div>
    </div>

    <!-- ================= ADMIN ================= -->
    <div id="viewAdmin" class="card" style="display:none">
      <div class="headRow">
        <div class="h2">Connexion admin</div>
        <div class="status" id="adminStatus">Admin : non connect√©</div>
      </div>

      <div class="row">
        <div>
          <label>Code admin</label>
          <input id="adminCode" type="password" placeholder="Code admin" />
        </div>
        <div>
          <button class="btn primary" onclick="ADMIN.login()">Se connecter</button>
        </div>
      </div>
      <div id="adminToast" class="toast"></div>

      <div id="adminArea" style="display:none;margin-top:14px;">
        <div class="divider"></div>

        <div class="card">
          <div class="headRow"><div class="h2">Changer le code admin</div></div>
          <div class="row">
            <div>
              <label>Ancien code</label>
              <input id="oldAdminCode" type="password" placeholder="ancien code" />
            </div>
            <div>
              <label>Nouveau code</label>
              <input id="newAdminCode" type="password" placeholder="nouveau code (min 4)" />
            </div>
            <div>
              <button class="btn" onclick="ADMIN.changeCode()">Changer</button>
            </div>
          </div>
          <div id="adminCodeToast" class="toast"></div>
        </div>

        <div class="divider"></div>

        <div class="twoColBlock">
          <div class="card">
            <div class="headRow"><div class="h2">üë• Agents</div><div class="status ok">Local (d√©mo)</div></div>

            <div class="row">
              <div>
                <label>Nom Pr√©nom</label>
                <input id="newAgentName" placeholder="Ex : V√©nante Pierre" />
              </div>
              <div>
                <label>Code</label>
                <input id="newAgentCode" value="0000" />
              </div>
              <div>
                <button class="btn primary" onclick="ADMIN.addAgent()">Ajouter</button>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>Reset code (0000)</label>
                <select id="resetAgentSel"></select>
              </div>
              <div>
                <button class="btn" onclick="ADMIN.resetAgent()">Reset 0000</button>
              </div>
            </div>

            <div id="adminAgentsToast" class="toast"></div>
          </div>

          <div class="card">
            <div class="headRow"><div class="h2">Liste agents</div></div>
            <div id="adminAgentsList" class="scrollBox"></div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="twoColBlock">
          <div class="card">
            <div class="headRow"><div class="h2">üìö Catalogue missions</div></div>
            <label>Libell√©</label>
            <input id="newMissionLib" placeholder="Ex : Nettoyage communs" />
            <div style="margin-top:10px">
              <button class="btn primary" onclick="ADMIN.addMission()">Ajouter</button>
            </div>
            <div id="adminMissionsToast" class="toast"></div>
          </div>

          <div class="card">
            <div class="headRow"><div class="h2">Liste missions</div></div>
            <div id="adminMissionsList" class="scrollBox"></div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="twoColBlock">
          <div class="card">
            <div class="headRow"><div class="h2">üß© Groupe par p√©riode</div><div class="status" id="adminRespPill">Responsable : ‚Äî</div></div>
            <div class="row">
              <div>
                <label>P√©riode</label>
                <select id="periodeSel"></select>
              </div>
              <div>
                <button class="btn primary" onclick="ADMIN.loadPeriod()">Charger groupe</button>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>Ajouter au groupe</label>
                <select id="addToGroupSel"></select>
              </div>
              <div>
                <button class="btn primary" onclick="ADMIN.addToGroup()">Ajouter</button>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>D√©finir responsable</label>
                <select id="responsableSel"></select>
              </div>
              <div>
                <button class="btn primary" onclick="ADMIN.setResponsable()">D√©finir</button>
              </div>
            </div>

            <div id="adminGroupToast" class="toast"></div>
          </div>

          <div class="card">
            <div class="headRow"><div class="h2">Agents du groupe</div></div>
            <div id="adminGroupList" class="scrollBox"></div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="twoColBlock">
          <div class="card">
            <div class="headRow"><div class="h2">Missions du mois (actives)</div></div>
            <div class="row">
              <div class="muted" style="align-self:center">Active/d√©sactive les missions pour la p√©riode.</div>
              <div><button class="btn" onclick="ADMIN.loadMonthMissions()">Charger</button></div>
            </div>

            <div id="adminMonthBox" class="scrollBox" style="margin-top:10px"></div>

            <div style="margin-top:10px">
              <button class="btn primary" onclick="ADMIN.saveMonthMissions()">Enregistrer</button>
            </div>
            <div id="adminMonthToast" class="toast"></div>
          </div>

          <div class="card">
            <div class="headRow"><div class="h2">Missions actives (r√©sum√©)</div></div>
            <div id="adminMonthActiveList" class="scrollBox"></div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="card">
          <div class="headRow"><div class="h2">üìå Retours (Partiel / Non fait)</div></div>
          <div class="row">
            <div class="muted" style="align-self:center">Affich√© pour la p√©riode s√©lectionn√©e.</div>
            <div><button class="btn" onclick="ADMIN.loadRetours()">Charger</button></div>
          </div>
          <div id="adminRetoursList" class="scrollBox" style="margin-top:10px"></div>
          <div id="adminRetoursToast" class="toast"></div>
        </div>

      </div>
    </div>
  </div>

<script>
  // ===== Helpers UI =====
  const UI = {
    esc(s){ return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); },
    toast(id, msg, ok){
      const el = document.getElementById(id);
      if(!el) return;
      el.className = "toast show " + (ok ? "ok":"bad");
      el.textContent = msg || "";
    },
    clearToast(id){
      const el = document.getElementById(id);
      if(!el) return;
      el.className = "toast";
      el.textContent = "";
    },
    status(id, ok, txt){
      const el = document.getElementById(id);
      el.textContent = txt;
      el.className = "status " + (ok ? "ok":"bad");
    },
    show(which){
      document.getElementById("tabAgent").classList.toggle("active", which==="agent");
      document.getElementById("tabAdmin").classList.toggle("active", which==="admin");
      document.getElementById("viewAgent").style.display = (which==="agent") ? "" : "none";
      document.getElementById("viewAdmin").style.display = (which==="admin") ? "" : "none";
    },
  };

  // ===== Donn√©es DEMO (pas d‚ÄôIDs affich√©s) =====
  const APP = {
    adminCode: "1234",
    agents: [
      { agent_id:"A-3476b9ab", nom:"V√©nante Pierre", code:"0000", actif:true },
      { agent_id:"A-6c290cae", nom:"Laleeu Franck", code:"0000", actif:true },
      { agent_id:"A-7a8a4f8d", nom:"Bamm√© Melody", code:"0000", actif:true },
      { agent_id:"A-2c37da4d", nom:"V√©nante Am√©lie", code:"0000", actif:true },
      { agent_id:"A-46f9df6d", nom:"Michel Marianne", code:"0000", actif:true },
      { agent_id:"A-253f2ed1", nom:"S√©n√©chal Benjar", code:"0000", actif:true },
    ],
    missionsCatalog: [
      { mission_id:"M-1", libelle:"Boire un coup", actif:true },
      { mission_id:"M-2", libelle:"Laver vitres", actif:true },
      { mission_id:"M-3", libelle:"Nettoyage communs", actif:true },
      { mission_id:"M-4", libelle:"Pression v√©hicules", actif:true },
      { mission_id:"M-5", libelle:"Rangement mat√©riel", actif:true },
    ],
    periodes: [
      { period_id:"2026-01", libelle:"Janvier 2026" },
      { period_id:"2026-02", libelle:"F√©vrier 2026" },
      { period_id:"2026-03", libelle:"Mars 2026" },
    ],
    groupByPeriod: {
      "2026-01": { group:["A-3476b9ab","A-6c290cae","A-7a8a4f8d"], responsable:"A-3476b9ab" },
      "2026-02": { group:["A-3476b9ab","A-2c37da4d"], responsable:"A-2c37da4d" },
      "2026-03": { group:["A-46f9df6d"], responsable:"A-46f9df6d" },
    },
    monthMissionsOn: { // actifs par p√©riode
      "2026-01": ["M-1","M-2","M-3"],
      "2026-02": ["M-2","M-4"],
      "2026-03": ["M-3","M-5"],
    },
    declarations: { // period -> agent -> mission -> {declaration, justificatif}
      "2026-01": {
        "A-3476b9ab": { "M-1": {declaration:"Fait", justificatif:""}, "M-2":{declaration:"Partiel", justificatif:"Manque produit"}, "M-3":{declaration:"", justificatif:""} }
      }
    },

    resetDemo(){
      // reset UI seulement (on garde les donn√©es)
      UI.clearToast("adminToast");
      UI.clearToast("agentToast");
      UI.clearToast("agentSaveToast");
      UI.clearToast("adminCodeToast");
      UI.clearToast("adminAgentsToast");
      UI.clearToast("adminMissionsToast");
      UI.clearToast("adminGroupToast");
      UI.clearToast("adminMonthToast");
      UI.clearToast("adminRetoursToast");

      document.getElementById("adminCode").value="";
      document.getElementById("agentCode").value="";
      UI.status("adminStatus", false, "Admin : non connect√©");
      UI.status("agentStatus", false, "Agent : non connect√©");
      document.getElementById("adminArea").style.display="none";
      document.getElementById("agentArea").style.display="none";
      ADMIN.ok=false;
      AGENT.ok=false;
      ADMIN.pid="";
      AGENT.pid="";
      ADMIN.renderAll();
      AGENT.renderAll();
    }
  };

  // ===== Render bootstrap =====
  function bootstrapUI(){
    // agent select
    const aSel = document.getElementById("agentSel");
    aSel.innerHTML = `<option value="">‚Äî Choisir agent ‚Äî</option>` +
      APP.agents.filter(a=>a.actif).map(a=>`<option value="${UI.esc(a.agent_id)}">${UI.esc(a.nom)}</option>`).join("");

    // admin selects
    const pSel = document.getElementById("periodeSel");
    pSel.innerHTML = `<option value="">‚Äî Choisir p√©riode ‚Äî</option>` +
      APP.periodes.map(p=>`<option value="${UI.esc(p.period_id)}">${UI.esc(p.libelle)}</option>`).join("");

    ADMIN.renderAll();
    AGENT.renderAll();
  }

  // ===== ADMIN (local demo) =====
  const ADMIN = {
    ok:false,
    pid:"",
    login(){
      const code = (document.getElementById("adminCode").value||"").trim();
      if(!code){ UI.toast("adminToast","Code requis.", false); return; }
      if(code !== APP.adminCode){
        this.ok=false;
        UI.status("adminStatus", false, "Admin : non connect√©");
        UI.toast("adminToast","Code incorrect.", false);
        document.getElementById("adminArea").style.display="none";
        return;
      }
      this.ok=true;
      UI.status("adminStatus", true, "Admin : connect√©");
      UI.toast("adminToast","Connect√© ‚úÖ", true);
      document.getElementById("adminArea").style.display="";
      this.renderAll();
    },
    changeCode(){
      if(!this.ok) return;
      const oldC = (document.getElementById("oldAdminCode").value||"").trim();
      const newC = (document.getElementById("newAdminCode").value||"").trim();
      if(oldC !== APP.adminCode){ UI.toast("adminCodeToast","Ancien code incorrect.", false); return; }
      if(newC.length < 4){ UI.toast("adminCodeToast","Nouveau code trop court (min 4).", false); return; }
      APP.adminCode = newC;
      document.getElementById("oldAdminCode").value="";
      document.getElementById("newAdminCode").value="";
      UI.toast("adminCodeToast","Code admin chang√© ‚úÖ", true);
    },
    renderAll(){
      this.renderAgents();
      this.renderMissions();
      this.renderPeriodDependent();
      this.refreshAgentSelects();
    },
    refreshAgentSelects(){
      const active = APP.agents.filter(a=>a.actif);
      const resetSel = document.getElementById("resetAgentSel");
      const addSel = document.getElementById("addToGroupSel");
      resetSel.innerHTML = `<option value="">‚Äî Choisir agent ‚Äî</option>` + active.map(a=>`<option value="${UI.esc(a.agent_id)}">${UI.esc(a.nom)}</option>`).join("");
      addSel.innerHTML = `<option value="">‚Äî Choisir agent ‚Äî</option>` + active.map(a=>`<option value="${UI.esc(a.agent_id)}">${UI.esc(a.nom)}</option>`).join("");
    },
    renderAgents(){
      const box = document.getElementById("adminAgentsList");
      const list = APP.agents.slice().sort((a,b)=>a.nom.localeCompare(b.nom));
      if(!list.length){ box.innerHTML = `<div class="itemRow"><span class="muted">‚Äî</span></div>`; return; }
      box.innerHTML = list.map(a=>{
        const badge = a.actif ? `<span class="tag ok">Actif ‚úÖ</span>` : `<span class="tag bad">Inactif ‚ùå</span>`;
        return `
          <div class="itemRow">
            <div>
              <div style="font-weight:950">${UI.esc(a.nom)}</div>
              <div class="muted" style="font-size:12px">(ID masqu√©)</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end">
              ${badge}
              <button class="btn small" onclick="ADMIN.toggleAgent('${UI.esc(a.agent_id)}')">${a.actif?'D√©sactiver':'Activer'}</button>
              <button class="btn small" onclick="ADMIN.resetAgentCode('${UI.esc(a.agent_id)}')">Reset 0000</button>
              <button class="btn small danger" onclick="ADMIN.deleteAgent('${UI.esc(a.agent_id)}')">Supprimer</button>
            </div>
          </div>`;
      }).join("");
    },
    addAgent(){
      if(!this.ok) return;
      const nom = (document.getElementById("newAgentName").value||"").trim();
      const code = (document.getElementById("newAgentCode").value||"0000").trim() || "0000";
      if(!nom){ UI.toast("adminAgentsToast","Nom requis.", false); return; }
      APP.agents.push({ agent_id:"A-"+Math.random().toString(16).slice(2,10), nom, code, actif:true });
      document.getElementById("newAgentName").value="";
      document.getElementById("newAgentCode").value="0000";
      UI.toast("adminAgentsToast","Agent ajout√© ‚úÖ", true);
      this.renderAll();
      // agent view select refresh
      bootstrapUI();
    },
    resetAgent(){
      if(!this.ok) return;
      const id = document.getElementById("resetAgentSel").value;
      if(!id){ UI.toast("adminAgentsToast","Choisis un agent.", false); return; }
      this.resetAgentCode(id);
    },
    resetAgentCode(id){
      if(!this.ok) return;
      const a = APP.agents.find(x=>x.agent_id===id);
      if(!a) return;
      a.code = "0000";
      UI.toast("adminAgentsToast","Code agent reset ‚úÖ", true);
    },
    toggleAgent(id){
      if(!this.ok) return;
      const a = APP.agents.find(x=>x.agent_id===id);
      if(!a) return;
      a.actif = !a.actif;
      UI.toast("adminAgentsToast","Statut modifi√© ‚úÖ", true);
      this.renderAll();
      bootstrapUI();
    },
    deleteAgent(id){
      if(!this.ok) return;
      if(!confirm("Supprimer d√©finitivement cet agent ?")) return;
      APP.agents = APP.agents.filter(x=>x.agent_id!==id);
      UI.toast("adminAgentsToast","Supprim√© ‚úÖ", true);
      this.renderAll();
      bootstrapUI();
    },

    renderMissions(){
      const box = document.getElementById("adminMissionsList");
      const list = APP.missionsCatalog.slice().sort((a,b)=>a.libelle.localeCompare(b.libelle));
      if(!list.length){ box.innerHTML = `<div class="itemRow"><span class="muted">‚Äî</span></div>`; return; }
      box.innerHTML = list.map(m=>{
        const badge = m.actif ? `<span class="tag ok">Actif ‚úÖ</span>` : `<span class="tag bad">Inactif ‚ùå</span>`;
        return `
          <div class="itemRow">
            <div>
              <div style="font-weight:950">${UI.esc(m.libelle)}</div>
              <div class="muted" style="font-size:12px">(ID masqu√©)</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end">
              ${badge}
              <button class="btn small" onclick="ADMIN.toggleMission('${UI.esc(m.mission_id)}')">${m.actif?'D√©sactiver':'Activer'}</button>
              <button class="btn small danger" onclick="ADMIN.deleteMission('${UI.esc(m.mission_id)}')">Supprimer</button>
            </div>
          </div>`;
      }).join("");
    },
    addMission(){
      if(!this.ok) return;
      const lib = (document.getElementById("newMissionLib").value||"").trim();
      if(!lib){ UI.toast("adminMissionsToast","Libell√© requis.", false); return; }
      APP.missionsCatalog.push({ mission_id:"M-"+Math.random().toString(16).slice(2,8), libelle:lib, actif:true });
      document.getElementById("newMissionLib").value="";
      UI.toast("adminMissionsToast","Mission ajout√©e ‚úÖ", true);
      this.renderAll();
    },
    toggleMission(id){
      if(!this.ok) return;
      const m = APP.missionsCatalog.find(x=>x.mission_id===id);
      if(!m) return;
      m.actif = !m.actif;
      UI.toast("adminMissionsToast","Statut modifi√© ‚úÖ", true);
      this.renderAll();
    },
    deleteMission(id){
      if(!this.ok) return;
      if(!confirm("Supprimer d√©finitivement cette mission ?")) return;
      APP.missionsCatalog = APP.missionsCatalog.filter(x=>x.mission_id!==id);
      // nettoie monthMissionsOn
      Object.keys(APP.monthMissionsOn).forEach(pid=>{
        APP.monthMissionsOn[pid] = (APP.monthMissionsOn[pid]||[]).filter(mid=>mid!==id);
      });
      UI.toast("adminMissionsToast","Supprim√©e ‚úÖ", true);
      this.renderAll();
    },

    loadPeriod(){
      if(!this.ok) return;
      const pid = document.getElementById("periodeSel").value;
      if(!pid){ UI.toast("adminGroupToast","Choisis une p√©riode.", false); return; }
      this.pid = pid;
      this.renderPeriodDependent();
      UI.toast("adminGroupToast","P√©riode charg√©e ‚úÖ", true);
    },
    renderPeriodDependent(){
      // group
      const pid = this.pid || document.getElementById("periodeSel").value || "";
      const gBox = document.getElementById("adminGroupList");
      const respPill = document.getElementById("adminRespPill");
      const rSel = document.getElementById("responsableSel");

      if(!pid){
        respPill.textContent = "Responsable : ‚Äî";
        gBox.innerHTML = `<div class="itemRow"><span class="muted">Choisis une p√©riode.</span></div>`;
        rSel.innerHTML = `<option value="">‚Äî</option>`;
        // month boxes
        document.getElementById("adminMonthBox").innerHTML = `<div class="itemRow"><span class="muted">Choisis une p√©riode.</span></div>`;
        document.getElementById("adminMonthActiveList").innerHTML = `<div class="itemRow"><span class="muted">‚Äî</span></div>`;
        document.getElementById("adminRetoursList").innerHTML = `<div class="itemRow"><span class="muted">‚Äî</span></div>`;
        return;
      }

      const gp = APP.groupByPeriod[pid] || { group:[], responsable:null };
      const groupAgents = gp.group.map(aid=>APP.agents.find(a=>a.agent_id===aid)).filter(Boolean);
      const respAgent = gp.responsable ? APP.agents.find(a=>a.agent_id===gp.responsable) : null;

      respPill.textContent = "Responsable : " + (respAgent ? respAgent.nom : "‚Äî");

      if(!groupAgents.length){
        gBox.innerHTML = `<div class="itemRow"><span class="muted">Aucun agent dans le groupe.</span></div>`;
      }else{
        gBox.innerHTML = groupAgents.map(a=>`
          <div class="itemRow">
            <div>
              <div style="font-weight:950">${UI.esc(a.nom)}</div>
              <div class="muted" style="font-size:12px">(ID masqu√©)</div>
            </div>
            <button class="btn small danger" onclick="ADMIN.removeFromGroup('${UI.esc(a.agent_id)}')">Retirer</button>
          </div>
        `).join("");
      }

      rSel.innerHTML = `<option value="">‚Äî Choisir responsable ‚Äî</option>` +
        groupAgents.map(a=>`<option value="${UI.esc(a.agent_id)}">${UI.esc(a.nom)}</option>`).join("");

      // month missions
      this.renderMonthMissions(pid);
      // retours
      this.renderRetours(pid);
    },
    addToGroup(){
      if(!this.ok) return;
      const pid = document.getElementById("periodeSel").value;
      const aid = document.getElementById("addToGroupSel").value;
      if(!pid || !aid){ UI.toast("adminGroupToast","Choisis p√©riode + agent.", false); return; }
      APP.groupByPeriod[pid] = APP.groupByPeriod[pid] || { group:[], responsable:null };
      const arr = APP.groupByPeriod[pid].group;
      if(!arr.includes(aid)) arr.push(aid);
      UI.toast("adminGroupToast","Agent ajout√© ‚úÖ", true);
      this.pid = pid;
      this.renderPeriodDependent();
    },
    removeFromGroup(aid){
      if(!this.ok) return;
      const pid = this.pid || document.getElementById("periodeSel").value;
      if(!pid) return;
      const gp = APP.groupByPeriod[pid] || { group:[], responsable:null };
      gp.group = gp.group.filter(x=>x!==aid);
      if(gp.responsable===aid) gp.responsable=null;
      APP.groupByPeriod[pid]=gp;
      UI.toast("adminGroupToast","Retir√© ‚úÖ", true);
      this.renderPeriodDependent();
    },
    setResponsable(){
      if(!this.ok) return;
      const pid = this.pid || document.getElementById("periodeSel").value;
      const aid = document.getElementById("responsableSel").value;
      if(!pid || !aid){ UI.toast("adminGroupToast","Choisis un responsable.", false); return; }
      APP.groupByPeriod[pid] = APP.groupByPeriod[pid] || { group:[], responsable:null };
      if(!APP.groupByPeriod[pid].group.includes(aid)){
        UI.toast("adminGroupToast","Le responsable doit √™tre dans le groupe.", false);
        return;
      }
      APP.groupByPeriod[pid].responsable = aid;
      UI.toast("adminGroupToast","Responsable d√©fini ‚úÖ", true);
      this.renderPeriodDependent();
    },

    loadMonthMissions(){
      if(!this.ok) return;
      const pid = this.pid || document.getElementById("periodeSel").value;
      if(!pid){ UI.toast("adminMonthToast","Choisis une p√©riode.", false); return; }
      this.renderMonthMissions(pid);
      UI.toast("adminMonthToast","Charg√© ‚úÖ", true);
    },
    renderMonthMissions(pid){
      const box = document.getElementById("adminMonthBox");
      const activeBox = document.getElementById("adminMonthActiveList");

      const all = APP.missionsCatalog.filter(m=>m.actif);
      const on = new Set((APP.monthMissionsOn[pid]||[]).map(String));

      if(!all.length){
        box.innerHTML = `<div class="itemRow"><span class="muted">Aucune mission catalogue active.</span></div>`;
        activeBox.innerHTML = `<div class="itemRow"><span class="muted">‚Äî</span></div>`;
        return;
      }

      box.innerHTML = all.map(m=>{
        const checked = on.has(String(m.mission_id)) ? "checked" : "";
        return `
          <label class="itemRow" style="cursor:pointer">
            <div style="display:flex;align-items:center;gap:10px;min-width:0">
              <input type="checkbox" data-mid="${UI.esc(m.mission_id)}" ${checked} />
              <div style="font-weight:950;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${UI.esc(m.libelle)}</div>
            </div>
            <span class="muted" style="font-size:12px">(ID masqu√©)</span>
          </label>
        `;
      }).join("");

      const activeIds = (APP.monthMissionsOn[pid]||[]);
      if(!activeIds.length){
        activeBox.innerHTML = `<div class="itemRow"><span class="muted">Aucune mission active.</span></div>`;
      }else{
        const names = activeIds.map(id=>APP.missionsCatalog.find(m=>m.mission_id===id)).filter(Boolean);
        activeBox.innerHTML = names.map(m=>`
          <div class="itemRow">
            <div style="font-weight:950">${UI.esc(m.libelle)}</div>
            <span class="tag ok">Active</span>
          </div>
        `).join("");
      }
    },
    saveMonthMissions(){
      if(!this.ok) return;
      const pid = this.pid || document.getElementById("periodeSel").value;
      if(!pid){ UI.toast("adminMonthToast","Choisis une p√©riode.", false); return; }
      const checks = Array.from(document.querySelectorAll('#adminMonthBox input[type="checkbox"][data-mid]'));
      const ids = checks.filter(c=>c.checked).map(c=>c.getAttribute("data-mid"));
      APP.monthMissionsOn[pid] = ids;
      this.renderMonthMissions(pid);
      UI.toast("adminMonthToast","Enregistr√© ‚úÖ", true);
    },

    loadRetours(){
      if(!this.ok) return;
      const pid = this.pid || document.getElementById("periodeSel").value;
      if(!pid){ UI.toast("adminRetoursToast","Choisis une p√©riode.", false); return; }
      this.renderRetours(pid);
      UI.toast("adminRetoursToast","Charg√© ‚úÖ", true);
    },
    renderRetours(pid){
      const box = document.getElementById("adminRetoursList");
      const declP = APP.declarations[pid] || {};
      const activeIds = new Set((APP.monthMissionsOn[pid]||[]).map(String));

      // construit liste retours: Partiel / Non fait
      const items = [];
      Object.keys(declP).forEach(aid=>{
        const agent = APP.agents.find(a=>a.agent_id===aid);
        const perAgent = declP[aid] || {};
        Object.keys(perAgent).forEach(mid=>{
          if(!activeIds.has(String(mid))) return; // seulement missions actives
          const d = perAgent[mid] || {};
          if(d.declaration === "Partiel" || d.declaration === "Non fait"){
            const m = APP.missionsCatalog.find(x=>x.mission_id===mid);
            items.push({
              agent: agent ? agent.nom : "‚Äî",
              mission: m ? m.libelle : "‚Äî",
              declaration: d.declaration || "",
              justificatif: d.justificatif || ""
            });
          }
        });
      });

      if(!items.length){
        box.innerHTML = `<div class="itemRow"><span class="muted">Aucun retour (tout est fait).</span></div>`;
        return;
      }

      box.innerHTML = items.map(it=>`
        <div class="itemRow" style="align-items:flex-start">
          <div style="min-width:0">
            <div style="font-weight:950">${UI.esc(it.agent)}</div>
            <div class="muted" style="font-size:13px;margin-top:2px">${UI.esc(it.mission)}</div>
            <div style="margin-top:8px">
              <span class="tag ${it.declaration==="Non fait"?"bad":"ok"}">${UI.esc(it.declaration)}</span>
            </div>
            ${it.justificatif ? `<div class="muted" style="font-size:13px;margin-top:8px">Justif : ${UI.esc(it.justificatif)}</div>` : `<div class="muted" style="font-size:13px;margin-top:8px">Justif : ‚Äî</div>`}
          </div>
          <div class="muted" style="font-size:12px">(IDs masqu√©s)</div>
        </div>
      `).join("");
    },
  };

  // ===== AGENT (local demo) =====
  const AGENT = {
    ok:false,
    agent:null,
    pid:"",
    renderAll(){
      // agent periods select depends on group membership
      const pSel = document.getElementById("agentPeriodSel");
      if(!this.ok || !this.agent){
        pSel.innerHTML = `<option value="">‚Äî</option>`;
        document.getElementById("agentMissionsBox").innerHTML = `<div class="itemRow"><span class="muted">Choisis une p√©riode puis ‚ÄúCharger‚Äù.</span></div>`;
        document.getElementById("agentRespPill").textContent = "‚Äî";
        document.getElementById("agentPeriodPill").textContent = "‚Äî";
        return;
      }
      const periods = APP.periodes.filter(p=>{
        const gp = APP.groupByPeriod[p.period_id];
        return gp && (gp.group||[]).includes(this.agent.agent_id);
      });
      pSel.innerHTML = `<option value="">‚Äî Choisir p√©riode ‚Äî</option>` + periods.map(p=>`<option value="${UI.esc(p.period_id)}">${UI.esc(p.libelle)}</option>`).join("");
    },
    login(){
      const id = document.getElementById("agentSel").value;
      const code = (document.getElementById("agentCode").value||"").trim();
      if(!id || !code){ UI.toast("agentToast","S√©lection + code requis.", false); return; }
      const a = APP.agents.find(x=>x.agent_id===id);
      if(!a || !a.actif){ UI.toast("agentToast","Agent inactif.", false); return; }
      if(code !== String(a.code||"").trim()){
        this.ok=false; this.agent=null;
        UI.status("agentStatus", false, "Agent : non connect√©");
        UI.toast("agentToast","Code incorrect.", false);
        document.getElementById("agentArea").style.display="none";
        return;
      }
      this.ok=true;
      this.agent=a;
      UI.status("agentStatus", true, "Agent : " + a.nom);
      UI.toast("agentToast","Connect√© ‚úÖ", true);
      document.getElementById("agentArea").style.display="";
      this.renderAll();
    },
    loadMissions(){
      if(!this.ok || !this.agent) return;
      const pid = document.getElementById("agentPeriodSel").value;
      if(!pid){ UI.toast("agentSaveToast","Choisis une p√©riode.", false); return; }
      this.pid = pid;
      document.getElementById("agentPeriodPill").textContent = APP.periodes.find(p=>p.period_id===pid)?.libelle || pid;

      const gp = APP.groupByPeriod[pid] || { group:[], responsable:null };
      const resp = gp.responsable ? APP.agents.find(a=>a.agent_id===gp.responsable)?.nom : null;
      document.getElementById("agentRespPill").textContent = resp ? ("Resp : "+resp) : "Resp : ‚Äî";

      const active = new Set((APP.monthMissionsOn[pid]||[]).map(String));
      const missions = APP.missionsCatalog.filter(m=>m.actif && active.has(String(m.mission_id)));

      // get existing declarations
      APP.declarations[pid] = APP.declarations[pid] || {};
      APP.declarations[pid][this.agent.agent_id] = APP.declarations[pid][this.agent.agent_id] || {};
      const per = APP.declarations[pid][this.agent.agent_id];

      const box = document.getElementById("agentMissionsBox");
      if(!missions.length){
        box.innerHTML = `<div class="itemRow"><span class="muted">Aucune mission attribu√©e.</span></div>`;
        return;
      }

      box.innerHTML = missions.map(m=>{
        const d = per[m.mission_id] || { declaration:"", justificatif:"" };
        return `
          <div class="itemRow" style="align-items:flex-start">
            <div style="min-width:0;flex:1">
              <div style="font-weight:950">${UI.esc(m.libelle)}</div>
              <div class="muted" style="font-size:12px;margin-top:3px">(ID masqu√©)</div>

              <div class="row" style="margin-top:10px">
                <div>
                  <label>D√©claration</label>
                  <select data-mid="${UI.esc(m.mission_id)}" class="aDec">
                    <option value="" ${d.declaration===""?"selected":""}>‚Äî</option>
                    <option value="Fait" ${d.declaration==="Fait"?"selected":""}>Fait</option>
                    <option value="Partiel" ${d.declaration==="Partiel"?"selected":""}>Partiel</option>
                    <option value="Non fait" ${d.declaration==="Non fait"?"selected":""}>Non fait</option>
                  </select>
                </div>
                <div>
                  <label>Justificatif (si Partiel/Non fait)</label>
                  <input data-mid="${UI.esc(m.mission_id)}" class="aJust" placeholder="Justificatif"
                         value="${UI.esc(d.justificatif||"")}" />
                </div>
              </div>
            </div>
            <div class="tag ok">Mission</div>
          </div>
        `;
      }).join("");
      UI.toast("agentSaveToast","Missions charg√©es ‚úÖ", true);
    },
    save(){
      if(!this.ok || !this.agent || !this.pid){ UI.toast("agentSaveToast","Connecte-toi + charge une p√©riode.", false); return; }
      const pid = this.pid;
      const aid = this.agent.agent_id;
      APP.declarations[pid] = APP.declarations[pid] || {};
      APP.declarations[pid][aid] = APP.declarations[pid][aid] || {};
      const per = APP.declarations[pid][aid];

      const decs = Array.from(document.querySelectorAll("#agentMissionsBox .aDec"));
      const justs = Array.from(document.querySelectorAll("#agentMissionsBox .aJust"));

      const byMid = {};
      decs.forEach(sel=>{
        const mid = sel.getAttribute("data-mid");
        byMid[mid] = byMid[mid] || {};
        byMid[mid].declaration = sel.value;
      });
      justs.forEach(inp=>{
        const mid = inp.getAttribute("data-mid");
        byMid[mid] = byMid[mid] || {};
        byMid[mid].justificatif = (inp.value||"").trim();
      });

      // validation: justificatif si Partiel/Non fait
      for(const mid of Object.keys(byMid)){
        const d = byMid[mid];
        const need = (d.declaration==="Partiel" || d.declaration==="Non fait");
        if(need && !d.justificatif){
          UI.toast("agentSaveToast","Justificatif obligatoire si Partiel/Non fait.", false);
          document.getElementById("agentSavePill").className="status bad";
          document.getElementById("agentSavePill").textContent="Erreur";
          return;
        }
      }

      Object.keys(byMid).forEach(mid=>{
        per[mid] = { declaration: byMid[mid].declaration || "", justificatif: byMid[mid].justificatif || "" };
      });

      document.getElementById("agentSavePill").className="status ok";
      document.getElementById("agentSavePill").textContent="Enregistr√© ‚úÖ";
      UI.toast("agentSaveToast","Enregistr√© ‚úÖ", true);
    }
  };

  // init
  bootstrapUI();
</script>
</body>
</html>
