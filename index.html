<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Entretien CS Consenvoye</title>

  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1724; --panel2:#111b2b;
      --stroke:rgba(255,255,255,.12);
      --text:#e8eef9; --muted:rgba(232,238,249,.65);
      --accent:#ff7a00; --accent2:#ffb000;
      --ok:#1fd36b; --bad:#ff3b30;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --r:18px;
      --font: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,"Noto Sans",sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:var(--font);color:var(--text);
      background:
        radial-gradient(900px 420px at 20% 20%, rgba(255,122,0,.18), transparent 65%),
        radial-gradient(900px 420px at 80% 10%, rgba(255,176,0,.12), transparent 60%),
        linear-gradient(180deg, #06080b, var(--bg));
      min-height:100vh;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px 14px 50px}
    h1{margin:0;text-align:center;color:#ff8d1a;font-size:28px;font-weight:900}
    .subtitle{margin:6px 0 0;text-align:center;color:var(--muted);font-size:12px}
    .tabsCenter{margin:14px 0 18px;display:flex;justify-content:center;}
    .tabs{display:flex;gap:8px;align-items:center;border:1px solid var(--stroke);background:rgba(255,255,255,.02);padding:6px;border-radius:999px;box-shadow:var(--shadow);}
    .tab{border:0;background:transparent;color:var(--muted);padding:10px 14px;border-radius:999px;cursor:pointer;font-weight:900;font-size:13px;}
    .tab.active{background:linear-gradient(90deg, rgba(255,122,0,.26), rgba(255,176,0,.18));color:var(--text);}
    .btn{appearance:none;border:1px solid var(--stroke);background:rgba(255,255,255,.03);color:var(--text);border-radius:999px;padding:10px 14px;cursor:pointer;font-weight:900;font-size:13px;white-space:nowrap;}
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));border-color:transparent;color:#0b0f14;}
    .btn.danger{background:rgba(255,59,48,.14);border-color:rgba(255,59,48,.35);color:#ffd0cd}
    .btn.small{padding:8px 12px;font-size:12px}
    .btn.icon{padding:10px 12px; min-width:44px; display:inline-flex; align-items:center; justify-content:center}
    .btn.loading,.btn.primary.loading{
      background:linear-gradient(90deg,#1fd36b,#7dff9c)!important;
      border-color:transparent!important;color:#0b0f14!important;cursor:wait!important;
    }
    .btn.loading::after{content:" ‚è≥";font-weight:900}
    .btn[disabled]{opacity:.6;cursor:not-allowed}

    .card{border:1px solid var(--stroke);background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));border-radius:var(--r);padding:16px;box-shadow:var(--shadow);}
    .headRow{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .h2{margin:0;font-size:15px;font-weight:900}
    .status{font-size:12px;font-weight:900;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.02);color:var(--muted);}
    .status.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.10);color:#bdf6d2}
    .status.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.10);color:#ffd0cd}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
    input,select,textarea{width:100%;padding:11px 12px;border-radius:12px;border:1px solid var(--stroke);background:rgba(0,0,0,.25);color:var(--text);outline:none;font-size:13px;}
    textarea{min-height:90px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .row>*{flex:1;min-width:220px}
    .right{display:flex;justify-content:flex-end;gap:8px;align-items:center}
    .divider{height:1px;background:rgba(255,255,255,.09);margin:14px 0}
    .twoCol{display:grid;gap:12px}
    @media(min-width:1000px){.twoCol{grid-template-columns:1fr 1fr}}
    .scrollBox{max-height:240px;overflow:auto;border-radius:14px;border:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.18)}
    .listItem{display:flex;justify-content:space-between;gap:12px;align-items:center;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08)}
    .listItem:last-child{border-bottom:0}
    .listLeft{min-width:0}
    .listTitle{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .listSub{font-size:12px;color:rgba(232,238,249,.6);margin-top:2px}
    .pillRow{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);font-size:13px;vertical-align:top}
    .table th{color:var(--muted);text-align:left;font-weight:900}
    .table tr:last-child td{border-bottom:0}
    .toast{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);background:rgba(255,255,255,.02);color:var(--muted);font-size:13px;display:none}
    .toast.show{display:block}
    .toast.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.08);color:#c9f9db}
    .toast.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.08);color:#ffd0cd}

    /* Missions AGENT mobile lisibles (sans checkbox "fait") */
    .mCard{border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);border-radius:16px;padding:12px;margin:10px 0}
    .mTitle{font-size:16px;font-weight:900;line-height:1.2;margin-bottom:10px;white-space:normal}
    .mSelect,.mJustif{width:100%;min-height:44px;font-size:16px;border-radius:14px}
    .mJustif{margin-top:10px}

    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.70);display:none;align-items:center;justify-content:center;z-index:9999;padding:18px}
    .overlay.show{display:flex}
    .overlayCard{max-width:560px;width:100%;border-radius:18px;border:1px solid rgba(255,255,255,.14);background:rgba(15,23,36,.75);box-shadow:0 20px 60px rgba(0,0,0,.55);overflow:hidden}
    .overlayCard img{width:100%;display:block}
    .overlayHint{padding:10px 12px;font-size:12px;color:rgba(232,238,249,.75)}
    .overlayHint b{color:var(--text)}

    @media (max-width:700px){
      .wrap{padding:12px}
      input,select,textarea,button,.btn{min-height:44px;font-size:16px}
      .row>*{min-width:100%}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Entretien du centre de secours de Consenvoye</h1>
    <div class="subtitle">GitHub Pages (UI) + Apps Script (API Sheets)</div>

    <div class="tabsCenter">
      <div class="tabs">
        <button class="tab active" id="tabAgent" onclick="showView('agent')">üßë‚Äçüöí Agent</button>
        <button class="tab" id="tabAdmin" onclick="showView('admin')">üõ°Ô∏è Admin</button>
        <button class="btn" onclick="bootstrap()">Recharger</button>
      </div>
    </div>

    <!-- AGENT -->
    <div id="viewAgent" class="card">
      <div class="headRow">
        <div class="h2">Espace agent</div>
        <div class="right">
          <button class="btn icon" id="btnAgentKey" title="Changer mon code" onclick="toggleAgentKey()" style="display:none">üîë</button>
          <button class="btn danger" id="btnAgentLogout" onclick="agentLogout()" style="display:none">D√©connexion</button>
          <div class="status bad" id="agentStatus">Agent : non connect√©</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Agent</label>
          <select id="agentSel"></select>
        </div>
        <div>
          <label>Code</label>
          <input id="agentCode" placeholder="Code agent" />
        </div>
        <div class="right">
          <button class="btn primary" id="btnAgentLogin" onclick="agentLogin(event)">Se connecter</button>
        </div>
      </div>
      <div id="toastAgentLogin" class="toast"></div>

      <div id="agentKeyBox" style="display:none;margin-top:12px">
        <div class="divider"></div>
        <div class="h2" style="margin:0 0 10px 0">Changer mon code</div>
        <div class="row">
          <div>
            <label>Ancien code</label>
            <input id="agentOld" placeholder="Ancien code" />
          </div>
          <div>
            <label>Nouveau code</label>
            <input id="agentNew" placeholder="Nouveau code (min 4)" />
          </div>
          <div class="right">
            <button class="btn primary" id="btnAgentChange" onclick="agentChange(event)">Valider</button>
          </div>
        </div>
        <div id="toastAgentChange" class="toast"></div>
      </div>

      <div id="agentWork" style="display:none;margin-top:14px">
        <div class="divider"></div>

        <div class="headRow">
          <div class="h2">Missions du mois</div>
          <div class="status" id="agentPeriodPill">P√©riode : ‚Äî</div>
        </div>

        <div class="row">
          <div>
            <label>P√©riode</label>
            <select id="agentPeriodSel"></select>
          </div>
          <div class="right">
            <button class="btn primary" id="btnAgentLoad" onclick="agentLoad(event)">Charger</button>
          </div>
        </div>
        <div id="toastAgentPeriod" class="toast"></div>

        <div class="divider"></div>
        <div class="scrollBox" id="agentMissionsBox"></div>

        <div class="divider"></div>
        <label>Remarque g√©n√©rale (facultatif)</label>
        <textarea id="agentRemark" placeholder="Remarque g√©n√©rale..."></textarea>

        <div class="right" style="margin-top:10px">
          <button class="btn primary" id="btnAgentSave" onclick="agentSave(event)">Enregistrer</button>
        </div>
        <div id="toastAgentSave" class="toast"></div>
      </div>
    </div>

    <!-- ADMIN -->
    <div id="viewAdmin" class="card" style="display:none">
      <div class="headRow">
        <div class="h2">Espace admin</div>
        <div class="right">
          <button class="btn icon" id="btnAdminKey" title="Changer le code admin" onclick="toggleAdminKey()" style="display:none">üîë</button>
          <button class="btn danger" id="btnAdminLogout" onclick="adminLogout()" style="display:none">D√©connexion</button>
          <div class="status bad" id="adminStatus">Admin : non connect√©</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Code admin</label>
          <input id="adminCode" placeholder="Code admin" />
        </div>
        <div class="right">
          <button class="btn primary" id="btnAdminLogin" onclick="adminLogin(event)">Se connecter</button>
        </div>
      </div>
      <div id="toastAdminLogin" class="toast"></div>

      <div id="adminKeyBox" style="display:none;margin-top:12px">
        <div class="divider"></div>
        <div class="h2" style="margin:0 0 10px 0">Changer le code admin</div>
        <div class="row">
          <div>
            <label>Ancien code</label>
            <input id="adminOld" placeholder="Ancien code" />
          </div>
          <div>
            <label>Nouveau code</label>
            <input id="adminNew" placeholder="Nouveau code (min 4)" />
          </div>
          <div class="right">
            <button class="btn primary" id="btnAdminChange" onclick="adminChange(event)">Valider</button>
          </div>
        </div>
        <div id="toastAdminChange" class="toast"></div>
      </div>

      <div id="adminWork" style="display:none;margin-top:14px">
        <div class="divider"></div>

        <!-- Agents + Catalogue -->
        <div class="twoCol">
          <div class="card">
            <div class="headRow"><div class="h2">üë• Agents</div></div>
            <div class="row">
              <div>
                <label>Nom</label>
                <input id="newAgentName" placeholder="Nom Pr√©nom" />
              </div>
              <div>
                <label>Code</label>
                <input id="newAgentCode" value="0000" />
              </div>
              <div class="right">
                <button class="btn primary" id="btnAddAgent" onclick="adminAddAgent(event)">Ajouter</button>
              </div>
            </div>
            <div id="toastAdminAgents" class="toast"></div>
            <div class="divider"></div>
            <div class="scrollBox" id="adminAgentsList"></div>
          </div>

          <div class="card">
            <div class="headRow"><div class="h2">üìö Catalogue missions</div></div>
            <div class="row">
              <div>
                <label>Libell√©</label>
                <input id="newMissionLib" placeholder="Ex : Nettoyage" />
              </div>
              <div class="right">
                <button class="btn primary" id="btnAddMission" onclick="adminAddMission(event)">Ajouter</button>
              </div>
            </div>
            <div id="toastAdminMissions" class="toast"></div>
            <div class="divider"></div>
            <div class="scrollBox" id="adminMissionsList"></div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- P√©riode / Groupe / Responsable -->
        <div class="twoCol">
          <div class="card">
            <div class="headRow">
              <div class="h2">üìÖ P√©riode / Groupe / Responsable</div>
              <div class="status" id="pillResp">Responsable : ‚Äî</div>
            </div>

            <div class="row">
              <div>
                <label>P√©riode</label>
                <select id="adminPeriodSel"></select>
              </div>
              <div class="right">
                <button class="btn primary" id="btnLoadPeriod" onclick="adminLoadPeriod(event)">Charger</button>
              </div>
            </div>
            <div id="toastAdminPeriod" class="toast"></div>

            <div class="divider"></div>
            <div class="row">
              <div>
                <label>Ajouter au groupe</label>
                <select id="addToGroupSel"></select>
              </div>
              <div class="right">
                <button class="btn primary" id="btnAddToGroup" onclick="adminAddToGroup(event)">Ajouter</button>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>Responsable</label>
                <select id="respSel"></select>
              </div>
              <div class="right">
                <button class="btn primary" id="btnSetResp" onclick="adminSetResp(event)">D√©finir</button>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="headRow"><div class="h2">üë• Agents du groupe</div></div>
            <div class="scrollBox" id="groupList"></div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- Missions actives -->
        <div class="twoCol">
          <div class="card">
            <div class="headRow"><div class="h2">‚úÖ Missions actives (p√©riode)</div></div>
            <div class="right" style="margin-bottom:10px">
              <button class="btn" id="btnLoadActive" onclick="adminLoadActive(event)">Charger</button>
              <button class="btn primary" id="btnSaveActive" onclick="adminSaveActive(event)">Enregistrer</button>
            </div>
            <div id="toastAdminActive" class="toast"></div>
            <div class="scrollBox" id="activeBox"></div>
          </div>
          <div class="card">
            <div class="headRow"><div class="h2">üìå Actives (r√©sum√©)</div></div>
            <div class="scrollBox" id="activeSummary"></div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- Retours -->
        <div class="card">
          <div class="headRow"><div class="h2">üßæ Retours (Partiel / Non fait)</div></div>
          <div class="right">
            <button class="btn" id="btnLoadRetours" onclick="adminLoadRetours(event)">Charger (par p√©riode)</button>
          </div>
          <div id="toastAdminRetours" class="toast"></div>
          <div class="divider"></div>
          <div class="scrollBox">
            <table class="table">
              <thead>
                <tr><th>P√©riode</th><th>Agent</th><th>Mission</th><th>D√©claration</th><th>Justificatif</th></tr>
              </thead>
              <tbody id="retoursTbl">
                <tr><td class="ghost" colspan="5">‚Äî</td></tr>
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </div>

  </div>

  <div class="overlay" id="doneOverlay">
    <div class="overlayCard">
      <img id="doneImg" alt="Missions accomplies" src="missions-accomplies.jpg">
      <div class="overlayHint">Double-clic / double-tap pour fermer. <b>‚úî</b></div>
    </div>
  </div>

<script>
/* ======================================================
   CONFIG : mets ici ton URL Apps Script /exec
   ====================================================== */
const API_EXEC = "https://script.google.com/macros/s/AKfycbwTo8mKf9yDCmFDZbT03-nbxv5QVLcMjNEGuvlL25alCktBLX9P-G3i4NTVMw048DE/exec";

/* ======================================================
   JSONP helper (compat GitHub Pages)
   ====================================================== */
function jsonp(action, params={}){
  return new Promise((resolve, reject)=>{
    if(!API_EXEC || API_EXEC.includes("COLLE_ICI")){
      reject(new Error("API_EXEC_missing"));
      return;
    }
    const cb = "__cb_" + Math.random().toString(36).slice(2) + "_" + Date.now();
    window[cb] = (data)=>{
      try{ delete window[cb]; }catch(_){}
      try{ script.remove(); }catch(_){}
      resolve(data);
    };
    const q = new URLSearchParams();
    q.set("action", action);
    q.set("callback", cb);
    Object.entries(params).forEach(([k,v])=> q.set(k, v==null?"":String(v)));
    q.set("_ts", String(Date.now()));
    const script = document.createElement("script");
    script.src = API_EXEC + "?" + q.toString();
    script.onerror = ()=>{ try{ delete window[cb]; }catch(_){}
      reject(new Error("jsonp_error"));
    };
    document.head.appendChild(script);
  });
}

/* ======================================================
   UI helpers
   ====================================================== */
const $ = (id)=>document.getElementById(id);
function toast(id,msg,ok){
  const el=$(id); if(!el) return;
  el.className="toast show " + (ok?"ok":"bad");
  el.textContent=msg||"";
}
function toastHide(id){
  const el=$(id); if(!el) return;
  el.className="toast"; el.textContent="";
}
function setStatus(id,txt,ok){
  const el=$(id); if(!el) return;
  el.textContent=txt;
  el.className="status " + (ok===true?"ok":ok===false?"bad":"");
}
function setLoading(btn,on){
  if(!btn) return;
  btn.classList.toggle("loading", !!on);
  btn.disabled = !!on;
}
function showView(which){
  $("tabAgent").classList.toggle("active", which==="agent");
  $("tabAdmin").classList.toggle("active", which==="admin");
  $("viewAgent").style.display = (which==="agent") ? "" : "none";
  $("viewAdmin").style.display = (which==="admin") ? "" : "none";
}

/* ======================================================
   STATE
   ====================================================== */
let ADMIN_OK=false;
let ADMIN_CODE="";
let CUR_PERIOD="";
let AGENT_OK=false;
let AGENT_ID="";

let CACHE = { agents:[], periodes:[], catalog:[] };

/* ======================================================
   Boot
   ====================================================== */
async function bootstrap(){
  try{
    const res = await jsonp("bootstrap");
    if(!res || !res.ok) return;
    CACHE.agents = res.agents || [];
    CACHE.periodes = res.periodes || [];
    CACHE.catalog = res.catalog || [];
    fillPublicAgents();
    fillAdminPeriodes();
    fillAdminCatalog();
    // si admin connect√©, refresh list agents
    if(ADMIN_OK) await refreshAdminAgents();
  }catch(e){
    console.error(e);
  }
}
bootstrap();
showView("agent");

/* ======================================================
   Renders
   ====================================================== */
function fillPublicAgents(){
  $("agentSel").innerHTML = `<option value="">‚Äî Choisir agent ‚Äî</option>` +
    CACHE.agents.map(a=>`<option value="${a.agent_id}">${a.name}</option>`).join("");
  $("addToGroupSel").innerHTML = `<option value="">‚Äî Choisir agent ‚Äî</option>` +
    CACHE.agents.map(a=>`<option value="${a.agent_id}">${a.name}</option>`).join("");
}
function fillAdminPeriodes(){
  $("adminPeriodSel").innerHTML = `<option value="">‚Äî Choisir p√©riode ‚Äî</option>` +
    CACHE.periodes.map(p=>`<option value="${p.period_id}">${p.label}</option>`).join("");
}
function fillAdminCatalog(){
  renderAdminMissions(CACHE.catalog);
}

function renderAdminAgents(list){
  const box = $("adminAgentsList");
  if(!list.length){
    box.innerHTML = `<div class="listItem"><div class="listLeft"><div class="listTitle ghost">‚Äî</div></div></div>`;
    return;
  }
  box.innerHTML = list.map(a=>`
    <div class="listItem">
      <div class="listLeft">
        <div class="listTitle">${a.nom}</div>
        <div class="listSub">${a.actif ? "Actif ‚úÖ":"Inactif ‚ùå"}</div>
      </div>
      <div class="pillRow">
        <button class="btn small" onclick="adminToggleAgent('${a.agent_id}', ${a.actif ? "false":"true"})">${a.actif ? "D√©sactiver":"Activer"}</button>
        <button class="btn small" onclick="adminResetAgent('${a.agent_id}')">Reset 0000</button>
        <button class="btn small danger" onclick="adminDeleteAgent('${a.agent_id}')">Supprimer</button>
      </div>
    </div>
  `).join("");
}

function renderAdminMissions(list){
  const box = $("adminMissionsList");
  if(!list.length){
    box.innerHTML = `<div class="listItem"><div class="listLeft"><div class="listTitle ghost">‚Äî</div></div></div>`;
    return;
  }
  box.innerHTML = list.map(m=>`
    <div class="listItem">
      <div class="listLeft">
        <div class="listTitle">${m.label}</div>
        <div class="listSub">${m.active ? "Active ‚úÖ":"Inactive ‚ùå"}</div>
      </div>
      <div class="pillRow">
        <button class="btn small" onclick="adminToggleMission('${m.mission_id}', ${m.active ? "false":"true"})">${m.active ? "D√©sactiver":"Activer"}</button>
        <button class="btn small danger" onclick="adminDeleteMission('${m.mission_id}')">Supprimer</button>
      </div>
    </div>
  `).join("");
}

function renderGroup(group){
  const box=$("groupList");
  if(!group.length){
    box.innerHTML = `<div class="ghost" style="padding:10px">Aucun groupe charg√©.</div>`;
    return;
  }
  box.innerHTML = group.map(a=>`
    <div class="listItem">
      <div class="listLeft"><div class="listTitle">${a.nom}</div></div>
      <div class="pillRow">
        <button class="btn small danger" onclick="adminRemoveFromGroup('${a.agent_id}')">Retirer</button>
      </div>
    </div>
  `).join("");
}

function renderActive(all, active){
  const on = new Set(active.map(x=>x.mission_id));
  $("activeBox").innerHTML = all.map(m=>`
    <label class="listItem" style="cursor:pointer">
      <div class="listLeft"><div class="listTitle">${m.label}</div></div>
      <input type="checkbox" data-mid="${m.mission_id}" ${on.has(m.mission_id)?"checked":""} style="width:18px;height:18px">
    </label>
  `).join("") || `<div class="ghost" style="padding:10px">Aucune mission.</div>`;

  $("activeSummary").innerHTML = all.filter(m=>on.has(m.mission_id)).map(m=>`
    <div class="listItem"><div class="listLeft"><div class="listTitle">${m.label}</div></div></div>
  `).join("") || `<div class="ghost" style="padding:10px">Aucune mission active.</div>`;
}

function renderRetours(items){
  const tb=$("retoursTbl");
  if(!items.length){
    tb.innerHTML = `<tr><td class="ghost" colspan="5">Aucun retour.</td></tr>`;
    return;
  }
  tb.innerHTML = items.map(it=>`
    <tr>
      <td>${CUR_PERIOD}</td>
      <td>${it.agent}</td>
      <td>${it.mission}</td>
      <td>${it.declaration}</td>
      <td>${it.justificatif||""}</td>
    </tr>
  `).join("");
}

function renderAgentMissions(list){
  const box=$("agentMissionsBox");
  if(!list.length){
    box.innerHTML = `<div class="ghost" style="padding:10px">Aucune mission.</div>`;
    return;
  }
  box.innerHTML = list.map(m=>`
    <div class="mCard">
      <div class="mTitle">${m.label}</div>
      <select class="mSelect" data-mid="${m.mission_id}">
        <option value="Fait" ${m.declaration==="Fait"?"selected":""}>Fait</option>
        <option value="Partiel" ${m.declaration==="Partiel"?"selected":""}>Partiel</option>
        <option value="Non fait" ${m.declaration==="Non fait"?"selected":""}>Non fait</option>
      </select>
      <input class="mJustif" data-justif="${m.mission_id}" placeholder="Justificatif si Partiel/Non fait" value="${m.justificatif||""}">
    </div>
  `).join("");
}

/* ======================================================
   ADMIN actions
   ====================================================== */
function toggleAdminKey(){ $("adminKeyBox").style.display = ($("adminKeyBox").style.display==="none"||!$("adminKeyBox").style.display) ? "" : "none"; }
function adminLogout(){
  ADMIN_OK=false; ADMIN_CODE=""; CUR_PERIOD="";
  $("adminWork").style.display="none";
  $("btnAdminKey").style.display="none";
  $("btnAdminLogout").style.display="none";
  setStatus("adminStatus","Admin : non connect√©",false);
}

async function adminLogin(ev){
  toastHide("toastAdminLogin");
  const btn=$("btnAdminLogin");
  const code=$("adminCode").value.trim();
  if(!code){ toast("toastAdminLogin","Code requis.",false); return; }
  setLoading(btn,true);
  try{
    const res = await jsonp("adminLogin",{ code });
    if(!res || !res.ok){ toast("toastAdminLogin","Code admin incorrect.",false); setLoading(btn,false); return; }
    ADMIN_OK=true; ADMIN_CODE=code;
    setStatus("adminStatus","Admin : connect√© ‚úÖ",true);
    $("adminWork").style.display="";
    $("btnAdminKey").style.display="";
    $("btnAdminLogout").style.display="";
    toast("toastAdminLogin","Admin connect√© ‚úÖ",true);
    await refreshAdminAgents();
    setLoading(btn,false);
  }catch(e){
    setLoading(btn,false);
    toast("toastAdminLogin","Erreur API",false);
  }
}

async function adminChange(ev){
  toastHide("toastAdminChange");
  const btn=$("btnAdminChange");
  if(!ADMIN_OK){ toast("toastAdminChange","Non connect√©.",false); return; }
  const old_code=$("adminOld").value.trim();
  const new_code=$("adminNew").value.trim();
  if(!old_code||!new_code){ toast("toastAdminChange","Ancien + nouveau requis.",false); return; }
  setLoading(btn,true);
  try{
    const res = await jsonp("adminChangeCode",{ admin_code:ADMIN_CODE, old_code, new_code });
    setLoading(btn,false);
    if(!res || !res.ok){ toast("toastAdminChange",(res&&res.message)||"Erreur",false); return; }
    toast("toastAdminChange","Code admin modifi√© ‚úÖ",true);
    ADMIN_CODE=new_code;
    $("adminOld").value=""; $("adminNew").value="";
  }catch(e){
    setLoading(btn,false);
    toast("toastAdminChange","Erreur API",false);
  }
}

async function refreshAdminAgents(){
  const res = await jsonp("adminListAgents",{ admin_code: ADMIN_CODE });
  if(res && res.ok){
    renderAdminAgents(res.agents||[]);
  }
}

async function adminAddAgent(ev){
  toastHide("toastAdminAgents");
  const btn=$("btnAddAgent");
  if(!ADMIN_OK){ toast("toastAdminAgents","Non connect√©.",false); return; }
  const nom=$("newAgentName").value.trim();
  const code=$("newAgentCode").value.trim()||"0000";
  if(!nom){ toast("toastAdminAgents","Nom requis.",false); return; }
  setLoading(btn,true);
  try{
    const res = await jsonp("adminAddAgent",{ admin_code:ADMIN_CODE, nom, code });
    setLoading(btn,false);
    if(!res || !res.ok){ toast("toastAdminAgents",(res&&res.message)||"Erreur",false); return; }
    toast("toastAdminAgents","Agent ajout√© ‚úÖ",true);
    $("newAgentName").value=""; $("newAgentCode").value="0000";
    // refresh minimal
    await bootstrap();
    await refreshAdminAgents();
  }catch(e){
    setLoading(btn,false);
    toast("toastAdminAgents","Erreur API",false);
  }
}

async function adminToggleAgent(agent_id, actif){
  if(!ADMIN_OK) return;
  await jsonp("adminToggleAgent",{ admin_code:ADMIN_CODE, agent_id, actif: actif ? "TRUE":"FALSE" });
  await refreshAdminAgents();
  await bootstrap();
}
async function adminResetAgent(agent_id){
  if(!ADMIN_OK) return;
  await jsonp("adminResetAgentCode",{ admin_code:ADMIN_CODE, agent_id });
  await refreshAdminAgents();
  await bootstrap();
}
async function adminDeleteAgent(agent_id){
  if(!ADMIN_OK) return;
  if(!confirm("Supprimer d√©finitivement cet agent ?")) return;
  await jsonp("adminDeleteAgent",{ admin_code:ADMIN_CODE, agent_id });
  await refreshAdminAgents();
  await bootstrap();
}

async function adminAddMission(ev){
  toastHide("toastAdminMissions");
  const btn=$("btnAddMission");
  if(!ADMIN_OK){ toast("toastAdminMissions","Non connect√©.",false); return; }
  const libelle=$("newMissionLib").value.trim();
  if(!libelle){ toast("toastAdminMissions","Libell√© requis.",false); return; }
  setLoading(btn,true);
  try{
    const res = await jsonp("adminAddMission",{ admin_code:ADMIN_CODE, libelle });
    setLoading(btn,false);
    if(!res || !res.ok){ toast("toastAdminMissions",(res&&res.message)||"Erreur",false); return; }
    toast("toastAdminMissions","Mission ajout√©e ‚úÖ",true);
    $("newMissionLib").value="";
    await bootstrap();
  }catch(e){
    setLoading(btn,false);
    toast("toastAdminMissions","Erreur API",false);
  }
}
async function adminToggleMission(mission_id, actif){
  if(!ADMIN_OK) return;
  await jsonp("adminToggleMission",{ admin_code:ADMIN_CODE, mission_id, actif: actif ? "TRUE":"FALSE" });
  await bootstrap();
  if(CUR_PERIOD) await adminLoadActive({target:$("btnLoadActive")});
}
async function adminDeleteMission(mission_id){
  if(!ADMIN_OK) return;
  if(!confirm("Supprimer d√©finitivement cette mission ?")) return;
  await jsonp("adminDeleteMission",{ admin_code:ADMIN_CODE, mission_id });
  await bootstrap();
  if(CUR_PERIOD) await adminLoadActive({target:$("btnLoadActive")});
}

async function adminLoadPeriod(ev){
  toastHide("toastAdminPeriod");
  const btn=$("btnLoadPeriod");
  if(!ADMIN_OK){ toast("toastAdminPeriod","Non connect√©.",false); return; }
  const pid=$("adminPeriodSel").value;
  if(!pid){ toast("toastAdminPeriod","Choisis une p√©riode.",false); return; }
  setLoading(btn,true);
  try{
    const res = await jsonp("adminLoadPeriode",{ admin_code:ADMIN_CODE, period_id: pid });
    setLoading(btn,false);
    if(!res || !res.ok){ toast("toastAdminPeriod",(res&&res.message)||"Erreur",false); return; }
    CUR_PERIOD = pid;
    renderGroup(res.group||[]);
    $("respSel").innerHTML = `<option value="">‚Äî Choisir ‚Äî</option>` +
      (res.group||[]).map(a=>`<option value="${a.agent_id}">${a.nom}</option>`).join("");
    $("pillResp").textContent = "Responsable : " + (res.responsable ? res.responsable.nom : "‚Äî");
    toast("toastAdminPeriod","P√©riode charg√©e ‚úÖ",true);

    // load active + retours
    await adminLoadActive({target:$("btnLoadActive")});
    await adminLoadRetours({target:$("btnLoadRetours")});
  }catch(e){
    setLoading(btn,false);
    toast("toastAdminPeriod","Erreur API",false);
  }
}

async function adminAddToGroup(ev){
  toastHide("toastAdminPeriod");
  const btn=$("btnAddToGroup");
  if(!ADMIN_OK){ toast("toastAdminPeriod","Non connect√©.",false); return; }
  if(!CUR_PERIOD){ toast("toastAdminPeriod","Charge une p√©riode d‚Äôabord.",false); return; }
  const aid=$("addToGroupSel").value;
  if(!aid){ toast("toastAdminPeriod","Choisis un agent.",false); return; }
  setLoading(btn,true);
  try{
    const res = await jsonp("adminAddToGroup",{ admin_code:ADMIN_CODE, period_id:CUR_PERIOD, agent_id:aid });
    setLoading(btn,false);
    if(!res || !res.ok){ toast("toastAdminPeriod",(res&&res.message)||"Erreur",false); return; }
    toast("toastAdminPeriod","Agent ajout√© au groupe ‚úÖ",true);
    await adminLoadPeriod({target:$("btnLoadPeriod")});
  }catch(e){
    setLoading(btn,false);
    toast("toastAdminPeriod","Erreur API",false);
  }
}
async function adminRemoveFromGroup(agent_id){
  if(!ADMIN_OK || !CUR_PERIOD) return;
  await jsonp("adminRemoveFromGroup",{ admin_code:ADMIN_CODE, period_id:CUR_PERIOD, agent_id });
  await adminLoadPeriod({target:$("btnLoadPeriod")});
}
async function adminSetResp(ev){
  toastHide("toastAdminPeriod");
  const btn=$("btnSetResp");
  if(!ADMIN_OK){ toast("toastAdminPeriod","Non connect√©.",false); return; }
  if(!CUR_PERIOD){ toast("toastAdminPeriod","Charge une p√©riode d‚Äôabord.",false); return; }
  const aid=$("respSel").value;
  if(!aid){ toast("toastAdminPeriod","Choisis un responsable.",false); return; }
  setLoading(btn,true);
  try{
    const res = await jsonp("adminSetResponsable",{ admin_code:ADMIN_CODE, period_id:CUR_PERIOD, agent_id:aid });
    setLoading(btn,false);
    if(!res || !res.ok){ toast("toastAdminPeriod",(res&&res.message)||"Erreur",false); return; }
    toast("toastAdminPeriod","Responsable d√©fini ‚úÖ",true);
    await adminLoadPeriod({target:$("btnLoadPeriod")});
  }catch(e){
    setLoading(btn,false);
    toast("toastAdminPeriod","Erreur API",false);
  }
}

async function adminLoadActive(ev){
  toastHide("toastAdminActive");
  const btn = ev?.target || $("btnLoadActive");
  if(!ADMIN_OK){ toast("toastAdminActive","Non connect√©.",false); return; }
  if(!CUR_PERIOD){ toast("toastAdminActive","Charge une p√©riode d‚Äôabord.",false); return; }
  setLoading(btn,true);
  try{
    const res = await jsonp("adminGetActiveMissions",{ admin_code:ADMIN_CODE, period_id:CUR_PERIOD });
    setLoading(btn,false);
    if(!res || !res.ok){ toast("toastAdminActive",(res&&res.message)||"Erreur",false); return; }
    renderActive(res.all||[], res.active||[]);
    toast("toastAdminActive","Charg√© ‚úÖ",true);
  }catch(e){
    setLoading(btn,false);
    toast("toastAdminActive","Erreur API",false);
  }
}
async function adminSaveActive(ev){
  toastHide("toastAdminActive");
  const btn = ev?.target || $("btnSaveActive");
  if(!ADMIN_OK){ toast("toastAdminActive","Non connect√©.",false); return; }
  if(!CUR_PERIOD){ toast("toastAdminActive","Charge une p√©riode d‚Äôabord.",false); return; }
  const ids = Array.from($("activeBox").querySelectorAll('input[type="checkbox"][data-mid]'))
    .filter(c=>c.checked)
    .map(c=>c.getAttribute("data-mid"));
  setLoading(btn,true);
  try{
    const res = await jsonp("adminSaveActiveMissions",{ admin_code:ADMIN_CODE, period_id:CUR_PERIOD, ids: JSON.stringify(ids) });
    setLoading(btn,false);
    if(!res || !res.ok){ toast("toastAdminActive",(res&&res.message)||"Erreur",false); return; }
    toast("toastAdminActive","Enregistr√© ‚úÖ",true);
    await adminLoadActive({target:$("btnLoadActive")});
  }catch(e){
    setLoading(btn,false);
    toast("toastAdminActive","Erreur API",false);
  }
}

async function adminLoadRetours(ev){
  toastHide("toastAdminRetours");
  const btn = ev?.target || $("btnLoadRetours");
  if(!ADMIN_OK){ toast("toastAdminRetours","Non connect√©.",false); return; }
  if(!CUR_PERIOD){ toast("toastAdminRetours","Charge une p√©riode d‚Äôabord.",false); return; }
  setLoading(btn,true);
  try{
    const res = await jsonp("adminLoadRetours",{ admin_code:ADMIN_CODE, period_id:CUR_PERIOD });
    setLoading(btn,false);
    if(!res || !res.ok){ toast("toastAdminRetours",(res&&res.message)||"Erreur",false); return; }
    renderRetours(res.items||[]);
    toast("toastAdminRetours","Charg√© ‚úÖ",true);
  }catch(e){
    setLoading(btn,false);
    toast("toastAdminRetours","Erreur API",false);
  }
}

/* ======================================================
   AGENT actions
   ====================================================== */
function toggleAgentKey(){ $("agentKeyBox").style.display = ($("agentKeyBox").style.display==="none"||!$("agentKeyBox").style.display) ? "" : "none"; }
function agentLogout(){
  AGENT_OK=false; AGENT_ID=""; CUR_PERIOD="";
  $("agentWork").style.display="none";
  $("btnAgentKey").style.display="none";
  $("btnAgentLogout").style.display="none";
  $("agentKeyBox").style.display="none";
  setStatus("agentStatus","Agent : non connect√©",false);
}

async function agentLogin(ev){
  toastHide("toastAgentLogin");
  const btn=$("btnAgentLogin");
  const agent_id=$("agentSel").value;
  const code=$("agentCode").value.trim();
  if(!agent_id || !code){ toast("toastAgentLogin","S√©lection + code requis.",false); return; }
  setLoading(btn,true);
  try{
    const res = await jsonp("agentLogin",{ agent_id, code });
    setLoading(btn,false);
    if(!res || !res.ok){ toast("toastAgentLogin","Code incorrect.",false); return; }
    AGENT_OK=true; AGENT_ID=res.agent.agent_id;
    setStatus("agentStatus","Agent : "+res.agent.nom,true);
    $("agentWork").style.display="";
    $("btnAgentKey").style.display="";
    $("btnAgentLogout").style.display="";
    $("agentPeriodSel").innerHTML = `<option value="">‚Äî Choisir p√©riode ‚Äî</option>` +
      (res.periodes||[]).map(p=>`<option value="${p.period_id}">${p.label}</option>`).join("");
    toast("toastAgentLogin","Connect√© ‚úÖ",true);
    if(res.agent.must_change){
      $("agentKeyBox").style.display="";
      toast("toastAgentChange","‚ö†Ô∏è Changement de code obligatoire.",false);
    }
  }catch(e){
    setLoading(btn,false);
    toast("toastAgentLogin","Erreur API",false);
  }
}

async function agentChange(ev){
  toastHide("toastAgentChange");
  const btn=$("btnAgentChange");
  if(!AGENT_OK){ toast("toastAgentChange","Non connect√©.",false); return; }
  const old_code=$("agentOld").value.trim();
  const new_code=$("agentNew").value.trim();
  if(!old_code||!new_code){ toast("toastAgentChange","Ancien + nouveau requis.",false); return; }
  setLoading(btn,true);
  try{
    const res = await jsonp("agentChangeCode",{ agent_id:AGENT_ID, old_code, new_code });
    setLoading(btn,false);
    if(!res || !res.ok){ toast("toastAgentChange",(res&&res.message)||"Erreur",false); return; }
    toast("toastAgentChange","Code modifi√© ‚úÖ",true);
    $("agentOld").value=""; $("agentNew").value="";
  }catch(e){
    setLoading(btn,false);
    toast("toastAgentChange","Erreur API",false);
  }
}

async function agentLoad(ev){
  toastHide("toastAgentPeriod");
  const btn=$("btnAgentLoad");
  if(!AGENT_OK){ toast("toastAgentPeriod","Non connect√©.",false); return; }
  const pid=$("agentPeriodSel").value;
  if(!pid){ toast("toastAgentPeriod","Choisis une p√©riode.",false); return; }
  setLoading(btn,true);
  try{
    const res = await jsonp("agentLoadPeriode",{ agent_id:AGENT_ID, period_id:pid });
    setLoading(btn,false);
    if(!res || !res.ok){ toast("toastAgentPeriod",(res&&res.message)||"Erreur",false); return; }
    CUR_PERIOD=pid;
    $("agentPeriodPill").textContent="P√©riode : "+pid;
    $("agentRemark").value=res.remark||"";
    renderAgentMissions(res.missions||[]);
    toast("toastAgentPeriod","Charg√© ‚úÖ",true);
  }catch(e){
    setLoading(btn,false);
    toast("toastAgentPeriod","Erreur API",false);
  }
}

async function agentSave(ev){
  toastHide("toastAgentSave");
  const btn=$("btnAgentSave");
  if(!AGENT_OK){ toast("toastAgentSave","Non connect√©.",false); return; }
  const pid=$("agentPeriodSel").value;
  if(!pid){ toast("toastAgentSave","Choisis une p√©riode.",false); return; }
  if(!confirm("Confirmer l‚Äôenregistrement ?")) return;

  const selects = Array.from($("agentMissionsBox").querySelectorAll("select[data-mid]"));
  const items = selects.map(sel=>{
    const mid = sel.getAttribute("data-mid");
    const decl = sel.value;
    const just = $("agentMissionsBox").querySelector(`input[data-justif="${CSS.escape(mid)}"]`)?.value || "";
    return { mission_id: mid, declaration: decl, justificatif: just };
  });

  setLoading(btn,true);
  try{
    const res = await jsonp("agentSaveDeclarations",{
      agent_id:AGENT_ID, period_id:pid,
      items: JSON.stringify(items),
      remark: $("agentRemark").value || ""
    });
    setLoading(btn,false);
    if(!res || !res.ok){
      const msg = (res && res.message==="justificatif_required") ? "Justificatif obligatoire si Partiel/Non fait" : ((res&&res.message)||"Erreur");
      toast("toastAgentSave",msg,false);
      return;
    }
    toast("toastAgentSave","Enregistr√© ‚úÖ",true);
    if(res.all_done) $("doneOverlay").classList.add("show");
    else $("doneOverlay").classList.remove("show");
  }catch(e){
    setLoading(btn,false);
    toast("toastAgentSave","Erreur API",false);
  }
}

/* overlay close */
$("doneImg").addEventListener("dblclick", ()=> $("doneOverlay").classList.remove("show"));
(function(){
  let lastTap=0;
  $("doneImg").addEventListener("touchend", ()=>{
    const now=Date.now();
    if(now-lastTap<350) $("doneOverlay").classList.remove("show");
    lastTap=now;
  }, {passive:true});
})();
</script>
</body>
</html>
