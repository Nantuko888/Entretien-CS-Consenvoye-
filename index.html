<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Entretien CS Consenvoye</title>

  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1724;
      --stroke:rgba(255,255,255,.12);
      --text:#e8eef9; --muted:rgba(232,238,249,.72);
      --accent:#ff7a00; --accent2:#ffb000;
      --danger:#ff3b30; --ok:#1fd36b;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --r:18px;
      --font: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,"Noto Sans",sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:var(--font);color:var(--text);
      background:
        radial-gradient(900px 420px at 20% 20%, rgba(255,122,0,.18), transparent 65%),
        radial-gradient(900px 420px at 80% 10%, rgba(255,176,0,.12), transparent 60%),
        linear-gradient(180deg, #06080b, var(--bg));
      min-height:100vh;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:16px 12px 48px}
    h1{margin:0;font-size:28px;font-weight:900;letter-spacing:.2px;color:#ff8d1a;text-align:center;text-shadow:0 2px 14px rgba(255,122,0,.18);}
    .subtitle{margin:6px 0 0;color:var(--muted);font-size:12px;text-align:center}
    .tabsCenter{margin:14px 0 18px;display:flex;justify-content:center;}
    .tabs{display:flex;gap:8px;align-items:center;border:1px solid var(--stroke);background:rgba(255,255,255,.02);padding:6px;border-radius:999px;box-shadow:var(--shadow);}
    .tab{border:0;background:transparent;color:var(--muted);padding:10px 14px;border-radius:999px;cursor:pointer;font-weight:900;font-size:13px;}
    .tab.active{background:linear-gradient(90deg, rgba(255,122,0,.26), rgba(255,176,0,.18));color:var(--text);}
    .btn{appearance:none;border:1px solid var(--stroke);background:rgba(255,255,255,.03);color:var(--text);border-radius:999px;padding:10px 14px;cursor:pointer;font-weight:900;font-size:13px;transition:.15s transform ease,.15s background ease,.15s border-color ease;white-space:nowrap;}
    .btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.2);background:rgba(255,255,255,.06)}
    .btn.primary{background:linear-gradient(90deg, var(--accent), var(--accent2));border-color:transparent;color:#0b0f14;box-shadow:0 12px 26px rgba(255,122,0,.18);}
    .btn.danger{background:rgba(255,59,48,.14);border-color:rgba(255,59,48,.35);color:#ffd0cd}
    .btn.small{padding:8px 12px;font-size:12px}
    .btn.loading,.btn.primary.loading{
      background: linear-gradient(90deg, #1fd36b, #7dff9c) !important;
      border-color: transparent !important;
      color:#0b0f14 !important;
      cursor: wait !important;
      opacity: .95;
    }
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .card{border:1px solid var(--stroke);background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));border-radius:var(--r);padding:16px;box-shadow:var(--shadow);}
    .headRow{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;flex-wrap:wrap}
    .h2{margin:0;font-size:15px;font-weight:900}
    .status{font-size:12px;font-weight:900;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.02);color:var(--muted);display:inline-flex;align-items:center;gap:8px;white-space:nowrap;}
    .status.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.10);color:#bdf6d2}
    .status.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.10);color:#ffd0cd}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
    input, select, textarea{width:100%;padding:11px 12px;border-radius:12px;border:1px solid var(--stroke);background:rgba(0,0,0,.25);color:var(--text);outline:none;font-size:14px;}
    textarea{min-height:90px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .row > *{flex:1;min-width:220px}
    .divider{height:1px;background:rgba(255,255,255,.09);margin:14px 0}
    .toast{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);background:rgba(255,255,255,.02);color:var(--muted);font-size:13px;display:none}
    .toast.show{display:block}
    .toast.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.08);color:#c9f9db}
    .toast.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.08);color:#ffd0cd}

    .list{display:grid;gap:10px}
    .item{
      border:1px solid var(--stroke);border-radius:14px;padding:12px;
      background:rgba(0,0,0,.18);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .item b{font-size:15px}
    .pill{font-size:12px;font-weight:900;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.02);color:var(--muted)}
    .pill.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.10);color:#bdf6d2}
    .pill.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.10);color:#ffd0cd}

    .keyBtn{
      border:1px solid var(--stroke);background:rgba(255,255,255,.04);
      border-radius:999px;padding:10px 12px;cursor:pointer;font-weight:900;
    }

    .imgDone{
      width:100%;max-width:560px;margin:8px auto 0;display:block;border-radius:16px;
      border:1px solid var(--stroke);
    }

    @media(max-width:700px){
      .wrap{max-width:none;width:100%;margin:0;padding:12px}
      .row > *{min-width:100%}
      h1{font-size:26px}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Entretien CS Consenvoye</h1>
    <div class="subtitle">Agent : saisie ‚Ä¢ Admin : configuration ‚Ä¢ Justificatif obligatoire si <b>Partiel</b> / <b>Non fait</b></div>

    <div class="tabsCenter">
      <div class="tabs">
        <button class="tab active" id="tabAgent" onclick="showView('agent')">üßë‚Äçüöí Agent</button>
        <button class="tab" id="tabAdmin" onclick="showView('admin')">üõ°Ô∏è Admin</button>
        <button class="btn" onclick="reloadAll()">Recharger</button>
      </div>
    </div>

    <!-- AGENT -->
    <div id="viewAgent" class="card">
      <div class="headRow">
        <div class="h2">Connexion agent</div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="keyBtn" id="agentKey" style="display:none" title="Changer le code" onclick="openAgentChangeCode()">üîë</button>
          <button class="btn danger small" id="agentLogout" style="display:none" onclick="agentDoLogout()">D√©connexion</button>
          <div class="status" id="agentStatus">Agent : non connect√©</div>
        </div>
      </div>

      <div class="row" id="agentLoginRow">
        <div>
          <label>Agent</label>
          <select id="agentSel"></select>
        </div>
        <div>
          <label>Code</label>
          <input id="agentCode" placeholder="Code agent" />
        </div>
        <div class="right">
          <button class="btn primary" id="btnAgentLogin" onclick="agentLogin()">Se connecter</button>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Change code obligatoire -->
      <div id="agentMustChange" style="display:none">
        <div class="h2" style="margin:0 0 8px 0">Changement de code obligatoire</div>
        <div class="row">
          <div>
            <label>Ancien code</label>
            <input id="agentOldCode" placeholder="Ancien code" />
          </div>
          <div>
            <label>Nouveau code (min 4)</label>
            <input id="agentNewCode" placeholder="Nouveau code" />
          </div>
          <div class="right">
            <button class="btn primary" id="btnAgentChange" onclick="agentChangeCode()">Valider</button>
          </div>
        </div>
        <div id="agentChangeToast" class="toast"></div>
        <div class="divider"></div>
      </div>

      <!-- Missions -->
      <div id="agentWork" style="display:none">
        <div class="row">
          <div>
            <label>P√©riode</label>
            <select id="agentPeriodSel"></select>
          </div>
          <div class="right">
            <button class="btn primary" id="btnAgentLoad" onclick="agentLoadPeriod()">Charger</button>
          </div>
        </div>

        <div class="divider"></div>

        <div id="agentDoneWrap" style="display:none">
          <img class="imgDone" id="imgDone" src="./missions-accomplies.jpg" alt="missions accomplies" />
          <div class="ghost" style="text-align:center;margin-top:6px;color:var(--muted);font-size:12px">
            (double-tap / double-clic pour masquer)
          </div>
          <div class="divider"></div>
        </div>

        <div id="agentMissions" class="list"></div>

        <div class="divider"></div>

        <label>Remarque g√©n√©rale (facultatif)</label>
        <textarea id="agentRemark" placeholder="Remarque g√©n√©rale‚Ä¶"></textarea>

        <div class="row" style="margin-top:10px">
          <div class="right">
            <button class="btn primary" id="btnAgentSave" onclick="agentSave()">Enregistrer</button>
          </div>
        </div>
        <div id="agentToast" class="toast"></div>
      </div>
    </div>

    <!-- ADMIN -->
    <div id="viewAdmin" class="card" style="display:none">
      <div class="headRow">
        <div class="h2">Connexion admin</div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="keyBtn" id="adminKey" style="display:none" title="Changer le code admin" onclick="openAdminChangeCode()">üîë</button>
          <button class="btn danger small" id="adminLogout" style="display:none" onclick="adminDoLogout()">D√©connexion</button>
          <div class="status" id="adminStatus">Admin : non connect√©</div>
        </div>
      </div>

      <div class="row" id="adminLoginRow">
        <div>
          <label>Code admin</label>
          <input id="adminCode" placeholder="Code admin" />
        </div>
        <div class="right">
          <button class="btn primary" id="btnAdminLogin" onclick="adminLogin()">Se connecter</button>
        </div>
      </div>
      <div id="adminToast" class="toast"></div>

      <div class="divider"></div>

      <!-- Changement code admin (via cl√©) -->
      <div id="adminChangeWrap" style="display:none">
        <div class="h2" style="margin:0 0 8px 0">Changer le code admin</div>
        <div class="row">
          <div>
            <label>Nouveau code (min 4)</label>
            <input id="adminNewCode" placeholder="Nouveau code" />
          </div>
          <div class="right">
            <button class="btn primary" id="btnAdminChange" onclick="adminChangeCode()">Valider</button>
          </div>
        </div>
        <div id="adminChangeToast" class="toast"></div>
        <div class="divider"></div>
      </div>

      <!-- Zone admin (version simple propre) -->
      <div id="adminWork" style="display:none">
        <div class="headRow">
          <div class="h2">Panneau admin</div>
          <button class="btn" id="btnAdminReload" onclick="adminReload()">Recharger</button>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="right">
            <button class="btn primary" id="btnLoadAgents" onclick="adminLoadAgents()">Charger les agents</button>
          </div>
        </div>

        <div id="adminAgents" class="list" style="margin-top:12px"></div>
      </div>
    </div>

  </div>

<script>
/*** METS ICI TON URL /exec Apps Script ***/
const API_EXEC = "https://script.google.com/macros/s/AKfycbwTo8mKf9yDCmFDZbT03-nbxv5QVLcMjNEGuvlL25alCktBLX9P-G3i4NTVMw048DE/exec"; // ex: https://script.google.com/macros/s/XXXX/exec

function esc(s){ return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function toast(id,msg,ok){
  const el=document.getElementById(id);
  if(!el) return;
  el.className="toast show " + (ok?"ok":"bad");
  el.textContent=msg||"";
}
function clearToast(id){
  const el=document.getElementById(id);
  if(!el) return;
  el.className="toast";
  el.textContent="";
}
function setLoading(btn,on){
  if(!btn) return;
  btn.classList.toggle("loading", !!on);
  btn.disabled = !!on;
}
function showView(v){
  document.getElementById("tabAgent").classList.toggle("active", v==="agent");
  document.getElementById("tabAdmin").classList.toggle("active", v==="admin");
  document.getElementById("viewAgent").style.display = (v==="agent") ? "" : "none";
  document.getElementById("viewAdmin").style.display = (v==="admin") ? "" : "none";
}

/* JSONP helper */
function jsonp(action, params){
  return new Promise((resolve,reject)=>{
    const cb = "cb_" + action + "_" + Date.now() + "_" + Math.random().toString(16).slice(2);
    window[cb] = (data)=>{ cleanup(); resolve(data); };
    const cleanup = ()=>{
      try{ delete window[cb]; }catch(_){}
      if(s && s.parentNode) s.parentNode.removeChild(s);
    };
    const q = new URLSearchParams({ action, callback: cb, ...params });
    const s = document.createElement("script");
    s.src = API_EXEC + "?" + q.toString();
    s.onerror = ()=>{ cleanup(); reject(new Error("load_error")); };
    document.head.appendChild(s);
  });
}

/* ---------- Data local ---------- */
let AG = { ok:false, agent_id:"", nom:"", must_change:false };
let AD = { ok:false, code:"" };
let currentPeriod = "";

async function reloadAll(){
  await loadPublicAgents();
  toast("agentToast","",true); clearToast("agentToast");
  toast("adminToast","",true); clearToast("adminToast");
}

/* ---------- PUBLIC: agents list ---------- */
async function loadPublicAgents(){
  const sel = document.getElementById("agentSel");
  sel.innerHTML = `<option value="">‚Äî Chargement‚Ä¶ ‚Äî</option>`;
  try{
    const res = await jsonp("listAgentsPublic",{});
    if(!res || !res.ok) throw new Error("bad");
    sel.innerHTML = `<option value="">‚Äî Choisir agent ‚Äî</option>` + (res.agents||[]).map(a=>
      `<option value="${esc(a.agent_id)}">${esc(a.nom)}</option>`
    ).join("");
  }catch(e){
    sel.innerHTML = `<option value="">‚Äî Erreur ‚Äî</option>`;
  }
}

/* ---------- AGENT ---------- */
function agentUIConnected(on){
  document.getElementById("agentKey").style.display = on ? "" : "none";
  document.getElementById("agentLogout").style.display = on ? "" : "none";
  document.getElementById("agentWork").style.display = on ? "" : "none";
}

async function agentLogin(){
  clearToast("agentToast");
  const btn = document.getElementById("btnAgentLogin");
  const agent_id = document.getElementById("agentSel").value;
  const code = document.getElementById("agentCode").value.trim();
  if(!agent_id || !code) return;

  setLoading(btn,true);
  try{
    const res = await jsonp("agentLogin",{ agent_id, code });
    if(!res || !res.ok){
      document.getElementById("agentStatus").className="status bad";
      document.getElementById("agentStatus").textContent="Agent : code incorrect";
      setLoading(btn,false);
      return;
    }
    AG.ok=true; AG.agent_id=res.agent.agent_id; AG.nom=res.agent.nom; AG.must_change=!!res.must_change;

    document.getElementById("agentStatus").className="status ok";
    document.getElementById("agentStatus").textContent="Agent : " + AG.nom;

    // cl√© + d√©connexion visibles
    document.getElementById("agentKey").style.display="";
    document.getElementById("agentLogout").style.display="";

    // Changement obligatoire ?
    document.getElementById("agentMustChange").style.display = AG.must_change ? "" : "none";
    document.getElementById("agentWork").style.display = AG.must_change ? "none" : "";

    // Charge ses p√©riodes
    await agentLoadPeriods();

  }catch(e){
    document.getElementById("agentStatus").className="status bad";
    document.getElementById("agentStatus").textContent="Agent : erreur r√©seau";
  }finally{
    setLoading(btn,false);
  }
}

async function agentLoadPeriods(){
  const sel = document.getElementById("agentPeriodSel");
  sel.innerHTML = `<option value="">‚Äî Chargement‚Ä¶ ‚Äî</option>`;
  try{
    const res = await jsonp("agentListMyPeriodes",{ agent_id: AG.agent_id });
    if(!res || !res.ok) throw new Error("bad");
    sel.innerHTML = `<option value="">‚Äî Choisir p√©riode ‚Äî</option>` + (res.periodes||[]).map(p=>
      `<option value="${esc(p.period_id)}">${esc(p.libelle||p.period_id)}</option>`
    ).join("");
  }catch(e){
    sel.innerHTML = `<option value="">‚Äî Erreur ‚Äî</option>`;
  }
}

function agentDoLogout(){
  AG = { ok:false, agent_id:"", nom:"", must_change:false };
  currentPeriod = "";
  document.getElementById("agentCode").value="";
  document.getElementById("agentRemark").value="";
  document.getElementById("agentWork").style.display="none";
  document.getElementById("agentMustChange").style.display="none";
  document.getElementById("agentKey").style.display="none";
  document.getElementById("agentLogout").style.display="none";
  document.getElementById("agentStatus").className="status";
  document.getElementById("agentStatus").textContent="Agent : non connect√©";
  document.getElementById("agentMissions").innerHTML="";
  document.getElementById("agentDoneWrap").style.display="none";
}

function openAgentChangeCode(){
  // ouvre/ferme bloc obligatoire comme ‚Äúpanneau‚Äù
  const w = document.getElementById("agentMustChange");
  w.style.display = (w.style.display==="none" || !w.style.display) ? "" : "none";
}

async function agentChangeCode(){
  clearToast("agentChangeToast");
  const btn = document.getElementById("btnAgentChange");
  const old_code = document.getElementById("agentOldCode").value.trim();
  const new_code = document.getElementById("agentNewCode").value.trim();
  if(!old_code || !new_code) return;

  setLoading(btn,true);
  try{
    const res = await jsonp("agentChangeCode",{ agent_id: AG.agent_id, old_code, new_code });
    if(!res || !res.ok){
      toast("agentChangeToast", res?.message || "Erreur", false);
      setLoading(btn,false);
      return;
    }
    toast("agentChangeToast","Code modifi√© ‚úÖ", true);
    AG.must_change=false;
    document.getElementById("agentMustChange").style.display="none";
    document.getElementById("agentWork").style.display="";
  }catch(e){
    toast("agentChangeToast","Erreur r√©seau", false);
  }finally{
    setLoading(btn,false);
  }
}

async function agentLoadPeriod(){
  clearToast("agentToast");
  const btn = document.getElementById("btnAgentLoad");
  const pid = document.getElementById("agentPeriodSel").value;
  if(!AG.ok || !pid) return;

  setLoading(btn,true);
  try{
    const res = await jsonp("agentLoadPeriod",{ agent_id: AG.agent_id, period_id: pid });
    if(!res || !res.ok){
      toast("agentToast", res?.message || "Erreur", false);
      setLoading(btn,false);
      return;
    }
    currentPeriod = pid;

    // Remarque (facultatif)
    document.getElementById("agentRemark").value = res.remark || "";

    // image missions accomplies (et double tap pour masquer)
    const key = "hide_done_" + AG.agent_id + "_" + pid;
    const hideDone = localStorage.getItem(key) === "1";
    const doneWrap = document.getElementById("agentDoneWrap");
    const img = document.getElementById("imgDone");

    if(res.allDone && !hideDone){
      doneWrap.style.display="";
    }else{
      doneWrap.style.display="none";
    }

    // double tap / double click => hide
    img.ondblclick = () => {
      localStorage.setItem(key,"1");
      doneWrap.style.display="none";
    };
    // double tap mobile
    let lastTap=0;
    img.ontouchend = () => {
      const now=Date.now();
      if(now-lastTap<350){
        localStorage.setItem(key,"1");
        doneWrap.style.display="none";
      }
      lastTap=now;
    };

    // Missions (max 10 visibles, scroll si plus tard)
    const list = document.getElementById("agentMissions");
    const missions = (res.missions||[]).slice(0,10);
    if(res.allDone){
      list.innerHTML = ""; // on cache la liste quand tout est fait
    }else{
      list.innerHTML = missions.map(m=>{
        return `
          <div class="item" data-mid="${esc(m.mission_id)}">
            <div style="min-width:0">
              <b>${esc(m.libelle)}</b>
            </div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end">
              <select class="dec">
                <option value="" ${m.declaration===""?"selected":""}>‚Äî</option>
                <option value="Fait" ${m.declaration==="Fait"?"selected":""}>Fait</option>
                <option value="Partiel" ${m.declaration==="Partiel"?"selected":""}>Partiel</option>
                <option value="Non fait" ${m.declaration==="Non fait"?"selected":""}>Non fait</option>
              </select>
              <input class="justif" placeholder="Justificatif si Partiel/Non fait" value="${esc(m.justificatif||"")}" />
            </div>
          </div>
        `;
      }).join("");
    }

  }catch(e){
    toast("agentToast","Erreur r√©seau", false);
  }finally{
    setLoading(btn,false);
  }
}

async function agentSave(){
  clearToast("agentToast");
  const btn = document.getElementById("btnAgentSave");
  if(!AG.ok || !currentPeriod) return;

  setLoading(btn,true);
  try{
    const items = Array.from(document.querySelectorAll("#agentMissions .item")).map(div=>{
      const mid = div.getAttribute("data-mid");
      const dec = div.querySelector(".dec")?.value || "";
      const just = div.querySelector(".justif")?.value || "";
      return { mission_id: mid, declaration: dec, justificatif: just };
    });

    const remark = document.getElementById("agentRemark").value || "";

    const res = await jsonp("agentSave",{
      agent_id: AG.agent_id,
      period_id: currentPeriod,
      items: JSON.stringify(items),
      remark
    });

    if(!res || !res.ok){
      toast("agentToast", res?.message || "Erreur", false);
      setLoading(btn,false);
      return;
    }
    toast("agentToast", "Enregistrement effectu√© ‚úÖ", true);

    // recharge pour appliquer ‚Äúmissions accomplies‚Äù
    await agentLoadPeriod();

  }catch(e){
    toast("agentToast","Erreur r√©seau", false);
  }finally{
    setLoading(btn,false);
  }
}

/* ---------- ADMIN ---------- */
function adminDoLogout(){
  AD={ok:false,code:""};
  document.getElementById("adminKey").style.display="none";
  document.getElementById("adminLogout").style.display="none";
  document.getElementById("adminWork").style.display="none";
  document.getElementById("adminChangeWrap").style.display="none";
  document.getElementById("adminStatus").className="status";
  document.getElementById("adminStatus").textContent="Admin : non connect√©";
}

function openAdminChangeCode(){
  const w=document.getElementById("adminChangeWrap");
  w.style.display = (w.style.display==="none" || !w.style.display) ? "" : "none";
}

async function adminLogin(){
  clearToast("adminToast");
  const btn=document.getElementById("btnAdminLogin");
  const code=document.getElementById("adminCode").value.trim();
  if(!code) return;

  setLoading(btn,true);
  try{
    const res = await jsonp("adminLogin",{ code });
    if(!res || !res.ok){
      document.getElementById("adminStatus").className="status bad";
      document.getElementById("adminStatus").textContent="Admin : code incorrect";
      toast("adminToast","Erreur connexion admin.", false);
      setLoading(btn,false);
      return;
    }
    AD.ok=true; AD.code=code;
    document.getElementById("adminStatus").className="status ok";
    document.getElementById("adminStatus").textContent="Admin connect√© ‚úÖ";
    document.getElementById("adminKey").style.display="";
    document.getElementById("adminLogout").style.display="";
    document.getElementById("adminWork").style.display="";
    toast("adminToast","Admin connect√© ‚úÖ", true);
  }catch(e){
    toast("adminToast","Erreur r√©seau", false);
  }finally{
    setLoading(btn,false);
  }
}

async function adminChangeCode(){
  clearToast("adminChangeToast");
  const btn=document.getElementById("btnAdminChange");
  const new_code=document.getElementById("adminNewCode").value.trim();
  if(!new_code) return;
  setLoading(btn,true);
  try{
    const res = await jsonp("adminChangeAdminCode",{ code: AD.code, new_code });
    if(!res || !res.ok){
      toast("adminChangeToast", res?.message || "Erreur", false);
      setLoading(btn,false); return;
    }
    toast("adminChangeToast","Code admin chang√© ‚úÖ", true);
  }catch(e){
    toast("adminChangeToast","Erreur r√©seau", false);
  }finally{
    setLoading(btn,false);
  }
}

async function adminReload(){
  if(!AD.ok) return;
  document.getElementById("adminAgents").innerHTML="";
  clearToast("adminToast");
}

async function adminLoadAgents(){
  const btn=document.getElementById("btnLoadAgents");
  const box=document.getElementById("adminAgents");
  setLoading(btn,true);
  box.innerHTML="";
  try{
    const res = await jsonp("adminListAgents",{ code: AD.code });
    if(!res || !res.ok) throw new Error("bad");
    const agents = res.agents || [];
    box.innerHTML = agents.map(a=>{
      const pill = a.actif ? `<span class="pill ok">Actif ‚úÖ</span>` : `<span class="pill bad">Inactif ‚ùå</span>`;
      return `<div class="item"><div style="min-width:0"><b>${esc(a.nom)}</b></div>${pill}</div>`;
    }).join("");
  }catch(e){
    box.innerHTML = "";
    toast("adminToast","Erreur load_error", false);
  }finally{
    setLoading(btn,false);
  }
}

/* init */
loadPublicAgents();
</script>
</body>
</html>
