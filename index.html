<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Entretien CS Consenvoye</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f1724;
      --panel2:#111b2b;
      --stroke:rgba(255,255,255,.12);
      --text:#e8eef9;
      --muted:rgba(232,238,249,.72);
      --accent:#ff7a00;
      --accent2:#ffb000;
      --danger:#ff3b30;
      --ok:#1fd36b;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --r:18px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial, "Noto Sans", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:var(--font);color:var(--text);
      background:
        radial-gradient(900px 420px at 20% 20%, rgba(255,122,0,.18), transparent 65%),
        radial-gradient(900px 420px at 80% 10%, rgba(255,176,0,.12), transparent 60%),
        linear-gradient(180deg, #06080b, var(--bg));
      min-height:100vh;
      overflow-x:hidden;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px 12px 40px}
    h1{
      margin:0;
      font-size:28px;
      font-weight:900;
      letter-spacing:.2px;
      color:#ff8d1a;
      text-shadow:0 2px 14px rgba(255,122,0,.18);
      text-align:center;
    }
    .subtitle{margin:6px 0 0;color:var(--muted);font-size:12px;text-align:center}

    .tabsCenter{margin:14px 0 14px;display:flex;justify-content:center;}
    .tabs{
      display:flex;gap:8px;align-items:center;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.02);
      padding:6px;border-radius:999px;
      box-shadow:var(--shadow);
      flex-wrap:wrap;
      justify-content:center;
    }
    .tab{
      border:0;background:transparent;color:var(--muted);
      padding:10px 14px;border-radius:999px;
      cursor:pointer;font-weight:900;font-size:13px;
    }
    .tab.active{
      background:linear-gradient(90deg, rgba(255,122,0,.26), rgba(255,176,0,.18));
      color:var(--text);
    }

    .btn{
      appearance:none;border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);color:var(--text);
      border-radius:999px;padding:10px 14px;cursor:pointer;
      font-weight:900;font-size:13px;transition:.15s transform ease,.15s background ease,.15s border-color ease;
      white-space:nowrap;
      min-height:44px;
    }
    .btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.2);background:rgba(255,255,255,.06)}
    .btn.primary{
      background:linear-gradient(90deg, var(--accent), var(--accent2));
      border-color:transparent;color:#0b0f14;
      box-shadow:0 12px 26px rgba(255,122,0,.18);
    }
    .btn.danger{background:rgba(255,59,48,.14);border-color:rgba(255,59,48,.35);color:#ffd0cd}
    .btn.small{padding:8px 12px;font-size:12px;min-height:38px}

    /* loading => vert */
    .btn.loading, .btn.primary.loading{
      background:linear-gradient(90deg, #1fd36b, #7dff9c) !important;
      border-color:transparent !important;
      color:#0b0f14 !important;
      cursor:wait !important;
      opacity:.95;
      box-shadow:0 12px 26px rgba(31,211,107,.18) !important;
    }
    .btn[disabled]{opacity:.65;cursor:not-allowed}

    .card{
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border-radius:var(--r);
      padding:16px;
      box-shadow:var(--shadow);
    }
    .headRow{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;flex-wrap:wrap}
    .h2{margin:0;font-size:15px;font-weight:900}

    .pillRow{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{
      font-size:12px;font-weight:900;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.02);
      color:var(--muted);
      display:inline-flex;align-items:center;gap:8px;
    }
    .pill.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.10);color:#bdf6d2}
    .pill.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.10);color:#ffd0cd}

    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
    input, select, textarea{
      width:100%;
      padding:11px 12px;border-radius:12px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
      font-size:14px;
      min-height:44px;
    }
    textarea{min-height:88px;resize:vertical}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .row > *{flex:1;min-width:240px}
    .right{display:flex;justify-content:flex-end}

    .divider{height:1px;background:rgba(255,255,255,.09);margin:14px 0}

    /* 2 colonnes sur PC */
    .twoCol{display:grid;gap:12px}
    @media(min-width:1000px){ .twoCol{grid-template-columns:1fr 1fr;} }

    /* scroll boxes */
    .scrollBox{
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.18);
      border-radius:14px;
      overflow:auto;
      max-height:260px;
    }
    .listItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .listItem:last-child{border-bottom:0}
    .listLeft{min-width:0}
    .listTitle{
      font-weight:900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .listSub{font-size:12px;color:rgba(232,238,249,.55)}

    .toast{
      margin-top:10px;padding:10px 12px;border-radius:12px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.02);
      color:var(--muted);
      font-size:13px;
      display:none;
    }
    .toast.show{display:block}
    .toast.ok{border-color:rgba(31,211,107,.35);background:rgba(31,211,107,.08);color:#c9f9db}
    .toast.bad{border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.08);color:#ffd0cd}

    /* checkbox list clean */
    .checkRow{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .checkRow:last-child{border-bottom:0}
    .checkRow input[type="checkbox"]{width:20px;height:20px;min-height:auto}

    /* image "missions accomplies" */
    .doneOverlay{
      margin-top:14px;
      border:1px solid rgba(31,211,107,.35);
      background:rgba(31,211,107,.08);
      border-radius:14px;
      overflow:hidden;
      display:none;
    }
    .doneOverlay img{width:100%;display:block}
    .doneOverlay .hint{padding:10px 12px;font-size:12px;color:rgba(232,238,249,.75)}
    .doneOverlay.show{display:block}

    /* mobile: un peu moins gros */
    @media(max-width:700px){
      h1{font-size:24px}
      .row > *{min-width:100%}
      .btn{width:100%}
      .right{justify-content:stretch}
      .tabs{width:100%}
      .tab{flex:1;text-align:center}
      .scrollBox{max-height:220px}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Entretien du centre de secours de Consenvoye</h1>
    <div class="subtitle">JTUB (GitHub) ‚Ä¢ Sheets (moteur) ‚Äî Nommage <b>tout au pluriel</b></div>

    <div class="tabsCenter">
      <div class="tabs">
        <button class="tab active" id="tabAgent" onclick="showViews('agents')">üßë‚Äçüöí Agent</button>
        <button class="tab" id="tabAdmin" onclick="showViews('admins')">üõ°Ô∏è Admin</button>
      </div>
    </div>

    <!-- ======================= AGENTS ======================= -->
    <div id="viewAgents" class="card">
      <div class="headRow">
        <div class="h2">Espace agent</div>
        <div class="pillRow">
          <button class="btn small" id="btnAgentsKey" style="display:none" onclick="toggleAgentsKey()">üîë</button>
          <button class="btn small danger" id="btnAgentsLogout" style="display:none" onclick="agentsLogouts()">D√©connexion</button>
          <span class="pill" id="pillAgentsStatus">Agent : non connect√©</span>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Agent</label>
          <select id="agentsSel"></select>
        </div>
        <div>
          <label>Code</label>
          <input id="agentsCode" placeholder="Code agent" />
        </div>
        <div class="right">
          <button class="btn primary" id="btnAgentsLogin" onclick="agentsLogins(event)">Se connecter</button>
        </div>
      </div>

      <div id="toastAgentsLogin" class="toast"></div>

      <!-- changement code agent -->
      <div id="boxAgentsKey" style="display:none;margin-top:12px">
        <div class="divider"></div>
        <div class="headRow">
          <div class="h2">Changer mon code</div>
        </div>
        <div class="row">
          <div>
            <label>Ancien code</label>
            <input id="agentsOldCode" placeholder="Ancien code" />
          </div>
          <div>
            <label>Nouveau code</label>
            <input id="agentsNewCode" placeholder="Nouveau code (min 4)" />
          </div>
          <div class="right">
            <button class="btn primary" id="btnAgentsChange" onclick="agentsChangePasswords(event)">Valider</button>
          </div>
        </div>
        <div id="toastAgentsChange" class="toast"></div>
      </div>

      <!-- travail agent -->
      <div id="boxAgentsWork" style="display:none;margin-top:12px">
        <div class="divider"></div>

        <div class="row">
          <div>
            <label>P√©riode</label>
            <select id="agentsPeriodsSel"></select>
          </div>
          <div class="right">
            <button class="btn primary" id="btnAgentsLoad" onclick="agentsLoadPeriods(event)">Charger</button>
          </div>
        </div>

        <div class="divider"></div>

        <label>Remarque g√©n√©rale (facultatif)</label>
        <textarea id="agentsRemark" placeholder="Remarque g√©n√©rale‚Ä¶"></textarea>

        <div class="divider"></div>

        <div class="headRow">
          <div class="h2">Missions du mois</div>
          <span class="pill" id="pillAgentsPeriod">P√©riode : ‚Äî</span>
        </div>

        <div class="scrollBox" id="boxAgentsMissions">
          <div class="listItem"><div class="listLeft"><div class="listTitle" style="color:rgba(232,238,249,.55)">Choisis une p√©riode puis ‚ÄúCharger‚Äù.</div></div></div>
        </div>

        <div class="right" style="margin-top:10px">
          <button class="btn primary" id="btnAgentsSave" onclick="agentsSaves(event)">Enregistrer</button>
        </div>

        <div id="toastAgentsSave" class="toast"></div>

        <!-- image missions accomplies -->
        <div id="doneOverlay" class="doneOverlay">
          <img id="doneImg" alt="missions accomplies" src="missions-accomplies.jpg" />
          <div class="hint">Double-clic / double-tap sur l‚Äôimage pour la masquer.</div>
        </div>
      </div>
    </div>

    <!-- ======================= ADMINS ======================= -->
    <div id="viewAdmins" class="card" style="display:none">
      <div class="headRow">
        <div class="h2">Espace admin</div>
        <div class="pillRow">
          <button class="btn small" id="btnAdminsKey" style="display:none" onclick="toggleAdminsKey()">üîë</button>
          <button class="btn small danger" id="btnAdminsLogout" style="display:none" onclick="adminsLogouts()">D√©connexion</button>
          <span class="pill" id="pillAdminsStatus">Admin : non connect√©</span>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Code admin</label>
          <input id="adminsCode" placeholder="Code admin" />
        </div>
        <div class="right">
          <button class="btn primary" id="btnAdminsLogin" onclick="adminsLogins(event)">Se connecter</button>
        </div>
      </div>

      <div id="toastAdminsLogin" class="toast"></div>

      <!-- changement code admin (via üîë) -->
      <div id="boxAdminsKey" style="display:none;margin-top:12px">
        <div class="divider"></div>
        <div class="headRow"><div class="h2">Changer le code admin</div></div>
        <div class="row">
          <div>
            <label>Ancien code</label>
            <input id="adminsOldCode" placeholder="Ancien code" />
          </div>
          <div>
            <label>Nouveau code</label>
            <input id="adminsNewCode" placeholder="Nouveau code (min 4)" />
          </div>
          <div class="right">
            <button class="btn primary" id="btnAdminsChange" onclick="adminsChangePasswords(event)">Valider</button>
          </div>
        </div>
        <div id="toastAdminsChange" class="toast"></div>
      </div>

      <!-- contenu admin -->
      <div id="boxAdminsWork" style="display:none;margin-top:12px">
        <div class="divider"></div>

        <!-- Agents + Missions catalogue -->
        <div class="twoCol">
          <div class="card">
            <div class="headRow"><div class="h2">Agents</div></div>
            <div class="row">
              <div>
                <label>Nom Pr√©nom</label>
                <input id="adminsNewAgentName" placeholder="Nom Pr√©nom" />
              </div>
              <div>
                <label>Code</label>
                <input id="adminsNewAgentCode" value="0000" />
              </div>
              <div class="right">
                <button class="btn primary" id="btnAdminsAddAgent" onclick="adminsAddAgents(event)">Ajouter</button>
              </div>
            </div>

            <div id="toastAdminsAgents" class="toast"></div>

            <div class="divider"></div>
            <div class="h2" style="margin:0 0 10px 0">Liste agents</div>
            <div class="scrollBox" id="boxAdminsAgents"></div>
          </div>

          <div class="card">
            <div class="headRow"><div class="h2">Catalogue missions</div></div>
            <div class="row">
              <div>
                <label>Libell√©</label>
                <input id="adminsNewMissionLib" placeholder="Ex : Nettoyage" />
              </div>
              <div class="right">
                <button class="btn primary" id="btnAdminsAddMission" onclick="adminsAddMissions(event)">Ajouter</button>
              </div>
            </div>

            <div id="toastAdminsMissions" class="toast"></div>

            <div class="divider"></div>
            <div class="h2" style="margin:0 0 10px 0">Liste missions</div>
            <div class="scrollBox" id="boxAdminsMissions"></div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- P√©riodes / Groupe / Missions actives / Retours -->
        <div class="card">
          <div class="headRow">
            <div class="h2">P√©riodes / Groupe / Missions actives / Retours</div>
            <span class="pill" id="pillAdminsResponsables">Responsable : ‚Äî</span>
          </div>

          <div class="row">
            <div>
              <label>P√©riode</label>
              <select id="adminsPeriodsSel"></select>
            </div>
            <div class="right">
              <button class="btn primary" id="btnAdminsLoadPeriod" onclick="adminsLoadPeriods(event)">Charger</button>
            </div>
          </div>

          <div id="toastAdminsPeriods" class="toast"></div>

          <div class="divider"></div>

          <div class="twoCol">
            <div class="card">
              <div class="headRow"><div class="h2">Ajouter au groupe</div></div>
              <div class="row">
                <div>
                  <label>Agent</label>
                  <select id="adminsAddToGroupsSel"></select>
                </div>
                <div class="right">
                  <button class="btn primary" id="btnAdminsAddToGroups" onclick="adminsAddToGroups(event)">Ajouter</button>
                </div>
              </div>

              <div class="divider"></div>

              <div class="headRow"><div class="h2">D√©finir responsable</div></div>
              <div class="row">
                <div>
                  <label>Responsable</label>
                  <select id="adminsResponsablesSel"></select>
                </div>
                <div class="right">
                  <button class="btn primary" id="btnAdminsSetResponsables" onclick="adminsSetResponsables(event)">D√©finir</button>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="headRow"><div class="h2">Groupe</div></div>
              <div class="scrollBox" id="boxAdminsGroups"></div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="twoCol">
            <div class="card">
              <div class="headRow"><div class="h2">Missions actives</div></div>
              <div class="scrollBox" id="boxAdminsActiveMissions"></div>
              <div class="right" style="margin-top:10px">
                <button class="btn primary" id="btnAdminsSaveActiveMissions" onclick="adminsSaveActiveMissions(event)">Enregistrer missions actives</button>
              </div>
              <div id="toastAdminsActiveMissions" class="toast"></div>
            </div>

            <div class="card">
              <div class="headRow"><div class="h2">Retours (Partiel / Non fait)</div></div>
              <div class="right" style="margin-bottom:10px">
                <button class="btn" id="btnAdminsLoadRetours" onclick="adminsLoadRetours(event)">Charger retours</button>
              </div>
              <div class="scrollBox" id="boxAdminsRetours"></div>
              <div id="toastAdminsRetours" class="toast"></div>
            </div>
          </div>

        </div>
      </div>
    </div>

  </div>

<script>
/* =============================
   CONFIG
   ============================= */

/** ‚ö†Ô∏è Quand tu voudras brancher l‚ÄôAPI Apps Script :
 * - colle ton URL /exec ici
 * - mets MODE_DEMO = false
 */
const MODE_DEMO = true;
const API_EXEC = "https://script.google.com/macros/s/AKfycbwTo8mKf9yDCmFDZbT03-nbxv5QVLcMjNEGuvlL25alCktBLX9P-G3i4NTVMw048DE/exec"; // ex: https://script.google.com/macros/s/XXXXX/exec

/* =============================
   ETAT
   ============================= */
const STATE = {
  admins: { ok:false, code:"" },
  agents: { ok:false, agent_id:"", name:"", code:"", must_change:false },
  data: {
    agents: [],
    missions: [],
    periods: [],
    groups: [], // groupe de la p√©riode courante
    responsables: null, // responsable de la p√©riode courante
    active_missions: [], // missions actives de la p√©riode courante
    agent_work: [] // missions agent
  },
  current: { period_id:"" }
};

/* =============================
   OUTILS UI
   ============================= */
function esc(s){return String(s??"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
function $(id){return document.getElementById(id);}

function showToasts(id,msg,ok){
  const el=$(id); if(!el) return;
  el.className="toast show "+(ok?"ok":"bad"); el.textContent=msg||"";
}
function hideToasts(id){
  const el=$(id); if(!el) return;
  el.className="toast"; el.textContent="";
}

function setLoadings(btn,on){
  if(!btn) return;
  btn.classList.toggle("loading", !!on);
  btn.disabled = !!on;
}

function showViews(which){
  $("tabAgent").classList.toggle("active", which==="agents");
  $("tabAdmin").classList.toggle("active", which==="admins");
  $("viewAgents").style.display = (which==="agents") ? "" : "none";
  $("viewAdmins").style.display = (which==="admins") ? "" : "none";
}

function setPills(id, txt, kind){
  const el=$(id); if(!el) return;
  el.textContent = txt;
  el.className = "pill" + (kind ? (" "+kind) : "");
}

/* =============================
   API LAYER (JSONP)
   ============================= */
function jsonps(url){
  return new Promise((resolve,reject)=>{
    const cb = "cb_"+Math.random().toString(36).slice(2);
    const s = document.createElement("script");
    const cleanup = ()=>{
      try{ delete window[cb]; }catch(_){}
      if(s && s.parentNode) s.parentNode.removeChild(s);
    };
    window[cb] = (data)=>{ cleanup(); resolve(data); };
    s.onerror = ()=>{ cleanup(); reject(new Error("load_error")); };
    s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + encodeURIComponent(cb);
    document.head.appendChild(s);
  });
}

function apiUrls(action, params){
  // action + params -> URL
  const q = new URLSearchParams();
  q.set("action", action);
  for(const [k,v] of Object.entries(params||{})){
    if(v===undefined || v===null) continue;
    q.set(k, String(v));
  }
  return API_EXEC + "?" + q.toString();
}

// --- Appels API (Apps Script) en JSONP : compatible GitHub Pages ---
function apiCalls(action, params = {}) {
  return new Promise((resolve, reject) => {
    const cb = "cb_" + action + "_" + Date.now() + "_" + Math.random().toString(16).slice(2);

    // callback global
    window[cb] = (data) => {
      try { delete window[cb]; } catch(e){}
      try { script.remove(); } catch(e){}
      resolve(data);
    };

    const q = new URLSearchParams();
    q.set("action", action);

    // ajoute params dans l'URL
    Object.entries(params || {}).forEach(([k, v]) => {
      if (v === undefined || v === null) return;
      q.set(k, String(v));
    });

    q.set("callback", cb);

    const script = document.createElement("script");
    script.src = API_EXEC + "?" + q.toString();
    script.onerror = () => {
      try { delete window[cb]; } catch(e){}
      reject(new Error("jsonp_error"));
    };

    document.head.appendChild(script);
  });
}
}

/* =============================
   DEMO (sans API)
   ============================= */
function demoInitData(){
  if(STATE.data.agents.length) return;

  STATE.data.agents = [
    {agent_id:"A-1", name:"Bamm√© Melody", active:true, code:"1111"},
    {agent_id:"A-2", name:"Laleeuw Franck", active:true, code:"0000"},
    {agent_id:"A-3", name:"V√©nante Am√©lie", active:true, code:"0000"},
    {agent_id:"A-4", name:"S√©n√©chal Benjamin", active:true, code:"0000"},
    {agent_id:"A-5", name:"Michel Marianne", active:true, code:"0000"},
    {agent_id:"A-6", name:"V√©nante Pierre", active:true, code:"0000"},
  ];
  STATE.data.missions = [
    {mission_id:"M1", label:"Boire un coup", active:true},
    {mission_id:"M2", label:"Laver vitres", active:true},
    {mission_id:"M3", label:"Nettoyage communs", active:true},
    {mission_id:"M4", label:"Pression v√©hicules", active:false},
    {mission_id:"M5", label:"Rangement VSAV", active:false},
  ];
  STATE.data.periods = [
    {period_id:"2026-01", label:"Janvier 2026", active:true},
    {period_id:"2026-02", label:"F√©vrier 2026", active:true},
  ];
}

async function demoCalls(action, params){
  demoInitData();

  // Public agents list for login dropdown
  if(action==="listAgentsPublic"){
    return { ok:true, agents: STATE.data.agents.map(a=>({agent_id:a.agent_id, name:a.name, active:a.active})) };
  }

  if(action==="adminLogin"){
    const ok = String(params.code||"").trim()==="1234";
    return { ok };
  }

  if(action==="adminChangePassword"){
    const ok = String(params.old_code||"").trim()==="1234" && String(params.new_code||"").trim().length>=4;
    return { ok, message: ok ? "Code admin modifi√©" : "Erreur" };
  }

  if(action==="adminListAgents"){
    return { ok:true, agents: STATE.data.agents.map(a=>({agent_id:a.agent_id, name:a.name, active:a.active})) };
  }
  if(action==="adminAddAgents"){
    const name=String(params.name||"").trim();
    const code=String(params.code||"").trim();
    if(!name) return { ok:false, message:"Nom manquant" };
    const id="A-"+Math.random().toString(36).slice(2,8);
    STATE.data.agents.unshift({agent_id:id,name,active:true,code:code||"0000"});
    return { ok:true, message:"Agent ajout√©" };
  }
  if(action==="adminToggleAgents"){
    const id=String(params.agent_id||"");
    const a=STATE.data.agents.find(x=>x.agent_id===id);
    if(a){ a.active = String(params.active)==="true"; }
    return { ok:true };
  }
  if(action==="adminRemoveAgents"){
    const id=String(params.agent_id||"");
    STATE.data.agents = STATE.data.agents.filter(x=>x.agent_id!==id);
    return { ok:true };
  }

  if(action==="adminListMissions"){
    return { ok:true, missions: STATE.data.missions.map(m=>({mission_id:m.mission_id,label:m.label,active:m.active})) };
  }
  if(action==="adminAddMissions"){
    const label=String(params.label||"").trim();
    if(!label) return { ok:false, message:"Libell√© manquant" };
    const id="M"+Math.random().toString(36).slice(2,6).toUpperCase();
    STATE.data.missions.unshift({mission_id:id,label,active:true});
    return { ok:true, message:"Mission ajout√©e" };
  }
  if(action==="adminToggleMissions"){
    const id=String(params.mission_id||"");
    const m=STATE.data.missions.find(x=>x.mission_id===id);
    if(m){ m.active = String(params.active)==="true"; }
    return { ok:true };
  }
  if(action==="adminRemoveMissions"){
    const id=String(params.mission_id||"");
    STATE.data.missions = STATE.data.missions.filter(x=>x.mission_id!==id);
    return { ok:true };
  }

  if(action==="adminListPeriods"){
    return { ok:true, periods: STATE.data.periods };
  }

  if(action==="adminLoadPeriods"){
    // loads group/responsable/active missions for period
    const pid=String(params.period_id||"");
    STATE.current.period_id = pid;
    if(!STATE.data._per){ STATE.data._per = {}; }
    if(!STATE.data._per[pid]){
      STATE.data._per[pid] = {
        groups:[ STATE.data.agents[0], STATE.data.agents[1] ].map(a=>({agent_id:a.agent_id,name:a.name})),
        responsable: {agent_id: STATE.data.agents[0].agent_id, name: STATE.data.agents[0].name},
        active_missions: STATE.data.missions.filter(x=>x.active).map(m=>({mission_id:m.mission_id,label:m.label}))
      };
    }
    const p = STATE.data._per[pid];
    return { ok:true, period_id:pid, groups:p.groups, responsables:p.responsable, active_missions:p.active_missions };
  }

  if(action==="adminAddToGroups"){
    const pid=String(params.period_id||"");
    const aid=String(params.agent_id||"");
    const per = STATE.data._per?.[pid];
    if(!per) return { ok:false, message:"P√©riode non charg√©e" };
    const a = STATE.data.agents.find(x=>x.agent_id===aid);
    if(!a) return { ok:false, message:"Agent introuvable" };
    if(!per.groups.find(x=>x.agent_id===aid)){
      per.groups.push({agent_id:aid,name:a.name});
    }
    return { ok:true, message:"Ajout√©" };
  }

  if(action==="adminRemoveFromGroups"){
    const pid=String(params.period_id||"");
    const aid=String(params.agent_id||"");
    const per = STATE.data._per?.[pid];
    if(!per) return { ok:false, message:"P√©riode non charg√©e" };
    per.groups = per.groups.filter(x=>x.agent_id!==aid);
    if(per.responsable && per.responsable.agent_id===aid){
      per.responsable = null;
    }
    return { ok:true, message:"Retir√©" };
  }

  if(action==="adminSetResponsables"){
    const pid=String(params.period_id||"");
    const aid=String(params.agent_id||"");
    const per = STATE.data._per?.[pid];
    if(!per) return { ok:false, message:"P√©riode non charg√©e" };
    const inGroup = per.groups.find(x=>x.agent_id===aid);
    if(!inGroup) return { ok:false, message:"Doit √™tre dans le groupe" };
    per.responsable = {agent_id:aid, name: inGroup.name};
    return { ok:true, message:"Responsable d√©fini" };
  }

  if(action==="adminSaveActiveMissions"){
    const pid=String(params.period_id||"");
    const per = STATE.data._per?.[pid];
    if(!per) return { ok:false, message:"P√©riode non charg√©e" };
    const ids = (String(params.mission_ids||"").split(",").map(x=>x.trim()).filter(Boolean));
    per.active_missions = STATE.data.missions.filter(m=>ids.includes(m.mission_id)).map(m=>({mission_id:m.mission_id,label:m.label}));
    return { ok:true, message:"Missions actives enregistr√©es", active_missions: per.active_missions };
  }

  if(action==="adminLoadRetours"){
    return { ok:true, items: [] };
  }

  // Agent side
  if(action==="agentsLogins"){
    const aid=String(params.agent_id||"");
    const code=String(params.code||"").trim();
    const a = STATE.data.agents.find(x=>x.agent_id===aid);
    if(!a) return { ok:false, message:"Agent inconnu" };
    if(String(a.code).trim()!==code) return { ok:false, message:"Code incorrect" };
    // demo: show allowed periods = all active
    return { ok:true, agent:{agent_id:a.agent_id, name:a.name}, periods: STATE.data.periods.filter(p=>p.active) };
  }

  if(action==="agentsChangePasswords"){
    const aid=String(params.agent_id||"");
    const oldc=String(params.old_code||"").trim();
    const newc=String(params.new_code||"").trim();
    const a = STATE.data.agents.find(x=>x.agent_id===aid);
    if(!a) return { ok:false, message:"Agent inconnu" };
    if(String(a.code).trim()!==oldc) return { ok:false, message:"Ancien code incorrect" };
    if(newc.length<4) return { ok:false, message:"Nouveau code trop court" };
    a.code=newc;
    return { ok:true, message:"Code modifi√©" };
  }

  if(action==="agentsLoadPeriods"){
    const pid=String(params.period_id||"");
    const list = (STATE.data._per?.[pid]?.active_missions || []).map(m=>({
      mission_id:m.mission_id,
      label:m.label,
      done:false,
      note:""
    }));
    return { ok:true, period_id:pid, missions:list, responsables: STATE.data._per?.[pid]?.responsable?.name || "" };
  }

  if(action==="agentsSaves"){
    return { ok:true, message:"Enregistr√© ‚úÖ" };
  }

  return { ok:false, error:"unknown_action", action };
}

/* =============================
   RENDER
   ============================= */
function renderAgentsPublics(agents){
  const sel = $("agentsSel");
  sel.innerHTML = `<option value="">‚Äî Choisir agent ‚Äî</option>` + (agents||[])
    .filter(a=>a.active)
    .map(a=>`<option value="${esc(a.agent_id)}">${esc(a.name)}</option>`)
    .join("");
}

function renderAdminsAgents(agents){
  const box = $("boxAdminsAgents");
  if(!agents || !agents.length){
    box.innerHTML = `<div class="listItem"><div class="listLeft"><div class="listTitle" style="color:rgba(232,238,249,.55)">Aucun agent</div></div></div>`;
    return;
  }
  box.innerHTML = agents.map(a=>`
    <div class="listItem">
      <div class="listLeft">
        <div class="listTitle">${esc(a.name)}</div>
        <div class="listSub">${a.active ? "Actif ‚úÖ" : "Inactif ‚ùå"}</div>
      </div>
      <div class="pillRow">
        <button class="btn small" onclick="adminsToggleAgents('${esc(a.agent_id)}', ${a.active ? "false" : "true"})">${a.active ? "D√©sactiver" : "Activer"}</button>
        <button class="btn small danger" onclick="adminsRemoveAgents('${esc(a.agent_id)}')">Supprimer</button>
      </div>
    </div>
  `).join("");
}

function renderAdminsMissions(missions){
  const box = $("boxAdminsMissions");
  if(!missions || !missions.length){
    box.innerHTML = `<div class="listItem"><div class="listLeft"><div class="listTitle" style="color:rgba(232,238,249,.55)">Aucune mission</div></div></div>`;
    return;
  }
  box.innerHTML = missions.map(m=>`
    <div class="listItem">
      <div class="listLeft">
        <div class="listTitle">${esc(m.label)}</div>
        <div class="listSub">${m.active ? "Active ‚úÖ" : "Inactive ‚ùå"}</div>
      </div>
      <div class="pillRow">
        <button class="btn small" onclick="adminsToggleMissions('${esc(m.mission_id)}', ${m.active ? "false" : "true"})">${m.active ? "D√©sactiver" : "Activer"}</button>
        <button class="btn small danger" onclick="adminsRemoveMissions('${esc(m.mission_id)}')">Supprimer</button>
      </div>
    </div>
  `).join("");
}

function renderAdminsPeriods(periods){
  const sel = $("adminsPeriodsSel");
  sel.innerHTML = `<option value="">‚Äî Choisir p√©riode ‚Äî</option>` + (periods||[])
    .filter(p=>p.active!==false)
    .map(p=>`<option value="${esc(p.period_id)}">${esc(p.label || p.period_id)}</option>`)
    .join("");
}

function renderAdminsAddToGroupsSel(agents){
  const sel = $("adminsAddToGroupsSel");
  sel.innerHTML = `<option value="">‚Äî Choisir agent ‚Äî</option>` + (agents||[])
    .filter(a=>a.active)
    .map(a=>`<option value="${esc(a.agent_id)}">${esc(a.name)}</option>`)
    .join("");
}

function renderAdminsResponsablesSel(groups){
  const sel = $("adminsResponsablesSel");
  sel.innerHTML = `<option value="">‚Äî Choisir ‚Äî</option>` + (groups||[])
    .map(a=>`<option value="${esc(a.agent_id)}">${esc(a.name)}</option>`)
    .join("");
}

function renderAdminsGroups(groups){
  const box = $("boxAdminsGroups");
  if(!groups || !groups.length){
    box.innerHTML = `<div class="listItem"><div class="listLeft"><div class="listTitle" style="color:rgba(232,238,249,.55)">Aucun agent dans le groupe</div></div></div>`;
    return;
  }
  box.innerHTML = groups.map(a=>`
    <div class="listItem">
      <div class="listLeft"><div class="listTitle">${esc(a.name)}</div></div>
      <div>
        <button class="btn small danger" onclick="adminsRemoveFromGroups('${esc(a.agent_id)}')">Retirer</button>
      </div>
    </div>
  `).join("");
}

function renderAdminsActiveMissions(allMissions, activeMissions){
  const box = $("boxAdminsActiveMissions");
  const activeSet = new Set((activeMissions||[]).map(m=>String(m.mission_id)));
  const list = (allMissions||[]).slice();
  if(!list.length){
    box.innerHTML = `<div class="listItem"><div class="listLeft"><div class="listTitle" style="color:rgba(232,238,249,.55)">Aucune mission catalogue</div></div></div>`;
    return;
  }
  box.innerHTML = list.map(m=>`
    <label class="checkRow" style="cursor:pointer">
      <input type="checkbox" data-mid="${esc(m.mission_id)}" ${activeSet.has(String(m.mission_id)) ? "checked" : ""} />
      <div class="listLeft" style="min-width:0">
        <div class="listTitle">${esc(m.label)}</div>
      </div>
    </label>
  `).join("");
}

function renderAdminsRetours(items){
  const box = $("boxAdminsRetours");
  if(!items || !items.length){
    box.innerHTML = `<div class="listItem"><div class="listLeft"><div class="listTitle" style="color:rgba(232,238,249,.55)">Aucun retour.</div></div></div>`;
    return;
  }
  box.innerHTML = items.map(it=>`
    <div class="listItem">
      <div class="listLeft">
        <div class="listTitle">${esc(it.agent)}</div>
        <div class="listSub">${esc(it.mission)} ‚Äî ${esc(it.declaration)}</div>
      </div>
    </div>
  `).join("");
}

function renderAgentsPeriods(periods){
  const sel = $("agentsPeriodsSel");
  sel.innerHTML = `<option value="">‚Äî Choisir p√©riode ‚Äî</option>` + (periods||[])
    .filter(p=>p.active!==false)
    .map(p=>`<option value="${esc(p.period_id)}">${esc(p.label || p.period_id)}</option>`)
    .join("");
}

function renderAgentsMissions(missions){
  const box = $("boxAgentsMissions");
  if(!missions || !missions.length){
    box.innerHTML = `<div class="listItem"><div class="listLeft"><div class="listTitle" style="color:rgba(232,238,249,.55)">Aucune mission.</div></div></div>`;
    return;
  }
  box.innerHTML = missions.map(m=>`
    <div class="checkRow">
      <input type="checkbox" data-mid="${esc(m.mission_id)}" ${m.done ? "checked" : ""} />
      <div class="listLeft" style="min-width:0;flex:1">
        <div class="listTitle">${esc(m.label)}</div>
      </div>
    </div>
  `).join("");
}

/* =============================
   ACTIONS ‚Äî ADMINS (tout au pluriel)
   ============================= */
async function adminsLogins(ev){
  hideToasts("toastAdminsLogin");
  const btn = ev?.target || $("btnAdminsLogin");
  const code = $("adminsCode").value.trim();
  if(!code){ showToasts("toastAdminsLogin","Code requis.",false); return; }

  setLoadings(btn,true);
  try{
    const res = await apiCalls("adminLogin", { code });
    if(!res || !res.ok){
      STATE.admins.ok=false; STATE.admins.code="";
      setPills("pillAdminsStatus","Admin : non connect√©","bad");
      $("btnAdminsKey").style.display="none";
      $("btnAdminsLogout").style.display="none";
      $("boxAdminsWork").style.display="none";
      showToasts("toastAdminsLogin","Erreur connexion admin.",false);
      return;
    }
    STATE.admins.ok=true;
    STATE.admins.code=code;

    setPills("pillAdminsStatus","Admin : connect√©","ok");
    $("btnAdminsKey").style.display="";
    $("btnAdminsLogout").style.display="";
    $("boxAdminsWork").style.display="";
    showToasts("toastAdminsLogin","Admin connect√© ‚úÖ",true);

    await adminBootstraps();
  }catch(e){
    showToasts("toastAdminsLogin", e.message==="load_error" ? "Erreur load_error" : "Erreur r√©seau", false);
  }finally{
    setLoadings(btn,false);
  }
}

async function adminsLogouts(){
  STATE.admins.ok=false; STATE.admins.code="";
  setPills("pillAdminsStatus","Admin : non connect√©","bad");
  $("btnAdminsKey").style.display="none";
  $("btnAdminsLogout").style.display="none";
  $("boxAdminsWork").style.display="none";
  $("boxAdminsKey").style.display="none";
}

function toggleAdminsKey(){
  const box = $("boxAdminsKey");
  box.style.display = (box.style.display==="none" || !box.style.display) ? "" : "none";
}

async function adminsChangePasswords(ev){
  hideToasts("toastAdminsChange");
  const btn = ev?.target || $("btnAdminsChange");
  if(!STATE.admins.ok){ showToasts("toastAdminsChange","Connecte-toi d'abord.",false); return; }
  const old_code = $("adminsOldCode").value.trim();
  const new_code = $("adminsNewCode").value.trim();
  if(!old_code || !new_code){ showToasts("toastAdminsChange","Ancien + nouveau requis.",false); return; }
  if(new_code.length<4){ showToasts("toastAdminsChange","Nouveau code trop court.",false); return; }

  setLoadings(btn,true);
  try{
    const res = await apiCalls("adminChangePassword", { old_code, new_code, admin_code: STATE.admins.code });
    if(!res || !res.ok){
      showToasts("toastAdminsChange", (res && res.message) ? res.message : "Erreur", false);
      return;
    }
    showToasts("toastAdminsChange","Code admin modifi√© ‚úÖ",true);
    // en d√©mo, on reste sur 1234 ; en API r√©elle tu voudras re-login
  }catch(e){
    showToasts("toastAdminsChange","Erreur r√©seau",false);
  }finally{
    setLoadings(btn,false);
  }
}

async function adminBootstraps(){
  // charge periods + agents + missions
  await adminsListPeriods();
  await adminsListAgents();
  await adminsListMissions();
}

async function adminsListPeriods(){
  const res = await apiCalls("adminListPeriods", { admin_code: STATE.admins.code });
  if(!res || !res.ok) return;
  STATE.data.periods = res.periods || [];
  renderAdminsPeriods(STATE.data.periods);
}

async function adminsListAgents(){
  const res = await apiCalls("adminListAgents", { admin_code: STATE.admins.code });
  if(!res || !res.ok) return;
  STATE.data.agents = res.agents || [];
  renderAdminsAgents(STATE.data.agents);
  renderAdminsAddToGroupsSel(STATE.data.agents);

  // c√¥t√© agents (dropdown public)
  renderAgentsPublics(STATE.data.agents);
}

async function adminsAddAgents(ev){
  hideToasts("toastAdminsAgents");
  const btn = ev?.target || $("btnAdminsAddAgent");
  if(!STATE.admins.ok){ showToasts("toastAdminsAgents","Non connect√©.",false); return; }

  const name = $("adminsNewAgentName").value.trim();
  const code = $("adminsNewAgentCode").value.trim() || "0000";
  if(!name){ showToasts("toastAdminsAgents","Nom requis.",false); return; }

  setLoadings(btn,true);
  try{
    const res = await apiCalls("adminAddAgents", { name, code, admin_code: STATE.admins.code });
    if(!res || !res.ok){
      showToasts("toastAdminsAgents", (res&&res.message)||"Erreur", false);
      return;
    }
    showToasts("toastAdminsAgents","Agent ajout√© ‚úÖ",true);
    $("adminsNewAgentName").value="";
    $("adminsNewAgentCode").value="0000";
    await adminsListAgents();
  }catch(e){
    showToasts("toastAdminsAgents","Erreur r√©seau",false);
  }finally{
    setLoadings(btn,false);
  }
}

async function adminsToggleAgents(agent_id, active){
  if(!STATE.admins.ok) return;
  await apiCalls("adminToggleAgents", { agent_id, active, admin_code: STATE.admins.code });
  await adminsListAgents();
}

async function adminsRemoveAgents(agent_id){
  if(!STATE.admins.ok) return;
  if(!confirm("Supprimer cet agent ?")) return;
  await apiCalls("adminRemoveAgents", { agent_id, admin_code: STATE.admins.code });
  await adminsListAgents();
}

async function adminsListMissions(){
  const res = await apiCalls("adminListMissions", { admin_code: STATE.admins.code });
  if(!res || !res.ok) return;
  STATE.data.missions = res.missions || [];
  renderAdminsMissions(STATE.data.missions);
}

async function adminsAddMissions(ev){
  hideToasts("toastAdminsMissions");
  const btn = ev?.target || $("btnAdminsAddMission");
  if(!STATE.admins.ok){ showToasts("toastAdminsMissions","Non connect√©.",false); return; }
  const label = $("adminsNewMissionLib").value.trim();
  if(!label){ showToasts("toastAdminsMissions","Libell√© requis.",false); return; }
  setLoadings(btn,true);
  try{
    const res = await apiCalls("adminAddMissions", { label, admin_code: STATE.admins.code });
    if(!res || !res.ok){
      showToasts("toastAdminsMissions",(res&&res.message)||"Erreur",false);
      return;
    }
    showToasts("toastAdminsMissions","Mission ajout√©e ‚úÖ",true);
    $("adminsNewMissionLib").value="";
    await adminsListMissions();
  }catch(e){
    showToasts("toastAdminsMissions","Erreur r√©seau",false);
  }finally{
    setLoadings(btn,false);
  }
}

async function adminsToggleMissions(mission_id, active){
  if(!STATE.admins.ok) return;
  await apiCalls("adminToggleMissions", { mission_id, active, admin_code: STATE.admins.code });
  await adminsListMissions();
}

async function adminsRemoveMissions(mission_id){
  if(!STATE.admins.ok) return;
  if(!confirm("Supprimer cette mission ?")) return;
  await apiCalls("adminRemoveMissions", { mission_id, admin_code: STATE.admins.code });
  await adminsListMissions();
}

async function adminsLoadPeriods(ev){
  hideToasts("toastAdminsPeriods");
  const btn = ev?.target || $("btnAdminsLoadPeriod");
  if(!STATE.admins.ok){ showToasts("toastAdminsPeriods","Non connect√©.",false); return; }

  const pid = $("adminsPeriodsSel").value;
  if(!pid){ showToasts("toastAdminsPeriods","Choisis une p√©riode.",false); return; }

  setLoadings(btn,true);
  try{
    const res = await apiCalls("adminLoadPeriods", { period_id: pid, admin_code: STATE.admins.code });
    if(!res || !res.ok){
      showToasts("toastAdminsPeriods",(res&&res.message)||"Erreur",false);
      return;
    }
    STATE.current.period_id = pid;
    STATE.data.groups = res.groups || [];
    STATE.data.responsables = res.responsables || null;
    STATE.data.active_missions = res.active_missions || [];

    setPills("pillAdminsResponsables", "Responsable : " + (STATE.data.responsables?.name || "‚Äî"));
    renderAdminsGroups(STATE.data.groups);
    renderAdminsResponsablesSel(STATE.data.groups);
    renderAdminsActiveMissions(STATE.data.missions, STATE.data.active_missions);

    showToasts("toastAdminsPeriods","P√©riode charg√©e ‚úÖ",true);
  }catch(e){
    showToasts("toastAdminsPeriods", e.message==="load_error" ? "Erreur load_error" : "Erreur r√©seau", false);
  }finally{
    setLoadings(btn,false);
  }
}

async function adminsAddToGroups(ev){
  hideToasts("toastAdminsPeriods");
  const btn = ev?.target || $("btnAdminsAddToGroups");
  if(!STATE.admins.ok) return;
  const pid = STATE.current.period_id;
  const agent_id = $("adminsAddToGroupsSel").value;
  if(!pid){ showToasts("toastAdminsPeriods","Charge d‚Äôabord une p√©riode.",false); return; }
  if(!agent_id){ showToasts("toastAdminsPeriods","Choisis un agent.",false); return; }

  setLoadings(btn,true);
  try{
    const res = await apiCalls("adminAddToGroups", { period_id: pid, agent_id, admin_code: STATE.admins.code });
    if(!res || !res.ok){
      showToasts("toastAdminsPeriods",(res&&res.message)||"Erreur",false);
      return;
    }
    // reload clean (une seule fois)
    await adminsLoadPeriods({target:$("btnAdminsLoadPeriod")});
  }catch(e){
    showToasts("toastAdminsPeriods","Erreur r√©seau",false);
  }finally{
    setLoadings(btn,false);
  }
}

async function adminsRemoveFromGroups(agent_id){
  hideToasts("toastAdminsPeriods");
  if(!STATE.admins.ok) return;
  const pid = STATE.current.period_id;
  if(!pid) return;
  const res = await apiCalls("adminRemoveFromGroups", { period_id: pid, agent_id, admin_code: STATE.admins.code });
  if(!res || !res.ok){
    showToasts("toastAdminsPeriods",(res&&res.message)||"Erreur",false);
    return;
  }
  await adminsLoadPeriods({target:$("btnAdminsLoadPeriod")});
}

async function adminsSetResponsables(ev){
  hideToasts("toastAdminsPeriods");
  const btn = ev?.target || $("btnAdminsSetResponsables");
  if(!STATE.admins.ok) return;
  const pid = STATE.current.period_id;
  const agent_id = $("adminsResponsablesSel").value;
  if(!pid){ showToasts("toastAdminsPeriods","Charge d‚Äôabord une p√©riode.",false); return; }
  if(!agent_id){ showToasts("toastAdminsPeriods","Choisis un responsable.",false); return; }

  setLoadings(btn,true);
  try{
    const res = await apiCalls("adminSetResponsables", { period_id: pid, agent_id, admin_code: STATE.admins.code });
    if(!res || !res.ok){
      showToasts("toastAdminsPeriods",(res&&res.message)||"Erreur",false);
      return;
    }
    await adminsLoadPeriods({target:$("btnAdminsLoadPeriod")});
  }catch(e){
    showToasts("toastAdminsPeriods","Erreur r√©seau",false);
  }finally{
    setLoadings(btn,false);
  }
}

async function adminsSaveActiveMissions(ev){
  hideToasts("toastAdminsActiveMissions");
  const btn = ev?.target || $("btnAdminsSaveActiveMissions");
  if(!STATE.admins.ok) return;
  const pid = STATE.current.period_id;
  if(!pid){ showToasts("toastAdminsActiveMissions","Charge d‚Äôabord une p√©riode.",false); return; }

  const checks = Array.from($("boxAdminsActiveMissions").querySelectorAll('input[type="checkbox"][data-mid]'));
  const mission_ids = checks.filter(c=>c.checked).map(c=>c.getAttribute("data-mid")).join(",");

  setLoadings(btn,true);
  try{
    const res = await apiCalls("adminSaveActiveMissions", { period_id: pid, mission_ids, admin_code: STATE.admins.code });
    if(!res || !res.ok){
      showToasts("toastAdminsActiveMissions",(res&&res.message)||"Erreur",false);
      return;
    }
    STATE.data.active_missions = res.active_missions || [];
    renderAdminsActiveMissions(STATE.data.missions, STATE.data.active_missions);
    showToasts("toastAdminsActiveMissions","Enregistr√© ‚úÖ",true);
  }catch(e){
    showToasts("toastAdminsActiveMissions","Erreur r√©seau",false);
  }finally{
    setLoadings(btn,false);
  }
}

async function adminsLoadRetours(ev){
  hideToasts("toastAdminsRetours");
  const btn = ev?.target || $("btnAdminsLoadRetours");
  if(!STATE.admins.ok) return;
  const pid = STATE.current.period_id;
  if(!pid){ showToasts("toastAdminsRetours","Charge d‚Äôabord une p√©riode.",false); return; }

  setLoadings(btn,true);
  try{
    const res = await apiCalls("adminLoadRetours", { period_id: pid, admin_code: STATE.admins.code });
    if(!res || !res.ok){
      showToasts("toastAdminsRetours","Erreur",false);
      return;
    }
    renderAdminsRetours(res.items||[]);
    showToasts("toastAdminsRetours","Retours charg√©s ‚úÖ",true);
  }catch(e){
    showToasts("toastAdminsRetours","Erreur r√©seau",false);
  }finally{
    setLoadings(btn,false);
  }
}

/* =============================
   ACTIONS ‚Äî AGENTS (tout au pluriel)
   ============================= */
async function agentsBootstraps(){
  try{
    const res = await apiCalls("listAgentsPublic", {});
    if(res && res.ok){
      STATE.data.agents = res.agents || [];
      renderAgentsPublics(STATE.data.agents);
    }
  }catch(_){
    renderAgentsPublics([]);
    $("agentsSel").innerHTML = `<option value="">‚Äî Erreur chargement ‚Äî</option>`;
  }
}

async function agentsLogins(ev){
  hideToasts("toastAgentsLogin");
  const btn = ev?.target || $("btnAgentsLogin");
  const sel = document.querySelector('#agentsSel');
const inp = document.querySelector('#agentsCode');

if(!sel || !inp){
  showToasts("toastAgentsLogin","Interface agent non pr√™te",false);
  return;
}

const agent_id = sel.value;
const code = inp.value.trim();

  if(!agent_id || !code){ showToasts("toastAgentsLogin","S√©lection + code requis.",false); return; }

  setLoadings(btn,true);
  try{
    const res = await apiCalls("agentLogin", { agent_id, code });
    if(!res || !res.ok){
      showToasts("toastAgentsLogin",(res&&res.message)||"Erreur connexion.",false);
      setPills("pillAgentsStatus","Agent : non connect√©","bad");
      $("btnAgentsKey").style.display="none";
      $("btnAgentsLogout").style.display="none";
      $("boxAgentsWork").style.display="none";
      return;
    }
    STATE.agents.ok = true;
    STATE.agents.agent_id = res.agent.agent_id;
    STATE.agents.name = res.agent.name;
    STATE.agents.code = code;

    setPills("pillAgentsStatus","Agent : "+STATE.agents.name,"ok");
    $("btnAgentsKey").style.display="";
    $("btnAgentsLogout").style.display="";
    $("boxAgentsWork").style.display="";
    showToasts("toastAgentsLogin","Connect√© ‚úÖ",true);

    renderAgentsPeriods(res.periods || []);
    $("doneOverlay").classList.remove("show");
  }catch(e){
    showToasts("toastAgentsLogin", e.message==="load_error" ? "Erreur load_error" : "Erreur r√©seau", false);
  }finally{
    setLoadings(btn,false);
  }
}

async function agentsLogouts(){
  STATE.agents = { ok:false, agent_id:"", name:"", code:"", must_change:false };
  setPills("pillAgentsStatus","Agent : non connect√©","bad");
  $("btnAgentsKey").style.display="none";
  $("btnAgentsLogout").style.display="none";
  $("boxAgentsKey").style.display="none";
  $("boxAgentsWork").style.display="none";
  $("agentsCode").value="";
  $("agentsPeriodsSel").innerHTML = `<option value="">‚Äî</option>`;
  $("boxAgentsMissions").innerHTML = `<div class="listItem"><div class="listLeft"><div class="listTitle" style="color:rgba(232,238,249,.55)">Choisis une p√©riode puis ‚ÄúCharger‚Äù.</div></div></div>`;
}

function toggleAgentsKey(){
  const box = $("boxAgentsKey");
  box.style.display = (box.style.display==="none" || !box.style.display) ? "" : "none";
}

async function agentsChangePasswords(ev){
  hideToasts("toastAgentsChange");
  const btn = ev?.target || $("btnAgentsChange");
  if(!STATE.agents.ok){ showToasts("toastAgentsChange","Connecte-toi d'abord.",false); return; }
  const old_code = $("agentsOldCode").value.trim();
  const new_code = $("agentsNewCode").value.trim();
  if(!old_code || !new_code){ showToasts("toastAgentsChange","Ancien + nouveau requis.",false); return; }
  if(new_code.length<4){ showToasts("toastAgentsChange","Nouveau code trop court.",false); return; }

  setLoadings(btn,true);
  try{
    const res = await apiCalls("agentsChangePasswords", { agent_id: STATE.agents.agent_id, old_code, new_code });
    if(!res || !res.ok){
      showToasts("toastAgentsChange",(res&&res.message)||"Erreur",false);
      return;
    }
    showToasts("toastAgentsChange","Code modifi√© ‚úÖ",true);
    STATE.agents.code = new_code;
  }catch(e){
    showToasts("toastAgentsChange","Erreur r√©seau",false);
  }finally{
    setLoadings(btn,false);
  }
}

async function agentsLoadPeriods(ev){
  hideToasts("toastAgentsSave");
  const btn = ev?.target || $("btnAgentsLoad");
  if(!STATE.agents.ok) return;

  const pid = $("agentsPeriodsSel").value;
  if(!pid){ showToasts("toastAgentsSave","Choisis une p√©riode.",false); return; }

  setLoadings(btn,true);
  try{
    const res = await apiCalls("agentsLoadPeriods", { agent_id: STATE.agents.agent_id, period_id: pid });
    if(!res || !res.ok){
      showToasts("toastAgentsSave",(res&&res.message)||"Erreur",false);
      return;
    }
    setPills("pillAgentsPeriod","P√©riode : "+(pid),"");
    STATE.current.period_id = pid;

    STATE.data.agent_work = (res.missions||[]).map(m=>({mission_id:m.mission_id,label:m.label,done:!!m.done,note:m.note||""}));
    renderAgentsMissions(STATE.data.agent_work);
    $("doneOverlay").classList.remove("show");
  }catch(e){
    showToasts("toastAgentsSave","Erreur r√©seau",false);
  }finally{
    setLoadings(btn,false);
  }
}

async function agentsSaves(ev){
  hideToasts("toastAgentsSave");
  const btn = ev?.target || $("btnAgentsSave");
  if(!STATE.agents.ok){ showToasts("toastAgentsSave","Non connect√©.",false); return; }
  const pid = STATE.current.period_id;
  if(!pid){ showToasts("toastAgentsSave","Choisis une p√©riode.",false); return; }

  // r√©cup√®re checks
  const checks = Array.from($("boxAgentsMissions").querySelectorAll('input[type="checkbox"][data-mid]'));
  const set = new Set(checks.filter(c=>c.checked).map(c=>c.getAttribute("data-mid")));

  const missions = (STATE.data.agent_work||[]).map(m=>({
    mission_id:m.mission_id,
    done: set.has(String(m.mission_id))
  }));

  const remark = $("agentsRemark").value.trim();

  setLoadings(btn,true);
  try{
    const res = await apiCalls("agentsSaves", { agent_id: STATE.agents.agent_id, period_id: pid, remark, missions: JSON.stringify(missions) });
    if(!res || !res.ok){
      showToasts("toastAgentsSave",(res&&res.message)||"Erreur",false);
      return;
    }
    showToasts("toastAgentsSave","Enregistr√© ‚úÖ",true);

    // si toutes faites => image
    const allDone = missions.length>0 && missions.every(x=>x.done);
    if(allDone){
      $("doneOverlay").classList.add("show");
    }else{
      $("doneOverlay").classList.remove("show");
    }
  }catch(e){
    showToasts("toastAgentsSave","Erreur r√©seau",false);
  }finally{
    setLoadings(btn,false);
  }
}

/* =============================
   EVENTS
   ============================= */
$("doneImg").addEventListener("dblclick", ()=> $("doneOverlay").classList.remove("show"));
$("doneImg").addEventListener("touchend", (e)=>{
  // double tap simple
  const now = Date.now();
  if(!window.__lastTap){ window.__lastTap = now; return; }
  if(now - window.__lastTap < 350){
    $("doneOverlay").classList.remove("show");
  }
  window.__lastTap = now;
});

/* =============================
   INIT
   ============================= */
(function init(){
  // tabs
  showViews("agents");
  // dropdown agents public
  agentsBootstraps();

  // statut pills init
  setPills("pillAdminsStatus","Admin : non connect√©","bad");
  setPills("pillAgentsStatus","Agent : non connect√©","bad");

  // si demo, pr√©remplit la liste agents aussi
  if(MODE_DEMO){
    demoInitData();
    renderAgentsPublics(STATE.data.agents);
  }
})();
</script>
</body>
</html>

